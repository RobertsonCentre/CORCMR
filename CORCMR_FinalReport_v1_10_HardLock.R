# Project: CORCMR
# program to derive final report including all main results, manuscript tables file, figures, diagnostic figures, and listings
# v1_10 started 22/09/2025
# program by Gemma McKinley

#### CLEAR WORKSPACE ####
rm(list=objects())
setwd("//rcb-storage/filestore/Studies/CORCMR/Secure/Unblinded/")
#### SETUP ####

# EDITABLE SECTION

# NAME OF STATISTICIAN RUNNING PROGRAM
stats.name<-"Gemma McKinley"

# PROGRAM DEVELOPMENT VERSION
Version<-"v1_10"
vdraft <- "HardLock"
# DEMO eCRF DETAILS
demo.url<-"https://www.rcbweb.com/CORCMR_de2_demo/Login.aspx"
demo.login<-"rn"
demo.password<-"password"

# PROJECT NAME
project.title<-"The clinical utility of cardiac magnetic resonance imaging in patients with angina but no obstructive coronary disease: a diagnostic study and nested randomised trial."
project.name<-"CORCMR"
Project.Disclaimer <- T

# LIBRARIES
# install.packages("tidyr")
# install.packages("dplyr")
# install.packages("survival")
# install.packages("car")
# install.packages("ggplot2")
#install.packages("officer")
library(tidyr)
library(dplyr)
library(survival)
library(car)
library(ggplot2)
library(officer)
# SET ANALYSIS NAME AND OUTPUT DIRECTORIES
analysis.name<-paste("FinalReport")
out.path<-paste0("C:/CORCMR/Unblinded/reports/", Version, "/", vdraft)
dir.create(out.path, recursive=T)
program.name<-paste(project.name,"_FinalReport_",Version,"_", vdraft, ".R",sep="")

# OUTPUT SUBDIRECTORIES
# CREATE SUBDIRECTORY FOR TABLES
table.path<-paste(out.path,"Tables",sep="/")
dir.create(table.path)
# CREATE SUBDIRECTORY FOR FIGURES
figure.path<-paste(out.path,"Tables","Figures",sep="/")
dir.create(figure.path)
# CREATE SUBDIRECTORY FOR FIGURES (diagnostics)
diags.path<-paste(out.path,"Tables","Figures","Diagnostics",sep="/")
dir.create(diags.path)

# DEFAULT FORMATS FOR TABLES
horiz.fmt<-
  list(
    Style=
      list(
        "font-family"="Arial","font-size"="10pt","page-break-inside"="avoid",
        "border-collapse"="collapse","padding"=paste(rep("0.1cm",4),collapse=" "),
        "border-top"="none","border-bottom"="solid windowtext 1pt","border-left"="none","border-right"="none"),
    Other=
      list(
        align="left",valign="middle"))
none.fmt<-
  list(
    Style=
      list(
        "font-family"="Arial","font-size"="10pt","page-break-inside"="avoid",
        "border-collapse"="collapse","padding"=paste(rep("0.1cm",4),collapse=" "),
        "border-bottom"="none","border-top"="none","border-left"="none","border-right"="none"),
    Other=
      list(
        align="left",valign="middle"))
list.fmt<-
  list(
    Style=
      list(
        "font-family"="Arial","font-size"="10pt","page-break-inside"="avoid",
        "border-collapse"="collapse","padding"=paste(rep("0.1cm",4),collapse=" "),
        "border-top"="none","border-bottom"="solid windowtext 1pt","border-left"="none","border-right"="none"),
    Other=
      list(
        align="left",valign="middle"))

#### FUNCTIONS ####

# TABLES FUNCTIONS
# v1.1 of SPlusTables
source("//Rcb-file-2000/filestore/Studies/SPlusTables/Share/SPlusTables_v1/SPlusTables_Functions_v1_1.R")

# FORMATTING
my.format<-
  function(x,ndp,na.replace="-")
    ifelse(
      is.na(x),
      na.replace,
      format(round(x,ndp),ns=ndp,scientific=F,trim=T))
p.format<-function(x,pref="p"){
  out<-my.format(x,3)
  ifelse(
    out=="0.000",
    paste(pref,"<0.001",sep=""),
    paste(pref,"=",out,sep=""))
}

# BASIC SUMMARY FUNCTION - REPLACE TEXT PATTERNS
summary.fun<-function(x,summary.text,ndp=1)
{
  out<-summary.text
  
  if(length(x)==0)
  {
    sub.n<-0
    sub.nmiss<-sub.pcmiss<-sub.mean<-sub.sd<-sub.count<-sub.percent<-sub.median<-sub.lq<-sub.uq<-sub.min<-sub.max<-sub.geomean<-sub.geosd<-"-"
  } else
  {
    sub.n<-sum(!is.na(x))
    sub.nmiss<-sum(is.na(x))
    sub.pcmiss<-my.format(100*mean(is.na(x)),1)
    sub.mean<-my.format(mean(x,na.rm=T),ndp)
    if(sub.n>1)
    {	sub.sd<-my.format(sqrt(var(x,na.rm=T)),ndp)
    } else
      sub.sd<-"-"
    sub.count<-sum(x,na.rm=T)
    sub.percent<-my.format(100*mean(x,na.rm=T),ndp)
    sub.median<-my.format(median(x,na.rm=T),ndp)
    sub.lq<-my.format(quantile(x,0.25,na.rm=T),ndp)
    sub.uq<-my.format(quantile(x,0.75,na.rm=T),ndp)
    if(sub.n)
    {
      sub.min<-my.format(min(x,na.rm=T),ndp)
      sub.max<-my.format(max(x,na.rm=T),ndp)
    } else
    {
      sub.min<-sub.max<-"-"
    }
    if(sum(x<=0,na.rm=T)==0)
    {
      sub.geomean<-my.format(exp(mean(log(x),na.rm=T)),ndp)
      if(sub.n>1)
      {	sub.geosd<-my.format(exp(sqrt(var(log(x),na.rm=T))),ndp)
      } else
        sub.geosd<-"-"
    }
  }
  
  out<-gsub("@N",sub.n,out)
  out<-gsub("@MISS",sub.nmiss,out)
  out<-gsub("@PCMISS",sub.pcmiss,out)
  out<-gsub("@MEAN",sub.mean,out)
  out<-gsub("@SD",sub.sd,out)
  out<-gsub("@COUNT",sub.count,out)
  out<-gsub("@PERCENT",sub.percent,out)
  out<-gsub("@MEDIAN",sub.median,out)
  out<-gsub("@LQ",sub.lq,out)
  out<-gsub("@UQ",sub.uq,out)
  out<-gsub("@MIN",sub.min,out)
  out<-gsub("@MAX",sub.max,out)
  if(sum(x<=0,na.rm=T)==0)
  {
    out<-gsub("@GEOMEAN",sub.geomean,out)
    out<-gsub("@GEOSD",sub.geosd,out)
  }
  out
}

# END ROW FOR TABLES
# INPUT PROJECT NAME AND DISCLAIMER INDICATOR
end.row<-
  function(
    pname=project.name,
    progname=program.name,
    disclaimer=Project.Disclaimer,
    footnote=NULL){
    end.text<-
      c(
        paste("Project:",pname,"  |  ", "Output created by program:",progname,"  |  ","Last run on",date(),"  |  ",R.version.string))
    
    if(is.character(disclaimer))
      end.text<-c(end.text,disclaimer)
    if(is.logical(disclaimer))
      if(disclaimer)
        end.text<-
          c(
            end.text,
            "These results have not been fully checked and must be treated as provisional.")
    output<-list(Text=end.text,Other=list(align="right"))
    
    if(!is.null(footnote))
      output<-rbindTable(row.title(footnote),output)
    
    output
  }
# ROW TITLES
row.title<-
  function(rowtext,anyOther=NULL,Style=NULL)
    list(Text=rowtext,Other=c(list(align="left"),anyOther),Style=Style)

# TABLE TITLE
table.title<-function(tabnum,tabtext)
  row.title(paste("<b>Table ",tabnum,":<b> ",tabtext,sep=""),Style=list("border-top"="solid windowtext 1pt"))

# FIGURE TITLE
figure.title<-function(tabnum,tabtext)
  row.title(paste("<b>Figure ",tabnum,":<b> ",tabtext,sep=""),Style=list("border-top"="solid windowtext 1pt"))

# CBINDTABLE FOR VECTORS
cbindVector<-function(x,...)do.call("cbindTable",lapply(as.list(x),function(x,...)list(Text=x,...),...=...))

# RBINDTABLE FOR VECTORS
rbindVector<-function(x,...)do.call("rbindTable",lapply(as.list(x),function(x,...)list(Text=x,...),...=...))

# N(%) COLUMN
npc.factor<-
  function(x,x.levels=NULL,showDenom=F)
  {
    if(is.factor(x)) xlev<-levels(x) else xlev<-sort(unique(x))
    if(is.null(x.levels)) x.levels<-xlev
    y<-table(factor(x,xlev),useNA="no")
    paste(
      paste(y,if(showDenom)paste("/",sum(y),sep="")," (",my.format(100*y/sum(y),1),"%)",sep="")[is.element(xlev,x.levels)],
      collapse="<br>")
  }

# SUMMARISE BY FACTOR
summary.by<-
  function(x,group,subset=NULL,fun,Style=NULL,Other=NULL,as.col=F,...){
    if(!(is.factor(group)|(is.list(group)))) stop("'group' must be a factor or a list.")
    if(is.factor(group))
      group<-lapply(as.list(levels(group)),function(i,g)g==i,g=group)
    if(!is.null(subset))
    {
      subset<-!is.na(subset)&subset
      x<-x[subset]
      group<-lapply(group,function(g,subset)g[subset],subset=subset)
    }
    temp<-
      unlist(
        lapply(
          group,
          function(g,x,fun,...)
          {
            if(is.null(g)) return("")
            fun(x[!is.na(g)&g],...)
          },
          x=x,fun=fun,...=...))
    if(as.col) rbindVector(temp,Style=Style,Other=Other) else cbindVector(temp,Style=Style,Other=Other)
  }

# CONTINUOUS ROW FUNCTION - ALL & BY TREAMENT
summary.cts<-function(x,row.name,ndp=1,treat,treat.levels,subset=NULL,summ.text=NULL,summ.desc=NULL)
{
  if(is.null(summ.text)) summ.text<-"@MEAN (@SD)<br>@MEDIAN (@LQ, @UQ)<br>[@MIN, @MAX]"
  if(is.null(summ.desc)) summ.desc<-"Mean (SD)<br>Median (IQR)<br>[Min, Max]"
  
  if(!is.null(subset))
  {
    subset<-subset&!is.na(subset)
    x<-x[subset]
    treat<-treat[subset]
  }
  
  out<-
    rbindTable(
      cbindTable(
        list(Text="N (N<sub>MISSING</sub>)",Style=list("border-bottom"="none")),
        list(Text="",Style=list("border-bottom"="none")),
        list(Text=summary.fun(x,"@N (@MISS)"),Style=list("border-bottom"="none"))),
      cbindTable(
        summ.desc,"",summary.fun(x,summ.text,ndp)))
  
  if(any(!is.na(treat)))
    out<-
    cbindTable(
      out,
      "",
      rbindTable(
        summary.by(
          x,factor(treat,treat.levels),
          fun=summary.fun,summary.text="@N (@MISS)",
          Style=list("border-bottom"="none")),
        summary.by(
          x,factor(treat,treat.levels),
          fun=summary.fun,summary.text=summ.text,ndp=ndp)))
  
  out<-rbindTable(row.title(row.name,Style=list("border-bottom"="none")),cbindTable("",out))
  
  out
}

# CONVERT TIME IN HOURS TO HOURS AND MINUTES
hours.mins<-function(x)
{
  x<-as.numeric(x)
  
  x.abs<-abs(x)
  x.hrs<-floor(x.abs)
  x.mins<-round(60*(x.abs-x.hrs))
  hrs.mins<-ifelse(is.na(x.hrs),"-",trimws(paste(x.hrs,substring(100+x.mins,2,3),sep=":")))
  hrs.mins<-ifelse(!is.na(x.hrs)&(x<0),paste("-",hrs.mins,sep=""),hrs.mins)
  hrs.mins
}

# BETTER MIN AND MAX FUNDTIONS
Smin<-function(x) if(all(is.na(x))) "-" else min(x,na.rm=T)
Smax<-function(x) if(all(is.na(x))) "-" else max(x,na.rm=T)

# SUMMARY FUNCTION FOR TIMES
summary.fun.time<-function(x)
  paste(
    hours.mins(mean(x,na.rm=T)),
    " (",hours.mins(sd(x,na.rm=T)),")<br>",
    hours.mins(median(x,na.rm=T)),
    " (",hours.mins(quantile(x,0.25,na.rm=T)),", ",hours.mins(quantile(x,0.75,na.rm=T)),")<br>",
    "[",hours.mins(Smin(x)),", ",hours.mins(Smax(x)),"]",
    sep="")

# ROW FUNCTION FOR TIMES - ALL & BY TREAMENT
summary.time<-function(x,row.name,treat,treat.levels,subset=NULL,...)
{
  if(!is.null(subset))
  {
    subset<-subset&!is.na(subset)
    x<-x[subset]
    treat<-treat[subset]
  }
  
  out<-
    rbindTable(
      cbindTable(
        list(Text="N (N<sub>MISSING</sub>)",Style=list("border-bottom"="none")),
        list(Text="",Style=list("border-bottom"="none")),
        list(Text=summary.fun(x,"@N (@MISS)"),Style=list("border-bottom"="none"))),
      cbindTable(
        "Mean (SD)<br>Median (IQR)<br>[Min, Max]",
        "",
        summary.fun.time(x)))
  
  if(any(!is.na(treat)))
    out<-
    cbindTable(
      out,
      "",
      rbindTable(
        summary.by(
          x,factor(treat,treat.levels),
          fun=summary.fun,summary.text="@N (@MISS)",
          Style=list("border-bottom"="none")),
        summary.by(
          x,factor(treat,treat.levels),
          fun=summary.fun.time)))
  
  out<-rbindTable(row.title(row.name,Style=list("border-bottom"="none")),cbindTable("",out))
  
  out
}

# CATEGORICAL ROW FUNCTION - ALL & BY TREATMENT
summary.cat<-function(x,row.name,treat,treat.levels,subset=NULL,showN=T,x.levels=NULL,showDenom=F)
{
  if(!is.null(subset))
  {
    subset<-subset&!is.na(subset)
    x<-x[subset]
    treat<-treat[subset]
  }
  
  if(is.null(x.levels))
    x.levels<-levels(x)
  
  out1<-
    cbindTable(
      paste("N",if(showDenom)"/Total"," (%) ",x.levels,sep=""),"",
      npc.factor(x,x.levels,showDenom))
  
  if(any(!is.na(treat)))
    out2<-
    cbindTable(
      "",
      summary.by(x,factor(treat,treat.levels),fun=npc.factor,x.levels=x.levels,showDenom=showDenom))
  
  if(showN)
  {
    out1<-
      rbindTable(
        cbindTable(
          list(Text="N (N<sub>MISSING</sub>)",Style=list("border-bottom"="none")),
          list(Text="",Style=list("border-bottom"="none")),
          list(Text=summary.fun(as.numeric(x),"@N (@MISS)"),Style=list("border-bottom"="none"))),
        out1)
    if(any(!is.na(treat)))
      out2<-
        rbindTable(
          cbindTable(
            list(Text="",Style=list("border-bottom"="none")),
            summary.by(
              as.numeric(x),
              factor(treat,treat.levels),
              fun=summary.fun,
              summary.text="@N (@MISS)",
              Style=list("border-bottom"="none"))),
          out2)
  }
  
  if(any(!is.na(treat)))
    out1<-cbindTable(out1,out2)
  out<-rbindTable(row.title(row.name,Style=list("border-bottom"="none")),cbindTable("",out1))
  
  out
}
# N ROW FUNCTION - ALL & BY TREATMENT
summary.N<-function(row.name,treat,treat.levels,subset=NULL,...)
{
  if(!is.null(subset))
  {
    subset<-subset&!is.na(subset)
    treat<-treat[subset]
  }
  
  out1<-cbindTable("N","",length(treat))
  
  if(any(!is.na(treat)))
    out2<-cbindTable("",cbindVector(table(factor(treat,treat.levels))))
  
  if(any(!is.na(treat)))
    out1<-cbindTable(out1,out2)
  
  out<-rbindTable(row.title(row.name,Style=list("border-bottom"="none")),cbindTable("",out1))
  
  out
}

# BASELINE CHARACTERISTICS - TABLE FUNCTION
summary.table<-
  function(tabnum,tabtext,basedata,treat,treat.levels=NULL,treat.names=NULL,out.file,footnote=NULL,...)
  {
    if(all(is.na(treat)))
    {
      ExportTable.HTML(
        rbindTable(
          table.title(tabnum,tabtext),
          cbindTable("","","","All")),
        rbindTable(
          do.call(
            "rbindTable",
            lapply(
              basedata,
              function(x,treat,treat.levels)
                if(!is.list(x))
                  row.title(x)
              else {
                if(!is.null(x$fun))
                  do.call(x$fun,c(x,list(treat=treat,treat.levels=treat.levels)))
                else if(!is.null(x$time))
                  do.call("summary.time",c(x,list(treat=treat,treat.levels=treat.levels)))
                else if(!is.null(x$nrow))
                  do.call("summary.N",c(x,list(treat=treat,treat.levels=treat.levels)))
                else if(is.factor(x$x))
                  do.call("summary.cat",c(x,list(treat=treat,treat.levels=treat.levels)))
                else
                  do.call("summary.cts",c(x,list(treat=treat,treat.levels=treat.levels))) },
              treat=treat,treat.levels=treat.levels)),
          end.row(footnote=footnote, disclaimer=T)),
        horiz.fmt,out.file,F,F,T)
    } else
    {
      if(is.null(treat.levels)) treat.levels<-levels(treat)
      if(is.null(treat.names)) treat.names<-levels(treat)
      ExportTable.HTML(
        rbindTable(
          table.title(tabnum,tabtext),
          cbindTable("","","",cbindTable("All","",cbindVector(treat.names)))),
        rbindTable(
          do.call(
            "rbindTable",
            lapply(
              basedata,
              function(x,treat,treat.levels)
                if(!is.list(x))
                  row.title(x)
              else {
                if(!is.null(x$fun))
                  do.call(x$fun,c(x,list(treat=treat,treat.levels=treat.levels)))
                else if(!is.null(x$time))
                  do.call("summary.time",c(x,list(treat=treat,treat.levels=treat.levels)))
                else if(!is.null(x$nrow))
                  do.call("summary.N",c(x,list(treat=treat,treat.levels=treat.levels)))
                else if(is.factor(x$x))
                  do.call("summary.cat",c(x,list(treat=treat,treat.levels=treat.levels)))
                else
                  do.call("summary.cts",c(x,list(treat=treat,treat.levels=treat.levels))) },
              treat=treat,treat.levels=treat.levels)),
          end.row(footnote=footnote, disclaimer=T)),
        horiz.fmt,out.file,F,F,T)
    }
  }
# FIGURE FUNCTIONS
fig.file<-function(fig.num,fig.path)
  paste(fig.path,"/Figure_",gsub("\\.","_",fig.num),".wmf",sep="")

fig.set<-function(fig.num,fig.path=figure.path,height=5,width=6.8)
  win.metafile(fig.file(fig.num,fig.path),height=height,width=width)

fig.tag<-function(fig.num,fig.path=figure.path)
  paste("<img src='",fig.file(fig.num,fig.path),"' alt='Figure ",fig.num,"'>",sep="")

# ANALYSIS - CONTINUOUS OUTCOMES #
analysis.cts<-
  function(xname, blvis, fuvis, moddesc, trans=function(x)x, itrans=function(x)x, digits.summ,...){
    # xname: variable of interest, in quotes (from outcomes), e.g. "saq_summ"
    # blvis: which visit is baseline, i.e. screening is "visit_1"
    # fuvis: which visit is follow-up, e.g. "visit_3" or "visit_4"
    analysis.dat <<- tidyr::pivot_wider(outcomes[,c("sno", "visittypeid", xname)], id_cols=c("sno"), 
                                        names_from=c("visittypeid"), names_prefix="visit_", values_from=c(xname))
    analysis.dat <<- analysis.dat %>% rename(xb=blvis, 
                                            x=fuvis)

    analysis.dat <<- merge(analysis.dat, randomised[, c("sno", "trtgrp", "rdesex", "rdedia", "rdepmi", "rdecadr", "rdelvsd", "site_simple")], 
                          by="sno", all.x=T)
    analysis.dat <<- merge(analysis.dat, screening[, c("sno", "age")], by="sno", all.x=T)
    analysis.dat <<- analysis.dat %>% mutate(chg=x-xb)
    # fits a linear model and summarises treatment effect to fit in with summary.table
    # when no transformation used, only report estimates for original data
    if(trans(10)==10){rbindTable(
      row.title(moddesc,Style=list("border-bottom"="none")),
      cbindTable(
        "",
        row.title("Estimate<br>(95% CI)<br>p-value"),
        "","","",
        list(
          Text=lm.summ(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple, data=analysis.dat),
                       term=2,trans=itrans,ndp=digits.summ),
          Other=list(colspan=length(levels(analysis.dat$trtgrp)),align="center"))))}
    # where a transformation is used, report estimates from the original data and transformed data
    else{rbindTable(
      row.title(moddesc,Style=list("border-bottom"="none")),
      cbindTable(
        "",
        row.title("Original data<br>Estimate<br>(95% CI)<br>p-value"),
        "","","",
        list(
          Text=lm.summ(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple, data=analysis.dat),
                       term=2,ndp=digits.summ),
          Other=list(colspan=length(levels(analysis.dat$trtgrp)),align="center"))),
      cbindTable(
        "",
        row.title("Transformation applied<br>Estimate<br>(95% CI)<br>p-value"),
        "","","",
        list(
          Text=lm.summ(lm(trans(x)~trtgrp+trans(xb)+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple, data=analysis.dat),
                       term=2,trans=itrans,ndp=digits.summ),
          Other=list(colspan=length(levels(analysis.dat$trtgrp)),align="center"))))}
  }
# summarise linear model with covars as descrfibed in SAP
analysis.cts.txt <- function(xname, blvis, fuvis, trans=function(x)x, itrans=function(x)x, digits.summ,...){
  # xname: variable of interest, in quotes (from outcomes), e.g. "saq_summ"
  # blvis: which visit is baseline, i.e. screening is "visit_1"
  # fuvis: which visit is follow-up, e.g. "visit_3" or "visit_4"
  analysis.dat <<- tidyr::pivot_wider(outcomes[,c("sno", "visittypeid", xname)], id_cols=c("sno"), 
                                      names_from=c("visittypeid"), names_prefix="visit_", values_from=c(xname))
  analysis.dat <<- analysis.dat %>% rename(xb=blvis, 
                                           x=fuvis)
  
  analysis.dat <<- merge(analysis.dat, randomised[, c("sno", "trtgrp", "rdesex", "rdedia", "rdepmi", "rdecadr", "rdelvsd", "site_simple")], 
                         by="sno", all.x=T)
  analysis.dat <<- merge(analysis.dat, screening[, c("sno", "age")], by="sno", all.x=T)
  analysis.dat <<- analysis.dat %>% mutate(chg=x-xb)
  
  out <- oth.lm.summ(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple, data=analysis.dat),
          term=2,trans=itrans,ndp=digits.summ, asTable=F)
  out
}
# summarise linear model adjusted for treatment and baseline value only
analysis.cts.txt.simple <- function(xname, blvis, fuvis, trans=function(x)x, itrans=function(x)x, digits.summ,...){
  # xname: variable of interest, in quotes (from outcomes), e.g. "saq_summ"
  # blvis: which visit is baseline, i.e. screening is "visit_1"
  # fuvis: which visit is follow-up, e.g. "visit_3" or "visit_4"
  analysis.dat <<- tidyr::pivot_wider(outcomes[,c("sno", "visittypeid", xname)], id_cols=c("sno"), 
                                      names_from=c("visittypeid"), names_prefix="visit_", values_from=c(xname))
  analysis.dat <<- analysis.dat %>% rename(xb=blvis, 
                                           x=fuvis)
  
  analysis.dat <<- merge(analysis.dat, randomised[, c("sno", "trtgrp", "rdesex", "rdedia", "rdepmi", "rdecadr", "rdelvsd", "site_simple")], 
                         by="sno", all.x=T)
  analysis.dat <<- merge(analysis.dat, screening[, c("sno", "age")], by="sno", all.x=T)
  analysis.dat <<- analysis.dat %>% mutate(chg=x-xb)
  
  out <- oth.lm.summ(lm(x~trtgrp+xb, data=analysis.dat),
                     term=2,trans=itrans,ndp=digits.summ, asTable=F)
  out
}

# function for continuous outcome summary table
# baseline and follow-up values of variable, fit model and show results
# export diagnostic plots to check if transformations are needed
cts.out.tab <- function(tabnum, tabtext, xname, blvis, fuvis,
                        vardesc, moddesc, treat=analysis.dat$trtgrp, 
                        digits=1, digits.summ=2,
                        outfile=tables.file, diagsfile=diags.file, 
                        trans=function(x){x},
                        itrans=function(x){x}){
  analysis.dat <<- tidyr::pivot_wider(outcomes[,c("sno", "visittypeid", xname)], id_cols=c("sno"), 
                                      names_from=c("visittypeid"), names_prefix="visit_", values_from=c(xname))
  analysis.dat <<- analysis.dat %>% rename(xb=blvis, 
                                           x=fuvis)
  
  analysis.dat <<- merge(analysis.dat, randomised[, c("sno", "trtgrp", "rdesex", "rdedia", "rdepmi", "rdecadr", "rdelvsd", "site_simple")], 
                         by="sno")
  analysis.dat <<- merge(analysis.dat, screening[, c("sno", "age")], by="sno", all.x=T)
  analysis.dat <<- analysis.dat %>% mutate(chg=x-xb)
  
  summary.table(
    tabnum,
    tabtext,
    basedata=list(
      list(x=analysis.dat$sno,row.name="N Randomised",nrow=T),
      list(x=analysis.dat$xb,row.name=paste0("Baseline ", vardesc),ndp=digits),
      list(x=analysis.dat$sno,row.name="N with follow-up data",nrow=T,subset=!is.na(analysis.dat$x)),
      list(x=analysis.dat$x,row.name=paste0("Follow-up ", vardesc),ndp=digits,subset=!is.na(analysis.dat$x)),
      list(x=analysis.dat$chg,row.name=paste0("Change in ", vardesc),ndp=digits,subset=!is.na(analysis.dat$x)),
      list(
        fun="analysis.cts",xname, blvis, fuvis, moddesc,trans,itrans,digits.summ,
        desc=
          paste(moddesc))
      ),
    treat=analysis.dat$trtgrp,
    out.file=outfile)
  
  # diagnostics
  if(trans(10)==10){
    diag.plot.file1 <- paste0(diags.path,paste0("/Figure ", tabnum, ".1.jpg"))
    jpeg(diag.plot.file1,width=18,height=14,units="cm",quality=100,res=72)
    qqnorm(resid(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)))
    qqline(resid(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)))
    dev.off()
    
    temp<-
      list(
        head=as.Table(figure.title(tabnum=paste0(tabnum, ".1"), tabtext=paste("Normal QQ plot for", vardesc, "model residuals: Original data"))),
        body=
          rbindTable(
            paste0("<img src='",
                   diag.plot.file1, "'>"),
            end.row(disclaimer=T)))
    ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
    
    
    diag.plot.file2 <- paste0(diags.path,paste0("/Figure ", tabnum, ".2.jpg"))
    jpeg(diag.plot.file2,width=18,height=14,units="cm",quality=100,res=72)
    plot(predict(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)),
         residuals(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)),
         xlab="predicted values", ylab="residual values")
    dev.off()

    temp<-
      list(
        head=as.Table(figure.title(paste0(tabnum, ".2"), tabtext=paste("Residuals vs fitted values for", vardesc, "original data"))),
        body=
          rbindTable(
            paste0("<img src='",
                   diag.plot.file2, "'>"),
            end.row(disclaimer=T)))
    ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
  }
  else{
    # diagnostics for original data
    diag.plot.file3 <- paste0(diags.path,paste0("/Figure ", tabnum, ".1.1.jpg"))
    jpeg(diag.plot.file3,width=18,height=14,units="cm",quality=100,res=72)
    qqnorm(resid(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)))
    qqline(resid(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)))
    dev.off()

    temp<-
      list(
        head=as.Table(figure.title(tabnum=paste0(tabnum, ".1.1"), tabtext=paste("Normal QQ plot for", vardesc, "model residuals: original data"))),
        body=
          rbindTable(
            paste0("<img src='",
                   diag.plot.file3, "'>"),
            end.row(disclaimer=T)))
    ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)


    diag.plot.file4 <- paste0(diags.path,paste0("/Figure ", tabnum, ".1.2.jpg"))
    jpeg(diag.plot.file4,width=18,height=14,units="cm",quality=100,res=72)
    plot(predict(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)),
         residuals(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)),
         xlab="predicted values", ylab="residual values")
    dev.off()

    temp<-
      list(
        head=as.Table(figure.title(paste0(tabnum, ".1.2"), tabtext=paste("Residuals vs fitted values for", vardesc, "original data"))),
        body=
          rbindTable(
            paste0("<img src='",
                   diag.plot.file4, "'>"),
            end.row(disclaimer=T)))
    ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)

    # diagnostics for transformed data
    diag.plot.file5 <- paste0(diags.path,paste0("/Figure ", tabnum, ".2.1.jpg"))
    jpeg(diag.plot.file5,width=18,height=14,units="cm",quality=100,res=72)
    qqnorm(resid(lm(trans(x)~trtgrp+trans(xb)+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)))
    qqline(resid(lm(trans(x)~trtgrp+trans(xb)+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)))
    dev.off()

    temp<-
      list(
        head=as.Table(figure.title(tabnum=paste0(tabnum, ".2.1"), tabtext=paste("Normal QQ plot for", vardesc, "model residuals: transformed data"))),
        body=
          rbindTable(
            paste0("<img src='",
                   diag.plot.file5, "'>"),
            end.row(disclaimer=T)))
    ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)


    diag.plot.file6 <- paste0(diags.path,paste0("/Figure ", tabnum, ".2.2.jpg"))
    jpeg(diag.plot.file6,width=18,height=14,units="cm",quality=100,res=72)
    plot(predict(lm(trans(x)~trtgrp+trans(xb)+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)),
         residuals(lm(trans(x)~trtgrp+trans(xb)+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)),
         xlab="predicted values", ylab="residual values")
    dev.off()

    temp<-
      list(
        head=as.Table(figure.title(paste0(tabnum, ".2.2"), tabtext=paste("Residuals vs fitted values for", vardesc, "transformed data"))),
        body=
          rbindTable(
            paste0("<img src='",
                   diag.plot.file6, "'>"),
            end.row(disclaimer=T)))
    ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)

  }

  
}

# snippet to run just diagnostics (useful if reporting multiple models in one table)
analysis.cts.diags <- function(xname, blvis, fuvis, tabnum, vardesc, trans=function(x)x, diagsfile){
  analysis.dat <<- tidyr::pivot_wider(outcomes[,c("sno", "visittypeid", xname)], id_cols=c("sno"), 
                                      names_from=c("visittypeid"), names_prefix="visit_", values_from=c(xname))
  analysis.dat <<- analysis.dat %>% rename(xb=blvis, 
                                           x=fuvis)
  analysis.dat <<- merge(analysis.dat, randomised[, c("sno", "trtgrp", "rdesex", "rdedia", "rdepmi", "rdecadr", "rdelvsd", "site_simple")], 
                         by="sno")
  analysis.dat <<- merge(analysis.dat, screening[, c("sno", "age")], by="sno", all.x=T)
  analysis.dat <<- analysis.dat %>% mutate(chg=x-xb)
  
  # diagnostics
  if(trans(10)==10){
    diag.plot.file1 <- paste0(diags.path,paste0("/Figure ", tabnum, ".1.jpg"))
    jpeg(diag.plot.file1,width=18,height=14,units="cm",quality=100,res=72)
    qqnorm(resid(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)))
    qqline(resid(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)))
    dev.off()
    
    temp<-
      list(
        head=as.Table(figure.title(tabnum=paste0(tabnum, ".1"), tabtext=paste("Normal QQ plot for", vardesc, "model residuals: Original data"))),
        body=
          rbindTable(
            paste0("<img src='",
                   diag.plot.file1, "'>"),
            end.row(disclaimer=T)))
    ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
    
    
    diag.plot.file2 <- paste0(diags.path,paste0("/Figure ", tabnum, ".2.jpg"))
    jpeg(diag.plot.file2,width=18,height=14,units="cm",quality=100,res=72)
    plot(predict(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)),
         residuals(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)),
         xlab="predicted values", ylab="residual values")
    dev.off()
    
    temp<-
      list(
        head=as.Table(figure.title(paste0(tabnum, ".2"), tabtext=paste("Residuals vs fitted values for", vardesc, "original data"))),
        body=
          rbindTable(
            paste0("<img src='",
                   diag.plot.file2, "'>"),
            end.row(disclaimer=T)))
    ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
  }
  else{
    # diagnostics for original data
    diag.plot.file3 <- paste0(diags.path,paste0("/Figure ", tabnum, ".1.1.jpg"))
    jpeg(diag.plot.file3,width=18,height=14,units="cm",quality=100,res=72)
    qqnorm(resid(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)))
    qqline(resid(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)))
    dev.off()
    
    temp<-
      list(
        head=as.Table(figure.title(tabnum=paste0(tabnum, ".1.1"), tabtext=paste("Normal QQ plot for", vardesc, "model residuals: original data"))),
        body=
          rbindTable(
            paste0("<img src='",
                   diag.plot.file3, "'>"),
            end.row(disclaimer=T)))
    ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
    
    
    diag.plot.file4 <- paste0(diags.path,paste0("/Figure ", tabnum, ".1.2.jpg"))
    jpeg(diag.plot.file4,width=18,height=14,units="cm",quality=100,res=72)
    plot(predict(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)),
         residuals(lm(x~trtgrp+xb+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)),
         xlab="predicted values", ylab="residual values")
    dev.off()
    
    temp<-
      list(
        head=as.Table(figure.title(paste0(tabnum, ".1.2"), tabtext=paste("Residuals vs fitted values for", vardesc, "original data"))),
        body=
          rbindTable(
            paste0("<img src='",
                   diag.plot.file4, "'>"),
            end.row(disclaimer=T)))
    ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
    
    # diagnostics for transformed data
    diag.plot.file5 <- paste0(diags.path,paste0("/Figure ", tabnum, ".2.1.jpg"))
    jpeg(diag.plot.file5,width=18,height=14,units="cm",quality=100,res=72)
    qqnorm(resid(lm(trans(x)~trtgrp+trans(xb)+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)))
    qqline(resid(lm(trans(x)~trtgrp+trans(xb)+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)))
    dev.off()
    
    temp<-
      list(
        head=as.Table(figure.title(tabnum=paste0(tabnum, ".2.1"), tabtext=paste("Normal QQ plot for", vardesc, "model residuals: transformed data"))),
        body=
          rbindTable(
            paste0("<img src='",
                   diag.plot.file5, "'>"),
            end.row(disclaimer=T)))
    ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
    
    
    diag.plot.file6 <- paste0(diags.path,paste0("/Figure ", tabnum, ".2.2.jpg"))
    jpeg(diag.plot.file6,width=18,height=14,units="cm",quality=100,res=72)
    plot(predict(lm(trans(x)~trtgrp+trans(xb)+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)),
         residuals(lm(trans(x)~trtgrp+trans(xb)+rdesex+age+rdedia+rdepmi+rdecadr+rdelvsd+site_simple,data=analysis.dat,na.action=na.omit)),
         xlab="predicted values", ylab="residual values")
    dev.off()
    
    temp<-
      list(
        head=as.Table(figure.title(paste0(tabnum, ".2.2"), tabtext=paste("Residuals vs fitted values for", vardesc, "transformed data"))),
        body=
          rbindTable(
            paste0("<img src='",
                   diag.plot.file6, "'>"),
            end.row(disclaimer=T)))
    ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
    
  }
}

# generate diagnostics for a linear model
lm.diags <- function(fit, vardesc, diagsfile, tabnum){
  # diagnostics
  diag.plot.file1 <- paste0(diags.path,paste0("/Figure ", tabnum, ".1.jpg"))
  jpeg(diag.plot.file1,width=18,height=14,units="cm",quality=100,res=72)
  qqnorm(resid(fit))
  qqline(resid(fit))
  dev.off()
  
  temp<-
    list(
      head=as.Table(figure.title(tabnum=paste0(tabnum, ".1"), tabtext=paste("Normal QQ plot for", vardesc, "model residuals: Original data"))),
      body=
        rbindTable(
          paste0("<img src='",
                 diag.plot.file1, "'>"),
          end.row(disclaimer=T)))
  ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
  
  
  diag.plot.file2 <- paste0(diags.path,paste0("/Figure ", tabnum, ".2.jpg"))
  jpeg(diag.plot.file2,width=18,height=14,units="cm",quality=100,res=72)
  plot(predict(fit),
       residuals(fit),
       xlab="predicted values", ylab="residual values")
  dev.off()
  
  temp<-
    list(
      head=as.Table(figure.title(paste0(tabnum, ".2"), tabtext=paste("Residuals vs fitted values for", vardesc, "original data"))),
      body=
        rbindTable(
          paste0("<img src='",
                 diag.plot.file2, "'>"),
          end.row(disclaimer=T)))
  ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
}

# analysis function: logistic regression
analysis.logistic <- function(xname, blvis, fuvis, vardesc, digits.summ){
  analysis.dat <<- tidyr::pivot_wider(outcomes[,c("sno", "visittypeid", xname)], id_cols=c("sno"), 
                                      names_from=c("visittypeid"), names_prefix="visit_", values_from=c(xname))
  analysis.dat <<- analysis.dat %>% rename(xb=blvis, 
                                           x=fuvis)
  
  analysis.dat <<- merge(analysis.dat, randomised[, c("sno", "trtgrp", "rdesex", "rdedia", "rdepmi", "rdecadr", "rdelvsd", "site_simple")], 
                         by="sno", all.x=T)
  analysis.dat <<- merge(analysis.dat, screening[, c("sno", "age")], by="sno", all.x=T)
  
  logistic_mod <<- glm(formula=x ~ trtgrp  + xb + age + rdesex + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                      family=binomial(link="logit"), data=analysis.dat)
  
  cbindTable("Treatment group", paste(levels(analysis.dat$trtgrp), collapse="<br>"), 
             paste(c("Reference category", 
                     oth.lm.summ_norm(logistic_mod, term=2, ndp=digits.summ, asTable=F, trans=function(x)exp(x)))))
}

# diagnostics from a logistic regression
analysis.logistic.diags <- function(xname, blvis, fuvis, vardesc, tabnum, diagsfile){
  analysis.dat <<- tidyr::pivot_wider(outcomes[,c("sno", "visittypeid", xname)], id_cols=c("sno"), 
                                      names_from=c("visittypeid"), names_prefix="visit_", values_from=c(xname))
  analysis.dat <<- analysis.dat %>% rename(xb=blvis, 
                                           x=fuvis)
  
  analysis.dat <<- merge(analysis.dat, randomised[, c("sno", "trtgrp", "rdesex", "rdedia", "rdepmi", "rdecadr", "rdelvsd", "site_simple")], 
                         by="sno", all.x=T)
  analysis.dat <<- merge(analysis.dat, screening[, c("sno", "age")], by="sno", all.x=T)
  
  logistic_mod <<- glm(formula=x ~ trtgrp  + xb + age + rdesex + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                       family=binomial(link="logit"), data=analysis.dat)
  
  residual_plots <- residualPlots(logistic_mod, layout=c(4,3))
  residual_plots_p <- ifelse(residual_plots=="No possible lack-of-fit tests", 
                             "No possible lack-of-fit tests", 
                             p.format(residualPlots(logistic_mod, ask=F)[1,2]))
  
  fig.set(fig.num=paste0(tabnum,".1"), fig.path=diags.path)
  residualPlots(logistic_mod, ask=F, layout=c(4,3))
  dev.off()
  
  fig.set(fig.num=paste0(tabnum,".2"), fig.path=diags.path)
  marginalModelPlots(logistic_mod)
  dev.off()
  
  vifs <- vif(logistic_mod)
  
  temp<-
    list(
      head=as.Table(figure.title(tabnum=paste0(tabnum, ".1"), tabtext=paste("Residual plots for", vardesc, "logistic regression"))),
      body=
        rbindTable(
          fig.tag(fig.num=paste0(tabnum,".1"), fig.path=diags.path),
          end.row(disclaimer=T)))
  ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
  
  temp<-
    list(
      head=as.Table(figure.title(tabnum=paste0(tabnum, ".2"), tabtext=paste("Marginal model plots for", vardesc, "logistic regression"))),
      body=
        rbindTable(
          fig.tag(fig.num=paste0(tabnum,".2"), fig.path=diags.path),
          end.row(disclaimer=T)))
  ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
  
  temp <- 
    list(head=rbindTable(paste("<b>Table", paste0(tabnum, ".3:", vardesc), "lack of fit p-values and VIF p-values.</b>")), 
         body=rbindTable(cbindTable(paste("Lack of fit:", residual_plots_p)), 
                         cbindTable(paste("VIF values:", paste(as.numeric(vifs), collapse=", "))), 
                         end.row(disclaimer=T))
    )
  ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
  
}

# alternate function to  get diagnostics from a logistic regression
logistic.diags <- function(fit, tabnum, diagsfile, desc){
  residual_plots <- (residualPlots(fit))
  residual_plots_p <- ifelse(residual_plots=="No possible lack-of-fit tests", 
                             "No possible lack-of-fit tests", 
                             p.format(residualPlots(fit)[1,2]))
  
  fig.set(fig.num=paste0(tabnum,".1"), fig.path=diags.path)
  residualPlots(fit)
  dev.off()
  
  fig.set(fig.num=paste0(tabnum,".2"), fig.path=diags.path)
  marginalModelPlots(fit)
  dev.off()
  
  vifs <- vif(fit)
  
  temp<-
    list(
      head=as.Table(figure.title(tabnum=paste0(tabnum, ".1"), tabtext=paste("Residual plots for", desc, "logistic regression"))),
      body=
        rbindTable(
          fig.tag(fig.num=paste0(tabnum,".1"), fig.path=diags.path),
          end.row(disclaimer=T)))
  ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
  
  temp<-
    list(
      head=as.Table(figure.title(tabnum=paste0(tabnum, ".2"), tabtext=paste("Marginal model plots for", desc, "logistic regression"))),
      body=
        rbindTable(
          fig.tag(fig.num=paste0(tabnum,".2"), fig.path=diags.path),
          end.row(disclaimer=T)))
  ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
  
  temp <- 
    list(head=rbindTable(paste("<b>Table", paste0(tabnum, ".3:"), "lack of fit p-values and VIF p-values.</b>")), 
         body=rbindTable(cbindTable(paste("Lack of fit:", residual_plots_p)), 
                         cbindTable(paste("VIF values:", paste(as.numeric(vifs), collapse=", "))), 
                         end.row(disclaimer=T))
    )
  ExportTable.HTML(temp$head,temp$body,horiz.fmt,diagsfile,F,F,T)
  
  
}

# LISTINGS FUNCTION
ae.listing.type1<-
  function(
    ae.data,ae.vars,ae.factors,
    link.by,link.data,link.vars,link.factors,
    all.titles,
    order.by,
    blocks.per.page=8,block.fun,
    listnum,list.title,
    out.fmt,out.file,footnote=NULL)
  {
    dataset<-
      data.frame(link.data[match(ae.data[,link.by],link.data[,link.by]),link.vars],ae.data[,ae.vars[ae.vars!=link.by]])
    dataset<-
      dataset[do.call("order",dataset[,order.by]),]
    
    if(!nrow(dataset))
    {
      ExportTable.HTML(
        rbindTable(
          row.title(
            paste(paste("<b>Listing ",listnum," (Page 1 of 1): ",sep=""),list.title,"</b>",sep=""),
            Style=list("border-top"="solid windowtext 1pt"))),
        rbindTable(
          row.title("No events of this type were observed"),
          end.row()),
        out.fmt,out.file,F,F,T)
      return(NULL)
    }
    
    dataset<-
      data.frame(obs=1:nrow(dataset),dataset)
    
    if(!is.null(link.factors))
      for(i in 1:length(link.factors))
        dataset[,link.factors[[i]]$var.name]<-
      factor(dataset[,link.factors[[i]]$var.name],link.factors[[i]]$levels,link.factors[[i]]$labels,exclude=NULL)
    
    if(!is.null(ae.factors))
      for(i in 1:length(ae.factors))
        dataset[,ae.factors[[i]]$var.name]<-
      factor(dataset[,ae.factors[[i]]$var.name],ae.factors[[i]]$levels,ae.factors[[i]]$labels,exclude=NULL)
    
    dataset<-
      as.data.frame(
        lapply(dataset,function(x)ifelse(is.na(x),"-",as.character(x))),
        stringsAsFactors=F)
    
    n<-ceiling(nrow(dataset)/blocks.per.page)
    
    for(i in 1:n)
    {
      cat("Page ",i,"\n")
      ExportTable.HTML(
        rbindTable(
          row.title(
            paste(paste("<b>Listing ",listnum," (Page ",i," of ",n,"): ",sep=""),list.title,"</b>",sep=""),
            Style=list("border-top"="solid windowtext 1pt")),
          all.titles),
        rbindTable(
          do.call(
            "rbindTable",
            lapply(
              ((i-1)*blocks.per.page+1):min(c(i*blocks.per.page,nrow(dataset))),
              function(j,use.data,use.fun)
                do.call("use.fun",as.list(use.data[j,])),
              use.data=dataset,
              use.fun=block.fun)),
          end.row(footnote=footnote)),
        out.fmt,out.file,F,F,T)
    }
  }

# REPLACE SPACES IN TEXT WITH NON-BREAKING SPACES
nospace<-function(x)gsub(" ","&nbsp;",x)

# AE/CONMED TABLES
safety.row<-function(safety.id,safety.subset,safety.treat,safety.name1,safety.class2=NULL,pop.id,pop.treat,treat.levels,do.treat,type="Event")
{
  safety.subset<-!is.na(safety.subset)&safety.subset
  safety.id<-safety.id[safety.subset]
  safety.treat<-factor(safety.treat[safety.subset],treat.levels)
  safety.class2<-safety.class2[safety.subset]
  
  if(do.treat)
  {
    if(is.null(safety.class2))
      rbindTable(
        row.title(casefold(safety.name1,upper=T),Style=list("border-bottom"="none")),
        cbindTable(
          "",
          list(Text=casefold(paste("Any",type),upper=F),Other=list(align="right")),
          {
            N<-length(pop.id)
            safetyN<-sum(table(factor(safety.id,pop.id),exclude=NA)>0)
            paste(safetyN," (",my.format(100*safetyN/N,1),"%)",sep="")
          },
          "",
          {
            N<-table(pop.treat,exclude=NA)
            safetyN<-apply(table(safety.treat,factor(safety.id,pop.id),exclude=NA)>0,1,sum)
            cbindVector(paste(safetyN," (",my.format(100*safetyN/N,1),"%)",sep=""))
          }))
    else
      rbindTable(
        row.title(casefold(safety.name1,upper=T),Style=list("border-bottom"="none")),
        cbindTable(
          list(Text="",Style=list("border-bottom"="none")),
          list(Text=casefold(paste("Any",type),upper=F),Other=list(align="right"),Style=list("border-bottom"="none")),
          {
            N<-length(pop.id)
            safetyN<-sum(table(factor(safety.id,pop.id),exclude=NA)>0)
            list(Text=paste(safetyN," (",my.format(100*safetyN/N,1),"%)",sep=""),Style=list("border-bottom"="none"))
          },
          list(Text="",Style=list("border-bottom"="none")),
          {
            N<-table(pop.treat,exclude=NA)
            safetyN<-apply(table(safety.treat,factor(safety.id,pop.id),exclude=NA)>0,1,sum)
            cbindVector(paste(safetyN," (",my.format(100*safetyN/N,1),"%)",sep=""),Style=list("border-bottom"="none"))
          }),
        cbindTable(
          "",
          list(Text=sort(unique(as.character(safety.class2))),Other=list(align="right")),
          {
            N<-length(pop.id)
            safetyN<-apply(table(as.character(safety.class2),factor(safety.id,pop.id),exclude=NA)>0,1,sum)
            paste(safetyN," (",my.format(100*safetyN/N,1),"%)",sep="")
          },
          "",
          {
            N<-table(pop.treat,exclude=NA)
            safetyN<-apply(table(safety.treat,as.character(safety.class2),factor(safety.id,pop.id),exclude=NA)>0,1:2,sum)
            cbindVector(
              c(
                apply(
                  matrix(
                    paste(
                      safetyN," (",my.format(100*apply(safetyN,2,function(x,N)x/N,N=N),1),"%)",
                      sep=""),
                    nr=length(treat.levels)),
                  1,paste,collapse="<br>")))
          }))
    
  }
  
  else
  {
    if(is.null(safety.class2))
      rbindTable(
        row.title(casefold(safety.name1,upper=T),Style=list("border-bottom"="none")),
        cbindTable(
          "",
          list(Text=casefold(paste("Any",type),upper=F),Other=list(align="right")),
          {
            N<-length(pop.id)
            safetyN<-sum(table(factor(safety.id,pop.id),exclude=NA)>0)
            paste(safetyN," (",my.format(100*safetyN/N,1),"%)",sep="")
          }))
    else
      rbindTable(
        row.title(casefold(safety.name1,upper=T),Style=list("border-bottom"="none")),
        cbindTable(
          list(Text="",Style=list("border-bottom"="none")),
          list(Text=casefold(paste("Any",type),upper=F),Other=list(align="right"),Style=list("border-bottom"="none")),
          {
            N<-length(pop.id)
            safetyN<-sum(table(factor(safety.id,pop.id),exclude=NA)>0)
            list(Text=paste(safetyN," (",my.format(100*safetyN/N,1),"%)",sep=""),Style=list("border-bottom"="none"))
          }),
        cbindTable(
          "",
          list(Text=sort(unique(as.character(safety.class2))),Other=list(align="right")),
          {
            N<-length(pop.id)
            safetyN<-apply(table(as.character(safety.class2),factor(safety.id,pop.id),exclude=NA)>0,1,sum)
            paste(safetyN," (",my.format(100*safetyN/N,1),"%)",sep="")
          }))
  }
  
}

safety.table<-
  function(
    tabnum,tabtext,
    safety.id,safety.subset=NULL,safety.treat,safety.class1,safety.class2,
    pop.id,pop.subset=NULL,pop.treat,treat.levels,treat.names,type="Event",out.file)
  {
    do.treat<-!all(is.na(pop.treat))
    
    if(!is.null(pop.subset))
    {
      pop.subset<-!is.na(pop.subset)&pop.subset
      pop.id<-pop.id[pop.subset]
      pop.treat<-factor(pop.treat[pop.subset],treat.levels)
    }
    
    if(is.null(safety.subset))
      safety.subset<-rep(T,length(safety.id))
    
    if(sum(safety.subset,na.rm=T)) 
      ExportTable.HTML(
        rbindTable(
          table.title(tabnum,tabtext),
          if(do.treat)
            cbindTable(
              "","",
              rbindTable(
                cbindTable(
                  paste("All<br>(N=",length(pop.id),")",sep=""),"",
                  rbindTable("Treatment",cbindVector(paste(treat.names,"<br>(N=",table(pop.treat),")",sep="")))),
                cbindVector(c("N (%)","",rep("N (%)",length(treat.names))))))
          else
            cbindTable("","",paste("All<br>(N=",length(pop.id),")",sep=""))),
        rbindTable(
          safety.row(safety.id,safety.subset,safety.treat,paste("Any",type),NULL,pop.id,pop.treat,treat.levels,do.treat,type),
          do.call(
            "rbindTable",
            by(
              data.frame(
                safety.id=safety.id,
                safety.subset=safety.subset,
                safety.treat=safety.treat,
                safety.class1=safety.class1,
                safety.class2=safety.class2)[safety.subset,],
              as.character(safety.class1[safety.subset]),
              function(x,pop.id,pop.subset,pop.treat,treat.levels,treat.names,do.treat,type)
                safety.row(
                  x$safety.id,
                  x$safety.subset,
                  x$safety.treat,
                  as.character(x$safety.class1)[1],
                  x$safety.class2,
                  pop.id,
                  pop.treat,
                  treat.levels,
                  do.treat,
                  type),
              pop.id=pop.id,pop.subset=pop.subset,
              pop.treat=pop.treat,treat.levels=treat.levels,treat.names=treat.names,
              do.treat=do.treat,type=type)),
          end.row()),
        horiz.fmt,out.file,F,F,T) else
          ExportTable.HTML(
            rbindTable(
              table.title(tabnum,tabtext),
              if(do.treat)
                cbindTable(
                  "","",
                  rbindTable(
                    cbindTable(
                      paste("All<br>(N=",length(pop.id),")",sep=""),"",
                      rbindTable("Treatment",cbindVector(paste(treat.names,"<br>(N=",table(pop.treat),")",sep="")))),
                    cbindTable("N (%)","","N (%)","N( %)")))
              else
                cbindTable("","",paste("All<br>(N=",length(pop.id),")",sep=""))),
            rbindTable(
              row.title(paste("No ",type,"s of this type observed",sep=""),anyOther=list(colspan=6)),
              end.row()),
            horiz.fmt,out.file,F,F,T)
  }

# DEFINE FACTOR VARIABLE AS CHANGES OVER TIME

factor.change<-function(x.from,x.to)
{
  temp<-paste("'",x.from,"' to '",x.to,"'",sep="")
  temp[is.na(x.from)|is.na(x.to)]<-NA
  temp<-factor(temp,apply(expand.grid(levels(x.to),levels(x.from)),1,function(x)paste("'",x[2],"' to '",x[1],"'",sep="")))
  factor(temp,levels(temp)[is.element(levels(temp),temp)])
}

factor.change2<-function(x.from,x.to)
{
  temp<-paste("'",x.from,"' to '",x.to,"'",sep="")
  temp[is.na(x.from)|is.na(x.to)]<-NA
  temp<-factor(temp,apply(expand.grid(levels(x.to),levels(x.from)),1,function(x)paste("'",x[2],"' to '",x[1],"'",sep="")))
  factor(temp,levels(temp))
}

# EXTRACT EFFECT ESTIMATE FROM GLM: use either normal or t distribution as required
lm.summ_norm<-function(fit,term,trans=function(x)x,ndp=2)
{
  temp<-summary(fit)$coefficients[term,,drop=F]
  est<-my.format(trans(temp[,1]),ndp)
  lcl<-my.format(trans(temp[,1]+qnorm(0.025)*temp[,2]),ndp)
  ucl<-my.format(trans(temp[,1]+qnorm(0.975)*temp[,2]),ndp)
  p.val<-p.format(2*pnorm(-abs(temp[,3])))

  paste(est,"<br>(",lcl,", ",ucl,")<br>",p.val,sep="")
}
lm.summ<-function(fit,term,trans=function(x)x,ndp=2)
{
  temp<-summary(fit)$coefficients[term,,drop=F]
  est<-my.format(trans(temp[,1]),ndp)
  lcl<-my.format(trans(temp[,1]+qt(p=0.025, df=fit$df.residual)*temp[,2]),ndp)
  ucl<-my.format(trans(temp[,1]+qt(p=0.975, df=fit$df.residual)*temp[,2]),ndp)
  p.val<-p.format(2*pt(q=-abs(temp[,3]), df=fit$df.residual))
  
  paste(est,"<br>(",lcl,", ",ucl,")<br>",p.val,sep="")
}
# different output format
oth.lm.summ_norm<-function(fit,term,trans=function(x)x,ndp=2,asTable=T){
  temp<-summary(fit)$coefficients[term,,drop=F]
  est<-my.format(trans(temp[,1]),ndp)
  lcl<-my.format(trans(temp[,1]+qnorm(0.025)*temp[,2]),ndp)
  ucl<-my.format(trans(temp[,1]+qnorm(0.975)*temp[,2]),ndp)
  p.val<-p.format(2*pnorm(-abs(temp[,3])))

  if(asTable)
    cbindTable(paste(est," (",lcl,", ",ucl,")",sep=""),p.val)
  else
    paste(est," (",lcl,", ",ucl,"), ",p.val,sep="")
}

oth.lm.summ<-function(fit,term,trans=function(x)x,ndp=2,asTable=T)
{
  temp<-summary(fit)$coefficients[term,,drop=F]
  est<-my.format(trans(temp[,1]),ndp)
  lcl<-my.format(trans(temp[,1]+qt(p=0.025, df=fit$df.residual)*temp[,2]),ndp)
  ucl<-my.format(trans(temp[,1]+qt(p=0.975, df=fit$df.residual)*temp[,2]),ndp)
  p.val<-p.format(2*pt(q=-abs(temp[,3]), df=fit$df.residual))
  
  if(asTable)
         cbindTable(paste(est," (",lcl,", ",ucl,")",sep=""),p.val)
       else
         paste(est," (",lcl,", ",ucl,"), ",p.val,sep="")
}
# summary from Cox model
cph.summ <- function(fit,term,trans=exp,ndp=2,asTable=T)
{
  temp<-summary(fit)$coefficients[term,,drop=F]
  est<-my.format(trans(temp[,1]),ndp)
  lcl<-my.format(trans(temp[,1]+qnorm(0.025)*temp[,3]),ndp)
  ucl<-my.format(trans(temp[,1]+qnorm(0.975)*temp[,3]),ndp)
  p.val<-p.format(temp[,5])
  
  if(asTable)
    cbindTable(paste(est," (",lcl,", ",ucl,")",sep=""),p.val)
  else
    paste(est,"<br>(",lcl,", ",ucl,")<br>",p.val,sep="")
}
# quick summary of correlation between 2 variables
corr.out <- function(data, var1, var2, digits){
  npair <- nrow(data[!is.na(var1) & !is.na(var2),])
  test <- cor.test(var1, var2, use="complete.obs")
  est <- my.format(as.numeric(test$estimate), ndp=digits)
  lcl <- my.format(test$conf.int[1], ndp=digits)
  ucl <- my.format(test$conf.int[2], ndp=digits)
  pval <- p.format(test$p.value)
  out <- paste0(npair, "<br>", est, "<br>(", lcl, ", ", ucl, ")<br>", pval)
  out
}

# ffun, skew, pfun, modified from Martina Messow
ffun <- function(x){
  paste("%.", x, "f", sep="")
}
skew <- function(xmiss){
  x <- na.omit(xmiss)
  n <- length(x)
  mux <- mean(x)
  sk <- (n/((n-1)*(n-2)))*sum(((x-mux)/sd(x))^3)
  return(sk)
}
# calculate a p-value for difference between variables
pfun <- function(varname, split, data){
  #browser()
  if(inherits(data[, varname], "numeric") | inherits(data[, varname], "integer")){
    if(all(abs(as.numeric(by(data[, varname], data[, split], skew)))<=1))
      out <- paste("AOV:", p.format(summary(aov(data[, varname]~data[, split]))[[1]][1,5]))
    if(any(abs(as.numeric(by(data[, varname], data[, split], skew)))>1))
      out <- paste("KW:", p.format(kruskal.test(data[,varname],data[,split])$p.value))
  }
  if(inherits(data[, varname], "factor")){
    test <- try(fisher.test(data[, varname],data[, split], simulate.p.value=F), silent=TRUE)
    if(!inherits(test, "try-error"))
      out <- paste("F:", p.format(test$p.value))
    if(inherits(test, "try-error")){
      test <- chisq.test(data[, varname],data[, split])
      out <- paste("&Chi;:", p.format(test$p.value))
    }
  }
  return(out)
}

perc.from.num <- function(num, denom){
  perc <- my.format((num/denom)*100, ndp=1)
  out <- paste0(num, " (", perc, "%)")
  out
}

#### IMPORT DATA ####
datVersion <- "v1_9"
draftno <- "draft01"
data.path <- paste("//RCB-STORAGE/filestore/Studies/CORCMR/Secure/Unblinded/data/S1", datVersion, draftno, "HardLock", sep="/")

clinq <- readRDS(paste0(data.path, "/clinq_", datVersion, "_", draftno, ".rds"))
corfunctest <- readRDS(paste0(data.path, "/corfunctest_", datVersion, "_", draftno, ".rds"))
outcomes <- readRDS(paste0(data.path, "/outcomes_", datVersion, "_", draftno, ".rds"))
randomised <- readRDS(paste0(data.path, "/randomised_", datVersion, "_", draftno, ".rds"))
saes <- readRDS(paste0(data.path, "/saes_", datVersion, "_", draftno, ".rds"))
screening <- readRDS(paste0(data.path, "/screening_", datVersion, "_", draftno, ".rds"))
visits <- readRDS(paste0(data.path, "/visits_", datVersion, "_", draftno, ".rds"))
withdrawals <- readRDS(paste0(data.path, "/withdrawals_", datVersion, "_", draftno, ".rds"))
mri <- readRDS(paste0(data.path, "/mri_", datVersion, "_", draftno, ".rds"))
saes <- readRDS(paste0(data.path, "/saes_", datVersion, "_", draftno, ".rds"))
sae_coded <- readRDS(paste0(data.path, "/sae_coded_", datVersion, "_", draftno, ".rds"))
diagnoses <- readRDS(paste0(data.path, "/diagnoses_", datVersion, "_", draftno, ".rds"))
aes <- readRDS(paste0(data.path, "/aes_", datVersion, "_", draftno, ".rds"))

#### OUTPUTS ####
# define output files
datetime<-gsub(" ","_",date())
datetime<-gsub(":","_",datetime)
tables.file <- paste0(out.path, "/Tables/", project.name, "_", analysis.name, "_", Version, "_", gsub("-","",Sys.Date()),"_",substring(datetime,12,13),substring(datetime,15,16), ".doc")
figure.file <- paste0(figure.path, "/", project.name, "_", analysis.name, "_Figures_", Version, "_", gsub("-","",Sys.Date()),"_",substring(datetime,12,13),substring(datetime,15,16), ".doc")
diags.file <- paste0(diags.path, "/", project.name, "_", analysis.name, "_DiagnosticFigures_", Version, "_", gsub("-","",Sys.Date()),"_",substring(datetime,12,13),substring(datetime,15,16), ".doc")

#### Title Pages ####
snapshot.date.text <- "05/07/2025"
# Tables
ExportTable.HTML(
  as.Table(list(Text=project.name,Style=list("font-size"=16))),
  rbindTable(
    "",
    as.Table(list(Text=paste("<b>",project.title,"</b>"),Style=list("font-size"=14))),
    "",
    paste("Final Analysis: Statistical Tables"),
    "",
    paste("Based on a snapshot of the study database, taken on",snapshot.date.text),
    "",
    paste("Program run by",stats.name,"on",substring(date(),1,10)),
    "",
    "Robertson Centre for Biostatistics",
    "",
    "For further information about the data collected in the study eCRF, see:",
    "",
    paste("<a href='",demo.url,"'>Demo eCRF</a>",sep=""),
    "",
    paste("Login: '",demo.login,"'",sep=""),
    paste("Password: '",demo.password,"'",sep="")),
  none.fmt,tables.file,T,F,T)
# Figures
ExportTable.HTML(
  as.Table(list(Text=project.name,Style=list("font-size"=16))),
  rbindTable(
    "",
    as.Table(list(Text=paste("<b>",project.title,"</b>"),Style=list("font-size"=14))),
    "",
    paste("Final Analysis: Figures"),
    "",
    paste("Based on a snapshot of the study database, taken on",snapshot.date.text),
    "",
    paste("Program run by",stats.name,"on",substring(date(),1,10)),
    "",
    "Robertson Centre for Biostatistics",
    "",
    "For further information about the data collected in the study eCRF, see:",
    "",
    paste("<a href='",demo.url,"'>Demo eCRF</a>",sep=""),
    "",
    paste("Login: '",demo.login,"'",sep=""),
    paste("Password: '",demo.password,"'",sep="")),
  none.fmt,figure.file,T,F,T)
# Diagnostic Figures
ExportTable.HTML(
  as.Table(list(Text=project.name,Style=list("font-size"=16))),
  rbindTable(
    "",
    as.Table(list(Text=paste("<b>",project.title,"</b>"),Style=list("font-size"=14))),
    "",
    paste("Final Analysis: Diagnostic Figures"),
    "",
    paste("Based on a snapshot of the study database, taken on",snapshot.date.text),
    "",
    paste("Program run by",stats.name,"on",substring(date(),1,10)),
    "",
    "Robertson Centre for Biostatistics",
    "",
    "For further information about the data collected in the study eCRF, see:",
    "",
    paste("<a href='",demo.url,"'>Demo eCRF</a>",sep=""),
    "",
    paste("Login: '",demo.login,"'",sep=""),
    paste("Password: '",demo.password,"'",sep="")),
  none.fmt,diags.file,T,F,T)

#### 1.1: VISIT ATTENDANCE ####
summary.table(tabnum="1.1", tabtext="Visit attendance by treatment group.", 
              basedata=list(
                list(x=visits$siteid, row.name="N screened", nrow=T, subset=visits$visittypeid==1),
                list(x=visits$siteid, row.name="N at MRI (&le; 3 months)", nrow=T, subset=visits$visittypeid==2), 
                list(x=visits$siteid, row.name="N randomised", nrow=T, subset=visits$visittypeid==1&visits$randyn=="Yes"),
                list(x=visits$siteid, row.name="N at 6 months", nrow=T, subset=visits$visittypeid==3), 
                list(x=visits$siteid, row.name="N at 12 months", nrow=T, subset=visits$visittypeid==4)
              ), 
              treat=visits$trtgrp, out.file=tables.file)
randomised$sitename <- factor(randomised$sitename)
summary.table(tabnum="1.2", tabtext=paste("Randomisation by month at each study site.<br></b>", 
                                          "Note that two patients were recruited at University Hospital Ayr,", 
                                          "however these individuals are included as patients at the Glasgow", 
                                          "Golden Jubilee Hospital."),
              basedata=list(
                list(x=randomised$randyn, row.name="March 2021", nrow=T, subset=randomised$randmonyear=="2021-03"), 
                list(x=randomised$randyn, row.name="April 2021", nrow=T, subset=randomised$randmonyear=="2021-04"),
                list(x=randomised$randyn, row.name="May 2021", nrow=T, subset=randomised$randmonyear=="2021-05"),
                list(x=randomised$randyn, row.name="June 2021", nrow=T, subset=randomised$randmonyear=="2021-06"),
                list(x=randomised$randyn, row.name="July 2021", nrow=T, subset=randomised$randmonyear=="2021-07"),
                list(x=randomised$randyn, row.name="August 2021", nrow=T, subset=randomised$randmonyear=="2021-08"),
                list(x=randomised$randyn, row.name="September 2021", nrow=T, subset=randomised$randmonyear=="2021-09"),
                list(x=randomised$randyn, row.name="October 2021", nrow=T, subset=randomised$randmonyear=="2021-10"),
                list(x=randomised$randyn, row.name="November 2021", nrow=T, subset=randomised$randmonyear=="2021-11"),
                list(x=randomised$randyn, row.name="December 2021", nrow=T, subset=randomised$randmonyear=="2021-12"),
                list(x=randomised$randyn, row.name="January 2022", nrow=T, subset=randomised$randmonyear=="2022-01"),
                list(x=randomised$randyn, row.name="February 2022", nrow=T, subset=randomised$randmonyear=="2022-02"),
                list(x=randomised$randyn, row.name="March 2022", nrow=T, subset=randomised$randmonyear=="2022-03"), 
                list(x=randomised$randyn, row.name="April 2022", nrow=T, subset=randomised$randmonyear=="2022-04"),
                list(x=randomised$randyn, row.name="May 2022", nrow=T, subset=randomised$randmonyear=="2022-05"),
                list(x=randomised$randyn, row.name="June 2022", nrow=T, subset=randomised$randmonyear=="2022-06"),
                list(x=randomised$randyn, row.name="July 2022", nrow=T, subset=randomised$randmonyear=="2022-07"),
                list(x=randomised$randyn, row.name="August 2022", nrow=T, subset=randomised$randmonyear=="2022-08"),
                list(x=randomised$randyn, row.name="September 2022", nrow=T, subset=randomised$randmonyear=="2022-09"),
                list(x=randomised$randyn, row.name="October 2022", nrow=T, subset=randomised$randmonyear=="2022-10"),
                list(x=randomised$randyn, row.name="November 2022", nrow=T, subset=randomised$randmonyear=="2022-11"),
                list(x=randomised$randyn, row.name="December 2022", nrow=T, subset=randomised$randmonyear=="2022-12"),
                list(x=randomised$randyn, row.name="January 2023", nrow=T, subset=randomised$randmonyear=="2023-01"),
                list(x=randomised$randyn, row.name="February 2023", nrow=T, subset=randomised$randmonyear=="2023-02"),
                list(x=randomised$randyn, row.name="March 2023", nrow=T, subset=randomised$randmonyear=="2023-03"), 
                list(x=randomised$randyn, row.name="April 2023", nrow=T, subset=randomised$randmonyear=="2023-04"),
                list(x=randomised$randyn, row.name="May 2023", nrow=T, subset=randomised$randmonyear=="2023-05"),
                list(x=randomised$randyn, row.name="June 2023", nrow=T, subset=randomised$randmonyear=="2023-06"),
                list(x=randomised$randyn, row.name="July 2023", nrow=T, subset=randomised$randmonyear=="2023-07"),
                list(x=randomised$randyn, row.name="August 2023", nrow=T, subset=randomised$randmonyear=="2023-08")
              ),
              treat=randomised$sitename, out.file=tables.file)
screening$sitename <- factor(screening$sitename)

consort_tab <- list(head=rbindTable(list(Text="<b>Table 1.3: Progression of patients by site.", Other=list(colspan=7)), 
                                    list(Text=paste("Note that two patients were recruited at University Hospital Ayr,", 
                                                    "however these individuals are included as patients at the Glasgow", 
                                                    "Golden Jubilee Hospital."), Other=list(colspan=7)),
                                    cbindTable("", "", "", "All", "", 
                                               "Glasgow Golden Jubilee Hospital", 
                                               "University Hospital Hairmyres")),
                    body=rbindTable(summary.N(row.name="N screened", treat=screening$sitename, treat.levels=levels(screening$sitename)),
                                    summary.N(row.name="N randomised", treat=screening$sitename, subset=!is.na(screening$randdate), treat.levels=levels(screening$sitename)),
                                    summary.N(row.name="N not randomised", treat=screening$sitename, subset=is.na(screening$randdate), treat.levels=levels(screening$sitename), nrow=T),
                                    summary.cat(row.name="Not randomised reasons", treat=screening$sitename, treat.levels=levels(screening$sitename), x=screening$notrand_reas, subset=is.na(screening$randdate)),
                                    summary.cat(row.name="Withdrawal prior to randomisation reasons", treat=screening$sitename, treat.levels=levels(screening$sitename), x=screening$wd_prerand_reas, subset=screening$randyn=="No"),
                                    summary.N(row.name="Allocated to control", treat=screening$sitename, treat.levels=levels(screening$sitename), x=screening$siteid, subset=screening$trtgrp=="Control"),
                                    summary.cat(row.name="Control group: end of study status", treat=screening$sitename, treat.levels=levels(screening$sitename), x=screening$eos, subset=screening$trtgrp=="Control"),
                                    summary.N(row.name="Allocated to intervention", treat=screening$sitename, treat.levels=levels(screening$sitename), x=screening$siteid, subset=screening$trtgrp=="Intervention"),
                                    summary.cat(row.name="Intervention group: end of study status", treat=screening$sitename, treat.levels=levels(screening$sitename), x=screening$eos, subset=screening$trtgrp=="Intervention"),
                                    end.row(disclaimer=T)
                                    )
                    )
ExportTable.HTML(consort_tab$head, consort_tab$body, filename=tables.file, horiz.fmt, first=F, last=F)

#### 2.X: SCREENING DATA ####
summary.table(tabnum="2.1", 
              tabtext="Baseline data: demographics.", 
              basedata=list(
                list(x=screening$age, row.name="Age", ndp=1, subset=screening$randyn=="Yes"),
                list(x=screening$sex, row.name="Sex", subset=screening$randyn=="Yes"), 
                list(x=screening$ethnic_simple, row.name="Ethnicity", subset=screening$randyn=="Yes"), 
                list(x=screening$employ, row.name="Employment status", subset=screening$randyn=="Yes"), 
                list(x=screening$smoking, row.name="Smoking status", subset=screening$randyn=="Yes")
                ), 
              treat=screening$trtgrp, out.file=tables.file)
summary.table(tabnum="2.2.1", 
              tabtext="Baseline data: medical history - angina and CT coronary angiogram.", 
              basedata=list(
                list(x=screening$angina_vsa, row.name="Vasospastic angina", x.levels="Yes", subset=screening$randyn=="Yes"), 
                list(x=screening$angina_dur, row.name="Duration of angina symptoms (months)", ndp=1, subset=screening$angina_vsa=="Yes"&screening$randyn=="Yes"),
                list(x=screening$angina_ccs, row.name="Canadian Cardiovascular Society angina class", subset=screening$randyn=="Yes"), 
                list(x=screening$ctca_perf, row.name="CT coronary angiogram performed", x.levels="Yes", subset=screening$randyn=="Yes"), 
                list(x=screening$ctca_when, row.name="When CT coronary angiogram was performed", subset=screening$ctca_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$ctca_res, row.name="CT coronary angiogram results", subset=screening$ctca_perf=="Yes"&screening$randyn=="Yes")
              ), 
              treat=screening$trtgrp, out.file=tables.file)
summary.table(tabnum="2.2.2", 
              tabtext="Baseline data: medical history - stress testing.", 
              basedata=list(
                list(x=screening$str_perf, row.name="Stress testing performed", x.levels="Yes", subset=screening$randyn=="Yes"),
                list(x=screening$trd_perf, row.name="Treadmill stress testing performed", 
                     subset=screening$str_perf=="Yes"&screening$randyn=="Yes", x.levels="Yes"),
                list(x=screening$trd_when, row.name="When treadmill stress testing was performed",
                     subset=screening$str_perf=="Yes"&screening$trd_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$trd_res, row.name="Treadmill stress testing results",
                     subset=screening$str_perf=="Yes"&screening$trd_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$strecho_perf, row.name="Stress echocardiogramperformed", x.levels="Yes", 
                     subset=screening$str_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$strecho_when, row.name="When stress echocardiogramwas performed",
                     subset=screening$str_perf=="Yes"&screening$strecho_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$strecho_res, row.name="Stress echocardiogramresults",
                     subset=screening$str_perf=="Yes"&screening$strecho_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$strspect_perf, row.name="Stress SPECT performed", x.levels="Yes", 
                     subset=screening$str_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$strspect_when, row.name="When stress SPECT was performed",
                     subset=screening$str_perf=="Yes"&screening$strspect_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$strspect_res, row.name="Stress SPECT results",
                     subset=screening$str_perf=="Yes"&screening$strspect_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$strpet_perf, row.name="Stress PET performed", x.levels="Yes", 
                     subset=screening$str_perf=="Yes"&screening$randyn=="Yes"),
                # list(x=screening$strpet_when, row.name="When Stress PET was performed",
                #      subset=screening$str_perf=="Yes"&screening$strpet_perf=="Yes"&screening$randyn=="Yes"),
                # list(x=screening$strpet_res, row.name="Stress PET results",
                #      subset=screening$str_perf=="Yes"&screening$strpet_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$strmri_perf, row.name="Stress MRI performed", x.levels="Yes", 
                     subset=screening$str_perf=="Yes"&screening$randyn=="Yes")#,
                # list(x=screening$strmri_when, row.name="When Stress MRI was performed",
                #      subset=screening$str_perf=="Yes"&screening$strmri_perf=="Yes"&screening$randyn=="Yes"),
                # list(x=screening$strmri_res, row.name="Stress MRI results",
                #      subset=screening$str_perf=="Yes"&screening$strmri_perf=="Yes"&screening$randyn=="Yes")
              ), 
              treat=screening$trtgrp, out.file=tables.file)

summary.table(tabnum="2.2.3", tabtext="Baseline data: medical history - cardiac imaging.", 
              basedata=list(
                list(x=screening$cardim_perf, row.name="Cardiac imaging performed", x.levels="Yes", subset=screening$randyn=="Yes"), 
                list(x=screening$cardecho_perf, row.name="Echocardiogram performed", 
                     x.levels="Yes", subset=screening$cardim_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$cardmri_perf, row.name="Cardiac MRI performed", 
                     x.levels="Yes", subset=screening$cardim_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$ctven_perf, row.name="CT ventriculogram performed", 
                     x.levels="Yes", subset=screening$cardim_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$cardpet_perf, row.name="PET performed", 
                     x.levels="Yes", subset=screening$cardim_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$cardspect_perf, row.name="SPECT performed", 
                     x.levels="Yes", subset=screening$cardim_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$cardoth_perf, row.name="Other cardiac imaging performed", 
                     x.levels="Yes", subset=screening$cardim_perf=="Yes"&screening$randyn=="Yes"),
                list(x=screening$lvfunction, row.name="LV systolic function", subset=screening$randyn=="Yes")
              ), 
              treat=screening$trtgrp, out.file=tables.file)

summary.table(tabnum="2.2.4",
              tabtext="Baseline data: medical history - comorbidities.", 
              basedata=list(
                list(x=screening$hyperten, row.name="Hypertension", x.levels="Yes", subset=screening$randyn=="Yes"), 
                list(x=screening$afib, row.name="Atrial fibrillation or flutter", x.levels="Yes", subset=screening$randyn=="Yes"), 
                list(x=screening$inflamj, row.name="Inflammatory joint disease", x.levels="Yes", subset=screening$randyn=="Yes"),
                list(x=screening$inflamb, row.name="Inflammatory bowel disease", x.levels="Yes", subset=screening$randyn=="Yes"),
                list(x=screening$gitract, row.name="Gastrointestinal tract pathology", x.levels="Yes", subset=screening$randyn=="Yes"),
                list(x=screening$cancer, row.name="History of cancer", x.levels="Yes", subset=screening$randyn=="Yes"),
                list(x=screening$copd, row.name="COPD or asthma", x.levels="Yes", subset=screening$randyn=="Yes"),
                list(x=screening$diab, row.name="Diabetes", x.levels="Yes", subset=screening$randyn=="Yes"),
                list(x=screening$diabtype, row.name="Diabetes type", subset=screening$diab=="Yes"&screening$randyn=="Yes"),
                list(x=screening$diabdur, row.name="Duration of diabetes", subset=screening$diab=="Yes"&screening$randyn=="Yes", ndp=1),
                list(x=screening$depress, row.name="Depression", x.levels="Yes", subset=screening$randyn=="Yes"),
                list(x=screening$chronpain, row.name="Chronic pain syndrome", x.levels="Yes", subset=screening$randyn=="Yes"),
                list(x=screening$muscdis, row.name="History of myopathy", x.levels="Yes", subset=screening$randyn=="Yes"),
                list(x=screening$neuromusc, row.name="History of neuromuscular disorder", x.levels="Yes", subset=screening$randyn=="Yes"),
                list(x=screening$ibs, row.name="IBS", x.levels="Yes", subset=screening$randyn=="Yes"),
                list(x=screening$fatigue, row.name="Chronic fatigue syndrome", x.levels="Yes", subset=screening$randyn=="Yes")
              ), 
              treat=screening$trtgrp, out.file=tables.file)

summary.table(tabnum="2.2.5", 
              tabtext="Baseline data: medical history - women's health.", 
              basedata=list(
                list(x=screening$wh_meno, row.name="Patient has started menopause", x.levels="Yes", 
                     subset=screening$sex=="Female"&screening$randyn=="Yes"), 
                list(x=screening$wh_menoage, row.name="Age when menopause started", ndp=1, 
                     subset=screening$sex=="Female"&screening$randyn=="Yes"&screening$wh_meno=="Yes"),
                list(x=screening$wh_menocomp, row.name="Menopause complete", x.levels="Yes", 
                     subset=screening$sex=="Female"&screening$randyn=="Yes"&screening$wh_meno=="Yes"),
                list(x=screening$wh_menotype, row.name="Type of menopause", 
                     subset=screening$sex=="Female"&screening$randyn=="Yes"&screening$wh_meno=="Yes"),
                list(x=screening$wh_hyst, row.name="Patient has had a hysterectomy", x.levels="Yes", 
                     subset=screening$sex=="Female"&screening$randyn=="Yes"), 
                list(x=screening$wh_hystage, row.name="Age at time of hysterectomy", ndp=1,
                     subset=screening$sex=="Female"&screening$randyn=="Yes"&screening$wh_hyst=="Yes"),
                list(x=screening$wh_preg, row.name="Former pregnancy", x.levels="Yes", 
                     subset=screening$sex=="Female"&screening$randyn=="Yes"), 
                list(x=screening$wh_miss, row.name="History of miscarriage", x.levels="Yes",
                     subset=screening$sex=="Female"&screening$randyn=="Yes"&screening$wh_preg=="Yes"),
                list(x=screening$wh_still, row.name="History of stillbirth", x.levels="Yes", 
                     subset=screening$sex=="Female"&screening$randyn=="Yes"&screening$wh_preg=="Yes"),
                list(x=screening$wh_hyp, row.name="History of hypertension", x.levels="Yes", 
                     subset=screening$sex=="Female"&screening$randyn=="Yes"&screening$wh_preg=="Yes"),
                list(x=screening$wh_preecl, row.name="History of pre-eclampsia", x.levels="Yes", 
                     subset=screening$sex=="Female"&screening$randyn=="Yes"&screening$wh_preg=="Yes")
              ), 
              treat=screening$trtgrp, out.file=tables.file)

summary.table(tabnum="2.3", 
              tabtext="Baseline data: cardiovascular events and procedures.", 
              basedata=list(
                list(x=screening$edatt, row.name="Attendance at emergency department", x.levels="Yes", subset=screening$randyn=="Yes"),
                if(any(screening$edatt=="Yes", na.rm=T)) list(x=screening$edattnum_simple, row.name="Total number of events", subset=screening$edatt=="Yes"&screening$randyn=="Yes"),
                
                list(x=screening$cpcatt, row.name="Attendance at chest pain clinic", x.levels="Yes", subset=screening$randyn=="Yes"),
                if(any(screening$cpcatt=="Yes", na.rm=T)) list(x=screening$cpcattnum_simple, row.name="Total number of events", subset=screening$cpcatt=="Yes"&screening$randyn=="Yes"),
                
                list(x=screening$cphosp, row.name="Hospitalisation for chest pain", x.levels="Yes", subset=screening$randyn=="Yes"),
                if(any(screening$cphosp=="Yes", na.rm=T)) list(x=screening$cphosp_numlast12, row.name="Number of events in last 12 months", subset=screening$cphosp=="Yes"&screening$randyn=="Yes", ndp=1),
                if(any(screening$cphosp=="Yes", na.rm=T)) list(x=screening$cphosp_num, row.name="Total number of events", subset=screening$cphosp=="Yes"&screening$randyn=="Yes", ndp=1),

                list(x=screening$myoinf, row.name="Myocardial infarction", x.levels="Yes", subset=screening$randyn=="Yes"),
                if(any(screening$myoinf=="Yes", na.rm=T)) list(x=screening$myoinf_numlast12, row.name="Number of events in last 12 months", subset=screening$myoinf=="Yes"&screening$randyn=="Yes", ndp=1),
                if(any(screening$myoinf=="Yes", na.rm=T)) list(x=screening$myoinf_num, row.name="Total number of events", subset=screening$myoinf=="Yes"&screening$randyn=="Yes", ndp=1),
                
                list(x=screening$stroke, row.name="Stroke/TIA", x.levels="Yes", subset=screening$randyn=="Yes"),
                if(any(screening$stroke=="Yes", na.rm=T)) list(x=screening$stroke_spec, row.name="Event type", subset=screening$stroke=="Yes"&screening$randyn=="Yes"),
                if(any(screening$stroke=="Yes", na.rm=T)) list(x=screening$stroke_numlast12, row.name="Number of events in last 12 months", subset=screening$stroke=="Yes"&screening$randyn=="Yes", ndp=1),
                if(any(screening$stroke=="Yes", na.rm=T)) list(x=screening$stroke_num, row.name="Total number of events", subset=screening$stroke=="Yes"&screening$randyn=="Yes", ndp=1),

                list(x=screening$corang, row.name="Coronary angiogram", x.levels="Yes", subset=screening$randyn=="Yes"),
                if(any(screening$corang=="Yes", na.rm=T)) list(x=screening$corang_numlast12, row.name="Number of events in last 12 months", subset=screening$corang=="Yes"&screening$randyn=="Yes", ndp=1),
                if(any(screening$corang=="Yes", na.rm=T)) list(x=screening$corang_num, row.name="Total number of events", subset=screening$corang=="Yes"&screening$randyn=="Yes", ndp=1),

                list(x=screening$pci, row.name="PCI", x.levels="Yes", subset=screening$randyn=="Yes"), 
                if(any(screening$pci=="Yes", na.rm=T)) list(x=screening$pci_numlast12, row.name="Number of events in last 12 months", subset=screening$pci=="Yes"&screening$randyn=="Yes", ndp=1),
                if(any(screening$pci=="Yes", na.rm=T)) list(x=screening$pci_num, row.name="Total number of events", subset=screening$pci=="Yes"&screening$randyn=="Yes", ndp=1),
                
                list(x=screening$carddev, row.name="Cardiac device", x.levels="Yes", subset=screening$randyn=="Yes"),
                if(any(screening$carddev=="Yes", na.rm=T)) list(x=screening$carddev_typesimple, row.name="Device type", subset=screening$carddev=="Yes"&screening$randyn=="Yes"),
                if(any(screening$carddev=="Yes", na.rm=T)) list(x=screening$carddev_numlast12, row.name="Number of events in last 12 months", subset=screening$carddev=="Yes"&screening$randyn=="Yes", ndp=1),
                if(any(screening$carddev=="Yes", na.rm=T)) list(x=screening$carddev_num, row.name="Total number of events", subset=screening$carddev=="Yes"&screening$randyn=="Yes", ndp=1),

                list(x=screening$valvsurg, row.name="Valve surgery", x.levels="Yes", subset=screening$randyn=="Yes"),
                if(any(screening$valvsurg=="Yes", na.rm=T)) list(x=screening$valvsurg_numlast12, row.name="Number of events in last 12 months", subset=screening$valvsurg=="Yes"&screening$randyn=="Yes", ndp=1),
                if(any(screening$valvsurg=="Yes", na.rm=T)) list(x=screening$valvsurg_num, row.name="Total number of events", subset=screening$valvsurg=="Yes"&screening$randyn=="Yes", ndp=1),

                list(x=screening$valvdis, row.name="Valve disease", x.levels="Yes", subset=screening$randyn=="Yes"),
                if(any(screening$valvdis=="Yes", na.rm=T)) list(x=screening$valvdis_as, row.name="Aortic stenosis", subset=screening$valvdis=="Yes"&screening$randyn=="Yes"),
                if(any(screening$valvdis=="Yes", na.rm=T)) list(x=screening$valvdis_ar, row.name="Aortic regurgitation", subset=screening$valvdis=="Yes"&screening$randyn=="Yes"),
                if(any(screening$valvdis=="Yes", na.rm=T)) list(x=screening$valvdis_ms, row.name="Mitral stenosis", subset=screening$valvdis=="Yes"&screening$randyn=="Yes"),
                if(any(screening$valvdis=="Yes", na.rm=T)) list(x=screening$valvdis_mr, row.name="Mitral regurgitation", subset=screening$valvdis=="Yes"&screening$randyn=="Yes"),
                if(any(screening$valvdis=="Yes", na.rm=T)) list(x=screening$valvdis_numlast12, row.name="Number of events in last 12 months", subset=screening$valvdis=="Yes"&screening$randyn=="Yes", ndp=1),
                if(any(screening$valvdis=="Yes", na.rm=T)) list(x=screening$valvdis_num, row.name="Total number of events", subset=screening$valvdis=="Yes"&screening$randyn=="Yes", ndp=1),

                list(x=screening$hf, row.name="Heart failure", x.levels="Yes", subset=screening$randyn=="Yes"),
                if(any(screening$hf=="Yes", na.rm=T)) list(x=screening$hf_hosp, row.name="Hospitalised for heart failure", subset=screening$hf=="Yes"&screening$randyn=="Yes", x.levels="Yes"),
                if(any(screening$hf=="Yes", na.rm=T)) list(x=screening$hf_numlast12, row.name="Number of events in last 12 months", subset=screening$hf=="Yes"&screening$randyn=="Yes", ndp=1),
                if(any(screening$hf=="Yes", na.rm=T)) list(x=screening$hf_num, row.name="Total number of events", subset=screening$hf=="Yes"&screening$randyn=="Yes", ndp=1)
              ), 
              treat=screening$trtgrp, out.file=tables.file)

summary.table(tabnum="2.4", 
              tabtext="Baseline data: coronary angiogram and coronary dominance.", 
              basedata=list(
                list(x=screening$angiodur, row.name="Duration of angiogram (minutes)", ndp=1, subset=screening$randyn=="Yes"),
                list(x=screening$contrastvol, row.name="Contrast volume (ml)", ndp=1, subset=screening$randyn=="Yes"),
                list(x=screening$corspasm, row.name="Coronary spasm occurred", x.levels="Yes", subset=screening$randyn=="Yes"),
                if(any(screening$corspasm=="Yes", na.rm=T)) list(x=screening$ivtadm, row.name="Intracoronary vasodilator therapy administered", subset=screening$corspasm=="Yes"&screening$randyn=="Yes", x.levels="Yes"),
                if(any(screening$corspasm=="Yes", na.rm=T)) list(x=screening$ivtadm_spec, row.name="Type of intracoronary vasodilator therapy", subset=screening$corspasm=="Yes"&screening$randyn=="Yes"),
                list(x=screening$cordom, row.name="Coronary dominance", subset=screening$randyn=="Yes")
              ), 
              treat=screening$trtgrp, out.file=tables.file)

summary.table(tabnum="2.5", 
              tabtext="Baseline data: stenosis severity.", 
              basedata=list(
                list(x=screening$stensev1_simple1, row.name="RCA proximal stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev1=="100%", na.rm=T)) list(x=screening$occdur1, row.name="RCA proximal: duration of chronic total occlusion", subset=screening$stensev1=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev2_simple1, row.name="RCA mid stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev2=="100%", na.rm=T)) list(x=screening$occdur2, row.name="RCA mid: duration of chronic total occlusion", subset=screening$stensev2=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev3_simple1, row.name="RCA distal stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev3=="100%", na.rm=T)) list(x=screening$occdur3, row.name="RCA distal: duration of chronic total occlusion", subset=screening$stensev3=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev16_simple1, row.name="Posterolateral from RCA stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev16=="100%", na.rm=T)) list(x=screening$occdur16, row.name="Posterolateral from RCA: duration of chronic total occlusion", subset=screening$stensev16=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev16a_simple1, row.name="Posterolateral from RCA (first branch) stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev16a=="100%", na.rm=T)) list(x=screening$occdur16a, row.name="Posterolateral from RCA (first branch): duration of chronic total occlusion", subset=screening$stensev16a=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev16b_simple1, row.name="Posterolateral from RCA (second branch) stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev16b=="100%", na.rm=T)) list(x=screening$occdur16b, row.name="Posterolateral from RCA (second branch): duration of chronic total occlusion", subset=screening$stensev16b=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev16c_simple1, row.name="Posterolateral from RCA (third branch) stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev16c=="100%", na.rm=T)) list(x=screening$occdur16c, row.name="Posterolateral from RCA (third branch): duration of chronic total occlusion", subset=screening$stensev16c=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev5_simple1, row.name="Left main stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev5=="100%", na.rm=T)) list(x=screening$occdur5, row.name="Left main: duration of chronic total occlusion", subset=screening$stensev5=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev6_simple1, row.name="LAD proximal stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev6=="100%", na.rm=T)) list(x=screening$occdur6, row.name="LAD proximal: duration of chronic total occlusion", subset=screening$stensev6=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev7_simple1, row.name="LAD mid stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev7=="100%", na.rm=T)) list(x=screening$occdur7, row.name="LAD mid: duration of chronic total occlusion", subset=screening$stensev7=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev8_simple1, row.name="LAD apical stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev8=="100%", na.rm=T)) list(x=screening$occdur8, row.name="LAD apical: duration of chronic total occlusion", subset=screening$stensev8=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev9_simple1, row.name="First diagonal stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev9=="100%", na.rm=T)) list(x=screening$occdur9, row.name="First diagnonal: duration of chronic total occlusion", subset=screening$stensev9=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev9a_simple1, row.name="Additional first diagonal stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev9a=="100%", na.rm=T)) list(x=screening$occdur9a, row.name="Additional first diagonal: duration of chronic total occlusion", subset=screening$stensev9a=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev10_simple1, row.name="Second diagonal stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev10=="100%", na.rm=T)) list(x=screening$occdur10, row.name="Second diagonal: duration of chronic total occlusion", subset=screening$stensev10=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev10a_simple1, row.name="Additional second diagonal stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev10a=="100%", na.rm=T)) list(x=screening$occdur10a, row.name="Additional second diagonal: duration of chronic total occlusion", subset=screening$stensev10a=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev11_simple1, row.name="Proximal circumflex stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev11=="100%", na.rm=T)) list(x=screening$occdur11, row.name="Proximal circumflex: duration of chronic total occlusion", subset=screening$stensev11=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev12_simple1, row.name="Intermediate/anterolateral stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev12=="100%", na.rm=T)) list(x=screening$occdur12, row.name="Intermediate/anterolateral: duration of chronic total occlusion", subset=screening$stensev12=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev12a_simple1, row.name="Obtuse marginal stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev12a=="100%", na.rm=T)) list(x=screening$occdur12a, row.name="Obtuse marginal: duration of chronic total occlusion", subset=screening$stensev12a=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev12b_simple1, row.name="Second obtuse marginal stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev12b=="100%", na.rm=T)) list(x=screening$occdur12b, row.name="Second obtuse marginal: duration of chronic total occlusion", subset=screening$stensev12b=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev13_simple1, row.name="Distal circumflex stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev13=="100%", na.rm=T)) list(x=screening$occdur13, row.name="Distal circumflex: duration of chronic total occlusion", subset=screening$stensev13=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev14_simple1, row.name="Left posterolateral stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev14=="100%", na.rm=T)) list(x=screening$occdur14, row.name="Left posterolateral: duration of chronic total occlusion", subset=screening$stensev14=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev14a_simple1, row.name="Distal from left posterolateral stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev14a=="100%", na.rm=T)) list(x=screening$occdur14a, row.name="Distal from left posterolateral: duration of chronic total occlusion", subset=screening$stensev14a=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev14b_simple1, row.name="Second distal from left posterolateral stenosis severity", subset=screening$randyn=="Yes"), 
                if(any(screening$stensev14b=="100%", na.rm=T)) list(x=screening$occdur14b, row.name="Second distal from left posterolateral: duration of chronic total occlusion", subset=screening$stensev14b=="100%"&screening$randyn=="Yes"), 
                list(x=screening$stensev15_simple1, row.name="Posterior descending stenosis severity", subset=screening$randyn=="Yes"),
                if(any(screening$stensev15=="100%", na.rm=T)) list(x=screening$occdur15, row.name="Posterior descending: duration of chronic total occlusion", subset=screening$stensev15=="100%"&screening$randyn=="Yes")
              ),
              treat=screening$trtgrp, out.file=tables.file)

summary.table(tabnum="2.6", 
              tabtext="Baseline data: haemodynamics.", 
              basedata=list(  
                list(x=screening$lvedp, row.name="LVEDP (mmHg)", ndp=1, screening$randyn=="Yes"), 
                list(x=screening$hr, row.name="Heart rate (at rest, bpm)", ndp=1, screening$randyn=="Yes"),
                list(x=screening$haemo_sbp, row.name="Systolic blood pressure (at rest, mmHg)", ndp=1, screening$randyn=="Yes"),
                list(x=screening$sbp_120plus, row.name="SBP > 120 mmHg", x.levels="Yes", subset=screening$randyn=="Yes"),
                list(x=screening$sbp_130plus, row.name="SBP > 130 mmHg", x.levels="Yes", subset=screening$randyn=="Yes"),
                list(x=screening$rpp, row.name="Rate pressure product", subset=screening$randyn=="Yes")
                
              ),
              treat=screening$trtgrp, out.file=tables.file)

summary.table(tabnum="2.7.1", 
              tabtext="Baseline data: standard bloods (part 1).", 
              basedata=list(
                list(x=outcomes$sbl_taken, row.name="Standard bloods taken", x.levels="Yes", subset=outcomes$visittypeid==1), 
                list(x=outcomes$sbl_samp1st, row.name="Sample taken before contrast given", x.levels="Yes", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_hb, row.name="Hb (g/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$anaemia_hb, row.name="Hb below WHO threshold for anaemia", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"),
                list(x=outcomes$sbl_wcc, row.name="White cell count (x10<sup>9</sup>/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_pota, row.name="Potassium (mmol/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_creat, row.name="Creatinine (umol/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_gluc, row.name="Glucose (mmol/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes")
                ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="2.7.2", 
              tabtext="Baseline data: standard bloods (part 2).", 
              basedata=list(
                list(x=outcomes$sbl_hba1c, row.name="HbA1c (IFCC)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$hba1c_cat, row.name="HbA1c category", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_crp, row.name="CRP (mg/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_plat, row.name="Platelets (x10<sup>9</sup>/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_urea, row.name="Urea (mmol/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_bili, row.name="Bilirubin (mmol/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_alt, row.name="ALT (U/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes")
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="2.7.3", 
              tabtext="Baseline data: standard bloods (part 3).", 
              basedata=list(
                list(x=outcomes$sbl_ast, row.name="AST (U/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_alp, row.name="ALP (U/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_album, row.name="Albumin (g/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_ntprobnp, row.name="NT-proBNP (pg/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$ntprobnp_125, row.name="NT-proBNP > 125pg/L", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$ntprobnp_400, row.name="NT-proBNP > 400pg/L", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_totchol, row.name="Total cholesterol (mmol/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_trig, row.name="Triglycerides (mmol/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes")
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="2.7.4", 
              tabtext="Baseline data: standard bloods (part 4).", 
              basedata=list(
                list(x=outcomes$sbl_hdl, row.name="HDL cholesterol (mmol/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_ldl, row.name="LDL cholesterol (mmol/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_vldl, row.name="VLDL cholesterol (mmol/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_tropt, row.name="Troponin-T (ng/L)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes"), 
                list(x=outcomes$sbl_egfr, row.name="eGFR (ml/min/1.73m<sup>2</sup>)", subset=outcomes$visittypeid==1&outcomes$sbl_taken=="Yes")
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="2.8", 
              tabtext="Baseline data: PROMs.", 
              basedata=list(
                list(x=screening$assign_score, row.name="ASSIGN score", ndp=1, screening$randyn=="Yes"),
                list(x=screening$charlson_sc, row.name="Charlson score", ndp=1, screening$randyn=="Yes"),
                list(x=screening$qr3risksc_calc, row.name="QR3 risk score", ndp=1, screening$randyn=="Yes")
              ), 
              treat=screening$trtgrp, out.file=tables.file)

summary.table(tabnum="2.9", 
              tabtext="Baseline data: electrocardiogram.", 
              basedata=list(
                list(x=screening$ecg_hr, row.name="Heart rate (bpm)", ndp=1, screening$randyn=="Yes"), 
                list(x=screening$ecg_rhythm, row.name="Heart rhythm", screening$randyn=="Yes"), 
                list(x=screening$ecg_qrsdur, row.name="QRS duration (ms)", ndp=1, screening$randyn=="Yes"),
                list(x=screening$ecg_lbbb, row.name="LBBB", x.levels="Yes", screening$randyn=="Yes"), 
                list(x=screening$ecg_rbbb, row.name="RBBB", x.levels="Yes", screening$randyn=="Yes"),
                list(x=screening$ecg_lvh, row.name="LVH", x.levels="Yes", screening$randyn=="Yes")
              ), 
              treat=screening$trtgrp, out.file=tables.file)

summary.table(tabnum="2.10", 
              tabtext="Baseline data: physical examination.", 
              basedata=list(
                list(x=screening$pe_norm, row.name="Physical exam normal", screening$randyn=="Yes"),
                if(any(screening$pe_norm=="No", na.rm=T)) list(x=screening$pe_gen, row.name="General (in those with abnormal exam)", subset=screening$pe_norm=="No"&screening$randyn=="Yes"),
                if(any(screening$pe_norm=="No", na.rm=T)) list(x=screening$pe_head, row.name="Head, neck, ENT (in those with abnormal exam)", subset=screening$pe_norm=="No"&screening$randyn=="Yes"),
                if(any(screening$pe_norm=="No", na.rm=T)) list(x=screening$pe_musc, row.name="Musculo-skeletal (in those with abnormal exam)", subset=screening$pe_norm=="No"&screening$randyn=="Yes"),
                if(any(screening$pe_norm=="No", na.rm=T)) list(x=screening$pe_resp, row.name="Respiratory (in those with abnormal exam)", subset=screening$pe_norm=="No"&screening$randyn=="Yes"),
                if(any(screening$pe_norm=="No", na.rm=T)) list(x=screening$pe_derm, row.name="Dermatological (in those with abnormal exam)", subset=screening$pe_norm=="No"&screening$randyn=="Yes"), 
                if(any(screening$pe_norm=="No", na.rm=T)) list(x=screening$pe_gast, row.name="Gastrointestinal (in those with abnormal exam)", subset=screening$pe_norm=="No"&screening$randyn=="Yes"),
                if(any(screening$pe_norm=="No", na.rm=T)) list(x=screening$pe_endo, row.name="Endocrine, metabolic (in those with abnormal exam)", subset=screening$pe_norm=="No"&screening$randyn=="Yes"),
                if(any(screening$pe_norm=="No", na.rm=T)) list(x=screening$pe_geni, row.name="Genitourinary (in those with abnormal exam)", subset=screening$pe_norm=="No"&screening$randyn=="Yes"), 
                if(any(screening$pe_norm=="No", na.rm=T)) list(x=screening$pe_neur, row.name="Neurological (in those with abnormal exam)", subset=screening$pe_norm=="No"&screening$randyn=="Yes"),
                if(any(screening$pe_norm=="No", na.rm=T)) list(x=screening$pe_card, row.name="Cardiovascular (in those with abnormal exam)", subset=screening$pe_norm=="No"&screening$randyn=="Yes"), 
                if(any(screening$pe_norm=="No", na.rm=T)) list(x=screening$pe_oth, row.name="Other (in those with abnormal exam)", subset=screening$pe_norm=="No"&screening$randyn=="Yes"),
                if(any(screening$pe_norm=="No", na.rm=T) & any(screening$pe_oth=="Yes", na.rm=T)) list(x=screening$pe_othres, row.name="Other: results (in those with abnormal exam)", subset=screening$pe_norm=="No"&screening$randyn=="Yes")
              ), 
              treat=screening$trtgrp, out.file=tables.file)

summary.table(tabnum="2.11", 
              tabtext="Baseline data: vital signs.", 
              basedata=list(
                list(x=outcomes$sbp_avg, row.name="Systolic blood pressure (mmHg)", subset=outcomes$visittypeid==1), 
                list(x=outcomes$dbp_avg, row.name="Diastolic blood pressure (mmHg)", subset=outcomes$visittypeid==1), 
                list(x=outcomes$esc_bpcat, row.name="Blood pressure category (ESC 2024 guidelines)", subset=outcomes$visittypeid==1), 
                list(x=outcomes$bmi, row.name="BMI (kg/m<sup>2</sup>)", subset=outcomes$visittypeid==1), 
                list(x=outcomes$waist, row.name="Waist circumference (cm)", subset=outcomes$visittypeid==1), #
                list(x=outcomes$hip, row.name="Hip circumference (cm)", subset=outcomes$visittypeid==1)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="2.12", 
              tabtext="Brain MRI.", 
              basedata=list(
                list(x=mri$brain_quality, row.name="N with brain MRI", subset=!is.na(mri$brain_quality)&!is.na(mri$trtgrp), nrow=T), 
                list(x=mri$brain_quality, row.name="Scan quality", x.levels="Adequate", subset=!is.na(mri$trtgrp)), 
                list(x=mri$brain_periwmh, row.name="Periventricular white matter hyperintensities", subset=!is.na(mri$trtgrp)), 
                list(x=mri$brain_deepwmh, row.name="Subcortical/deep white matter hyperintensities", subset=!is.na(mri$trtgrp)), 
                list(x=mri$brain_lacun, row.name="Lacunes/lacunar infarcts", subset=!is.na(mri$trtgrp)), 
                list(x=mri$brain_greynuc, row.name="Deep grey nuclei and lobar microhaemorrhages", subset=!is.na(mri$trtgrp)), 
                list(x=mri$brain_svdscore, row.name="Standardised score for presence of small vessel disease of the brain burden", ndp=2, subset=!is.na(mri$trtgrp)), 
                list(x=mri$brain_staals_lacun, row.name="Staals scoring system - lacunes", subset=!is.na(mri$trtgrp)), 
                list(x=mri$brain_staals_cbm, row.name="Staals scoring system - CBMs", subset=!is.na(mri$trtgrp)), 
                list(x=mri$brain_staals_pvs, row.name="Staals scoring system - PVS", subset=!is.na(mri$trtgrp)), 
                list(x=mri$brain_staals_wmh, row.name="Staals scoring system - WMH", subset=!is.na(mri$trtgrp)), 
                list(x=mri$brain_staalsscore, row.name="Staals score", subset=!is.na(mri$trtgrp)), 
                list(x=mri$brain_infarct, row.name="Presence of established territorial, cortical, and cerebellar infarcts", subset=!is.na(mri$trtgrp)), 
                list(x=mri$brain_ischae, row.name="Presence of acute/subacute ischaemia", subset=!is.na(mri$trtgrp)), 
                list(x=mri$brain_atrophy, row.name="Atrophy assessment", subset=!is.na(mri$trtgrp))
                ), 
              treat=mri$trtgrp, out.file=tables.file)

summary.table(tabnum="2.13.1", 
              tabtext="Cardiac MRI (part 1).", 
              basedata=list(
                list(x=mri$cardiac_lvef, row.name="LVEF (%)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_lvedv, row.name="LVEDV (ml)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_lvesv, row.name="LVESV (ml)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_lvedvi, row.name="Indexed LVEDV (ml/m<sup>2</sup>)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_lvesvi, row.name="Indexed LVESV (ml/m<sup>2</sup>)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_lvmass, row.name="Left ventricular mass (g)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_lvmassi, row.name="Indexed left ventricular mass (g/m<sup>2</sup>)", subset=!is.na(mri$trtgrp)),
                list(x=mri$cardiac_lvco, row.name="Left ventricular cardiac output (l/min)", subset=!is.na(mri$trtgrp)),
                list(x=mri$cardiac_lvcoi, row.name="Indexed left ventricular cardiac output (l/min/m<sup>2</sup>)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_laa, row.name="Left atrial area (cm<sup>2</sup>)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_raa, row.name="Right atrial area (cm<sup>2</sup>)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_abnormlge, row.name="Abnormal late gadolinium enhancement", x.levels="Yes", subset=!is.na(mri$trtgrp)), 
                if(any(mri$cardiac_abnormlge=="Yes", na.rm=T)) list(x=mri$cardiac_lgepattern, row.name="Abnormal late gadolinium enhancement pattern", subset=mri$cardiac_abnormlge=="Yes"&!is.na(mri$trtgrp)),
                list(x=mri$cardiac_globlge, row.name="Global late gadolinium enhancement (%)", subset=!is.na(mri$trtgrp))
              ), 
              treat=mri$trtgrp, out.file=tables.file)

summary.table(tabnum="2.13.2", 
              tabtext="Cardiac MRI (part 2).", 
              basedata=list(
                list(x=mri$cardiac_grs, row.name="Global radial strain (%)", subset=!is.na(mri$trtgrp)),
                list(x=mri$cardiac_gcs, row.name="Global circumferential strain (%)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_gls, row.name="Global longitudinal strain (%)", subset=!is.na(mri$trtgrp)),
                list(x=mri$cardiac_avgt1, row.name="Average global T1 relaxation time (ms)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_avgpct1, row.name="Average global post-contrast T1 relaxation time (ms)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_globt2, row.name="Global T2 relaxation time (ms)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_globecv, row.name="Global extra-cellular volume (%)", subset=!is.na(mri$trtgrp)),
                list(x=mri$cardiac_strglmbf, row.name="Global myocardial blood flow during stress (ml/min/g)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_strenmbf, row.name="Global endocardial myocardial blood flow during stress (ml/min/g)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_strepmbf, row.name="Global epicardial myocardial blood flow during stress (ml/min/g)", subset=!is.na(mri$trtgrp)),
                list(x=mri$cardiac_restglmbf, row.name="Global myocardial blood flow at rest (ml/min/g)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_restenmbf, row.name="Global endocardial myocardial blood flow at rest (ml/min/g)", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_restepmbf, row.name="Global epicardial myocardial blood flow at rest (ml/min/g)", subset=!is.na(mri$trtgrp)),
                list(x=mri$cardiac_glmpr, row.name="Global myocardial perfusion reserve", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_enmpr, row.name="Global endocardial myocardial perfusion reserve", subset=!is.na(mri$trtgrp)), 
                list(x=mri$cardiac_epmpr, row.name="Global epicardial myocardial perfusion reserve", subset=!is.na(mri$trtgrp)),
                list(x=mri$cardiac_enepres, row.name="Global endocardial: epicardial myocardial perfusion reserve ratio", subset=!is.na(mri$trtgrp))
              ), 
              treat=mri$trtgrp, out.file=tables.file)

#### 3.X: PRIMARY OUTCOMES (STUDY AND TRIAL) ####
#### PRIM OUT - DIAGNOSTIC STUDY
summary.table(tabnum="3.1.1", 
              tabtext="Primary outcome (diagnostic study): clinician questionnaire post-angiogram, pre-randomisation.", 
              basedata=list(
                list(x=clinq$pre_symp, row.name="Assessment of symptoms", subset=clinq$randyn=="Yes"), 
                list(x=clinq$prediag_cad, row.name="Likelihood of CAD", subset=clinq$randyn=="Yes"),
                list(x=clinq$prediag_obscad, row.name="Likelihood of angina due to obstructive CAD", subset=clinq$randyn=="Yes"), 
                list(x=clinq$prediag_mva, row.name="Likelihood of microvascular angina", subset=clinq$randyn=="Yes"),
                list(x=clinq$prediag_vsa, row.name="Likelihood of vasospastic angina", subset=clinq$randyn=="Yes"),
                list(x=clinq$prediag_noncard, row.name="Likelihood of non-cardiac chest pain", subset=clinq$randyn=="Yes"), 
                list(x=clinq$pre_likelydiag, row.name="Most likely diagnosis", subset=clinq$randyn=="Yes"), 
                list(x=clinq$pre_trtchg, row.name="Change in treatment plan", x.levels="Yes", subset=clinq$randyn=="Yes"),
                if(any(clinq$pre_trtchg=="Yes", na.rm=T)) list(x=clinq$pre_trtchgspec, row.name="Type of change in treatment plan", subset=clinq$pre_trtchg=="Yes"&clinq$randyn=="Yes"),
                list(x=clinq$pre_prevther, row.name="Preventative therapy included", subset=clinq$randyn=="Yes", x.levels="Yes"),
                list(x=clinq$pre_angther, row.name="Angina therapy included", subset=clinq$randyn=="Yes", x.levels="Yes"),
                if(any(clinq$pre_angther=="Yes", na.rm=T)) list(x=clinq$pre_angtherspec, row.name="If included, change in angina therapy", 
                                                                subset=clinq$pre_angther=="Yes"&clinq$randyn=="Yes", x.levels="Yes"),
                if(any(clinq$pre_angtherspec=="Yes", na.rm=T)) list(x=clinq$pre_cordisfunc, row.name="If changing angina therapy, for a disorder of coronary function", 
                                                                    subset=clinq$pre_angther=="Yes"&clinq$pre_angtherspec=="Yes"&clinq$randyn=="Yes", x.levels="Yes"),
                if(any(clinq$pre_trtchg=="Yes", na.rm=T)) list(x=clinq$pre_chgincfind, row.name="Change in onward management due to actionable incidental finding", 
                                                               subset=clinq$randyn=="Yes", x.levels="Yes"),
                list(x=clinq$pre_addtest, row.name="Additional diagnostic testing planned", x.levels="Yes", subset=clinq$randyn=="Yes"),
                if(any(clinq$pre_addtest=="Yes", na.rm=T)) list(x=clinq$pre_cvtest, row.name="Additional cardiovascular testing planned", x.levels="Yes", 
                                                                subset=clinq$pre_addtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_cvtest=="Yes", na.rm=T)) list(x=clinq$pre_echo, row.name="Echocardiogram", x.levels="Yes", 
                                                               subset=clinq$pre_addtest=="Yes"&clinq$pre_cvtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_cvtest=="Yes", na.rm=T)) list(x=clinq$pre_cvctscan, row.name="CT scan", x.levels="Yes", 
                                                               subset=clinq$pre_addtest=="Yes"&clinq$pre_cvtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_cvtest=="Yes", na.rm=T)) list(x=clinq$pre_cvmri, row.name="MRI", x.levels="Yes", 
                                                               subset=clinq$pre_addtest=="Yes"&clinq$pre_cvtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_cvtest=="Yes", na.rm=T)) list(x=clinq$pre_nuclear, row.name="Nuclear", x.levels="Yes", 
                                                               subset=clinq$pre_addtest=="Yes"&clinq$pre_cvtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_cvtest=="Yes", na.rm=T)) list(x=clinq$pre_ambecg, row.name="Ambulatory ECG", x.levels="Yes", 
                                                               subset=clinq$pre_addtest=="Yes"&clinq$pre_cvtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_cvtest=="Yes", na.rm=T)) list(x=clinq$pre_ambbp, row.name="Ambulatory BP", x.levels="Yes", 
                                                               subset=clinq$pre_addtest=="Yes"&clinq$pre_cvtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_addtest=="Yes", na.rm=T)) list(x=clinq$pre_noncvtest, row.name="Additional non-cardiovascular testing planned", x.levels="Yes", 
                                                                subset=clinq$pre_addtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_noncvtest=="Yes", na.rm=T)) list(x=clinq$pre_ultra, row.name="Ultrasound", x.levels="Yes", 
                                                                  subset=clinq$pre_addtest=="Yes"&clinq$pre_noncvtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_noncvtest=="Yes", na.rm=T)) list(x=clinq$pre_noncvctscan, row.name="CT scan", x.levels="Yes", 
                                                                  subset=clinq$pre_addtest=="Yes"&clinq$pre_noncvtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_noncvtest=="Yes", na.rm=T)) list(x=clinq$pre_noncvmri, row.name="MRI", x.levels="Yes", 
                                                                  subset=clinq$pre_addtest=="Yes"&clinq$pre_noncvtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_noncvtest=="Yes", na.rm=T)) list(x=clinq$pre_endo, row.name="Endoscopy", x.levels="Yes", 
                                                                  subset=clinq$pre_addtest=="Yes"&clinq$pre_noncvtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_noncvtest=="Yes", na.rm=T)) list(x=clinq$pre_resp, row.name="Respiratory", x.levels="Yes", 
                                                                  subset=clinq$pre_addtest=="Yes"&clinq$pre_noncvtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_noncvtest=="Yes", na.rm=T)) list(x=clinq$pre_psych, row.name="Psychology", x.levels="Yes", 
                                                                  subset=clinq$pre_addtest=="Yes"&clinq$pre_noncvtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_noncvtest=="Yes", na.rm=T)) list(x=clinq$pre_pft, row.name="PFT", x.levels="Yes", 
                                                                  subset=clinq$pre_addtest=="Yes"&clinq$pre_noncvtest=="Yes"&clinq$randyn=="Yes"),
                if(any(clinq$pre_noncvtest=="Yes", na.rm=T)) list(x=clinq$pre_othertest, row.name="Other", x.levels="Yes", 
                                                                  subset=clinq$pre_addtest=="Yes"&clinq$pre_noncvtest=="Yes"&clinq$randyn=="Yes"),
                list(x=clinq$pre_disch, row.name="Patient to be discharged", x.levels="Yes", subset=clinq$randyn=="Yes"),
                list(x=clinq$pre_refer, row.name="Patient to be referred to a different specialty", x.levels="Yes", subset=clinq$randyn=="Yes")
              ), 
              treat=clinq$trtgrp, out.file=tables.file)

tab_3_1_2 <- list(head=
                    rbindTable(
                      list(Text="<b>Table 3.1.2: Primary outcome (diagnostic study): Diagnosis post-angiogram, pre-randomisation, and post-randomisation, post-MRI.", 
                           Other=list(colspan=7)), 
                      cbindTable("", "", "", "All", "", "Control", "Intervention")
                      ),
                  body=
                    rbindTable(
                      summary.N(x=diagnoses$clinq_diag, row.name="Post-angiogram, pre-randomisation diagnosis recorded", subset=!is.na(diagnoses$trtgrp), treat=diagnoses$trtgrp),
                      summary.cat(x=diagnoses$clinq_diag, row.name="Post-angiogram, pre-randomisation diagnosis", subset=!is.na(diagnoses$trtgrp), treat=diagnoses$trtgrp),
                      summary.N(x=diagnoses$mridiag, row.name="Post-randomisation, post-MRI diagnosis recorded", subset=!is.na(diagnoses$trtgrp)&!is.na(diagnoses$mridiag), treat=diagnoses$trtgrp),
                      summary.cat(x=diagnoses$clinq_diag, row.name="Post-angiogram, pre-randomisation diagnosis (of those with both diagnoses recorded)", subset=!is.na(diagnoses$trtgrp)&!is.na(diagnoses$mridiag), treat=diagnoses$trtgrp),
                      summary.cat(x=diagnoses$mridiag, row.name="Post-randomisation, post-MRI diagnosis", subset=!is.na(diagnoses$trtgrp)&!is.na(diagnoses$diag_changed), treat=diagnoses$trtgrp),
                      summary.cat(x=diagnoses$change_in_diag, row.name="Change in diagnosis", subset=!is.na(diagnoses$trtgrp)&!is.na(diagnoses$diag_changed), treat=diagnoses$trtgrp),
                      summary.cat(x=diagnoses$diag_changed, row.name="Diagnosis reclassified", subset=!is.na(diagnoses$trtgrp)&!is.na(diagnoses$diag_changed), treat=diagnoses$trtgrp, x.levels="Yes"),
                      cbindTable("", list(Text="Fisher test for reclassification rate by randomised group", Other=list(colspan=3)), "", 
                                 list(Text=p.format(fisher.test(diagnoses$diag_changed, diagnoses$trtgrp)$p.value), Other=list(colspan=2))),
                      end.row(disclaimer=T)
                      )
                    )
ExportTable.HTML(tab_3_1_2$head, tab_3_1_2$body, horiz.fmt, filename=tables.file, first=F, last=F)

tab_3_1_3 <- list(head=rbindTable(list(Text="<b>Table 3.1.3: Cross-tabulation of diagnoses - randomised population."), 
                                  cbindTable("", list(Text="Pre-randomisation diagnosis", Other=list(colspan=5))),
                                  cbindTable("Post-randomisation diagnosis", 
                                             "Obstructive CAD", "Microvascular angina", "Vasospastic angina", "Non-cardiac chest pain", "Other")
                                  ),
                  body=rbindTable(cbindTable("Obstructive CAD", 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Obstructive CAD" & !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Obstructive CAD"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Obstructive CAD"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Obstructive CAD"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]),
                                             nrow(diagnoses[diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Obstructive CAD"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),])), 
                                  cbindTable("Microvascular angina", 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]),
                                             nrow(diagnoses[diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),])), 
                                  cbindTable("Vasospastic angina", 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]),
                                             nrow(diagnoses[diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),])),
                                  cbindTable("Non-cardiac chest pain", 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]),
                                             nrow(diagnoses[diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),])), 
                                  cbindTable("Other", 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Other"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Other"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Other"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                                             nrow(diagnoses[diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Other"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]),
                                             nrow(diagnoses[diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Other"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),])), 
                                  end.row(disclaimer=T))
                  
                  )
ExportTable.HTML(tab_3_1_3$head, tab_3_1_3$body, horiz.fmt, filename=tables.file, first=F, last=F)

tab_3_1_4 <- list(head=rbindTable(list(Text="<b>Table 3.1.4: Cross-tabulation of diagnoses - control group."), 
                                  cbindTable("", list(Text="Pre-randomisation diagnosis", Other=list(colspan=5))),
                                  cbindTable("Post-randomisation diagnosis", 
                                             "Obstructive CAD", "Microvascular angina", "Vasospastic angina", "Non-cardiac chest pain", "Other")
),
body=rbindTable(cbindTable("Obstructive CAD", 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Obstructive CAD"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Obstructive CAD"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Obstructive CAD"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Obstructive CAD"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]),
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Obstructive CAD"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),])), 
                cbindTable("Microvascular angina", 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]),
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),])), 
                cbindTable("Vasospastic angina", 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]),
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),])),
                cbindTable("Non-cardiac chest pain", 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]),
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),])), 
                cbindTable("Other", 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Other",]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Other",]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Other",]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Other",]),
                           nrow(diagnoses[diagnoses$trtgrp=="Control" & diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Other",])), 
                end.row(disclaimer=T))

)
ExportTable.HTML(tab_3_1_4$head, tab_3_1_4$body, horiz.fmt, filename=tables.file, first=F, last=F)

tab_3_1_5 <- list(head=rbindTable(list(Text="<b>Table 3.1.5: Cross-tabulation of diagnoses - intervention group."), 
                                  cbindTable("", list(Text="Pre-randomisation diagnosis", Other=list(colspan=5))),
                                  cbindTable("Post-randomisation diagnosis", 
                                             "Obstructive CAD", "Microvascular angina", "Vasospastic angina", "Non-cardiac chest pain", "Other")
),
body=rbindTable(cbindTable("Obstructive CAD", 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Obstructive CAD"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Obstructive CAD"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Obstructive CAD"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Obstructive CAD"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]),
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Obstructive CAD"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),])), 
                cbindTable("Microvascular angina", 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]),
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Microvascular angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),])), 
                cbindTable("Vasospastic angina", 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]),
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Vasospastic angina"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),])),
                cbindTable("Non-cardiac chest pain", 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]),
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Non-cardiac chest pain"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),])), 
                cbindTable("Other", 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Obstructive CAD" & diagnoses$mridiag=="Other"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Microvascular angina" & diagnoses$mridiag=="Other"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Vasospastic angina" & diagnoses$mridiag=="Other"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]), 
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Non-cardiac chest pain" & diagnoses$mridiag=="Other"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),]),
                           nrow(diagnoses[diagnoses$trtgrp=="Intervention" & diagnoses$clinq_diag=="Other" & diagnoses$mridiag=="Other"& !is.na(diagnoses$trtgrp) & !is.na(diagnoses$clinq_diag) & !is.na(diagnoses$mridiag),])), 
                end.row(disclaimer=T))

)
ExportTable.HTML(tab_3_1_5$head, tab_3_1_5$body, horiz.fmt, filename=tables.file, first=F, last=F)

#### PRIM OUT - TRIAL
summary.table(tabnum="3.2.1", 
              tabtext="Primary outcome (nested trial): Seattle Angina Questionnaire at screening.", 
              basedata=list(
                list(x=outcomes$saq_pl, row.name="Physical limitation score", ndp=1, 
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$saq_af, row.name="Angina frequency score", ndp=1, 
                     subset=outcomes$visittypeid==1), 
                list(x=outcomes$saq_ql, row.name="Quality of life score", ndp=1, 
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$saq_st, row.name="Stability score", ndp=1, 
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$saq_ts, row.name="Treatment satisfaction score", ndp=1, 
                     subset=outcomes$visittypeid==1), 
                list(x=outcomes$saq_summ, row.name="SAQ summary score", ndp=1, 
                     subset=outcomes$visittypeid==1)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="3.2.2", 
              tabtext="Primary outcome (nested trial): Seattle Angina Questionnaire at 6 months.", 
              basedata=list(
                list(x=outcomes$saq_pl, row.name="Physical limitation score", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$saq_af, row.name="Angina frequency score", ndp=1, 
                     subset=outcomes$visittypeid==3), 
                list(x=outcomes$saq_ql, row.name="Quality of life score", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$saq_st, row.name="Stability score", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$saq_ts, row.name="Treatment satisfaction score", ndp=1, 
                     subset=outcomes$visittypeid==3), 
                list(x=outcomes$saq_summ, row.name="SAQ summary score", ndp=1, 
                     subset=outcomes$visittypeid==3)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="3.2.3",
              tabtext="Primary outcome (nested trial): Seattle Angina Questionnaire at 12 months.",
              basedata=list(
                list(x=outcomes$saq_pl, row.name="Physical limitation score", ndp=1,
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$saq_af, row.name="Angina frequency score", ndp=1,
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$saq_ql, row.name="Quality of life score", ndp=1,
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$saq_st, row.name="Stability score", ndp=1,
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$saq_ts, row.name="Treatment satisfaction score", ndp=1,
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$saq_summ, row.name="SAQ summary score", ndp=1,
                     subset=outcomes$visittypeid==4)
              ),
              treat=outcomes$trtgrp, out.file=tables.file)

cts.out.tab(tabnum="3.2.4", 
            tabtext="Primary outcome (nested trial) analysis: Seattle Angina Questionnaire summary score - baseline and 6 months.",
            xname="saq_summ", blvis="visit_1", fuvis="visit_3", vardesc="SAQ summary score", 
            moddesc=paste("Linear regression intervention effect estimate, adjusted for",
                          "baseline SAQ summary score, age, sex, diabetes, prior myocardial", 
                          "infarction, coronary artery disease, LV systolic function, and site (lead vs other)."))
cts.out.tab(tabnum="3.2.5", 
            tabtext="Primary outcome (nested trial) analysis: Seattle Angina Questionnaire summary score - baseline and 12 months.",
            xname="saq_summ", blvis="visit_1", fuvis="visit_4", vardesc="SAQ summary score", 
            moddesc=paste("Linear regression intervention effect estimate, adjusted for",
                          "baseline SAQ summary score, age, sex, diabetes, prior myocardial", 
                          "infarction, coronary artery disease, LV systolic function, and site (lead vs other)."))


#### 4.X: SECONDARY OUTCOMES ####
outcomes$sae_rel <- saes$relation[match(outcomes$sno, saes$sno)]
# Secondary objective 1
summary.table(tabnum="4.1", 
              tabtext="Secondary outcomes: feasibility of MRI strategy, blinding effectiveness, and SAEs related to the intervention.", 
              basedata=list(
                list(x=outcomes$trtgrp, row.name="N with pre-randomisation diagnosis", nrow=T, subset=outcomes$visittypeid==1&!is.na(outcomes$clinqdiag)),
                list(x=outcomes$trtgrp, row.name="N randomised", nrow=T, subset=outcomes$visittypeid==1&!is.na(outcomes$trtgrp)), 
                list(x=outcomes$mridiag, row.name="N with MRI diagnosis at MRI visit", nrow=T, subset=outcomes$visittypeid==2&!is.na(outcomes$mridiag)),
                list(x=outcomes$blind1, row.name="Clinician informed of randomised group allocation?", x.levels="Yes", subset=outcomes$visittypeid==4),
                list(x=outcomes$blind2, row.name="Clinician aware of randomised group allocation (if not informed)?", x.levels="Yes", subset=outcomes$visittypeid==4&outcomes$blind1=="No"), 
                list(x=outcomes$blind3, row.name="Participant informed of randomised group allocation?", x.levels="Yes", subset=outcomes$visittypeid==4),
                list(x=outcomes$blind4, row.name="Participant aware of randomised group allocation (if not informed)?", x.levels="Yes", subset=outcomes$visittypeid==4&outcomes$blind3=="No"),
                list(x=outcomes$sae_rel, row.name="SAE related to intervention (of those who had any SAE)", x.levels="Yes", subset=is.element(outcomes$sno, saes$sno) & outcomes$visittypeid==4)
                ), 
              treat=outcomes$trtgrp, out.file=tables.file)

# secondary objective 2
outcomes$any_angther <- factor(ifelse(rowSums(outcomes[, c("beta", "gtn", "nitr", "nico", "ccb_any", "ivab", "rano", "trime")]=="Yes", na.rm=T) > 0, "Yes", "No"))
sec_tab_421 <- list(head=rbindTable(list(Text="<b>Table 4.2.1: Secondary outcomes: impact of MRI disclosure on medical management. Angina therapy at baseline."), 
                                    cbindTable("", "", "", "All", "", "Control", "Intervention")), 
                    body=rbindTable(summary.cat(x=outcomes$beta, row.name="Beta-blocker", x.levels="Yes",
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$gtn, row.name="GTN", x.levels="Yes",
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$nitr, row.name="Nitrate", x.levels="Yes",
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$nico, row.name="Nicorandil", x.levels="Yes",
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$ccb_any, row.name="Calcium channel blocker", x.levels="Yes",
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$ivab, row.name="Ivabradine", x.levels="Yes",
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$rano, row.name="Ranolazine", x.levels="Yes",
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$trime, row.name="Trimetazidine", x.levels="Yes",
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$any_angther, row.name="Any of the above", x.levels="Yes",
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    cbindTable("", list(Text="Fisher test for any angina therapy at baseline by randomised group", Other=list(colspan=3)), "",
                                               list(Text=p.format(fisher.test(outcomes$any_angther[outcomes$visittypeid==1], outcomes$trtgrp[outcomes$visittypeid==1])$p.value), Other=list(colspan=2))),
                                    end.row(disclaimer=T))
                    )
ExportTable.HTML(sec_tab_421$head, sec_tab_421$body, horiz.fmt, filename=tables.file, first=F, last=F)

sec_tab_422 <- list(head=rbindTable(list(Text="<b>Table 4.2.2: Secondary outcomes: impact of MRI disclosure on medical management. Angina therapy at 6 months."), 
                                    cbindTable("", "", "", "All", "", "Control", "Intervention")), 
                    body=rbindTable(summary.cat(x=outcomes$beta, row.name="Beta-blocker", x.levels="Yes",
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$gtn, row.name="GTN", x.levels="Yes",
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$nitr, row.name="Nitrate", x.levels="Yes",
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$nico, row.name="Nicorandil", x.levels="Yes",
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp), 
                                    summary.cat(x=outcomes$ccb_any, row.name="Calcium channel blocker", x.levels="Yes",
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$ivab, row.name="Ivabradine", x.levels="Yes",
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$rano, row.name="Ranolazine", x.levels="Yes",
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$trime, row.name="Trimetazidine", x.levels="Yes",
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$any_angther, row.name="Any of the above", x.levels="Yes", 
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp), 
                                    cbindTable("", list(Text="Fisher test for any angina therapy at 6 months by randomised group", Other=list(colspan=3)), "", 
                                               list(Text=p.format(fisher.test(outcomes$any_angther[outcomes$visittypeid==3], outcomes$trtgrp[outcomes$visittypeid==3])$p.value), Other=list(colspan=2))),
                                    end.row(disclaimer=T))
)
ExportTable.HTML(sec_tab_422$head, sec_tab_422$body, horiz.fmt, filename=tables.file, first=F, last=F)

sec_tab_423 <- list(head=rbindTable(list(Text="<b>Table 4.2.3: Secondary outcomes: impact of MRI disclosure on medical management. Angina therapy at 12 months."), 
                                    cbindTable("", "", "", "All", "", "Control", "Intervention")), 
                    body=rbindTable(summary.cat(x=outcomes$beta, row.name="Beta-blocker", x.levels="Yes",
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$gtn, row.name="GTN", x.levels="Yes",
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$nitr, row.name="Nitrate", x.levels="Yes",
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$nico, row.name="Nicorandil", x.levels="Yes",
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp), 
                                    summary.cat(x=outcomes$ccb_any, row.name="Calcium channel blocker", x.levels="Yes",
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$ivab, row.name="Ivabradine", x.levels="Yes",
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$rano, row.name="Ranolazine", x.levels="Yes",
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$trime, row.name="Trimetazidine", x.levels="Yes",
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$any_angther, row.name="Any of the above", x.levels="Yes", 
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp), 
                                    cbindTable("", list(Text="Fisher test for any angina therapy at 12 months by randomised group", Other=list(colspan=3)), "", 
                                               list(Text=p.format(fisher.test(outcomes$any_angther[outcomes$visittypeid==4], outcomes$trtgrp[outcomes$visittypeid==4])$p.value), Other=list(colspan=2))),
                                    end.row(disclaimer=T))
)
ExportTable.HTML(sec_tab_423$head, sec_tab_423$body, horiz.fmt, filename=tables.file, first=F, last=F)

outcomes$any_prevther <- factor(ifelse(rowSums(outcomes[, c("asp", "ezem", "pcsk", "omeg", "antip", "ace", "arb", "stat", "arni", "sglt", "fibr")]=="Yes", na.rm=T) > 0, "Yes", "No"))
sec_tab_424 <- list(head=rbindTable(list(Text="<b>Table 4.2.4: Secondary outcomes: impact of MRI disclosure on medical management. Preventative therapy at baseline."), 
                                    cbindTable("", "", "", "All", "", "Control", "Intervention")), 
                    body=rbindTable(summary.cat(x=outcomes$asp, row.name="Aspirin", x.levels="Yes", 
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp), 
                                    summary.cat(x=outcomes$ezem, row.name="Ezetimibe", x.levels="Yes", 
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$pcsk, row.name="PCSK9 inhibitor", x.levels="Yes", 
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$omeg, row.name="Omega-3 fatty acid", x.levels="Yes", 
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$antip, row.name="Other antiplatelet", x.levels="Yes",
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$ace, row.name="ACE inhibitor", x.levels="Yes", 
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$arb, row.name="ARB", x.levels="Yes", 
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$stat, row.name="Statin", x.levels="Yes",
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$arni, row.name="ARNI", x.levels="Yes", 
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$sglt, row.name="SGLT2", x.levels="Yes", 
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp), 
                                    summary.cat(x=outcomes$fibr, row.name="Fibrates", x.levels="Yes", 
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$any_prevther, row.name="Any of the above", x.levels="Yes", 
                                                subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                                    cbindTable("", list(Text="Fisher test for any preventative therapy at baseline by randomised group", Other=list(colspan=3)), "", 
                                               list(Text=p.format(fisher.test(outcomes$any_prevther[outcomes$visittypeid==1], outcomes$trtgrp[outcomes$visittypeid==1])$p.value), Other=list(colspan=2))),
                                    end.row(disclaimer=T))
)
ExportTable.HTML(sec_tab_424$head, sec_tab_424$body, horiz.fmt, filename=tables.file, first=F, last=F)

sec_tab_425 <- list(head=rbindTable(list(Text="<b>Table 4.2.5: Secondary outcomes: impact of MRI disclosure on medical management. Preventative therapy at 6 months."), 
                                    cbindTable("", "", "", "All", "", "Control", "Intervention")), 
                    body=rbindTable(summary.cat(x=outcomes$asp, row.name="Aspirin", x.levels="Yes", 
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp), 
                                    summary.cat(x=outcomes$ezem, row.name="Ezetimibe", x.levels="Yes", 
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$pcsk, row.name="PCSK9 inhibitor", x.levels="Yes", 
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$omeg, row.name="Omega-3 fatty acid", x.levels="Yes", 
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$antip, row.name="Other antiplatelet", x.levels="Yes",
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$ace, row.name="ACE inhibitor", x.levels="Yes", 
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$arb, row.name="ARB", x.levels="Yes", 
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$stat, row.name="Statin", x.levels="Yes",
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$arni, row.name="ARNI", x.levels="Yes", 
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$sglt, row.name="SGLT2", x.levels="Yes", 
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp), 
                                    summary.cat(x=outcomes$fibr, row.name="Fibrates", x.levels="Yes", 
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$any_prevther, row.name="Any of the above", x.levels="Yes", 
                                                subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                                    cbindTable("", list(Text="Fisher test for any preventative therapy at 6 months by randomised group", Other=list(colspan=3)), "", 
                                               list(Text=p.format(fisher.test(outcomes$any_prevther[outcomes$visittypeid==3], outcomes$trtgrp[outcomes$visittypeid==3])$p.value), Other=list(colspan=2))),
                                    end.row(disclaimer=T))
)
ExportTable.HTML(sec_tab_425$head, sec_tab_425$body, horiz.fmt, filename=tables.file, first=F, last=F)

sec_tab_426 <- list(head=rbindTable(list(Text="<b>Table 4.2.6: Secondary outcomes: impact of MRI disclosure on medical management. Preventative therapy at 12 months."), 
                                    cbindTable("", "", "", "All", "", "Control", "Intervention")), 
                    body=rbindTable(summary.cat(x=outcomes$asp, row.name="Aspirin", x.levels="Yes", 
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp), 
                                    summary.cat(x=outcomes$ezem, row.name="Ezetimibe", x.levels="Yes", 
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$pcsk, row.name="PCSK9 inhibitor", x.levels="Yes", 
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$omeg, row.name="Omega-3 fatty acid", x.levels="Yes", 
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$antip, row.name="Other antiplatelet", x.levels="Yes",
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$ace, row.name="ACE inhibitor", x.levels="Yes", 
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$arb, row.name="ARB", x.levels="Yes", 
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$stat, row.name="Statin", x.levels="Yes",
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$arni, row.name="ARNI", x.levels="Yes", 
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$sglt, row.name="SGLT2", x.levels="Yes", 
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp), 
                                    summary.cat(x=outcomes$fibr, row.name="Fibrates", x.levels="Yes", 
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    summary.cat(x=outcomes$any_prevther, row.name="Any of the above", x.levels="Yes", 
                                                subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                                    cbindTable("", list(Text="Fisher test for any preventative therapy at 12 months by randomised group", Other=list(colspan=3)), "", 
                                               list(Text=p.format(fisher.test(outcomes$any_prevther[outcomes$visittypeid==4], outcomes$trtgrp[outcomes$visittypeid==4])$p.value), Other=list(colspan=2))),
                                    end.row(disclaimer=T))
)
ExportTable.HTML(sec_tab_426$head, sec_tab_426$body, horiz.fmt, filename=tables.file, first=F, last=F)

# secondary objective 9 
# eq5d
summary.table(tabnum="4.3.1", 
              tabtext="Secondary outcomes: health status - EQ-5D scores.", 
              basedata=list(
                list(x=outcomes$eq5d_score, row.name="EQ-5D score at screening", ndp=1, 
                     subset=outcomes$visittypeid==1), 
                list(x=outcomes$eq5d_health, row.name="EQ-5D VAS at screening", ndp=1, 
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$eq5d_score, row.name="EQ-5D score at 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3), 
                list(x=outcomes$eq5d_score_ch, row.name="EQ-5D score change from baseline to 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$eq5d_health, row.name="EQ-5D VAS at 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$eq5d_health_ch, row.name="EQ-5D VAS change from baseline to 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$eq5d_score, row.name="EQ-5D score at 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4), 
                list(x=outcomes$eq5d_score_ch, row.name="EQ-5D score change from baseline to 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$eq5d_health, row.name="EQ-5D VAS at 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$eq5d_health_ch, row.name="EQ-5D score change from baseline to 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)
cts.out.tab(tabnum="4.3.2", digits=2, digits.summ=3,
            tabtext="Secondary outcomes: health status - EQ-5D scores.",
            xname="eq5d_score", blvis="visit_1", fuvis="visit_3", vardesc="EQ-5D score", 
            moddesc=paste("Linear regression intervention effect estimate for EQ-5D at 6 months, adjusted for",
                          "baseline EQ-5D score, age, sex, diabetes, prior myocardial", 
                          "infarction, coronary artery disease, LV systolic function, and site (lead vs other)."))
cts.out.tab(tabnum="4.3.3", digits=2, digits.summ=3,
            tabtext="Secondary outcomes: health status - EQ-5D scores.",
            xname="eq5d_score", blvis="visit_1", fuvis="visit_4", vardesc="EQ-5D score", 
            moddesc=paste("Linear regression intervention effect estimate for EQ-5D at 12 months, adjusted for",
                          "baseline EQ-5D score, age, sex, diabetes, prior myocardial", 
                          "infarction, coronary artery disease, LV systolic function, and site (lead vs other)."))

summary.table(tabnum="4.3.4", 
              tabtext="Secondary outcomes: health status - Seattle Angina Questionnaire at baseline.", 
              basedata=list(
                list(x=outcomes$saq_pl, row.name="Physical limitation score at baseline", ndp=1, 
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$saq_af, row.name="Angina frequency score at baseline", ndp=1, 
                     subset=outcomes$visittypeid==1), 
                list(x=outcomes$saq_ql, row.name="Quality of life score at baseline", ndp=1, 
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$saq_st, row.name="Stability score at baseline", ndp=1, 
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$saq_ts, row.name="Treatment satisfaction score at baseline", ndp=1, 
                     subset=outcomes$visittypeid==1), 
                list(x=outcomes$saq_summ, row.name="SAQ summary score at baseline", ndp=1, 
                     subset=outcomes$visittypeid==1)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="4.3.5", 
              tabtext="Secondary outcomes: health status - Seattle Angina Questionnaire at 6 months and changes from baseline.", 
              basedata=list(
                list(x=outcomes$saq_pl, row.name="Physical limitation score at 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$saq_pl_ch, row.name="Change in physical limitation score: baseline to 6 months", 
                     ndp=1, subset=outcomes$visittypeid==3),
                list(x=outcomes$saq_af, row.name="Angina frequency score at 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3), 
                list(x=outcomes$saq_af_ch, row.name="Change in angina frequency score: baseline to 6 months", 
                     ndp=1, subset=outcomes$visittypeid==3),
                list(x=outcomes$saq_ql, row.name="Quality of life score at 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$saq_ql_ch, row.name="Change in quality of life score: baseline to 6 months", 
                     ndp=1, subset=outcomes$visittypeid==3),
                list(x=outcomes$saq_st, row.name="Stability score at 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$saq_st_ch, row.name="Change in stability score: baseline to 6 months", 
                     ndp=1, subset=outcomes$visittypeid==3),
                list(x=outcomes$saq_ts, row.name="Treatment satisfaction score at 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3), 
                list(x=outcomes$saq_ts_ch, row.name="Change in treatment satisfaction score: baseline to 6 months", 
                     ndp=1, subset=outcomes$visittypeid==3),
                list(x=outcomes$saq_summ, row.name="SAQ summary score at 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$saq_summ_ch, row.name="Change in summary score: baseline to 6 months", 
                     ndp=1, subset=outcomes$visittypeid==3)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="4.3.6", 
              tabtext="Secondary outcomes: health status - Seattle Angina Questionnaire at 12 months and changes from baseline.", 
              basedata=list(
                list(x=outcomes$saq_pl, row.name="Physical limitation score at 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$saq_pl_ch, row.name="Change in physical limitation score: baseline to 12 months", 
                     ndp=1, subset=outcomes$visittypeid==4),
                list(x=outcomes$saq_af, row.name="Angina frequency score at 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4), 
                list(x=outcomes$saq_af_ch, row.name="Change in angina frequency score: baseline to 12 months", 
                     ndp=1, subset=outcomes$visittypeid==4),
                list(x=outcomes$saq_ql, row.name="Quality of life score at 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$saq_ql_ch, row.name="Change in quality of life score: baseline to 12 months", 
                     ndp=1, subset=outcomes$visittypeid==4),
                list(x=outcomes$saq_st, row.name="Stability score at 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$saq_st_ch, row.name="Change in stability score: baseline to 12 months", 
                     ndp=1, subset=outcomes$visittypeid==4),
                list(x=outcomes$saq_ts, row.name="Treatment satisfaction score at 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4), 
                list(x=outcomes$saq_ts_ch, row.name="Change in treatment satisfaction score: baseline to 12 months", 
                     ndp=1, subset=outcomes$visittypeid==4),
                list(x=outcomes$saq_summ, row.name="SAQ summary score at 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$saq_summ_ch, row.name="Change in summary score: baseline to 12 months", 
                     ndp=1, subset=outcomes$visittypeid==4)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

sectab_437 <- list(head=rbindTable(list(Text="<b>Table 4.3.7: Secondary outcomes: health status - Seattle Angina Questionnaire (baseline to 6 months).</b>"), 
                                   cbindTable("", 
                                              list(Text=paste("In each case, a linear regression intervention effect estimate for the 6 month value of the score is presented.", 
                                                              "This estimate is adjusted for the baseline value of the score, age, sex, diabetes, prior myocardial infarction,", 
                                                              "coronary artery disease, LV systolic function, and site (lead vs other)."), 
                                                   Other=list(colspan=6)))
                                   ), 
                   body=rbindTable(analysis.cts(xname="saq_pl", blvis="visit_1", fuvis="visit_3", moddesc="SAQ physical limitation", digits.summ=2), 
                                   analysis.cts(xname="saq_af", blvis="visit_1", fuvis="visit_3", moddesc="SAQ angina frequency", digits.summ=2), 
                                   analysis.cts(xname="saq_ql", blvis="visit_1", fuvis="visit_3", moddesc="SAQ quality of life", digits.summ=2),
                                   analysis.cts(xname="saq_st", blvis="visit_1", fuvis="visit_3", moddesc="SAQ stability", digits.summ=2), 
                                   analysis.cts(xname="saq_ts", blvis="visit_1", fuvis="visit_3", moddesc="SAQ treatment satisfaction", digits.summ=2), 
                                   end.row(disclaimer=T)
                                   )
                   )
ExportTable.HTML(sectab_437$head, sectab_437$body, filename=tables.file, first=F, last=F, horiz.fmt)
analysis.cts.diags(xname="saq_pl", blvis="visit_1", fuvis="visit_3", vardesc="SAQ physical limitation (baseline to 6 months)", tabnum="4.3.7.1", diagsfile=diags.file)
analysis.cts.diags(xname="saq_af", blvis="visit_1", fuvis="visit_3", vardesc="SAQ angina frequency (baseline to 6 months)", tabnum="4.3.7.2", diagsfile=diags.file)
analysis.cts.diags(xname="saq_ql", blvis="visit_1", fuvis="visit_3", vardesc="SAQ quality of life (baseline to 6 months)", tabnum="4.3.7.3", diagsfile=diags.file)
analysis.cts.diags(xname="saq_st", blvis="visit_1", fuvis="visit_3", vardesc="SAQ stability (baseline to 6 months)", tabnum="4.3.7.4", diagsfile=diags.file)
analysis.cts.diags(xname="saq_ts", blvis="visit_1", fuvis="visit_3", vardesc="SAQ treatment satisfaction", tabnum="4.3.7.5", diagsfile=diags.file)

sectab_438 <- list(head=rbindTable(list(Text="<b>Table 4.3.8: Secondary outcomes: health status - Seattle Angina Questionnaire (baseline to 12 months).</b>"), 
                                   cbindTable("", 
                                              list(Text=paste("In each case, a linear regression intervention effect estimate for the 12 month value of the score is presented.", 
                                                              "This estimate is adjusted for the baseline value of the score, age, sex, diabetes, prior myocardial infarction,", 
                                                              "coronary artery disease, LV systolic function, and site (lead vs other). Where required, to approximate normality in the model residuals,", 
                                                              "a second model was fitted to transformed data, and the intervention effect estimate from this model is also shown."), 
                                                   Other=list(colspan=6)))
), 
body=rbindTable(analysis.cts(xname="saq_pl", blvis="visit_1", fuvis="visit_4", moddesc="SAQ physical limitation", digits.summ=2), 
                analysis.cts(xname="saq_af", blvis="visit_1", fuvis="visit_4", moddesc="SAQ angina frequency", digits.summ=2), 
                analysis.cts(xname="saq_ql", blvis="visit_1", fuvis="visit_4", moddesc="SAQ quality of life", digits.summ=2),
                analysis.cts(xname="saq_st", blvis="visit_1", fuvis="visit_4", moddesc="SAQ stability", digits.summ=2), 
                analysis.cts(xname="saq_ts", blvis="visit_1", fuvis="visit_4", moddesc="SAQ treatment satisfaction", digits.summ=2), 
                end.row(disclaimer=T)
)
)
ExportTable.HTML(sectab_438$head, sectab_438$body, filename=tables.file, first=F, last=F, horiz.fmt)
analysis.cts.diags(xname="saq_pl", blvis="visit_1", fuvis="visit_4", vardesc="SAQ physical limitation (baseline to 12 months)", tabnum="4.3.8.1", diagsfile=diags.file)
analysis.cts.diags(xname="saq_af", blvis="visit_1", fuvis="visit_4", vardesc="SAQ angina frequency (baseline to 12 months)", tabnum="4.3.8.2", diagsfile=diags.file)
analysis.cts.diags(xname="saq_ql", blvis="visit_1", fuvis="visit_4", vardesc="SAQ quality of life (baseline to 12 months)", tabnum="4.3.8.3", diagsfile=diags.file)
analysis.cts.diags(xname="saq_st", blvis="visit_1", fuvis="visit_4", vardesc="SAQ stability (baseline to 12 months)", tabnum="4.3.8.4", diagsfile=diags.file)
analysis.cts.diags(xname="saq_ts", blvis="visit_1", fuvis="visit_4", vardesc="SAQ treatment satisfaction (baseline to 12 months)", tabnum="4.3.8.5", diagsfile=diags.file)

summary.table(tabnum="4.4.1", 
              tabtext="Secondary outcomes: Brief Illness Perception Questionnaire.", 
              basedata=list(
                list(x=outcomes$bipq_tot, row.name="BIPQ: Screening", subset=outcomes$visittypeid==1, ndp=1),
                list(x=outcomes$bipq_tot, row.name="BIPQ: 6 months", subset=outcomes$visittypeid==3, ndp=1), 
                list(x=outcomes$bipq_tot_ch, row.name="BIPQ: change from screening to 6 months", subset=outcomes$visittypeid==3, ndp=1),
                list(x=outcomes$bipq_tot, row.name="BIPQ: 12 months", subset=outcomes$visittypeid==4, ndp=1),
                list(x=outcomes$bipq_tot_ch, row.name="BIPQ: change from screening to 12 months", subset=outcomes$visittypeid==4, ndp=1),
                list(
                  fun="analysis.cts", xname="bipq_tot", blvis="visit_1", fuvis="visit_3", 
                  moddesc=paste("Linear regression intervention effect estimate for BIPQ at 6 months, adjusted for baseline BIPQ score,", 
                                "age, sex, diabetes, prior myocardial infarction, coronary artery disease, LV systolic function, and site (lead vs other)."),
                  trans=function(x)x,itrans=function(x)x,digits.summ=2,
                  desc=
                    paste("Linear regression intervention effect estimate for BIPQ at 6 months, adjusted for baseline BIPQ score,", 
                          "age, sex, diabetes, prior myocardial infarction, coronary artery disease, LV systolic function, and site (lead vs other).")),
                  list(
                    fun="analysis.cts", xname="bipq_tot", blvis="visit_1", fuvis="visit_4", 
                    moddesc=paste("Linear regression intervention effect estimate for BIPQ at 12 months, adjusted for baseline BIPQ score,", 
                                  "age, sex, diabetes, prior myocardial infarction, coronary artery disease, LV systolic function, and site (lead vs other)."),
                                  trans=function(x)x,itrans=function(x)x,digits.summ=2,
                                  desc=
                                    paste("Linear regression intervention effect estimate for BIPQ at 12 months, adjusted for baseline BIPQ score,", 
                                          "age, sex, diabetes, prior myocardial infarction, coronary artery disease, LV systolic function, and site (lead vs other)."))
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="4.4.2", 
              tabtext="Secondary outcomes: Patient Health Questionnaire (PHQ-4) at baseline.", 
              basedata=list(
                list(x=outcomes$phq_anx, row.name="PHQ anxiety score", ndp=1, subset=outcomes$visittypeid==1), 
                list(x=outcomes$phq_anx_yn, row.name="PHQ anxiety score indicative of anxiety (&ge; 3)", x.levels="Yes", subset=outcomes$visittypeid==1),
                list(x=outcomes$phq_dep, row.name="PHQ depression score", ndp=1, subset=outcomes$visittypeid==1), 
                list(x=outcomes$phq_dep_yn, row.name="PHQ depression score indicative of depression (&ge; 3)", x.levels="Yes", subset=outcomes$visittypeid==1),
                list(x=outcomes$phq_score, row.name="Total PHQ score", ndp=1, subset=outcomes$visittypeid==1),
                list(x=outcomes$phq_score_cat, row.name="Total PHQ score category", subset=outcomes$visittypeid==1)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="4.4.3", 
              tabtext="Secondary outcomes: Patient Health Questionnaire (PHQ-4) at 6 months and changes from baseline.", 
              basedata=list(
                list(x=outcomes$phq_anx, row.name="PHQ anxiety score", ndp=1, subset=outcomes$visittypeid==3), 
                list(x=outcomes$phq_anx_yn, row.name="PHQ anxiety score indicative of anxiety (&ge; 3)", x.levels="Yes", 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$phq_anx_ch, row.name="Change in PHQ anxiety score from baseline to 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3), 
                list(x=outcomes$phq_dep, row.name="PHQ depression score", ndp=1, subset=outcomes$visittypeid==3), 
                list(x=outcomes$phq_dep_yn, row.name="PHQ depression score indicative of depression (&ge; 3)", x.levels="Yes", 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$phq_dep_ch, row.name="Change in PHQ depression score from baseline to 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3), 
                list(x=outcomes$phq_score, row.name="Total PHQ score", ndp=1, subset=outcomes$visittypeid==3),
                list(x=outcomes$phq_score_ch, row.name="Change in total PHQ score from baseline to 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$phq_score_cat, row.name="Total PHQ score category", subset=outcomes$visittypeid==3)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="4.4.4", 
              tabtext="Secondary outcomes: Patient Health Questionnaire (PHQ-4) at 12 months and changes from baseline.", 
              basedata=list(
                list(x=outcomes$phq_anx, row.name="PHQ anxiety score", ndp=1, subset=outcomes$visittypeid==4), 
                list(x=outcomes$phq_anx_yn, row.name="PHQ anxiety score indicative of anxiety (&ge; 3)", x.levels="Yes", 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$phq_anx_ch, row.name="Change in PHQ anxiety score from baseline to 6 months", ndp=1, 
                     subset=outcomes$visittypeid==4), 
                list(x=outcomes$phq_dep, row.name="PHQ depression score", ndp=1, subset=outcomes$visittypeid==4), 
                list(x=outcomes$phq_dep_yn, row.name="PHQ depression score indicative of depression (&ge; 3)", x.levels="Yes", 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$phq_dep_ch, row.name="Change in PHQ depression score from baseline to 6 months", ndp=1, 
                     subset=outcomes$visittypeid==4), 
                list(x=outcomes$phq_score, row.name="Total PHQ score", ndp=1, subset=outcomes$visittypeid==4),
                list(x=outcomes$phq_score_ch, row.name="Change in total PHQ score from baseline to 6 months", ndp=1, 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$phq_score_cat, row.name="Total PHQ score category", subset=outcomes$visittypeid==4)
              ),
              treat=outcomes$trtgrp, out.file=tables.file)

sectab_445 <- list(head=rbindTable(list(Text="<b>Table 4.4.5: Secondary outcomes: health status - Patient Health Questionnaire (PHQ4).</b>", 
                                        Other=list(colspan=7)), 
                                   list(Text=paste("In each case, a linear regression intervention effect is presented for the follow-up value of the relevant PHQ score at follow-up.", 
                                                   "This estimate is adjusted for the baseline value of the variable, age, sex, diabetes, prior myocardial infarction,", 
                                                   "coronary artery disease, LV systolic function, and site (lead vs other)."), 
                                              Other=list(colspan=7)
                                              )
                                   ), 
body=rbindTable(analysis.cts(xname="phq_anx", blvis="visit_1", fuvis="visit_3", digits.summ=2, 
                             moddesc="PHQ anxiety (baseline to 6 months)"), 
                analysis.cts(xname="phq_anx", blvis="visit_1", fuvis="visit_4", digits.summ=2, 
                             moddesc="PHQ anxiety (baseline to 12 months)"), 
                analysis.cts(xname="phq_dep", blvis="visit_1", fuvis="visit_3", digits.summ=2, 
                             moddesc="PHQ depression (baseline to 6 months)"), 
                analysis.cts(xname="phq_dep", blvis="visit_1", fuvis="visit_4", digits.summ=2, 
                             moddesc="PHQ depression (baseline to 12 months)"), 
                end.row(disclaimer=T)
)
)
ExportTable.HTML(sectab_445$head, sectab_445$body, filename=tables.file, first=F, last=F, horiz.fmt)
analysis.cts.diags(xname="phq_anx", blvis="visit_1", fuvis="visit_3", vardesc="PHQ anxiety (baseline to 6 months)", tabnum="4.4.5.1", diagsfile=diags.file)
analysis.cts.diags(xname="phq_anx", blvis="visit_1", fuvis="visit_4", vardesc="PHQ anxiety (baseline to 12 months)", tabnum="4.4.5.2", diagsfile=diags.file)
analysis.cts.diags(xname="phq_dep", blvis="visit_1", fuvis="visit_3", vardesc="PHQ depression (baseline to 6 months)", tabnum="4.4.5.3", diagsfile=diags.file)
analysis.cts.diags(xname="phq_dep", blvis="visit_1", fuvis="visit_4", vardesc="PHQ depression (baseline to 12 months)", tabnum="4.4.5.4", diagsfile=diags.file)

summary.table(tabnum="4.4.6", 
              tabtext="Secondary outcomes: treatment satisfaction (TSQM-9) scores at baseline.", 
              basedata=list(
                list(x=outcomes$tsqm_eff, row.name="Effectiveness", subset=outcomes$visittypeid==1, ndp=1),
                list(x=outcomes$tsqm_conv, row.name="Convenience", subset=outcomes$visittypeid==1, ndp=1),
                list(x=outcomes$tsqm_sat, row.name="Overall satisfaction", subset=outcomes$visittypeid==1, ndp=1)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="4.4.7", 
              tabtext="Secondary outcomes: treatment satisfaction (TSQM-9) scores at 6 months and changes from baseline.", 
              basedata=list(
                list(x=outcomes$tsqm_eff, row.name="Effectiveness", subset=outcomes$visittypeid==3, ndp=1),
                list(x=outcomes$tsqm_eff_ch, row.name="Change in effectiveness from baseline to 6 months", 
                     subset=outcomes$visittypeid==3, ndp=1),
                list(x=outcomes$tsqm_conv, row.name="Convenience", subset=outcomes$visittypeid==3, ndp=1),
                list(x=outcomes$tsqm_conv_ch, row.name="Change in convenience from baseline to 6 months", 
                     subset=outcomes$visittypeid==3, ndp=1),
                list(x=outcomes$tsqm_sat, row.name="Overall satisfaction", subset=outcomes$visittypeid==3, ndp=1),
                list(x=outcomes$tsqm_sat_ch, row.name="Change in overall satisfaction from baseline to 6 months", 
                     subset=outcomes$visittypeid==3, ndp=1)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="4.4.8", 
              tabtext="Secondary outcomes: treatment satisfaction (TSQM-9) scores at 12 months and changes from baseline.", 
              basedata=list(
                list(x=outcomes$tsqm_eff, row.name="Effectiveness", subset=outcomes$visittypeid==4, ndp=1),
                list(x=outcomes$tsqm_eff_ch, row.name="Change in effectiveness from baseline to 12 months", 
                     subset=outcomes$visittypeid==4, ndp=1),
                list(x=outcomes$tsqm_conv, row.name="Convenience", subset=outcomes$visittypeid==4, ndp=1),
                list(x=outcomes$tsqm_conv_ch, row.name="Change in convenience from baseline to 12 months", 
                     subset=outcomes$visittypeid==4, ndp=1),
                list(x=outcomes$tsqm_sat, row.name="Overall satisfaction", subset=outcomes$visittypeid==4, ndp=1),
                list(x=outcomes$tsqm_sat_ch, row.name="Change in overall satisfaction from baseline to 12 months", 
                     subset=outcomes$visittypeid==4, ndp=1)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

sectab_449 <- list(head=rbindTable(list(Text="<b>Table 4.4.9: Secondary outcomes: health status - Treatment Satisfaction Questionnaire (TSQM9).</b>"), 
                                   cbindTable("", 
                                              list(Text=paste("In each case, a linear regression intervention effect estimate for the follow-up value of the score is presented.", 
                                                              "This estimate is adjusted for the baseline value of the score, age, sex, diabetes, prior myocardial infarction,", 
                                                              "coronary artery disease, LV systolic function, and site (lead vs other). Where required, to approximate normality in the model residuals,", 
                                                              "a second model was fitted to transformed data, and the intervention effect estimate from this model is also shown."), 
                                                   Other=list(colspan=6)))
), 
body=rbindTable(analysis.cts(xname="tsqm_eff", blvis="visit_1", fuvis="visit_3", moddesc="Effectiveness (baseline to 6 months)", digits.summ=2), 
                analysis.cts(xname="tsqm_eff", blvis="visit_1", fuvis="visit_4", moddesc="Effectiveness (baseline to 12 months)", digits.summ=2), 
                analysis.cts(xname="tsqm_conv", blvis="visit_1", fuvis="visit_3", moddesc="Convenience (baseline to 6 months)", digits.summ=2), 
                analysis.cts(xname="tsqm_conv", blvis="visit_1", fuvis="visit_4", moddesc="Convenience (baseline to 12 months)", digits.summ=2), 
                analysis.cts(xname="tsqm_sat", blvis="visit_1", fuvis="visit_3", moddesc="Overall satisfaction (baseline to 6 months)", digits.summ=2), 
                analysis.cts(xname="tsqm_sat", blvis="visit_1", fuvis="visit_4", moddesc="Overall satisfaction (baseline to 12 months)", digits.summ=2), 
                
                end.row(disclaimer=T)
)
)
ExportTable.HTML(sectab_449$head, sectab_449$body, filename=tables.file, first=F, last=F, horiz.fmt)
analysis.cts.diags(xname="tsqm_eff", blvis="visit_1", fuvis="visit_3", vardesc="TSQM effectiveness (baseline to 6 months)", tabnum="4.4.9.1", diagsfile=diags.file)
analysis.cts.diags(xname="tsqm_eff", blvis="visit_1", fuvis="visit_4", vardesc="TSQM effectiveness (baseline to 12 months)", tabnum="4.4.9.2", diagsfile=diags.file)
analysis.cts.diags(xname="tsqm_conv", blvis="visit_1", fuvis="visit_3", vardesc="TSQM convenience (baseline to 6 months)", tabnum="4.4.9.3", diagsfile=diags.file)
analysis.cts.diags(xname="tsqm_conv", blvis="visit_1", fuvis="visit_4", vardesc="TSQM convenience (baseline to 12 months)", tabnum="4.4.9.4", diagsfile=diags.file)
analysis.cts.diags(xname="tsqm_sat", blvis="visit_1", fuvis="visit_3", vardesc="TSQM overall satisfaction (baseline to 6 months)", tabnum="4.4.9.5", diagsfile=diags.file)
analysis.cts.diags(xname="tsqm_sat", blvis="visit_1", fuvis="visit_4", vardesc="TSQM overall satisfaction (baseline to 12 months)", tabnum="4.4.9.6", diagsfile=diags.file)

sectab_4410 <- list(head=rbindTable(list(Text="<b>Table 4.4.10: Secondary outcomes: Montreal Cognitive Assessment scores.</b>"), 
                                    list(Text=paste("A MOCA score < 26 is indicative of mild cognitive impairment.",
                                                    "In each case, a logistic regression intervention effect estimate for the follow-up value of the variable is presented.", 
                                                    "This estimate is adjusted for the baseline value of the variable, age, sex, diabetes, prior myocardial infarction,", 
                                                    "coronary artery disease, LV systolic function, and site (lead vs other)."), 
                                         Other=list(colspan=3)
                                    )
), 
body=rbindTable(list(Text="MOCA score abnormal (baseline to 12 months)"),
                analysis.logistic(xname="moc_sc_abn", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                end.row(disclaimer=T)
)
)
ExportTable.HTML(sectab_4410$head, sectab_4410$body, filename=tables.file, first=F, last=F, horiz.fmt)
analysis.logistic.diags(xname="moc_sc_abn", blvis="visit_1", fuvis="visit_4", vardesc="MOCA score indicator", tabnum="4.4.10", diagsfile=diags.file)

# 4.5.x: dasi and ipaq
summary.table(tabnum="4.5.1", 
              tabtext="Secondary outcomes: Duke Activity Status Index at baseline.", 
              basedata=list(
                list(x=outcomes$dasi_calc, row.name="DASI score", ndp=1, 
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$dasi_vo2calc, row.name="DASI VO<sub>2</sub> max: screening", ndp=1, 
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$dasi_metscalc, row.name="DASI METs: screening", ndp=1, 
                     subset=outcomes$visittypeid==1)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="4.5.2", 
              tabtext="Secondary outcomes: Duke Activity Status Index at 6 months, and changes from baseline.", 
              basedata=list(
                list(x=outcomes$dasi_calc, row.name="DASI score: 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$dasi_calc_ch, row.name="Change in DASI score from baseline to 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$dasi_vo2calc, row.name="DASI VO<sub>2</sub> max: 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$dasi_vo2calc_ch, row.name="Change in DASI VO<sub>2</sub> max from baseline to 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$dasi_metscalc, row.name="DASI METs: 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$dasi_metscalc_ch, row.name="Change in DASI METs from baseline to 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="4.5.3", 
              tabtext="Secondary outcomes: Duke Activity Status Index at 12 months, and changes from baseline.", 
              basedata=list(
                list(x=outcomes$dasi_calc, row.name="DASI score: 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$dasi_calc_ch, row.name="Change in DASI score from baseline to 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$dasi_vo2calc, row.name="DASI VO<sub>2</sub> max: 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$dasi_vo2calc_ch, row.name="Change in DASI VO<sub>2</sub> max from baseline to 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$dasi_metscalc, row.name="DASI METs: 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$dasi_metscalc_ch, row.name="Change in DASI METs from baseline to 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)


sectab_454 <- list(head=rbindTable(list(Text="<b>Table 4.5.4: Secondary outcomes: Duke Activity Status Index.</b>"), 
                                   cbindTable("", 
                                              list(Text=paste("In each case, a linear regression intervention effect estimate for the follow-up value of the measure is presented.", 
                                                              "This estimate is adjusted for the baseline value of the measure, age, sex, diabetes, prior myocardial infarction,", 
                                                              "coronary artery disease, LV systolic function, and site (lead vs other). Where required, to approximate normality in the model residuals,", 
                                                              "a second model was fitted to transformed data, and the intervention effect estimate from this model is also shown."), 
                                                   Other=list(colspan=6)))
), 
body=rbindTable(analysis.cts(xname="dasi_calc", blvis="visit_1", fuvis="visit_3", moddesc="DASI score (baseline to 6 months)", digits.summ=2), 
                analysis.cts(xname="dasi_calc", blvis="visit_1", fuvis="visit_4", moddesc="DASI score (baseline to 12 months)", digits.summ=2), 
                analysis.cts(xname="dasi_vo2calc", blvis="visit_1", fuvis="visit_3", moddesc="DASI VO<sub>2</sub> max (baseline to 6 months)", digits.summ=2), 
                analysis.cts(xname="dasi_vo2calc", blvis="visit_1", fuvis="visit_4", moddesc="DASI VO<sub>2</sub> max (baseline to 12 months)", digits.summ=2), 
                analysis.cts(xname="dasi_metscalc", blvis="visit_1", fuvis="visit_3", moddesc="DASI METs (baseline to 6 months)", digits.summ=2), 
                analysis.cts(xname="dasi_metscalc", blvis="visit_1", fuvis="visit_4", moddesc="DASI METs (baseline to 12 months)", digits.summ=2), 
                end.row(disclaimer=T)
)
)
ExportTable.HTML(sectab_454$head, sectab_454$body, filename=tables.file, first=F, last=F, horiz.fmt)
analysis.cts.diags(xname="dasi_calc", blvis="visit_1", fuvis="visit_3", vardesc="DASI score (baseline to 6 months)", tabnum="4.5.4.1", diagsfile=diags.file)
analysis.cts.diags(xname="dasi_calc", blvis="visit_1", fuvis="visit_4", vardesc="DASI score (baseline to 12 months)", tabnum="4.5.4.2", diagsfile=diags.file)
analysis.cts.diags(xname="dasi_vo2calc", blvis="visit_1", fuvis="visit_3", vardesc="DASI VO<sub>2</sub> max (baseline to 6 months)", tabnum="4.5.4.3", diagsfile=diags.file)
analysis.cts.diags(xname="dasi_vo2calc", blvis="visit_1", fuvis="visit_4", vardesc="DASI VO<sub>2</sub> max (baseline to 12 months)", tabnum="4.5.4.4", diagsfile=diags.file)
analysis.cts.diags(xname="dasi_metscalc", blvis="visit_1", fuvis="visit_3", vardesc="DASI METs (baseline to 6 months)", tabnum="4.5.4.5", diagsfile=diags.file)
analysis.cts.diags(xname="dasi_metscalc", blvis="visit_1", fuvis="visit_4", vardesc="DASI METs (baseline to 12 months)", tabnum="4.5.4.6", diagsfile=diags.file)

summary.table(tabnum="4.5.5", 
              tabtext="Secondary outcomes: International Physical Activity Questionnaire.", 
              basedata=list(
                list(x=outcomes$ipaq_totmetmin, row.name="IPAQ total weekly met-minutes: screening", ndp=1, 
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ipaq_totmetmin, row.name="IPAQ total weekly met-minutes: 6 months", ndp=1, 
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$ipaqtotmetmin_ch, row.name="Change in IPAQ total weekly met-minutes from baseline to 6 months", 
                     ndp=1, subset=outcomes$visittypeid==3),
                list(x=outcomes$ipaq_totmetmin, row.name="IPAQ total weekly met-minutes: 12 months", ndp=1, 
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$ipaqtotmetmin_ch, row.name="Change in IPAQ total weekly met-minutes from baseline to 12 months", 
                     ndp=1, subset=outcomes$visittypeid==4)
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

sectab_456 <- list(head=rbindTable(list(Text="<b>Table 4.5.6: Secondary outcomes: International Physical Activity Questionnaire.</b>"), 
                                   cbindTable("", 
                                              list(Text=paste("In each case, a linear regression intervention effect estimate for the follow-up value of the measure is presented.", 
                                                              "This estimate is adjusted for the baseline value of the measure, age, sex, diabetes, prior myocardial infarction,", 
                                                              "coronary artery disease, LV systolic function, and site (lead vs other). Where required, to approximate normality in the model residuals,", 
                                                              "a second model was fitted to transformed data, and the intervention effect estimate from this model is also shown."), 
                                                   Other=list(colspan=6)))
), 
body=rbindTable(analysis.cts(xname="ipaq_totmetmin", blvis="visit_1", fuvis="visit_3", moddesc="IPAQ total weekly met-minutes (baseline to 6 months)", digits.summ=2), 
                analysis.cts(xname="ipaq_totmetmin", blvis="visit_1", fuvis="visit_4", moddesc="IPAQ total weekly met-minutes (baseline to 12 months)", digits.summ=2), 
                end.row(disclaimer=T)
)
)
ExportTable.HTML(sectab_456$head, sectab_456$body, filename=tables.file, first=F, last=F, horiz.fmt)
analysis.cts.diags(xname="ipaq_totmetmin", blvis="visit_1", fuvis="visit_3", vardesc="IPAQ total weekly met-minutes (baseline to 6 months)", tabnum="4.5.6.1", diagsfile=diags.file)
analysis.cts.diags(xname="ipaq_totmetmin", blvis="visit_1", fuvis="visit_4", vardesc="IPAQ total weekly met-minutes (baseline to 12 months)", tabnum="4.5.6.2", diagsfile=diags.file)

# 4.6.x: MACE/MACCE
mace_assoc <- merge(outcomes[outcomes$visittypeid==1, c("sno", "randdate", "trtgrp", "saq_af_bl", "saq_summ_bl", "saq_ql_bl")], 
                    diagnoses[, c("sno", "mridiag")], by="sno", all.x=T)
mace_assoc$mace <- factor(is.element(mace_assoc$sno, sae_coded$sno[sae_coded$mace=="Yes"]), levels=c(T, F), 
                          labels=c("Yes", "No"))
mace_assoc$macedate <- ifelse(mace_assoc$mace=="No", NA, as.Date(saes$seriousdate[match(mace_assoc$sno, saes$sno)]))
mace_assoc$macedate <- as.Date("01-01-1970", format="%d-%m-%Y") + mace_assoc$macedate
mace_assoc$macce <- factor(is.element(mace_assoc$sno, sae_coded$sno[sae_coded$macce=="Yes"]), levels=c(T, F), 
                          labels=c("Yes", "No"))
mace_assoc$maccedate <- ifelse(mace_assoc$macce=="No", NA, as.Date(saes$seriousdate[match(mace_assoc$sno, saes$sno)]))
mace_assoc$maccedate <- as.Date("01-01-1970", format="%d-%m-%Y") + mace_assoc$maccedate
visits_type4 <- visits[visits$visittypeid==4, ]
mace_assoc$fu_12modate <- visits_type4$visitdate[match(mace_assoc$sno, visits_type4$sno)]
mace_assoc <- merge(mace_assoc, screening[, c("sno", "visitdate", "age", "simd_quintile")], by="sno", all.x=T)
mace_assoc <- merge(mace_assoc, mri[, c("sno", "strglmbf_225", "glmpr_22", "enmpr_241")], by="sno", all.x=T)
# time to event: screening to MACE or randomisation to MACE?
mace_assoc$ttmace_screen <- as.numeric(difftime(mace_assoc$macedate, mace_assoc$visitdate, units="days"))
mace_assoc$ttmace_rand <- as.numeric(difftime(mace_assoc$macedate, mace_assoc$randdate, units="days"))
# survtime from randomisation to event
mace_assoc$ttmacce_rand <- as.numeric(difftime(mace_assoc$maccedate, mace_assoc$randdate, units="days"))

# survival time: time to MACE or time to 12mo follow-up
mace_assoc$survtime_screen <- ifelse(mace_assoc$mace=="Yes", mace_assoc$ttmace_screen, 
                                     as.numeric(difftime(mace_assoc$fu_12modate, mace_assoc$visitdate, units="days")))
mace_assoc$survtime_rand <- ifelse(mace_assoc$mace=="Yes", mace_assoc$ttmace_rand, 
                                   as.numeric(difftime(mace_assoc$fu_12modate, mace_assoc$randdate, units="days")))
mace_assoc$survtime_rand_macce <- ifelse(mace_assoc$macce=="Yes", mace_assoc$ttmacce_rand, 
                                   as.numeric(difftime(mace_assoc$fu_12modate, mace_assoc$randdate, units="days")))

Surv(time=mace_assoc$survtime_rand, event=mace_assoc$mace=="Yes")
mace_assoc <- merge(mace_assoc, randomised[, c("sno", "rdedia", "rdesex", "rdepmi", "rdecadr", "rdelvsd")], by="sno", all.x=T)
# create grouping variables as required: subject to change based on finalised SAP
mace_assoc$age_grp <- factor(ifelse(is.na(mace_assoc$age), NA, 
                                    ifelse(mace_assoc$age <= quantile(mace_assoc$age, probs=0.334, na.rm=T), 1, 
                                           ifelse(mace_assoc$age > quantile(mace_assoc$age, probs=0.334, na.rm=T) & mace_assoc$age <= quantile(mace_assoc$age, probs=0.667, na.rm=T), 2, 
                                                  ifelse(mace_assoc$age > quantile(mace_assoc$age, probs=0.667, na.rm=T), 3, NA)))), 
                             levels=c(1:3), labels=c(paste0("T1: ", min(mace_assoc$age, na.rm=T), " - ", quantile(mace_assoc$age, probs=0.334, na.rm=T)), 
                                                     paste0("T2: ", quantile(mace_assoc$age, probs=0.334, na.rm=T) + 1, " - ", quantile(mace_assoc$age, probs=0.667, na.rm=T)), 
                                                     paste0("T3: ", quantile(mace_assoc$age, probs=0.667, na.rm=T) + 1, " - ", max(mace_assoc$age, na.rm=T))))
mace_assoc$simd2 <- factor(mace_assoc$simd_quintile, levels=levels(mace_assoc$simd_quintile), labels=c("1-2", "1-2", "3-5", "3-5", "3-5"))
# baseline SAQ score
# baseline angina frequency
mace_assoc$saq_af_grp <- factor(ifelse(is.na(mace_assoc$saq_af_bl), NA, 
                                       ifelse(mace_assoc$saq_af_bl <= 30, 1, 
                                              ifelse(mace_assoc$saq_af_bl > 30 & mace_assoc$saq_af_bl <= 60, 2, 
                                                     ifelse(mace_assoc$saq_af_bl > 60 & mace_assoc$saq_af_bl <= 99, 3, 
                                                            ifelse(mace_assoc$saq_af_bl==100, 4, NA))))), 
                                levels=c(1:4), labels=c("Daily angina", "Weekly angina", "Monthly angina", "No angina"))

mace_assoc$saq_summ_grp <- factor(ifelse(is.na(mace_assoc$saq_summ_bl), NA, 
                                         ifelse(mace_assoc$saq_summ_bl < 25, 1, 
                                                ifelse(mace_assoc$saq_summ_bl >= 25 & mace_assoc$saq_summ_bl < 50, 2, 
                                                       ifelse(mace_assoc$saq_summ_bl >= 50 & mace_assoc$saq_summ_bl < 75, 3, 
                                                              ifelse(mace_assoc$saq_summ_bl >= 75, 4, NA))))), 
                                  levels=c(1:4), labels=c("Poor health", "Fair health", "Good health", "Excellent health"))
mace_assoc$saq_ql_grp <- factor(ifelse(is.na(mace_assoc$saq_ql_bl), NA, 
                                       ifelse(mace_assoc$saq_ql_bl < 25, 1, 
                                              ifelse(mace_assoc$saq_ql_bl >= 25 & mace_assoc$saq_ql_bl < 50, 2, 
                                                     ifelse(mace_assoc$saq_ql_bl >= 50 & mace_assoc$saq_ql_bl < 75, 3, 
                                                            ifelse(mace_assoc$saq_ql_bl >= 75, 4, NA))))), 
                                levels=c(1:4), labels=c("Poor QOL", "Fair QOL", "Good QOL", "Excellent QOL"))

saes$mace <- sae_coded$mace[match(saes$caseno, sae_coded$caseno)]
summary.table(
  tabnum="4.6.1",
  tabtext="Secondary outcomes: Major cardiac adverse events. N (%) show people with at least one event of each type.",
  basedata=list(
    list(x=saes$sitename,row.name="Number of SAEs",nrow=T, 
         subset=saes$mace=="Yes"),
    list(x=saes$ser_death,row.name="Seriousness Criterion: Death",showN=F,x.levels="Yes", 
         subset=saes$mace=="Yes"),
    if(any(saes$ser_death=="Yes", na.rm=T)) list(x=saes$causedeath, row.name="Cause of death", 
                                                 subset=saes$ser_death=="Yes"&saes$mace=="Yes"),
    list(x=saes$ser_life,row.name="Seriousness Criterion: Life threatening",showN=F,x.levels="Yes", 
         subset=saes$mace=="Yes"),
    list(x=saes$ser_hosp,row.name="Seriousness Criterion: Hospitalisation",showN=F,x.levels="Yes", 
         subset=saes$mace=="Yes"),
    if(any(saes$ser_hosp=="Yes", na.rm=T)) list(x=as.numeric(saes$hospduration), row.name="Duration of hospitalisation (days)", 
                                                subset=saes$ser_hosp=="Yes"&saes$mace=="Yes", ndp=1),
    list(x=saes$ser_disab,row.name="Seriousness Criterion: Disability",showN=F,x.levels="Yes", 
         subset=saes$mace=="Yes"),
    list(x=saes$ser_cong,row.name="Seriousness Criterion: Congenital abnormality",showN=F,x.levels="Yes", 
         subset=saes$mace=="Yes"),
    list(x=saes$ser_omic,row.name="Seriousness Criterion: Other important medical event",showN=F,x.levels="Yes", 
         subset=saes$mace=="Yes"),
    list(x=saes$severity,row.name="Severity", 
         subset=saes$mace=="Yes"),
    list(x=saes$relation,row.name="Causality", 
         subset=saes$mace=="Yes"),
    if(any(saes$relation=="Yes",na.rm=T)) list(x=saes$expected,row.name="Expectedness (if related)",
                                               subset=saes$relation=="Yes"&saes$mace=="Yes"),
    list(x=saes$outcome,row.name="Outcome", 
         subset=saes$mace=="Yes"),
    list(x=as.numeric(saes$duration),row.name="Duration (days)",
         subset=saes$outcome %in% c("Recovered","Recovered with sequelae","Fatal")&saes$mace=="Yes",ndp=1)),
  treat=saes$trtgrp,
  out.file=tables.file)

sae_coded$mace <- saes$mace[match(sae_coded$caseno, saes$caseno)]
safety.table(
  tabnum="4.6.2",
  tabtext="Secondary outcomes: Major cardiac adverse events (MedDRA Coded).",
  safety.id=sae_coded$sno,
  safety.subset=sae_coded$mace=="Yes",
  safety.treat=sae_coded$trtgrp,
  safety.class1=sae_coded$soc_name,
  safety.class2=sae_coded$pt_name,
  pop.id=randomised$sno,
  pop.subset=NULL,
  pop.treat=randomised$trtgrp,
  treat.levels=levels(randomised$trtgrp),
  treat.names=levels(randomised$trtgrp),
  type="Event",
  out.file=tables.file)

sec_tab_463 <- list(head=rbindTable(list(Text=paste("<b>Table 4.6.3: Secondary outcomes analysis - associations", 
                                                    "between incidence of MACE and patient characteristics.</b>")), 
                                    list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                    "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                    "&Chi;<sup>2</sup>.")),
                                    cbindTable("", "", list(Text="MACE occured", Other=list(colspan=2))),
                                    cbindTable("", "Subgroup levels", "Nobs (Nmiss)", "N (%) Yes")
),
body=rbindTable(cbindTable("", "All participants", 
                           summary.fun(x=as.numeric(mace_assoc$mace), summary.text="@N (@MISS)"),
                           npc.factor(x=mace_assoc$mace, x.levels="Yes")                           
),
list(Text="Age tertile", Other=list(colspan=4)), 
cbindTable("", "Tertile 1: 37 - 59",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$age_grp=="T1: 37 - 59" & !is.na(mace_assoc$age_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$age_grp=="T1: 37 - 59" & !is.na(mace_assoc$age_grp)], x.levels="Yes")
),
cbindTable("", "Tertile 2: 60 - 68",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$age_grp=="T2: 60 - 68" & !is.na(mace_assoc$age_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$age_grp=="T2: 60 - 68" & !is.na(mace_assoc$age_grp)], x.levels="Yes")
),
cbindTable("", "Tertile 3: 69 - 85",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$age_grp=="T3: 69 - 85" & !is.na(mace_assoc$age_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$age_grp=="T3: 69 - 85" & !is.na(mace_assoc$age_grp)], x.levels="Yes")
),
cbindTable(list(Text="p-value: age tertile", Other=list(colspan=2)), "", pfun("mace", "age_grp", mace_assoc)),

list(Text="Sex", Other=list(colspan=4)),
cbindTable("", "Male",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$rdesex=="Male" & !is.na(mace_assoc$rdesex)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$rdesex=="Male" & !is.na(mace_assoc$rdesex)], x.levels="Yes")
),
cbindTable("", "Female",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$rdesex=="Female" & !is.na(mace_assoc$rdesex)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$rdesex=="Female" & !is.na(mace_assoc$rdesex)], x.levels="Yes")
),
cbindTable(list(Text="p-value: sex", Other=list(colspan=2)), "", pfun("mace", "rdesex", mace_assoc)),

list(Text="SIMD group", Other=list(colspan=4)),
cbindTable("", "SIMD quintile 1-2",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$sex=="1-2" & !is.na(mace_assoc$sex)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$sex=="1-2" & !is.na(mace_assoc$sex)], x.levels="Yes")
),
cbindTable("", "SIMD quintile 3-5",   
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$simd2=="3-5" & !is.na(mace_assoc$simd2)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$simd2=="3-5" & !is.na(mace_assoc$simd2)], x.levels="Yes")
), 
cbindTable(list(Text="p-value: SIMD group", Other=list(colspan=2)), "", pfun("mace", "simd2", mace_assoc)), 

list(Text="Baseline SAQ summary score category", Other=list(colspan=4)),
cbindTable("", "Poor health (score < 25)",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$saq_summ_grp=="Poor health" & !is.na(mace_assoc$saq_summ_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$saq_summ_grp=="Poor health" & !is.na(mace_assoc$saq_summ_grp)], x.levels="Yes")),
cbindTable("", "Fair health (score 24 - 49)",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$saq_summ_grp=="Fair health" & !is.na(mace_assoc$saq_summ_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$saq_summ_grp=="Fair health" & !is.na(mace_assoc$saq_summ_grp)], x.levels="Yes")),
cbindTable("", "Good health (score 50 - 74)",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$saq_summ_grp=="Good health" & !is.na(mace_assoc$saq_summ_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$saq_summ_grp=="Good health" & !is.na(mace_assoc$saq_summ_grp)], x.levels="Yes")),
cbindTable("", "Excellent health (score &ge; 75)",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$saq_summ_grp=="Excellent health" & !is.na(mace_assoc$saq_summ_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$saq_summ_grp=="Excellent health" & !is.na(mace_assoc$saq_summ_grp)], x.levels="Yes")),
cbindTable(list(Text="p-value: baseline SAQ summary score", Other=list(colspan=2)), "", pfun("mace", "saq_summ_grp", mace_assoc)),

list(Text="Baseline SAQ angina frequency score category", Other=list(colspan=4)),
cbindTable("", "Daily angina (score &le; 30)",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$saq_af_grp=="Daily angina" & !is.na(mace_assoc$saq_af_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$saq_af_grp=="Daily angina" & !is.na(mace_assoc$saq_af_grp)], x.levels="Yes")),
cbindTable("", "Weekly angina (score 31 - 60)",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$saq_af_grp=="Weekly angina" & !is.na(mace_assoc$saq_af_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$saq_af_grp=="Weekly angina" & !is.na(mace_assoc$saq_af_grp)], x.levels="Yes")),
cbindTable("", "Monthly angina (score 61 - 99)",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$saq_af_grp=="Monthly angina" & !is.na(mace_assoc$saq_af_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$saq_af_grp=="Monthly angina" & !is.na(mace_assoc$saq_af_grp)], x.levels="Yes")),
cbindTable("", "No angina (score 100)",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$saq_af_grp=="No angina" & !is.na(mace_assoc$saq_af_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$saq_af_grp=="No angina" & !is.na(mace_assoc$saq_af_grp)], x.levels="Yes")),
cbindTable(list(Text="p-value: baseline SAQ angina frequency score", Other=list(colspan=2)), "", pfun("mace", "saq_af_grp", mace_assoc)),

list(Text="Baseline SAQ quality of life score category", Other=list(colspan=4)),
cbindTable("", "Poor QOL (score < 25)",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$saq_ql_grp=="Poor QOL" & !is.na(mace_assoc$saq_ql_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$saq_ql_grp=="Poor QOL" & !is.na(mace_assoc$saq_ql_grp)], x.levels="Yes")),
cbindTable("", "Fair QOL (score 24 - 49)",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$saq_ql_grp=="Fair QOL" & !is.na(mace_assoc$saq_ql_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$saq_ql_grp=="Fair QOL" & !is.na(mace_assoc$saq_ql_grp)], x.levels="Yes")),
cbindTable("", "Good QOL (score 50 - 74)",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$saq_ql_grp=="Good QOL" & !is.na(mace_assoc$saq_ql_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$saq_ql_grp=="Good QOL" & !is.na(mace_assoc$saq_ql_grp)], x.levels="Yes")),
cbindTable("", "Excellent QOL (score &ge; 75)",
           summary.fun(x=as.numeric(mace_assoc$mace[mace_assoc$saq_ql_grp=="Excellent QOL" & !is.na(mace_assoc$saq_ql_grp)]),
                       summary.text="@N (@MISS)"),
           npc.factor(x=mace_assoc$mace[mace_assoc$saq_ql_grp=="Excellent QOL" & !is.na(mace_assoc$saq_ql_grp)], x.levels="Yes")),
cbindTable(list(Text="p-value: baseline SAQ quality of life score", Other=list(colspan=2)), "", pfun("mace", "saq_ql_grp", mace_assoc)),

list(Text="Post-randomisation diagnosis", Other=list(colspan=4)),
cbindTable("", "Obstructive CAD",
           summary.fun(as.numeric(mace_assoc$mace[mace_assoc$mridiag=="Obstructive CAD" & !is.na(mace_assoc$mridiag)]),
                       summary.text="@N (@MISS)"),
           npc.factor(mace_assoc$mace[mace_assoc$mridiag=="Obstructive CAD" & !is.na(mace_assoc$mridiag)], x.levels="Yes")),
cbindTable("", "Microvascular angina",
           summary.fun(as.numeric(mace_assoc$mace[mace_assoc$mridiag=="Microvascular angina" & !is.na(mace_assoc$mridiag)]),
                       summary.text="@N (@MISS)"),
           npc.factor(mace_assoc$mace[mace_assoc$mridiag=="Microvascular angina" & !is.na(mace_assoc$mridiag)], x.levels="Yes")),
cbindTable("", "Vasospastic angina",
           summary.fun(as.numeric(mace_assoc$mace[mace_assoc$mridiag=="Vasospastic angina" & !is.na(mace_assoc$mridiag)]),
                       summary.text="@N (@MISS)"),
           npc.factor(mace_assoc$mace[mace_assoc$mridiag=="Vasospastic angina" & !is.na(mace_assoc$mridiag)], x.levels="Yes")),
cbindTable("", "Non-cardiac chest pain",
           summary.fun(as.numeric(mace_assoc$mace[mace_assoc$mridiag=="Non-cardiac chest pain" & !is.na(mace_assoc$mridiag)]),
                       summary.text="@N (@MISS)"),
           npc.factor(mace_assoc$mace[mace_assoc$mridiag=="Non-cardiac chest pain" & !is.na(mace_assoc$mridiag)], x.levels="Yes")),
cbindTable("", "Other",
           summary.fun(as.numeric(mace_assoc$mace[mace_assoc$mridiag=="Other" & !is.na(mace_assoc$mridiag)]),
                       summary.text="@N (@MISS)"),
           npc.factor(mace_assoc$mace[mace_assoc$mridiag=="Other" & !is.na(mace_assoc$mridiag)], x.levels="Yes")),
cbindTable(list(Text="p-value: post-randomisation diagnosis", Other=list(colspan=2)), "", pfun("mace", "mridiag", mace_assoc)),

list(Text="Global MBF under stress < 2.25", Other=list(colspan=4)),
cbindTable("", "Yes",
           summary.fun(as.numeric(mace_assoc$mace[mace_assoc$strglmbf_225=="Yes" & !is.na(mace_assoc$strglmbf_225)]),
                       summary.text="@N (@MISS)"),
           npc.factor(mace_assoc$mace[mace_assoc$strglmbf_225=="Yes" & !is.na(mace_assoc$strglmbf_225)], x.levels="Yes")),
cbindTable("", "No",
           summary.fun(as.numeric(mace_assoc$mace[mace_assoc$strglmbf_225=="No" & !is.na(mace_assoc$strglmbf_225)]),
                       summary.text="@N (@MISS)"),
           npc.factor(mace_assoc$mace[mace_assoc$strglmbf_225=="No" & !is.na(mace_assoc$strglmbf_225)], x.levels="Yes")),
cbindTable(list(Text="p-value: global MBF", Other=list(colspan=2)), "", pfun("mace", "strglmbf_225", mace_assoc)),

list(Text="Global MPR < 2.2", Other=list(colspan=4)),
cbindTable("", "Yes",
           summary.fun(as.numeric(mace_assoc$mace[mace_assoc$glmpr_22=="Yes" & !is.na(mace_assoc$glmpr_22)]),
                       summary.text="@N (@MISS)"),
           npc.factor(mace_assoc$mace[mace_assoc$glmpr_22=="Yes" & !is.na(mace_assoc$glmpr_22)], x.levels="Yes")),
cbindTable("", "No",
           summary.fun(as.numeric(mace_assoc$mace[mace_assoc$glmpr_22=="No" & !is.na(mace_assoc$glmpr_22)]),
                       summary.text="@N (@MISS)"),
           npc.factor(mace_assoc$mace[mace_assoc$glmpr_22=="No" & !is.na(mace_assoc$glmpr_22)], x.levels="Yes")),
cbindTable(list(Text="p-value: global MPR", Other=list(colspan=2)), "", pfun("mace", "glmpr_22", mace_assoc)),

list(Text="Endocardial MPR < 2.41", Other=list(colspan=4)),
cbindTable("", "Yes",
           summary.fun(as.numeric(mace_assoc$mace[mace_assoc$enmpr_241=="Yes" & !is.na(mace_assoc$enmpr_241)]),
                       summary.text="@N (@MISS)"),
           npc.factor(mace_assoc$mace[mace_assoc$enmpr_241=="Yes" & !is.na(mace_assoc$enmpr_241)], x.levels="Yes")),
cbindTable("", "No",
           summary.fun(as.numeric(mace_assoc$mace[mace_assoc$enmpr_241=="No" & !is.na(mace_assoc$enmpr_241)]),
                       summary.text="@N (@MISS)"),
           npc.factor(mace_assoc$mace[mace_assoc$enmpr_241=="No" & !is.na(mace_assoc$enmpr_241)], x.levels="Yes")),
cbindTable(list(Text="p-value: endocardial MPR", Other=list(colspan=2)), "", pfun("mace", "enmpr_241", mace_assoc)),
end.row(disclaimer=T)
)
)

ExportTable.HTML(sec_tab_463$head, sec_tab_463$body, horiz.fmt, filename=tables.file, first=F, last=F)


cph_rand <- coxph(Surv(time=mace_assoc$survtime_rand, event=mace_assoc$mace=="Yes") ~ mace_assoc$trtgrp)
cph_screen <- coxph(Surv(time=mace_assoc$survtime_screen, event=mace_assoc$mace=="Yes") ~ mace_assoc$trtgrp)
cph.summ(cph_rand, term=1, asTable=F)
cph.summ(cph_screen, term=1, asTable=F)

cph_rand_macce <- coxph(Surv(time=mace_assoc$survtime_rand, event=mace_assoc$macce=="Yes") ~ mace_assoc$trtgrp)

first_card_ae <- aes[aes$aetype=="Cardiac",] %>% group_by(sno) %>% summarise(first_cardaedate=min(aedate))
mace_assoc <- merge(mace_assoc, first_card_ae, by="sno", all.x=T)
mace_assoc$cardae <- factor(is.na(mace_assoc$first_cardaedate), levels=c(T,F), labels=c("No", "Yes"))
mace_assoc$ttcardae_rand <- as.numeric(difftime(mace_assoc$first_cardaedate, mace_assoc$randdate, units="days"))
mace_assoc$survtime_rand_cardae <- ifelse(mace_assoc$cardae=="Yes", mace_assoc$ttcardae_rand, 
                                         as.numeric(difftime(mace_assoc$fu_12modate, mace_assoc$randdate, units="days")))

sectab_464 <- list(head=rbindTable(list(Text="<b>Table 4.6.4: Secondary outcomes: MACE. Time to event or 12 month follow-up, and Cox model results."), 
                                   cbindTable("", "", "", "All", "", "Control", "Intervention")), 
                   body=rbindTable(summary.cat(mace_assoc$mace, row.name="MACE occurred", x.levels="Yes", treat=mace_assoc$trtgrp), 
                                   summary.cts(mace_assoc$ttmace_screen, row.name="Time from screening to MACE (days)", treat=mace_assoc$trtgrp, subset=mace_assoc$mace=="Yes"),
                                   summary.cts(mace_assoc$survtime_screen, row.name="Time from screening to MACE/12 month follow-up (days)", treat=mace_assoc$trtgrp),
                                   summary.cts(mace_assoc$ttmace_rand, row.name="Time from randomisation to MACE (days)", treat=mace_assoc$trtgrp, subset=mace_assoc$mace=="Yes"),
                                   summary.cts(mace_assoc$survtime_rand, row.name="Time from randomisation to MACE/12 month follow-up (days)", treat=mace_assoc$trtgrp),
                                   cbindTable("", list(Text=paste("A Cox proportional hazards model was fitted to the time to event or 12 month follow-up from randomisation.", 
                                                                  "The model was adjusted for randomised group only, and the hazard ratio for randomised group is presented."), 
                                                       Other=list(colspan=6))), 
                                  cbindTable(list(Text="Survival time from randomisation: MACE", Other=list(colspan=7))),
                                   cbindTable("", list(Text="Estimate<br>(95% CI)<br>p-value"), "", "", "", 
                                              list(Text=cph.summ(cph_rand, term=1, asTable=F), Other=list(colspan=2))),
                                   cbindTable(list(Text="Survival time from randomisation: MACCE", Other=list(colspan=7))),
                                   cbindTable("", list(Text="Estimate<br>(95% CI)<br>p-value"), "", "", "", 
                                              list(Text=cph.summ(cph_rand_macce, term=1, asTable=F), Other=list(colspan=2))), 
                                   end.row(disclaimer=T))
)
ExportTable.HTML(sectab_464$head, sectab_464$body, horiz.fmt, filename=tables.file, first=F, last=F)

# KM plots: time to event (MACE, MACCE, Cardiac AE)
fig.set(fig.num="4.6.5.1", fig.path=figure.path)
plot(survfit(Surv(time=mace_assoc$survtime_rand, event=mace_assoc$mace=="Yes") ~ mace_assoc$trtgrp), 
     ylim=c(0.95, 1), col=c("red", "blue"), xlab="Survival time (days from randomisation)", ylab="Survival probability", 
     main="KM plot: MACE events by randomised group")
legend("bottomleft", legend=c("Control", "Intervention"), col=c("red", "blue"), pch=16, bty="n", cex=0.75)
dev.off()

fig.set(fig.num="4.6.5.2", fig.path=figure.path)
plot(survfit(Surv(time=mace_assoc$survtime_rand_macce, event=mace_assoc$macce=="Yes") ~ mace_assoc$trtgrp), 
     ylim=c(0.95, 1), col=c("red", "blue"), xlab="Survival time (days from randomisation)", ylab="Survival probability", 
     main="KM plot: MACCE events by randomised group")
legend("bottomleft", legend=c("Control", "Intervention"), col=c("red", "blue"), pch=16, bty="n", cex=0.75)
dev.off()

fig.set(fig.num="4.6.5.3", fig.path=figure.path)
plot(survfit(Surv(time=mace_assoc$survtime_rand_cardae, event=mace_assoc$cardae=="Yes") ~ mace_assoc$trtgrp), 
     ylim=c(0.8, 1), col=c("red", "blue"), xlab="Survival time (days from randomisation)", ylab="Survival probability", 
     main="KM plot: hospital attendance for chest pain by randomised group")
legend("bottomleft", legend=c("Control", "Intervention"), col=c("red", "blue"), pch=16, bty="n", cex=0.75)
dev.off()

sectab_465 <- list(head=rbindTable(list(Text="<b>Figures 4.6.5.1 - 4.6.5.3: Secondary outcomes: MACE, MACCE, and hospital attendance for chest pain. Kaplan-Meier figures for survival time by randomised group.")), 
                   body=rbindTable(cbindTable(fig.tag(fig.num="4.6.5.1", fig.path=figure.path)), 
                                   cbindTable(fig.tag(fig.num="4.6.5.2", fig.path=figure.path)),
                                   cbindTable(fig.tag(fig.num="4.6.5.3", fig.path=figure.path)),
                                   end.row(disclaimer=T)
                   )
)
ExportTable.HTML(sectab_465$head, sectab_465$body, horiz.fmt, filename=tables.file, first=F, last=F)


outcomes$ccb_adh <- ifelse(is.na(outcomes$ccb_any) | outcomes$ccb_any=="No", NA, 
                           ifelse(rowSums(outcomes[, c("amlo_adh", "nife_adh", "dilt_adh", "vera_adh", "felo_adh", "nicard_adh", "lercan_adh", "lacid_adh")]=="Yes", na.rm=T) > 0, "Yes", "No"))
outcomes$any_angther_adh <- ifelse(is.na(outcomes$any_angther) | outcomes$any_angther=="No", NA, 
                                   ifelse(rowSums(outcomes[, c("beta_adh", "gtn_adh", "nitr_adh", "nico_adh", "ccb_adh", "ivab_adh", "rano_adh", "trime_adh")]=="Yes", na.rm=T) > 0, "Yes", "No"))
# 4.7.x: meds
summary.table(tabnum="4.7.1",
              tabtext="Secondary outcomes: angina medication and adherence at screening.",
              basedata=list(
                list(x=outcomes$beta, row.name="Beta-blocker", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                if(any(outcomes$beta[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$beta_adh, row.name="Beta-blocker: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==1&outcomes$beta=="Yes"),
                
                list(x=outcomes$gtn, row.name="GTN", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                if(any(outcomes$gtn[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$gtn_adh, row.name="GTN: adherence < 80%", x.levels="Yes",
                                                                                   subset=outcomes$visittypeid==1&outcomes$gtn=="Yes"),

                list(x=outcomes$nitr, row.name="Nitrate", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                if(any(outcomes$nitr[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$nitr_adh, row.name="Nitrate: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==1&outcomes$nitr=="Yes"),
                
                list(x=outcomes$nico, row.name="Nicorandil", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                if(any(outcomes$nico[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$nico_adh, row.name="Nicorandil: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==1&outcomes$nico=="Yes"),
                
                list(x=outcomes$ccb_any, row.name="Calcium channel blocker: any", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                if(any(outcomes$ccb_any[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=factor(outcomes$ccb_adh), row.name="Calcium channel blocker: adherence < 80%", x.levels="Yes",
                                                                                       subset=outcomes$visittypeid==1&outcomes$ivab=="Yes"),
                
                list(x=outcomes$ivab, row.name="Ivabradine", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                if(any(outcomes$ivab[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$ivab_adh, row.name="Ivabradine: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==1&outcomes$ivab=="Yes"),
                list(x=outcomes$rano, row.name="Ranolazine", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                if(any(outcomes$rano[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$rano_adh, row.name="Ranolazine: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==1&outcomes$rano=="Yes"),
                
                list(x=outcomes$trime, row.name="Trimetazidine", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                if(any(outcomes$trime[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$trime_adh, row.name="Trimetazidine: adherence < 80%", x.levels="Yes",
                                                                                     subset=outcomes$visittypeid==1&outcomes$trime=="Yes"), 
               list(x=factor(outcomes$any_angther), row.name="Any of the above", x.levels="Yes", 
                    subset=outcomes$visittypeid==1),
               if(any(outcomes$any_angther[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=factor(outcomes$any_angther_adh), row.name="Any of the above: adherence < 80%", x.levels="Yes", 
                                                                                          subset=outcomes$visittypeid==1&outcomes$any_angther=="Yes")
              ),
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="4.7.2",
              tabtext="Secondary outcomes: angina medication and adherence at 6 months.",
              basedata=list(
                list(x=outcomes$medchg1, row.name="Medications changed since screening", x.levels="Yes",
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$beta, row.name="Beta-blocker", x.levels="Yes",
                     subset=outcomes$visittypeid==3),
                if(any(outcomes$beta[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$beta_adh, row.name="Beta-blocker: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==3&outcomes$beta=="Yes"),
                
                list(x=outcomes$gtn, row.name="GTN", x.levels="Yes",
                     subset=outcomes$visittypeid==3),
                if(any(outcomes$gtn[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$gtn_adh, row.name="GTN: adherence < 80%", x.levels="Yes",
                                                                                   subset=outcomes$visittypeid==3&outcomes$gtn=="Yes"),
                
                list(x=outcomes$nitr, row.name="Nitrate", x.levels="Yes",
                     subset=outcomes$visittypeid==3),
                if(any(outcomes$nitr[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$nitr_adh, row.name="Nitrate: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==3&outcomes$nitr=="Yes"),
                
                list(x=outcomes$nico, row.name="Nicorandil", x.levels="Yes",
                     subset=outcomes$visittypeid==3),
                if(any(outcomes$nico[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$nico_adh, row.name="Nicorandil: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==3&outcomes$nico=="Yes"),
                
                list(x=outcomes$ccb_any, row.name="Calcium channel blocker: any", x.levels="Yes",
                     subset=outcomes$visittypeid==3),
                if(any(outcomes$ccb_any[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=factor(outcomes$ccb_adh), row.name="Calcium channel blocker: adherence < 80%", x.levels="Yes",
                                                                                       subset=outcomes$visittypeid==3&outcomes$ivab=="Yes"),
                
                list(x=outcomes$ivab, row.name="Ivabradine", x.levels="Yes",
                     subset=outcomes$visittypeid==3),
                if(any(outcomes$ivab[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$ivab_adh, row.name="Ivabradine: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==3&outcomes$ivab=="Yes"),
                list(x=outcomes$rano, row.name="Ranolazine", x.levels="Yes",
                     subset=outcomes$visittypeid==3),
                if(any(outcomes$rano[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$rano_adh, row.name="Ranolazine: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==3&outcomes$rano=="Yes"),
                
                list(x=outcomes$trime, row.name="Trimetazidine", x.levels="Yes",
                     subset=outcomes$visittypeid==3),
                if(any(outcomes$trime[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$trime_adh, row.name="Trimetazidine: adherence < 80%", x.levels="Yes",
                                                                                     subset=outcomes$visittypeid==3&outcomes$trime=="Yes"), 
                list(x=factor(outcomes$any_angther), row.name="Any of the above", x.levels="Yes", 
                     subset=outcomes$visittypeid==3),
                if(any(outcomes$any_angther[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=factor(outcomes$any_angther_adh), row.name="Any of the above: adherence < 80%", x.levels="Yes", 
                                                                                           subset=outcomes$visittypeid==3&outcomes$any_angther=="Yes")
              ),
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="4.7.3",
              tabtext="Secondary outcomes: angina medication and adherence at 12 months.",
              basedata=list(
                list(x=outcomes$medchg1, row.name="Medications changed since 6 months", x.levels="Yes",
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$beta, row.name="Beta-blocker", x.levels="Yes",
                     subset=outcomes$visittypeid==4),
                if(any(outcomes$beta[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$beta_adh, row.name="Beta-blocker: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==4&outcomes$beta=="Yes"),
                
                list(x=outcomes$gtn, row.name="GTN", x.levels="Yes",
                     subset=outcomes$visittypeid==4),
                if(any(outcomes$gtn[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$gtn_adh, row.name="GTN: adherence < 80%", x.levels="Yes",
                                                                                   subset=outcomes$visittypeid==4&outcomes$gtn=="Yes"),
                
                list(x=outcomes$nitr, row.name="Nitrate", x.levels="Yes",
                     subset=outcomes$visittypeid==4),
                if(any(outcomes$nitr[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$nitr_adh, row.name="Nitrate: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==4&outcomes$nitr=="Yes"),
                
                list(x=outcomes$nico, row.name="Nicorandil", x.levels="Yes",
                     subset=outcomes$visittypeid==4),
                if(any(outcomes$nico[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$nico_adh, row.name="Nicorandil: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==4&outcomes$nico=="Yes"),
                
                list(x=outcomes$ccb_any, row.name="Calcium channel blocker: any", x.levels="Yes",
                     subset=outcomes$visittypeid==4),
                if(any(outcomes$ccb_any[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=factor(outcomes$ccb_adh), row.name="Calcium channel blocker: adherence < 80%", x.levels="Yes",
                                                                                       subset=outcomes$visittypeid==4&outcomes$ivab=="Yes"),
                
                list(x=outcomes$ivab, row.name="Ivabradine", x.levels="Yes",
                     subset=outcomes$visittypeid==4),
                if(any(outcomes$ivab[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$ivab_adh, row.name="Ivabradine: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==4&outcomes$ivab=="Yes"),
                list(x=outcomes$rano, row.name="Ranolazine", x.levels="Yes",
                     subset=outcomes$visittypeid==4),
                if(any(outcomes$rano[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$rano_adh, row.name="Ranolazine: adherence < 80%", x.levels="Yes",
                                                                                    subset=outcomes$visittypeid==4&outcomes$rano=="Yes"),
                
                list(x=outcomes$trime, row.name="Trimetazidine", x.levels="Yes",
                     subset=outcomes$visittypeid==4),
                if(any(outcomes$trime[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$trime_adh, row.name="Trimetazidine: adherence < 80%", x.levels="Yes",
                                                                                     subset=outcomes$visittypeid==4&outcomes$trime=="Yes"), 
                list(x=factor(outcomes$any_angther), row.name="Any of the above", x.levels="Yes", 
                     subset=outcomes$visittypeid==4),
                if(any(outcomes$any_angther[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=factor(outcomes$any_angther_adh), row.name="Any of the above: adherence < 80%", x.levels="Yes", 
                                                                                           subset=outcomes$visittypeid==4&outcomes$any_angther=="Yes")
              ),
              treat=outcomes$trtgrp, out.file=tables.file)

sec_tab_474 <- list(head=rbindTable(list(Text="<b>Table 4.7.4: Secondary outcomes: Angina therapy adherence."), 
                                    cbindTable("", "", "", "All", "", "Control", "Intervention")
), 
body=rbindTable(summary.cat(x=factor(outcomes$any_angther), row.name="Any angina therapy at baseline", x.levels="Yes",
                            subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                summary.cat(x=factor(outcomes$any_angther_adh), row.name="Any angina therapy adherence poor/incomplete at baseline", x.levels="Yes",
                            subset=outcomes$visittypeid==1&outcomes$any_angther=="Yes", treat=outcomes$trtgrp),
                cbindTable("", list(Text="Fisher test for any poor angina therapy adherence at baseline by randomised group", Other=list(colspan=3)), "",
                           list(Text=p.format(fisher.test(outcomes$any_angther_adh[outcomes$visittypeid==1], outcomes$trtgrp[outcomes$visittypeid==1])$p.value), Other=list(colspan=2))),
                summary.cat(x=factor(outcomes$any_angther), row.name="Any angina therapy at 6 months", x.levels="Yes",
                            subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                summary.cat(x=factor(outcomes$any_angther_adh), row.name="Any angina therapy adherence poor/incomplete at 6 months", x.levels="Yes",
                            subset=outcomes$visittypeid==3&outcomes$any_angther=="Yes", treat=outcomes$trtgrp),
                cbindTable("", list(Text="Fisher test for any poor angina therapy adherence at 6 months by randomised group", Other=list(colspan=3)), "",
                           list(Text=p.format(fisher.test(outcomes$any_angther_adh[outcomes$visittypeid==3], outcomes$trtgrp[outcomes$visittypeid==3])$p.value), Other=list(colspan=2))),
                summary.cat(x=factor(outcomes$any_angther), row.name="Any angina therapy at 12 months", x.levels="Yes",
                            subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                summary.cat(x=factor(outcomes$any_angther_adh), row.name="Any angina therapy adherence poor/incomplete at 12 months", x.levels="Yes",
                            subset=outcomes$visittypeid==4&outcomes$any_angther=="Yes", treat=outcomes$trtgrp),
                cbindTable("", list(Text="Fisher test for any poor angina therapy adherence at 12 months by randomised group", Other=list(colspan=3)), "",
                           list(Text=p.format(fisher.test(outcomes$any_angther_adh[outcomes$visittypeid==4], outcomes$trtgrp[outcomes$visittypeid==4])$p.value), Other=list(colspan=2))),
                end.row(disclaimer=T))
)
ExportTable.HTML(sec_tab_474$head, sec_tab_474$body, horiz.fmt, filename=tables.file, first=F, last=F)

outcomes$any_prevther_adh <- ifelse(rowSums(outcomes[, c("asp_adh", "ezem_adh", "pcsk_adh", "omeg_adh", "antip_adh", "ace_adh", "arb_adh", "stat_adh", "arni_adh", "sglt_adh", "fibr_adh")]=="Yes", na.rm=T) > 0, "Yes", "No")

summary.table(tabnum="4.7.5", 
              tabtext="Secondary outcomes: preventative therapy medication at screening.", 
              basedata=list(
                list(x=outcomes$asp, row.name="Aspirin", x.levels="Yes", subset=outcomes$visittypeid==1),
                if(any(outcomes$asp[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$asp_adh, row.name="Aspirin: adherence < 80%", x.levels="Yes", 
                                                                                   subset=outcomes$visittypeid==1&outcomes$asp=="Yes"),
                list(x=outcomes$ezem, row.name="Ezetimibe", x.levels="Yes", subset=outcomes$visittypeid==1),
                if(any(outcomes$ezem[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$ezem_adh, row.name="Ezetimibe: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==1&outcomes$ezem=="Yes"),
                list(x=outcomes$pcsk, row.name="PCSK9 inhibitor", x.levels="Yes", subset=outcomes$visittypeid==1),
                if(any(outcomes$pcsk[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$pcsk_adh, row.name="PCSK9 inhibitor: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==1&outcomes$pcsk=="Yes"),
                list(x=outcomes$omeg, row.name="Omega-3 fatty acid", x.levels="Yes", subset=outcomes$visittypeid==1),
                if(any(outcomes$omeg[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$omeg_adh, row.name="Omega-3 fatty acid: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==1&outcomes$omeg=="Yes"),
                list(x=outcomes$antip, row.name="Other antiplatelet", x.levels="Yes", subset=outcomes$visittypeid==1),
                if(any(outcomes$antip[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$antip_adh, row.name="Other antiplatelet: adherence < 80%", x.levels="Yes", 
                                                                                     subset=outcomes$visittypeid==1&outcomes$antip=="Yes"),
                list(x=outcomes$ace, row.name="ACE inhibitor", x.levels="Yes", subset=outcomes$visittypeid==1),
                if(any(outcomes$ace[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$ace_adh, row.name="ACE inhibitor: adherence < 80%", x.levels="Yes", 
                                                                                   subset=outcomes$visittypeid==1&outcomes$ace=="Yes"),
                list(x=outcomes$arb, row.name="ARB", x.levels="Yes", subset=outcomes$visittypeid==1),
                if(any(outcomes$arb[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$arb_adh, row.name="ARB: adherence < 80%", x.levels="Yes", 
                                                                                   subset=outcomes$visittypeid==1&outcomes$arb=="Yes"),
                list(x=outcomes$stat, row.name="Statin", x.levels="Yes", subset=outcomes$visittypeid==1),
                if(any(outcomes$stat[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$stat_adh, row.name="Statin: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==1&outcomes$stat=="Yes"),
                list(x=outcomes$arni, row.name="ARNI", x.levels="Yes", subset=outcomes$visittypeid==1),
                if(any(outcomes$arni[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$arni_adh, row.name="ARNI: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==1&outcomes$arni=="Yes"),
                list(x=outcomes$sglt, row.name="SGLT2", x.levels="Yes", subset=outcomes$visittypeid==1),
                if(any(outcomes$sglt[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$sglt_adh, row.name="SGLT2: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==1&outcomes$sglt=="Yes"),
                list(x=outcomes$fibr, row.name="Fibrates", x.levels="Yes", subset=outcomes$visittypeid==1),
                if(any(outcomes$fibr[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=outcomes$fibr_adh, row.name="Fibrates: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==1&outcomes$fibr=="Yes"),
                list(x=factor(outcomes$any_prevther), row.name="Any preventative therapy", x.levels="Yes", subset=outcomes$visittypeid==1), 
                if(any(outcomes$any_prevther[outcomes$visittypeid==1]=="Yes", na.rm=T))list(x=factor(outcomes$any_prevther_adh), row.name="Any preventative therapy adherence poor/incomplete", 
                                                                                            x.levels="Yes", subset=outcomes$visittypeid==1)
                
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="4.7.6", 
              tabtext="Secondary outcomes: preventative therapy medication at 6 months.", 
              basedata=list(
                list(x=outcomes$medchg1, row.name="Medications changed since screening", x.levels="Yes",
                     subset=outcomes$visittypeid==3),
                list(x=outcomes$asp, row.name="Aspirin", x.levels="Yes", subset=outcomes$visittypeid==3),
                if(any(outcomes$asp[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$asp_adh, row.name="Aspirin: adherence < 80%", x.levels="Yes", 
                                                                                   subset=outcomes$visittypeid==3&outcomes$asp=="Yes"),
                list(x=outcomes$ezem, row.name="Ezetimibe", x.levels="Yes", subset=outcomes$visittypeid==3),
                if(any(outcomes$ezem[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$ezem_adh, row.name="Ezetimibe: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==3&outcomes$ezem=="Yes"),
                list(x=outcomes$pcsk, row.name="PCSK9 inhibitor", x.levels="Yes", subset=outcomes$visittypeid==3),
                if(any(outcomes$pcsk[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$pcsk_adh, row.name="PCSK9 inhibitor: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==3&outcomes$pcsk=="Yes"),
                list(x=outcomes$omeg, row.name="Omega-3 fatty acid", x.levels="Yes", subset=outcomes$visittypeid==3),
                if(any(outcomes$omeg[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$omeg_adh, row.name="Omega-3 fatty acid: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==3&outcomes$omeg=="Yes"),
                list(x=outcomes$antip, row.name="Other antiplatelet", x.levels="Yes", subset=outcomes$visittypeid==3),
                if(any(outcomes$antip[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$antip_adh, row.name="Other antiplatelet: adherence < 80%", x.levels="Yes", 
                                                                                     subset=outcomes$visittypeid==3&outcomes$antip=="Yes"),
                list(x=outcomes$ace, row.name="ACE inhibitor", x.levels="Yes", subset=outcomes$visittypeid==3),
                if(any(outcomes$ace[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$ace_adh, row.name="ACE inhibitor: adherence < 80%", x.levels="Yes", 
                                                                                   subset=outcomes$visittypeid==3&outcomes$ace=="Yes"),
                list(x=outcomes$arb, row.name="ARB", x.levels="Yes", subset=outcomes$visittypeid==3),
                if(any(outcomes$arb[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$arb_adh, row.name="ARB: adherence < 80%", x.levels="Yes", 
                                                                                   subset=outcomes$visittypeid==3&outcomes$arb=="Yes"),
                list(x=outcomes$stat, row.name="Statin", x.levels="Yes", subset=outcomes$visittypeid==3),
                if(any(outcomes$stat[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$stat_adh, row.name="Statin: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==3&outcomes$stat=="Yes"),
                list(x=outcomes$arni, row.name="ARNI", x.levels="Yes", subset=outcomes$visittypeid==3),
                if(any(outcomes$arni[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$arni_adh, row.name="ARNI: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==3&outcomes$arni=="Yes"),
                list(x=outcomes$sglt, row.name="SGLT2", x.levels="Yes", subset=outcomes$visittypeid==3),
                if(any(outcomes$sglt[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$sglt_adh, row.name="SGLT2: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==3&outcomes$sglt=="Yes"),
                list(x=outcomes$fibr, row.name="Fibrates", x.levels="Yes", subset=outcomes$visittypeid==3),
                if(any(outcomes$fibr[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=outcomes$fibr_adh, row.name="Fibrates: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==3&outcomes$fibr=="Yes"),
                list(x=factor(outcomes$any_prevther), row.name="Any preventative therapy", x.levels="Yes", subset=outcomes$visittypeid==3), 
                if(any(outcomes$any_prevther[outcomes$visittypeid==3]=="Yes", na.rm=T))list(x=factor(outcomes$any_prevther_adh), row.name="Any preventative therapy adherence poor/incomplete", 
                                                                                            x.levels="Yes", subset=outcomes$visittypeid==3)
                
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="4.7.7", 
              tabtext="Secondary outcomes: preventative therapy medication at 12 months.", 
              basedata=list(
                list(x=outcomes$medchg1, row.name="Medications changed since 6 months", x.levels="Yes",
                     subset=outcomes$visittypeid==4),
                list(x=outcomes$asp, row.name="Aspirin", x.levels="Yes", subset=outcomes$visittypeid==4),
                if(any(outcomes$asp[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$asp_adh, row.name="Aspirin: adherence < 80%", x.levels="Yes", 
                                                                                   subset=outcomes$visittypeid==4&outcomes$asp=="Yes"),
                list(x=outcomes$ezem, row.name="Ezetimibe", x.levels="Yes", subset=outcomes$visittypeid==4),
                if(any(outcomes$ezem[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$ezem_adh, row.name="Ezetimibe: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==4&outcomes$ezem=="Yes"),
                list(x=outcomes$pcsk, row.name="PCSK9 inhibitor", x.levels="Yes", subset=outcomes$visittypeid==4),
                if(any(outcomes$pcsk[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$pcsk_adh, row.name="PCSK9 inhibitor: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==4&outcomes$pcsk=="Yes"),
                list(x=outcomes$omeg, row.name="Omega-3 fatty acid", x.levels="Yes", subset=outcomes$visittypeid==4),
                if(any(outcomes$omeg[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$omeg_adh, row.name="Omega-3 fatty acid: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==4&outcomes$omeg=="Yes"),
                list(x=outcomes$antip, row.name="Other antiplatelet", x.levels="Yes", subset=outcomes$visittypeid==4),
                if(any(outcomes$antip[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$antip_adh, row.name="Other antiplatelet: adherence < 80%", x.levels="Yes", 
                                                                                     subset=outcomes$visittypeid==4&outcomes$antip=="Yes"),
                list(x=outcomes$ace, row.name="ACE inhibitor", x.levels="Yes", subset=outcomes$visittypeid==4),
                if(any(outcomes$ace[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$ace_adh, row.name="ACE inhibitor: adherence < 80%", x.levels="Yes", 
                                                                                   subset=outcomes$visittypeid==4&outcomes$ace=="Yes"),
                list(x=outcomes$arb, row.name="ARB", x.levels="Yes", subset=outcomes$visittypeid==4),
                if(any(outcomes$arb[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$arb_adh, row.name="ARB: adherence < 80%", x.levels="Yes", 
                                                                                   subset=outcomes$visittypeid==4&outcomes$arb=="Yes"),
                list(x=outcomes$stat, row.name="Statin", x.levels="Yes", subset=outcomes$visittypeid==4),
                if(any(outcomes$stat[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$stat_adh, row.name="Statin: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==4&outcomes$stat=="Yes"),
                list(x=outcomes$arni, row.name="ARNI", x.levels="Yes", subset=outcomes$visittypeid==4),
                if(any(outcomes$arni[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$arni_adh, row.name="ARNI: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==4&outcomes$arni=="Yes"),
                list(x=outcomes$sglt, row.name="SGLT2", x.levels="Yes", subset=outcomes$visittypeid==4),
                if(any(outcomes$sglt[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$sglt_adh, row.name="SGLT2: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==4&outcomes$sglt=="Yes"),
                list(x=outcomes$fibr, row.name="Fibrates", x.levels="Yes", subset=outcomes$visittypeid==4),
                if(any(outcomes$fibr[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=outcomes$fibr_adh, row.name="Fibrates: adherence < 80%", x.levels="Yes", 
                                                                                    subset=outcomes$visittypeid==4&outcomes$fibr=="Yes"),
                list(x=factor(outcomes$any_prevther), row.name="Any preventative therapy", x.levels="Yes", subset=outcomes$visittypeid==4), 
                if(any(outcomes$any_prevther[outcomes$visittypeid==4]=="Yes", na.rm=T))list(x=factor(outcomes$any_prevther_adh), row.name="Any preventative therapy adherence poor/incomplete", 
                                                                                            x.levels="Yes", subset=outcomes$visittypeid==4)
                
              ), 
              treat=outcomes$trtgrp, out.file=tables.file)

sec_tab_478 <- list(head=rbindTable(list(Text="<b>Table 4.7.8: Secondary outcomes: Preventative therapy adherence."), 
                                    cbindTable("", "", "", "All", "", "Control", "Intervention")
), 
body=rbindTable(summary.cat(x=factor(outcomes$any_prevther), row.name="Any preventative therapy at baseline", x.levels="Yes",
                            subset=outcomes$visittypeid==1, treat=outcomes$trtgrp),
                summary.cat(x=factor(outcomes$any_prevther_adh), row.name="Any preventative therapy adherence poor/incomplete at baseline", x.levels="Yes",
                            subset=outcomes$visittypeid==1&outcomes$any_prevther=="Yes", treat=outcomes$trtgrp),
                cbindTable("", list(Text="Fisher test for any poor preventative therapy adherence at baseline by randomised group", Other=list(colspan=3)), "",
                           list(Text=p.format(fisher.test(outcomes$any_prevther_adh[outcomes$visittypeid==1], outcomes$trtgrp[outcomes$visittypeid==1])$p.value), Other=list(colspan=2))),
                summary.cat(x=factor(outcomes$any_prevther), row.name="Any preventative therapy at 6 months", x.levels="Yes",
                            subset=outcomes$visittypeid==3, treat=outcomes$trtgrp),
                summary.cat(x=factor(outcomes$any_prevther_adh), row.name="Any preventative therapy adherence poor/incomplete at 6 months", x.levels="Yes",
                            subset=outcomes$visittypeid==3&outcomes$any_prevther=="Yes", treat=outcomes$trtgrp),
                cbindTable("", list(Text="Fisher test for any poor preventative therapy adherence at 6 months by randomised group", Other=list(colspan=3)), "",
                           list(Text=p.format(fisher.test(outcomes$any_prevther_adh[outcomes$visittypeid==3], outcomes$trtgrp[outcomes$visittypeid==3])$p.value), Other=list(colspan=2))),
                summary.cat(x=factor(outcomes$any_prevther), row.name="Any preventative therapy at 12 months", x.levels="Yes",
                            subset=outcomes$visittypeid==4, treat=outcomes$trtgrp),
                summary.cat(x=factor(outcomes$any_prevther_adh), row.name="Any preventative therapy adherence poor/incomplete at 12 months", x.levels="Yes",
                            subset=outcomes$visittypeid==4&outcomes$any_prevther=="Yes", treat=outcomes$trtgrp),
                cbindTable("", list(Text="Fisher test for any poor preventative therapy adherence at 12 months by randomised group", Other=list(colspan=3)), "",
                           list(Text=p.format(fisher.test(outcomes$any_prevther_adh[outcomes$visittypeid==4], outcomes$trtgrp[outcomes$visittypeid==4])$p.value), Other=list(colspan=2))),
                end.row(disclaimer=T))
)
ExportTable.HTML(sec_tab_478$head, sec_tab_478$body, horiz.fmt, filename=tables.file, first=F, last=F)

#### PHASE 2 ANALYSES
summary.table(tabnum="4.8", 
              tabtext="Secondary outcomes: abnormal blood flow in the heart.", 
              basedata=list(
                list(x=mri$strglmbf_225, row.name="Global MBF during stress < 2.25 ml/min/g", x.levels="Yes", subset=!is.na(mri$trtgrp)),
                list(x=mri$glmpr_22, row.name="Global myocardial perfusion reserve < 2.2", x.levels="Yes", subset=!is.na(mri$trtgrp)),
                list(x=mri$enmpr_241, row.name="Endocardial myocardial perfusion reserve < 2.41", x.levels="Yes", subset=!is.na(mri$trtgrp))
              ), 
              treat=mri$trtgrp, out.file=tables.file)

corfunc_mbf <- merge(corfunctest, 
                     mri[, c("sno", "cardiac_strglmbf", "cardiac_strenmbf", "cardiac_strepmbf", 
                             "cardiac_restglmbf", "cardiac_restenmbf", "cardiac_restepmbf", 
                             "cardiac_glmpr", "cardiac_enmpr", "cardiac_epmpr")], 
                     by="sno", all.x=T)

sec_tab_49 <- list(head=rbindTable(list(Text="<b>Table 4.9: Secondary outcomes: Associations between measures of myocardial blood flow and invasive measures of coronary function.</b>", 
                                       Other=list(colspan=6)), 
                                  list(Text="Estimates of Pearson's correlation coefficient are presented, with a 95% confidence interval for each estimate and a p-value for a test of association between the two variables.", 
                                       Other=list(colspan=6)),
                                  cbindTable("", "", list(Text="Coronary function test measure", Other=list(colspan=4))),
                                  cbindTable("Myocardial blood flow measure", "Summary statistics", "CFR", "IMR", "FFR", "RFR")), 
                  body=rbindTable(cbindTable("Global MBF at rest", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_restglmbf, var2=corfunc_mbf$cfr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_restglmbf, var2=corfunc_mbf$imr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_restglmbf, var2=corfunc_mbf$ffr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_restglmbf, var2=corfunc_mbf$rfr, digits=2)),
                                  cbindTable("Endocardial MBF at rest", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_restenmbf, var2=corfunc_mbf$cfr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_restenmbf, var2=corfunc_mbf$imr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_restenmbf, var2=corfunc_mbf$ffr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_restenmbf, var2=corfunc_mbf$rfr, digits=2)),
                                  cbindTable("Epicardial MBF at rest", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_restepmbf, var2=corfunc_mbf$cfr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_restepmbf, var2=corfunc_mbf$imr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_restepmbf, var2=corfunc_mbf$ffr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_restepmbf, var2=corfunc_mbf$rfr, digits=2)),
                                  cbindTable("Global MBF under stress", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_strglmbf, var2=corfunc_mbf$cfr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_strglmbf, var2=corfunc_mbf$imr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_strglmbf, var2=corfunc_mbf$ffr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_strglmbf, var2=corfunc_mbf$rfr, digits=2)),
                                  cbindTable("Endocardial MBF under stress", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_strenmbf, var2=corfunc_mbf$cfr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_strenmbf, var2=corfunc_mbf$imr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_strenmbf, var2=corfunc_mbf$ffr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_strenmbf, var2=corfunc_mbf$rfr, digits=2)),
                                  cbindTable("Epicardial MBF under stress", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_strepmbf, var2=corfunc_mbf$cfr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_strepmbf, var2=corfunc_mbf$imr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_strepmbf, var2=corfunc_mbf$ffr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_strepmbf, var2=corfunc_mbf$rfr, digits=2)),
                                  cbindTable("Global MPR", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_glmpr, var2=corfunc_mbf$cfr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_glmpr, var2=corfunc_mbf$imr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_glmpr, var2=corfunc_mbf$ffr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_glmpr, var2=corfunc_mbf$rfr, digits=2)),
                                  cbindTable("Endocardial MPR", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_enmpr, var2=corfunc_mbf$cfr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_enmpr, var2=corfunc_mbf$imr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_enmpr, var2=corfunc_mbf$ffr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_enmpr, var2=corfunc_mbf$rfr, digits=2)),
                                  cbindTable("Epicardial MPR", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_epmpr, var2=corfunc_mbf$cfr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_epmpr, var2=corfunc_mbf$imr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_epmpr, var2=corfunc_mbf$ffr, digits=2),
                                             corr.out(data=corfunc_mbf, var1=corfunc_mbf$cardiac_epmpr, var2=corfunc_mbf$rfr, digits=2)),
                                  end.row(disclaimer=T)
                                  )
)
ExportTable.HTML(sec_tab_49$head, sec_tab_49$body, horiz.fmt, filename=tables.file, first=F, last=F)

sec_tab_410 <- list(head=rbindTable(list(Text="<b>Table 4.10: Secondary outcomes: Associations between measures of myocardial blood flow and myocardial tissue characteristics.</b>", 
                                         Other=list(colspan=5)), 
                                    list(Text="Estimates of Pearson's correlation coefficient are presented, with a 95% confidence interval for each estimate and a p-value for a test of association between the two variables.", 
                                         Other=list(colspan=5)),
                                    cbindTable("", "", list(Text="Myocardial tissue characteristic", Other=list(colspan=3))),
                                    cbindTable("Myocardial blood flow measure", "Summary statistics", "T1 relaxation time (ms)", "T2 relaxation time (ms)", "ECV")), 
                    body=rbindTable(cbindTable("Global MBF at rest", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri, var1=mri$cardiac_restglmbf, var2=mri$cardiac_avgt1, digits=2), 
                                               corr.out(data=mri, var1=mri$cardiac_restglmbf, var2=mri$cardiac_globt2, digits=2),
                                               corr.out(data=mri, var1=mri$cardiac_restglmbf, var2=mri$cardiac_globecv, digits=2)), 
                                    cbindTable("Endocardial MBF at rest", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri, var1=mri$cardiac_restenmbf, var2=mri$cardiac_avgt1, digits=2), 
                                               corr.out(data=mri, var1=mri$cardiac_restenmbf, var2=mri$cardiac_globt2, digits=2),
                                               corr.out(data=mri, var1=mri$cardiac_restenmbf, var2=mri$cardiac_globecv, digits=2)),
                                    cbindTable("Epicardial MBF at rest", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri, var1=mri$cardiac_restepmbf, var2=mri$cardiac_avgt1, digits=2), 
                                               corr.out(data=mri, var1=mri$cardiac_restepmbf, var2=mri$cardiac_globt2, digits=2),
                                               corr.out(data=mri, var1=mri$cardiac_restepmbf, var2=mri$cardiac_globecv, digits=2)),
                                    cbindTable("Global MBF under stress", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri, var1=mri$cardiac_strglmbf, var2=mri$cardiac_avgt1, digits=2), 
                                               corr.out(data=mri, var1=mri$cardiac_strglmbf, var2=mri$cardiac_globt2, digits=2),
                                               corr.out(data=mri, var1=mri$cardiac_strglmbf, var2=mri$cardiac_globecv, digits=2)), 
                                    cbindTable("Endocardial MBF under stress", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri, var1=mri$cardiac_strenmbf, var2=mri$cardiac_avgt1, digits=2), 
                                               corr.out(data=mri, var1=mri$cardiac_strenmbf, var2=mri$cardiac_globt2, digits=2),
                                               corr.out(data=mri, var1=mri$cardiac_strenmbf, var2=mri$cardiac_globecv, digits=2)),
                                    cbindTable("Epicardial MBF under stress", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri, var1=mri$cardiac_strepmbf, var2=mri$cardiac_avgt1, digits=2), 
                                               corr.out(data=mri, var1=mri$cardiac_strepmbf, var2=mri$cardiac_globt2, digits=2),
                                               corr.out(data=mri, var1=mri$cardiac_strepmbf, var2=mri$cardiac_globecv, digits=2)),
                                    end.row(disclaimer=T)
                    )
)
ExportTable.HTML(sec_tab_410$head, sec_tab_410$body, horiz.fmt, filename=tables.file, first=F, last=F)

mri_cardrisk <- merge(mri, screening[, c("sno", "qr3risksc_calc", "assign_score")], by="sno", all.x=T)
sec_tab_411 <- list(head=rbindTable(list(Text="<b>Table 4.11: Secondary outcomes: Associations between measures of myocardial blood flow and cardiovascular risk scores.</b>", 
                                         Other=list(colspan=4)), 
                                    list(Text="Estimates of Pearson's correlation coefficient are presented, with a 95% confidence interval for each estimate and a p-value for a test of association between the two variables.", 
                                         Other=list(colspan=4)),
                                    cbindTable("", "", list(Text="Cardiovascular risk score", Other=list(colspan=2))),
                                    cbindTable("Myocardial blood flow measure", "Summary statistics", "QRISK3 score", "ASSIGN score")), 
                    body=rbindTable(cbindTable("Global MBF at rest", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri_cardrisk, var1=mri_cardrisk$cardiac_restglmbf, var2=mri_cardrisk$qr3risksc_calc, digits=2), 
                                               corr.out(data=mri_cardrisk, var1=mri_cardrisk$cardiac_restglmbf, var2=mri_cardrisk$assign_score, digits=2)), 
                                    cbindTable("Endocardial MBF at rest", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri_cardrisk, var1=mri_cardrisk$cardiac_restenmbf, var2=mri_cardrisk$qr3risksc_calc, digits=2), 
                                               corr.out(data=mri_cardrisk, var1=mri_cardrisk$cardiac_restenmbf, var2=mri_cardrisk$assign_score, digits=2)),
                                    cbindTable("Epicardial MBF at rest", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri_cardrisk, var1=mri_cardrisk$cardiac_restepmbf, var2=mri_cardrisk$qr3risksc_calc, digits=2), 
                                               corr.out(data=mri_cardrisk, var1=mri_cardrisk$cardiac_restepmbf, var2=mri_cardrisk$assign_score, digits=2)),
                                    cbindTable("Global MBF under stress", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri_cardrisk, var1=mri_cardrisk$cardiac_strglmbf, var2=mri_cardrisk$qr3risksc_calc, digits=2), 
                                               corr.out(data=mri_cardrisk, var1=mri_cardrisk$cardiac_strglmbf, var2=mri_cardrisk$assign_score, digits=2)), 
                                    cbindTable("Endocardial MBF under stress", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri_cardrisk, var1=mri_cardrisk$cardiac_strenmbf, var2=mri_cardrisk$qr3risksc_calc, digits=2), 
                                               corr.out(data=mri_cardrisk, var1=mri_cardrisk$cardiac_strenmbf, var2=mri_cardrisk$assign_score, digits=2)),
                                    cbindTable("Epicardial MBF under stress", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri_cardrisk, var1=mri_cardrisk$cardiac_strepmbf, var2=mri_cardrisk$qr3risksc_calc, digits=2), 
                                               corr.out(data=mri_cardrisk, var1=mri_cardrisk$cardiac_strepmbf, var2=mri_cardrisk$assign_score, digits=2)),
                                    end.row(disclaimer=T)
                    )
)
ExportTable.HTML(sec_tab_411$head, sec_tab_411$body, horiz.fmt, filename=tables.file, first=F, last=F)

moc_assoc <- merge(outcomes[outcomes$visittypeid==1, c("sno", "moc_sc_bl", "saq_af_bl", "saq_summ_bl")], 
                   outcomes[outcomes$visittypeid==4, c("sno", "moc_sc")], by="sno", all.x=T)
moc_assoc$mridiag <- diagnoses$mridiag[match(moc_assoc$sno, diagnoses$sno)]
moc_assoc <- merge(moc_assoc, screening[, c("sno", "age", "sex", "simd_quintile")], by="sno", all.x=T)
moc_assoc <- merge(moc_assoc, mri[, c("sno", "strglmbf_225", "glmpr_22", "enmpr_241")], by="sno", all.x=T)
# create grouping variables as required: subject to change based on finalised SAP
moc_assoc$age_grp <- factor(ifelse(is.na(moc_assoc$age), NA, 
                                   ifelse(moc_assoc$age <= quantile(moc_assoc$age, probs=0.334, na.rm=T), 1, 
                                          ifelse(moc_assoc$age > quantile(moc_assoc$age, probs=0.334, na.rm=T) & moc_assoc$age <= quantile(moc_assoc$age, probs=0.667, na.rm=T), 2, 
                                                 ifelse(moc_assoc$age > quantile(moc_assoc$age, probs=0.667, na.rm=T), 3, NA)))), 
                            levels=c(1:3), labels=c(paste0("T1: ", min(moc_assoc$age, na.rm=T), " - ", quantile(moc_assoc$age, probs=0.334, na.rm=T)), 
                                                    paste0("T2: ", quantile(moc_assoc$age, probs=0.334, na.rm=T) + 1, " - ", quantile(moc_assoc$age, probs=0.667, na.rm=T)), 
                                                    paste0("T3: ", quantile(moc_assoc$age, probs=0.667, na.rm=T) + 1, " - ", max(moc_assoc$age, na.rm=T))))
moc_assoc$simd2 <- factor(moc_assoc$simd_quintile, levels=levels(moc_assoc$simd_quintile), labels=c("1-2", "1-2", "3-5", "3-5", "3-5"))
# baseline SAQ score
# baseline angina frequency
moc_assoc$saq_af_grp <- factor(ifelse(is.na(moc_assoc$saq_af_bl), NA, 
                                      ifelse(moc_assoc$saq_af_bl <= 30, 1, 
                                             ifelse(moc_assoc$saq_af_bl > 30 & moc_assoc$saq_af_bl <= 60, 2, 
                                                    ifelse(moc_assoc$saq_af_bl > 60 & moc_assoc$saq_af_bl <= 99, 3, 
                                                           ifelse(moc_assoc$saq_af_bl==100, 4, NA))))), 
                               levels=c(1:4), labels=c("Daily angina", "Weekly angina", "Monthly angina", "No angina"))

moc_assoc$saq_summ_grp <- factor(ifelse(is.na(moc_assoc$saq_summ_bl), NA, 
                                      ifelse(moc_assoc$saq_summ_bl < 25, 1, 
                                             ifelse(moc_assoc$saq_summ_bl >= 24 & moc_assoc$saq_summ_bl < 50, 2, 
                                                    ifelse(moc_assoc$saq_summ_bl >= 50 & moc_assoc$saq_summ_bl < 75, 3, 
                                                           ifelse(moc_assoc$saq_summ_bl >= 75, 4, NA))))), 
                               levels=c(1:4), labels=c("Poor health", "Fair health", "Good health", "Excellent health"))

sec_tab_4121 <- list(head=rbindTable(list(Text="<b>Table 4.12.1: Secondary outcomes: Associations between cognition at baseline and patient characteristics.</b>", 
                                         Other=list(colspan=4)),
                                     list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                     "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                     "&Chi;<sup>2</sup>.")),
                                    cbindTable("", "Summary statistics", "", "Montreal Cognitive Assessment Score (baseline)")
                                    ), 
                    body=rbindTable(summary.cts(moc_assoc$moc_sc_bl, row.name="All participants", treat=NULL),
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Age tertile 1: 37 - 59", treat=NULL, subset=moc_assoc$age_grp=="T1: 37 - 59"),
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Age tertile 2: 60 - 68", treat=NULL, subset=moc_assoc$age_grp=="T2: 60 - 68"),
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Age tertile 3: 69 - 85", treat=NULL, subset=moc_assoc$age_grp=="T3: 69 - 85"),
                                    cbindTable(list(Text="p-value: age tertile", Other=list(colspan=2)), "", pfun("moc_sc_bl", "age_grp", moc_assoc)), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Sex: Male", treat=NULL, subset=moc_assoc$sex=="Male"),
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Sex: Female", treat=NULL, subset=moc_assoc$sex=="Female"),
                                    cbindTable(list(Text="p-value", Other=list(colspan=2)), "", pfun("moc_sc_bl", "sex", moc_assoc)), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="SIMD quintile: 1-2", treat=NULL, subset=moc_assoc$simd2=="1-2"),
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="SIMD quintile: 3-5", treat=NULL, subset=moc_assoc$simd2=="3-5"),
                                    cbindTable(list(Text="p-value: SIMD group", Other=list(colspan=2)), "", pfun("moc_sc_bl", "simd2", moc_assoc)), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Baseline SAQ summary score 0 - 24", treat=NULL, subset=moc_assoc$saq_summ_grp=="Poor health"), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Baseline SAQ summary score 25 - 49", treat=NULL, subset=moc_assoc$saq_summ_grp=="Fair health"), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Baseline SAQ summary score 50 - 74", treat=NULL, subset=moc_assoc$saq_summ_grp=="Good health"), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Baseline SAQ summary score 75 - 100", treat=NULL, subset=moc_assoc$saq_summ_grp=="Excellent health"), 
                                    cbindTable(list(Text="p-value: baseline SAQ summary score", Other=list(colspan=2)), "", pfun("moc_sc_bl", "saq_summ_grp", moc_assoc)), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Baseline SAQ angina frequency score 0 - 30", treat=NULL, subset=moc_assoc$saq_af_grp=="Daily angina"), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Baseline SAQ angina frequency score 31 - 60", treat=NULL, subset=moc_assoc$saq_af_grp=="Weekly angina"), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Baseline SAQ angina frequency score 61 - 99", treat=NULL, subset=moc_assoc$saq_af_grp=="Monthly angina"), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Baseline SAQ angina frequency score 100", treat=NULL, subset=moc_assoc$saq_af_grp=="No angina"), 
                                    cbindTable(list(Text="p-value: baseline SAQ angina frequency score", Other=list(colspan=2)), "", pfun("moc_sc_bl", "saq_af_grp", moc_assoc)), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="MRI diagnosis of microvascular angina", treat=NULL, subset=moc_assoc$mridiag=="Microvascular angina"), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="MRI diagnosis of vasospastic angina", treat=NULL, subset=moc_assoc$mridiag=="Vasospastic angina"), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="MRI diagnosis of non-cardiac chest pain", treat=NULL, subset=moc_assoc$mridiag=="Non-cardiac chest pain"),
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Other MRI diagnosis", treat=NULL, subset=moc_assoc$mridiag=="Other"), 
                                    cbindTable(list(Text="p-value: MRI diagnosis", Other=list(colspan=2)), "", pfun("moc_sc_bl", "mridiag", moc_assoc)), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Global MBF under stress < 2.25", treat=NULL, subset=moc_assoc$strglmbf_225=="Yes"),
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Global MBF under stress &ge; 2.25", treat=NULL, subset=moc_assoc$strglmbf_225=="No"),
                                    cbindTable(list(Text="p-value: global MBF", Other=list(colspan=2)), "", pfun("moc_sc_bl", "strglmbf_225", moc_assoc)), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Global MPR < 2.2", treat=NULL, subset=moc_assoc$glmpr_22=="Yes"),
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Global MPR &ge; 2.2", treat=NULL, subset=moc_assoc$glmpr_22=="No"),
                                    cbindTable(list(Text="p-value: global MPR", Other=list(colspan=2)), "", pfun("moc_sc_bl", "glmpr_22", moc_assoc)), 
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Endocardial MPR < 2.41", treat=NULL, subset=moc_assoc$enmpr_241=="Yes"),
                                    summary.cts(moc_assoc$moc_sc_bl, row.name="Endocardial MPR &ge; 2.41", treat=NULL, subset=moc_assoc$enmpr_241=="No"),
                                    cbindTable(list(Text="p-value: endocardial MPR", Other=list(colspan=2)), "", pfun("moc_sc_bl", "enmpr_241", moc_assoc)), 
                                    end.row(disclaimer=T))
                    )
ExportTable.HTML(sec_tab_4121$head, sec_tab_4121$body, horiz.fmt, filename=tables.file, first=F, last=F)

sec_tab_4122 <- list(head=rbindTable(list(Text="<b>Table 4.12.2: Secondary outcomes: Associations between cognition at 12 months and patient characteristics.</b>", 
                                          Other=list(colspan=4)),
                                     list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                     "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                     "&Chi;<sup>2</sup>.")),
                                     cbindTable("", "Summary statistics", "", "Montreal Cognitive Assessment Score (12 months)")
), 
body=rbindTable(summary.cts(moc_assoc$moc_sc, row.name="All participants", treat=NULL),
                summary.cts(moc_assoc$moc_sc, row.name="Age tertile 1: 37 - 59", treat=NULL, subset=moc_assoc$age_grp=="T1: 37 - 59"),
                summary.cts(moc_assoc$moc_sc, row.name="Age tertile 2: 60 - 68", treat=NULL, subset=moc_assoc$age_grp=="T2: 60 - 68"),
                summary.cts(moc_assoc$moc_sc, row.name="Age tertile 3: 69 - 85", treat=NULL, subset=moc_assoc$age_grp=="T3: 69 - 85"),
                cbindTable(list(Text="p-value: age tertile", Other=list(colspan=2)), "", pfun("moc_sc", "age_grp", moc_assoc)), 
                summary.cts(moc_assoc$moc_sc, row.name="Sex: Male", treat=NULL, subset=moc_assoc$sex=="Male"),
                summary.cts(moc_assoc$moc_sc, row.name="Sex: Female", treat=NULL, subset=moc_assoc$sex=="Female"),
                cbindTable(list(Text="p-value", Other=list(colspan=2)), "", pfun("moc_sc", "sex", moc_assoc)), 
                summary.cts(moc_assoc$moc_sc, row.name="SIMD quintile: 1-2", treat=NULL, subset=moc_assoc$simd2=="1-2"),
                summary.cts(moc_assoc$moc_sc, row.name="SIMD quintile: 3-5", treat=NULL, subset=moc_assoc$simd2=="3-5"),
                cbindTable(list(Text="p-value: SIMD group", Other=list(colspan=2)), "", pfun("moc_sc", "simd2", moc_assoc)), 
                summary.cts(moc_assoc$moc_sc, row.name="Baseline SAQ summary score 0 - 24", treat=NULL, subset=moc_assoc$saq_summ_grp=="Poor health"), 
                summary.cts(moc_assoc$moc_sc, row.name="Baseline SAQ summary score 25 - 49", treat=NULL, subset=moc_assoc$saq_summ_grp=="Fair health"), 
                summary.cts(moc_assoc$moc_sc, row.name="Baseline SAQ summary score 50 - 74", treat=NULL, subset=moc_assoc$saq_summ_grp=="Good health"), 
                summary.cts(moc_assoc$moc_sc, row.name="Baseline SAQ summary score 75 - 100", treat=NULL, subset=moc_assoc$saq_summ_grp=="Excellent health"), 
                cbindTable(list(Text="p-value: baseline SAQ summary score", Other=list(colspan=2)), "", pfun("moc_sc", "saq_summ_grp", moc_assoc)), 
                summary.cts(moc_assoc$moc_sc, row.name="Baseline SAQ angina frequency score 0 - 30", treat=NULL, subset=moc_assoc$saq_af_grp=="Daily angina"), 
                summary.cts(moc_assoc$moc_sc, row.name="Baseline SAQ angina frequency score 31 - 60", treat=NULL, subset=moc_assoc$saq_af_grp=="Weekly angina"), 
                summary.cts(moc_assoc$moc_sc, row.name="Baseline SAQ angina frequency score 61 - 99", treat=NULL, subset=moc_assoc$saq_af_grp=="Monthly angina"), 
                summary.cts(moc_assoc$moc_sc, row.name="Baseline SAQ angina frequency score 100", treat=NULL, subset=moc_assoc$saq_af_grp=="No angina"), 
                cbindTable(list(Text="p-value: baseline SAQ angina frequency score", Other=list(colspan=2)), "", pfun("moc_sc", "saq_af_grp", moc_assoc)), 
                summary.cts(moc_assoc$moc_sc, row.name="MRI diagnosis of microvascular angina", treat=NULL, subset=moc_assoc$mridiag=="Microvascular angina"), 
                summary.cts(moc_assoc$moc_sc, row.name="MRI diagnosis of vasospastic angina", treat=NULL, subset=moc_assoc$mridiag=="Vasospastic angina"), 
                summary.cts(moc_assoc$moc_sc, row.name="MRI diagnosis of non-cardiac chest pain", treat=NULL, subset=moc_assoc$mridiag=="Non-cardiac chest pain"),
                summary.cts(moc_assoc$moc_sc, row.name="Other MRI diagnosis", treat=NULL, subset=moc_assoc$mridiag=="Other"), 
                cbindTable(list(Text="p-value: MRI diagnosis", Other=list(colspan=2)), "", pfun("moc_sc", "mridiag", moc_assoc)), 
                summary.cts(moc_assoc$moc_sc, row.name="Global MBF under stress < 2.25", treat=NULL, subset=moc_assoc$strglmbf_225=="Yes"),
                summary.cts(moc_assoc$moc_sc, row.name="Global MBF under stress &ge; 2.25", treat=NULL, subset=moc_assoc$strglmbf_225=="No"),
                cbindTable(list(Text="p-value: global MBF", Other=list(colspan=2)), "", pfun("moc_sc", "strglmbf_225", moc_assoc)), 
                summary.cts(moc_assoc$moc_sc, row.name="Global MPR < 2.2", treat=NULL, subset=moc_assoc$glmpr_22=="Yes"),
                summary.cts(moc_assoc$moc_sc, row.name="Global MPR &ge; 2.2", treat=NULL, subset=moc_assoc$glmpr_22=="No"),
                cbindTable(list(Text="p-value: global MPR", Other=list(colspan=2)), "", pfun("moc_sc", "glmpr_22", moc_assoc)), 
                summary.cts(moc_assoc$moc_sc, row.name="Endocardial MPR < 2.41", treat=NULL, subset=moc_assoc$enmpr_241=="Yes"),
                summary.cts(moc_assoc$moc_sc, row.name="Endocardial MPR &ge; 2.41", treat=NULL, subset=moc_assoc$enmpr_241=="No"),
                cbindTable(list(Text="p-value: endocardial MPR", Other=list(colspan=2)), "", pfun("moc_sc", "enmpr_241", moc_assoc)), 
                end.row(disclaimer=T))
)
ExportTable.HTML(sec_tab_4122$head, sec_tab_4122$body, horiz.fmt, filename=tables.file, first=F, last=F)

mri_healthstat <- merge(mri, outcomes[outcomes$visittypeid==1, c("sno", "eq5d_score_bl", "eq5d_health_bl", "saq_summ_bl")], by="sno", all.x=T)

sec_tab_413 <- list(head=rbindTable(list(Text="<b>Table 4.13: Secondary outcomes: Associations between measures of myocardial blood flow and health status at screening.</b>", 
                                         Other=list(colspan=5)), 
                                    list(Text="Estimates of Pearson's correlation coefficient are presented, with a 95% confidence interval for each estimate and a p-value for a test of association between the two variables.", 
                                         Other=list(colspan=5)),
                                    cbindTable("", "", list(Text="Health status measure ", Other=list(colspan=3))),
                                    cbindTable("Myocardial blood flow measure", "Summary statistics", "SAQ summary score", "EQ-5D health utility score", "EQ-5D VAS")), 
                    body=rbindTable(cbindTable("Global MBF at rest", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_restglmbf, var2=mri_healthstat$saq_summ_bl, digits=2), 
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_restglmbf, var2=mri_healthstat$eq5d_score_bl, digits=2), 
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_restglmbf, var2=mri_healthstat$eq5d_health_bl, digits=2)), 
                                    cbindTable("Endocardial MBF at rest", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_restenmbf, var2=mri_healthstat$saq_summ_bl, digits=2), 
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_restenmbf, var2=mri_healthstat$eq5d_score_bl, digits=2), 
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_restenmbf, var2=mri_healthstat$eq5d_health_bl, digits=2)),
                                    cbindTable("Epicardial MBF at rest", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_restepmbf, var2=mri_healthstat$saq_summ_bl, digits=2), 
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_restepmbf, var2=mri_healthstat$eq5d_score_bl, digits=2), 
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_restepmbf, var2=mri_healthstat$eq5d_health_bl, digits=2)),
                                    cbindTable("Global MBF under stress", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_strglmbf, var2=mri_healthstat$saq_summ_bl, digits=2), 
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_strglmbf, var2=mri_healthstat$eq5d_score_bl, digits=2), 
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_strglmbf, var2=mri_healthstat$eq5d_health_bl, digits=2)), 
                                    cbindTable("Endocardial MBF under stress", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_strenmbf, var2=mri_healthstat$saq_summ_bl, digits=2), 
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_strenmbf, var2=mri_healthstat$eq5d_score_bl, digits=2),
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_strenmbf, var2=mri_healthstat$eq5d_health_bl, digits=2)),
                                    cbindTable("Epicardial MBF under stress", "N paired observations<br>Estimate<br>95% CI<br>p-value",
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_strepmbf, var2=mri_healthstat$saq_summ_bl, digits=2), 
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_strepmbf, var2=mri_healthstat$eq5d_score_bl, digits=2), 
                                               corr.out(data=mri_healthstat, var1=mri_healthstat$cardiac_strepmbf, var2=mri_healthstat$eq5d_health_bl, digits=2)),
                                    end.row(disclaimer=T)
                    )
)
ExportTable.HTML(sec_tab_413$head, sec_tab_413$body, horiz.fmt, filename=tables.file, first=F, last=F)

medadh_sub <- merge(outcomes[outcomes$visittypeid==3, c("sno", "any_angther", "any_angther_adh", "any_prevther", "any_prevther_adh")], 
                    moc_assoc[, c("sno", "age_grp", "sex", "simd2", "saq_summ_grp", "saq_af_grp", "mridiag", "strglmbf_225", "glmpr_22", "enmpr_241")], 
                    by="sno", all.x=T)
sec_tab_4141 <- list(head=rbindTable(list(Text="<b>Table 4.14.1: Secondary outcomes: Associations between angina medication adherence at 6 months and patient characteristics.</b>", 
                                          Other=list(colspan=4)),
                                     cbindTable("", list(Text="Summary statistics", Other=list(colspan=3)))
                                     ), 
body=rbindTable(summary.cat(factor(medadh_sub$any_angther), row.name="Any angina medication - all participants", treat=NULL),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Any angina medication with poor/incomplete adherence - all participants", treat=NULL, subset=medadh_sub$any_angther=="Yes"), 
                
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - age tertile 1: 37 - 59", treat=NULL, subset=medadh_sub$age_grp=="T1: 37 - 59"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - age tertile 2: 60 - 68", treat=NULL, subset=medadh_sub$age_grp=="T2: 60 - 68"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - age tertile 3: 69 - 85", treat=NULL, subset=medadh_sub$age_grp=="T3: 69 - 85"&medadh_sub$any_angther=="Yes"),
                cbindTable(list(Text="p-value: age tertile", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_angther_adh), medadh_sub$age_grp)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - sex: male", treat=NULL, subset=medadh_sub$sex=="Male"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - sex: female", treat=NULL, subset=medadh_sub$sex=="Female"&medadh_sub$any_angther=="Yes"),
                cbindTable(list(Text="p-value: sex", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_angther_adh), medadh_sub$sex)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - SIMD quintile 1-2", treat=NULL, subset=medadh_sub$simd2=="1-2"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - SIMD quintile 3-5", treat=NULL, subset=medadh_sub$simd2=="3-5"&medadh_sub$any_angther=="Yes"),
                cbindTable(list(Text="p-value: SIMD group", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_angther_adh), medadh_sub$simd2)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - baseline SAQ summary score 0 - 24", treat=NULL, subset=medadh_sub$saq_summ_grp=="Poor health"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - baseline SAQ summary score 25 - 49", treat=NULL, subset=medadh_sub$saq_summ_grp=="Fair health"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - baseline SAQ summary score 50 - 74", treat=NULL, subset=medadh_sub$saq_summ_grp=="Good health"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - baseline SAQ summary score 75 - 100", treat=NULL, subset=medadh_sub$saq_summ_grp=="Excellent health"&medadh_sub$any_angther=="Yes"),
                cbindTable(list(Text="p-value: baseline SAQ summary score", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_angther_adh), medadh_sub$saq_summ_grp)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - baseline SAQ angina frequency score 0 - 30", treat=NULL, subset=medadh_sub$saq_af_grp=="Daily angina"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - baseline SAQ angina frequency score 31 - 60", treat=NULL, subset=medadh_sub$saq_af_grp=="Weekly angina"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - baseline SAQ angina frequency score 61 - 99", treat=NULL, subset=medadh_sub$saq_af_grp=="Monthly angina"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - baseline SAQ angina frequency score 100", treat=NULL, subset=medadh_sub$saq_af_grp=="No angina"&medadh_sub$any_angther=="Yes"),
                cbindTable(list(Text="p-value: baseline SAQ angina frequency score", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_angther_adh), medadh_sub$saq_af_grp)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - MRI diagnosis of microvascular angina", treat=NULL, subset=medadh_sub$mridiag=="Microvascular angina"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - MRI diagnosis of vasospastic angina", treat=NULL, subset=medadh_sub$mridiag=="Vasospastic angina"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - MRI diagnosis of non-cardiac chest pain", treat=NULL, subset=medadh_sub$mridiag=="Non-cardiac chest pain"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - Other MRI diagnosis", treat=NULL, subset=medadh_sub$mridiag=="Other"&medadh_sub$any_angther=="Yes"),
                cbindTable(list(Text="p-value: MRI diagnosis", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_angther_adh), medadh_sub$mridiag)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - global MBF under stress < 2.25", treat=NULL, subset=medadh_sub$strglmbf_225=="Yes"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - global MBF under stress &ge; 2.25", treat=NULL, subset=medadh_sub$strglmbf_225=="No"&medadh_sub$any_angther=="Yes"),
                cbindTable(list(Text="p-value: global MBF under stress", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_angther_adh), medadh_sub$strglmbf_225)$p.value)), 

                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - global MPR < 2.2", treat=NULL, subset=medadh_sub$glmpr_22=="Yes"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - global MPR &ge; 2.2", treat=NULL, subset=medadh_sub$glmpr_22=="No"&medadh_sub$any_angther=="Yes"),
                cbindTable(list(Text="p-value: global MPR", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_angther_adh), medadh_sub$glmpr_22)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - endocardial MPR < 2.41", treat=NULL, subset=medadh_sub$enmpr_241=="Yes"&medadh_sub$any_angther=="Yes"),
                summary.cat(factor(medadh_sub$any_angther_adh), row.name="Poor/incomplete adherence - endocardial MPR &ge; 2.41", treat=NULL, subset=medadh_sub$enmpr_241=="No"&medadh_sub$any_angther=="Yes"),
                cbindTable(list(Text="p-value: endocardial MPR", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_angther_adh), medadh_sub$enmpr_241)$p.value)), 
                
                end.row(disclaimer=T)
))
ExportTable.HTML(sec_tab_4141$head, sec_tab_4141$body, horiz.fmt, filename=tables.file, first=F, last=F)

sec_tab_4142 <- list(head=rbindTable(list(Text="<b>Table 4.14.2: Secondary outcomes: Associations between preventative therapy adherence at 6 months and patient characteristics.</b>", 
                                          Other=list(colspan=4)),
                                     cbindTable("", list(Text="Summary statistics", Other=list(colspan=3)))
), 
body=rbindTable(summary.cat(factor(medadh_sub$any_prevther), row.name="Any preventative therapy - all participants", treat=NULL),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Any preventative therapy with poor/incomplete adherence - all participants", treat=NULL), 
                
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - age tertile 1: 37 - 59", treat=NULL, subset=medadh_sub$age_grp=="T1: 37 - 59"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - age tertile 2: 60 - 68", treat=NULL, subset=medadh_sub$age_grp=="T2: 60 - 68"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - age tertile 3: 69 - 85", treat=NULL, subset=medadh_sub$age_grp=="T3: 69 - 85"&medadh_sub$any_prevther=="Yes"),
                cbindTable(list(Text="p-value: age tertile", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_prevther_adh), medadh_sub$age_grp)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - sex: male", treat=NULL, subset=medadh_sub$sex=="Male"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - sex: female", treat=NULL, subset=medadh_sub$sex=="Female"&medadh_sub$any_prevther=="Yes"),
                cbindTable(list(Text="p-value: sex", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_prevther_adh), medadh_sub$sex)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - SIMD quintile 1-2", treat=NULL, subset=medadh_sub$simd2=="1-2"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - SIMD quintile 3-5", treat=NULL, subset=medadh_sub$simd2=="3-5"&medadh_sub$any_prevther=="Yes"),
                cbindTable(list(Text="p-value: SIMD group", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_prevther_adh), medadh_sub$simd2)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - baseline SAQ summary score 0 - 24", treat=NULL, subset=medadh_sub$saq_summ_grp=="Poor health"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - baseline SAQ summary score 25 - 49", treat=NULL, subset=medadh_sub$saq_summ_grp=="Fair health"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - baseline SAQ summary score 50 - 74", treat=NULL, subset=medadh_sub$saq_summ_grp=="Good health"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - baseline SAQ summary score 75 - 100", treat=NULL, subset=medadh_sub$saq_summ_grp=="Excellent health"&medadh_sub$any_prevther=="Yes"),
                cbindTable(list(Text="p-value: baseline SAQ summary score", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_prevther_adh), medadh_sub$saq_summ_grp)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - baseline SAQ angina frequency score 0 - 30", treat=NULL, subset=medadh_sub$saq_af_grp=="Daily angina"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - baseline SAQ angina frequency score 31 - 60", treat=NULL, subset=medadh_sub$saq_af_grp=="Weekly angina"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - baseline SAQ angina frequency score 61 - 99", treat=NULL, subset=medadh_sub$saq_af_grp=="Monthly angina"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - baseline SAQ angina frequency score 100", treat=NULL, subset=medadh_sub$saq_af_grp=="No angina"&medadh_sub$any_prevther=="Yes"),
                cbindTable(list(Text="p-value: baseline SAQ angina frequency score", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_prevther_adh), medadh_sub$saq_af_grp)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - MRI diagnosis of microvascular angina", treat=NULL, subset=medadh_sub$mridiag=="Microvascular angina"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - MRI diagnosis of vasospastic angina", treat=NULL, subset=medadh_sub$mridiag=="Vasospastic angina"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - MRI diagnosis of non-cardiac chest pain", treat=NULL, subset=medadh_sub$mridiag=="Non-cardiac chest pain"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - Other MRI diagnosis", treat=NULL, subset=medadh_sub$mridiag=="Other"&medadh_sub$any_prevther=="Yes"),
                cbindTable(list(Text="p-value: MRI diagnosis", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_prevther_adh), medadh_sub$mridiag)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - global MBF under stress < 2.25", treat=NULL, subset=medadh_sub$strglmbf_225=="Yes"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - global MBF under stress &ge; 2.25", treat=NULL, subset=medadh_sub$strglmbf_225=="No"&medadh_sub$any_prevther=="Yes"),
                cbindTable(list(Text="p-value: global MBF under stress", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_prevther_adh), medadh_sub$strglmbf_225)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - global MPR < 2.2", treat=NULL, subset=medadh_sub$glmpr_22=="Yes"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - global MPR &ge; 2.2", treat=NULL, subset=medadh_sub$glmpr_22=="No"&medadh_sub$any_prevther=="Yes"),
                cbindTable(list(Text="p-value: global MPR", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_prevther_adh), medadh_sub$glmpr_22)$p.value)), 
                
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - endocardial MPR < 2.41", treat=NULL, subset=medadh_sub$enmpr_241=="Yes"&medadh_sub$any_prevther=="Yes"),
                summary.cat(factor(medadh_sub$any_prevther_adh), row.name="Poor/incomplete adherence - endocardial MPR &ge; 2.41", treat=NULL, subset=medadh_sub$enmpr_241=="No"&medadh_sub$any_prevther=="Yes"),
                cbindTable(list(Text="p-value: endocardial MPR", Other=list(colspan=2)), "", p.format(fisher.test(factor(medadh_sub$any_prevther_adh), medadh_sub$enmpr_241)$p.value)), 
                
                end.row(disclaimer=T)
))
ExportTable.HTML(sec_tab_4142$head, sec_tab_4142$body, horiz.fmt, filename=tables.file, first=F, last=F)

#### 5.X: PRE-SPECIFIED ANALYSES ####
prespec_mbf <- merge(mri[!is.na(mri$trtgrp), c("sno", "cardiac_strglmbf", "strglmbf_225", "enmpr_241", "cardiac_enepres", "cardiac_glmpr", "glmpr_22")], 
                     outcomes[outcomes$visittypeid==1, 
                              c("sno", "saq_af_bl", "saq_pl_bl", "saq_ql_bl", "saq_st_bl", "saq_ts_bl", "saq_summ_bl", 
                                "eq5d_score_bl", "eq5d_health_bl", "phq_score_bl", "dasi_calc_bl", "ipaqtotmetmin_bl")], 
                     by="sno", all.x=T)
prespec_mbf <- merge(prespec_mbf, diagnoses[, c("sno", "clinq_diag", "mridiag")], by="sno", all.x=T)
prespec_mbf <- merge(prespec_mbf, 
                     outcomes[outcomes$visittypeid==3, 
                              c("sno", "saq_af", "saq_pl", "saq_ql", "saq_st", "saq_ts", "saq_summ", 
                                "eq5d_score", "eq5d_health", "phq_score", "dasi_calc", "ipaq_totmetmin")], 
                     by="sno", all.x=T)
prespec_mbf$saq_af_grp <- factor(ifelse(is.na(prespec_mbf$saq_af_bl), NA, 
                                       ifelse(prespec_mbf$saq_af_bl <= 30, 1, 
                                              ifelse(prespec_mbf$saq_af_bl > 30 & prespec_mbf$saq_af_bl <= 60, 2, 
                                                     ifelse(prespec_mbf$saq_af_bl > 60 & prespec_mbf$saq_af_bl <= 99, 3, 
                                                            ifelse(prespec_mbf$saq_af_bl==100, 4, NA))))), 
                                levels=c(1:4), labels=c("Daily angina", "Weekly angina", "Monthly angina", "No angina"))

prespec_mbf$saq_summ_grp <- factor(ifelse(is.na(prespec_mbf$saq_summ_bl), NA, 
                                         ifelse(prespec_mbf$saq_summ_bl < 25, 1, 
                                                ifelse(prespec_mbf$saq_summ_bl >= 25 & prespec_mbf$saq_summ_bl < 50, 2, 
                                                       ifelse(prespec_mbf$saq_summ_bl >= 50 & prespec_mbf$saq_summ_bl < 75, 3, 
                                                              ifelse(prespec_mbf$saq_summ_bl >= 75, 4, NA))))), 
                                  levels=c(1:4), labels=c("Poor health", "Fair health", "Good health", "Excellent health"))
prespec_mbf$saq_ql_grp <- factor(ifelse(is.na(prespec_mbf$saq_ql_bl), NA, 
                                          ifelse(prespec_mbf$saq_ql_bl < 25, 1, 
                                                 ifelse(prespec_mbf$saq_ql_bl >= 25 & prespec_mbf$saq_ql_bl < 50, 2, 
                                                        ifelse(prespec_mbf$saq_ql_bl >= 50 & prespec_mbf$saq_ql_bl < 75, 3, 
                                                               ifelse(prespec_mbf$saq_ql_bl >= 75, 4, NA))))), 
                                   levels=c(1:4), labels=c("Poor QOL", "Fair QOL", "Good QOL", "Excellent QOL"))
mri$saq_af_grp <- prespec_mbf$saq_af_grp[match(mri$sno, prespec_mbf$sno)]
summary(aov(lm(mri$cardiac_strglmbf ~ mri$saq_af_grp)))
prespec_tab_511 <- list(head=rbindTable(list(Text="<b>Table 5.1.1: Pre-specified analyses - global myocardial blood flow under stress in relation to baseline measures (Seattle Angina Questionnaire as measures of angina symptoms).</b>"), 
                                        list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                        "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                        "&Chi;<sup>2</sup>.")),
                                        cbindTable("", "", list(Text="Global myocardial blood flow under stress (ml/min/g)", Other=list(colspan=3))),
                                        cbindTable("", "Subgroup levels", "Nobs (Nmiss)", "Median (Q1, Q3)", "N (%) < 2.25")), 
                        body=rbindTable(list(Text="SAQ angina frequency score category", Other=list(colspan=5)), 
                                        cbindTable("", "Daily angina (score &le; 30)", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_af_grp=="Daily angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_af_grp=="Daily angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$saq_af_grp=="Daily angina" & !is.na(prespec_mbf$saq_af_grp)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Weekly angina (score 31 - 60)", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_af_grp=="Weekly angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_af_grp=="Weekly angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$saq_af_grp=="Weekly angina" & !is.na(prespec_mbf$saq_af_grp)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Monthly angina (score 61 - 99)", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_af_grp=="Monthly angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_af_grp=="Monthly angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$saq_af_grp=="Monthly angina" & !is.na(prespec_mbf$saq_af_grp)], x.levels="Yes")
                                                   ),
                                        cbindTable("", "No angina (score 100)", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_af_grp=="No angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_af_grp=="No angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$saq_af_grp=="No angina" & !is.na(prespec_mbf$saq_af_grp)], x.levels="Yes")
                                                   ),
                                        list(Text="SAQ angina frequency category and global MBF under stress: p-values", Other=list(colspan=5)),
                                        cbindTable("", "", "", 
                                                   pfun("cardiac_strglmbf", "saq_af_grp", prespec_mbf), 
                                                   pfun("strglmbf_225", "saq_af_grp", prespec_mbf)), 
                                        list(Text="SAQ quality of life score category", Other=list(colspan=5)), 
                                        cbindTable("", "Poor QOL (score < 25)", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_ql_grp=="Poor QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_ql_grp=="Poor QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$saq_ql_grp=="Poor QOL" & !is.na(prespec_mbf$saq_ql_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Fair QOL (score 25 - 49)", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_ql_grp=="Fair QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_ql_grp=="Fair QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$saq_ql_grp=="Fair QOL" & !is.na(prespec_mbf$saq_ql_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Good QOL (score 50 - 74)", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_ql_grp=="Good QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_ql_grp=="Good QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$saq_ql_grp=="Good QOL" & !is.na(prespec_mbf$saq_ql_grp)], x.levels="Yes")
                                        ),
                                        cbindTable("", "Excellent QOL (score &ge; 75)", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_ql_grp=="Excellent QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_ql_grp=="Excellent QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$saq_ql_grp=="Excellent QOL" & !is.na(prespec_mbf$saq_ql_grp)], x.levels="Yes")
                                        ),
                                        list(Text="SAQ quality of life category and global MBF under stress: p-values", Other=list(colspan=5)),
                                        cbindTable("", "", "", 
                                                   pfun("cardiac_strglmbf", "saq_ql_grp", prespec_mbf), 
                                                   pfun("strglmbf_225", "saq_ql_grp", prespec_mbf)), 
                                        list(Text="SAQ summary score category", Other=list(colspan=5)), 
                                        cbindTable("", "Poor health (score < 25)", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_summ_grp=="Poor health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_summ_grp=="Poor health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$saq_summ_grp=="Poor health" & !is.na(prespec_mbf$saq_summ_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Fair health (score 25 - 49)", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_summ_grp=="Fair health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_summ_grp=="Fair health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$saq_summ_grp=="Fair health" & !is.na(prespec_mbf$saq_summ_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Good health (score 50 - 74)", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_summ_grp=="Good health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_summ_grp=="Good health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$saq_summ_grp=="Good health" & !is.na(prespec_mbf$saq_summ_grp)], x.levels="Yes")
                                        ),
                                        cbindTable("", "Excellent health (score &ge; 75)", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_summ_grp=="Excellent health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$saq_summ_grp=="Excellent health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$saq_summ_grp=="Excellent health" & !is.na(prespec_mbf$saq_summ_grp)], x.levels="Yes")
                                        ),
                                        list(Text="SAQ summary category and global MBF under stress: p-values", Other=list(colspan=5)),
                                        cbindTable("", "", "", 
                                                   pfun("cardiac_strglmbf", "saq_summ_grp", prespec_mbf), 
                                                   pfun("strglmbf_225", "saq_summ_grp", prespec_mbf)), 
                                        end.row(disclaimer=T)
                                        )
                        )
ExportTable.HTML(prespec_tab_511$head, prespec_tab_511$body, horiz.fmt, filename=tables.file, first=F, last=F)

prespec_tab_512 <- list(head=rbindTable(list(Text="<b>Table 5.1.2: Pre-specified analyses - global myocardial perfusion reserve in relation to baseline measures (Seattle Angina Questionnaire as measures of angina symptoms).</b>"), 
                                        list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                        "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                        "&Chi;<sup>2</sup>.")),
                                        cbindTable("", "", list(Text="Global MPR", Other=list(colspan=3))),
                                        cbindTable("", "Subgroup levels", "Nobs (Nmiss)", "Median (Q1, Q3)", "N (%) < 2.2")), 
                        body=rbindTable(list(Text="SAQ angina frequency score category", Other=list(colspan=5)), 
                                        cbindTable("", "Daily angina (score &le; 30)", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_af_grp=="Daily angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_af_grp=="Daily angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$saq_af_grp=="Daily angina" & !is.na(prespec_mbf$saq_af_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Weekly angina (score 31 - 60)", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_af_grp=="Weekly angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_af_grp=="Weekly angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$saq_af_grp=="Weekly angina" & !is.na(prespec_mbf$saq_af_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Monthly angina (score 61 - 99)", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_af_grp=="Monthly angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_af_grp=="Monthly angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$saq_af_grp=="Monthly angina" & !is.na(prespec_mbf$saq_af_grp)], x.levels="Yes")
                                        ),
                                        cbindTable("", "No angina (score 100)", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_af_grp=="No angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_af_grp=="No angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$saq_af_grp=="No angina" & !is.na(prespec_mbf$saq_af_grp)], x.levels="Yes")
                                        ),
                                        list(Text="SAQ angina frequency category and global MPR: p-values", Other=list(colspan=5)),
                                        cbindTable("", "", "",
                                                   pfun("cardiac_glmpr", "saq_af_grp", prespec_mbf), 
                                                   pfun("glmpr_22", "saq_af_grp", prespec_mbf)), 
                                        list(Text="SAQ quality of life score category", Other=list(colspan=5)), 
                                        cbindTable("", "Poor QOL (score < 25)", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_ql_grp=="Poor QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_ql_grp=="Poor QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$saq_ql_grp=="Poor QOL" & !is.na(prespec_mbf$saq_ql_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Fair QOL (score 25 - 49)", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_ql_grp=="Fair QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_ql_grp=="Fair QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$saq_ql_grp=="Fair QOL" & !is.na(prespec_mbf$saq_ql_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Good QOL (score 50 - 74)", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_ql_grp=="Good QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_ql_grp=="Good QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$saq_ql_grp=="Good QOL" & !is.na(prespec_mbf$saq_ql_grp)], x.levels="Yes")
                                        ),
                                        cbindTable("", "Excellent QOL (score &ge; 75)", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_ql_grp=="Excellent QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_ql_grp=="Excellent QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$saq_ql_grp=="Excellent QOL" & !is.na(prespec_mbf$saq_ql_grp)], x.levels="Yes")
                                        ),
                                        list(Text="SAQ quality of life category and global MPR: p-values", Other=list(colspan=5)),
                                        cbindTable("", "", "", 
                                                   pfun("cardiac_glmpr", "saq_ql_grp", prespec_mbf), 
                                                   pfun("glmpr_22", "saq_ql_grp", prespec_mbf)), 
                                        list(Text="SAQ summary score category", Other=list(colspan=5)), 
                                        cbindTable("", "Poor health (score < 25)", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_summ_grp=="Poor health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_summ_grp=="Poor health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$saq_summ_grp=="Poor health" & !is.na(prespec_mbf$saq_summ_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Fair health (score 25 - 49)", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_summ_grp=="Fair health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_summ_grp=="Fair health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$saq_summ_grp=="Fair health" & !is.na(prespec_mbf$saq_summ_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Good health (score 50 - 74)", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_summ_grp=="Good health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_summ_grp=="Good health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$saq_summ_grp=="Good health" & !is.na(prespec_mbf$saq_summ_grp)], x.levels="Yes")
                                        ),
                                        cbindTable("", "Excellent health (score &ge; 75)", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_summ_grp=="Excellent health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$saq_summ_grp=="Excellent health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$saq_summ_grp=="Excellent health" & !is.na(prespec_mbf$saq_summ_grp)], x.levels="Yes")
                                        ),
                                        list(Text="SAQ summary category and global MPR: p-values", Other=list(colspan=5)),
                                        cbindTable("", "", "", 
                                                   pfun("cardiac_glmpr", "saq_summ_grp", prespec_mbf), 
                                                   pfun("glmpr_22", "saq_summ_grp", prespec_mbf)), 
                                        end.row(disclaimer=T)
                        )
)
ExportTable.HTML(prespec_tab_512$head, prespec_tab_512$body, horiz.fmt, filename=tables.file, first=F, last=F)

prespec_tab_513 <- list(head=rbindTable(list(Text="<b>Table 5.1.3: Pre-specified analyses - endocardial and epicardial myocardial perfusion reserve in relation to baseline measures (Seattle Angina Questionnaire as measures of angina symptoms).</b>"), 
                                        list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                        "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                        "&Chi;<sup>2</sup>.")),
                                        cbindTable("", "", 
                                                   list(Text="Endocardial MPR/Epicardial MPR ratio", Other=list(colspan=2)), 
                                                   list(Text="Endocardial MPR", Other=list(colspan=2))),
                                        cbindTable("", "Subgroup levels", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)", 
                                                   "Nobs (Nmiss)", "N (%) < 2.41")), 
                        body=rbindTable(list(Text="SAQ angina frequency score category", Other=list(colspan=6)), 
                                        cbindTable("", "Daily angina (score &le; 30)", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_af_grp=="Daily angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_af_grp=="Daily angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$saq_af_grp=="Daily angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$saq_af_grp=="Daily angina" & !is.na(prespec_mbf$saq_af_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Weekly angina (score 31 - 60)", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_af_grp=="Weekly angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_af_grp=="Weekly angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$saq_af_grp=="Weekly angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$saq_af_grp=="Weekly angina" & !is.na(prespec_mbf$saq_af_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Monthly angina (score 61 - 99)", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_af_grp=="Monthly angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_af_grp=="Monthly angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$saq_af_grp=="Monthly angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$saq_af_grp=="Monthly angina" & !is.na(prespec_mbf$saq_af_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "No angina (score 100)", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_af_grp=="No angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_af_grp=="No angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$saq_af_grp=="No angina" & !is.na(prespec_mbf$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$saq_af_grp=="No angina" & !is.na(prespec_mbf$saq_af_grp)], x.levels="Yes")
                                        ), 
                                        list(Text="SAQ angina frequency category, endocardial and epicardial myocardial perfusion reserve: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "",
                                                   pfun("cardiac_enepres", "saq_af_grp", prespec_mbf),
                                                   "",
                                                   pfun("enmpr_241", "saq_af_grp", prespec_mbf)), 
                                        list(Text="SAQ quality of life score category", Other=list(colspan=6)), 
                                        cbindTable("", "Poor QOL (score < 25)", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_ql_grp=="Poor QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_ql_grp=="Poor QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$saq_ql_grp=="Poor QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$saq_ql_grp=="Poor QOL" & !is.na(prespec_mbf$saq_ql_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Fair QOL (score 25 - 49)", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_ql_grp=="Fair QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_ql_grp=="Fair QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$saq_ql_grp=="Fair QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$saq_ql_grp=="Fair QOL" & !is.na(prespec_mbf$saq_ql_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Good QOL 50 - 74", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_ql_grp=="Good QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_ql_grp=="Good QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$saq_ql_grp=="Good QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$saq_ql_grp=="Good QOL" & !is.na(prespec_mbf$saq_ql_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Excellent QOL (score &ge; 75)", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_ql_grp=="Excellent QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_ql_grp=="Excellent QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$saq_ql_grp=="Excellent QOL" & !is.na(prespec_mbf$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$saq_ql_grp=="Excellent QOL" & !is.na(prespec_mbf$saq_ql_grp)], x.levels="Yes")
                                        ), 
                                        list(Text="SAQ quality of life category, endocardial and epicardial myocardial perfusion reserve: p-values: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", 
                                                   pfun("cardiac_enepres", "saq_ql_grp", prespec_mbf),
                                                   "",
                                                   pfun("enmpr_241", "saq_ql_grp", prespec_mbf)), 
                                        list(Text="SAQ summary score category", Other=list(colspan=6)), 
                                        cbindTable("", "Poor health (score < 25)", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_summ_grp=="Poor health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_summ_grp=="Poor health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$saq_summ_grp=="Poor health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$saq_summ_grp=="Poor health" & !is.na(prespec_mbf$saq_summ_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Fair health (score 25 - 49)", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_summ_grp=="Fair health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_summ_grp=="Fair health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$saq_summ_grp=="Fair health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$saq_summ_grp=="Fair health" & !is.na(prespec_mbf$saq_summ_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Good health (score 50 - 74)", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_summ_grp=="Good health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_summ_grp=="Good health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$saq_summ_grp=="Good health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$saq_summ_grp=="Good health" & !is.na(prespec_mbf$saq_summ_grp)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Excellent health (score &ge; 75)", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_summ_grp=="Excellent health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$saq_summ_grp=="Excellent health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$saq_summ_grp=="Excellent health" & !is.na(prespec_mbf$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$saq_summ_grp=="Excellent health" & !is.na(prespec_mbf$saq_summ_grp)], x.levels="Yes")
                                        ), 
                                        list(Text="SAQ summary category, endocardial and epicardial myocardial perfusion reserve: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "",
                                                   pfun("cardiac_enepres", "saq_summ_grp", prespec_mbf),
                                                   "",
                                                   pfun("enmpr_241", "saq_summ_grp", prespec_mbf)), 
                                        end.row(disclaimer=T)
                                        )
                        )
ExportTable.HTML(prespec_tab_513$head, prespec_tab_513$body, horiz.fmt, filename=tables.file, first=F, last=F)

prespec_tab_514 <- list(head=rbindTable(list(Text=paste("<b>Table 5.1.4: Pre-specified analyses", 
                                                        "- global myocardial blood flow under stress in", 
                                                        "relation to pre-randomisation and post-randomisation", 
                                                        "diagnoses.</b>"), Other=list(colspan=5)),
                                        list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                        "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                        "&Chi;<sup>2</sup>."), Other=list(colspan=5)),
                                        cbindTable("", "", list(Text="Global myocardial blood flow under stress (ml/min/g)", Other=list(colspan=3))),
                                        cbindTable("", "Subgroup levels", "Nobs (Nmiss)", "Median (Q1, Q3)", "N (%) < 2.25")
                                        ),
                        body=rbindTable(list(Text="Pre-randomisation diagnosis"),
                                        cbindTable("", "Obstructive CAD", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$clinq_diag=="Obstructive CAD" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$clinq_diag=="Obstructive CAD" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$clinq_diag=="Obstructive CAD" & !is.na(prespec_mbf$clinq_diag)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Microvascular angina", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$clinq_diag=="Microvascular angina" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$clinq_diag=="Microvascular angina" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$clinq_diag=="Microvascular angina" & !is.na(prespec_mbf$clinq_diag)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Vasospastic angina", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$clinq_diag=="Vasospastic angina" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$clinq_diag=="Vasospastic angina" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$clinq_diag=="Vasospastic angina" & !is.na(prespec_mbf$clinq_diag)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Non-cardiac chest pain", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_mbf$clinq_diag)], x.levels="Yes")
                                        ), 
                                        list(Text="Pre-randomisation diagnosis and global MBF: p-values", Other=list(colspan=5)),
                                        cbindTable("", "", "", pfun("cardiac_strglmbf", "clinq_diag", prespec_mbf), 
                                                   pfun("strglmbf_225", "clinq_diag", prespec_mbf)),
                                        list(Text="Post-randomisation diagnosis"),
                                        cbindTable("", "Obstructive CAD", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$mridiag=="Obstructive CAD" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$mridiag=="Obstructive CAD" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$mridiag=="Obstructive CAD" & !is.na(prespec_mbf$mridiag)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Microvascular angina", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$mridiag=="Microvascular angina" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$mridiag=="Microvascular angina" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$mridiag=="Microvascular angina" & !is.na(prespec_mbf$mridiag)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Vasospastic angina", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$mridiag=="Vasospastic angina" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$mridiag=="Vasospastic angina" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$mridiag=="Vasospastic angina" & !is.na(prespec_mbf$mridiag)], x.levels="Yes")
                                        ), 
                                        cbindTable("", "Other", 
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$mridiag=="Other" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_strglmbf[prespec_mbf$mridiag=="Other" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$strglmbf_225[prespec_mbf$mridiag=="Other" & !is.na(prespec_mbf$mridiag)], x.levels="Yes")
                                        ), 
                                        list(Text="Post-randomisation diagnosis and global MBF: p-values", Other=list(colspan=5)),
                                        cbindTable("", "", "", 
                                                   paste("AOV:", p.format(summary(aov(prespec_mbf[, "cardiac_strglmbf"]~prespec_mbf[, "mridiag"]))[[1]][1,5])), 
                                                   pfun("strglmbf_225", "mridiag", prespec_mbf)),
                                        end.row(disclaimer=T)
                                        )
                        )
ExportTable.HTML(prespec_tab_514$head, prespec_tab_514$body, horiz.fmt, filename=tables.file, first=F, last=F)

prespec_tab_515 <- list(head=rbindTable(list(Text=paste("<b>Table 5.1.5: Pre-specified analyses", 
                                                        "- global myocardial perfusion reserve in", 
                                                        "relation to pre-randomisation and post-randomisation", 
                                                        "diagnoses.</b>"), Other=list(colspan=5)),
                                        list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                        "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                        "&Chi;<sup>2</sup>."), Other=list(colspan=5)),
                                        cbindTable("", "", list(Text="Global MPR", Other=list(colspan=3))),
                                        cbindTable("", "Subgroup levels", "Nobs (Nmiss)", "Median (Q1, Q3)", "N (%) < 2.25")
                                        ),
                        body=rbindTable(list(Text="Pre-randomisation diagnosis"),
                                        cbindTable("", "Obstructive CAD", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$clinq_diag=="Obstructive CAD" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$clinq_diag=="Obstructive CAD" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$clinq_diag=="Obstructive CAD" & !is.na(prespec_mbf$clinq_diag)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Microvascular angina", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$clinq_diag=="Microvascular angina" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$clinq_diag=="Microvascular angina" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$clinq_diag=="Microvascular angina" & !is.na(prespec_mbf$clinq_diag)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Vasospastic angina", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$clinq_diag=="Vasospastic angina" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$clinq_diag=="Vasospastic angina" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$clinq_diag=="Vasospastic angina" & !is.na(prespec_mbf$clinq_diag)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Non-cardiac chest pain", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_mbf$clinq_diag)], x.levels="Yes")
                                                   ), 
                                        list(Text="Pre-randomisation diagnosis and global MPR: p-values", Other=list(colspan=5)),
                                        cbindTable("", "", "", pfun("cardiac_glmpr", "clinq_diag", prespec_mbf), 
                                                   pfun("glmpr_22", "clinq_diag", prespec_mbf)),
                                        list(Text="Post-randomisation diagnosis"),
                                        cbindTable("", "Obstructive CAD", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$mridiag=="Obstructive CAD" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$mridiag=="Obstructive CAD" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$mridiag=="Obstructive CAD" & !is.na(prespec_mbf$mridiag)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Microvascular angina", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$mridiag=="Microvascular angina" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$mridiag=="Microvascular angina" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$mridiag=="Microvascular angina" & !is.na(prespec_mbf$mridiag)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Vasospastic angina", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$mridiag=="Vasospastic angina" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$mridiag=="Vasospastic angina" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$mridiag=="Vasospastic angina" & !is.na(prespec_mbf$mridiag)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Other", 
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$mridiag=="Other" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_glmpr[prespec_mbf$mridiag=="Other" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   npc.factor(x=prespec_mbf$glmpr_22[prespec_mbf$mridiag=="Other" & !is.na(prespec_mbf$mridiag)], x.levels="Yes")
                                                   ), 
                                        list(Text="Post-randomisation diagnosis and global MPR: p-values", Other=list(colspan=5)),
                                        cbindTable("", "", "", paste("AOV:", p.format(summary(aov(prespec_mbf[, "cardiac_glmpr"]~prespec_mbf[, "mridiag"]))[[1]][1,5])), 
                                                   pfun("glmpr_22", "mridiag", prespec_mbf)),
                                        end.row(disclaimer=T)
                                        )
                        )
ExportTable.HTML(prespec_tab_515$head, prespec_tab_515$body, horiz.fmt, filename=tables.file, first=F, last=F)

prespec_tab_516 <- list(head=rbindTable(list(Text=paste("<b>Table 5.1.6: Pre-specified analyses", 
                                                        "- endocardial and epicardial myocardial perfusion reserve in", 
                                                        "relation to pre-randomisation and post-randomisation", 
                                                        "diagnoses.</b>"), Other=list(colspan=6)),
                                        list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                        "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                        "&Chi;<sup>2</sup>."), Other=list(colspan=6)),
                                        cbindTable("", "", 
                                                   list(Text="Endocardial MPR/Epicardial MPR ratio", Other=list(colspan=2)), 
                                                   list(Text="Endocardial MPR", Other=list(colspan=2))),
                                        cbindTable("", "Subgroup levels", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)", 
                                                   "Nobs (Nmiss)", "N (%) < 2.41")), 
                        body=rbindTable(list(Text="Pre-randomisation diagnosis"),
                                        cbindTable("", "Obstructive CAD", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$clinq_diag=="Obstructive CAD" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$clinq_diag=="Obstructive CAD" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$clinq_diag=="Obstructive CAD" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$clinq_diag=="Obstructive CAD" & !is.na(prespec_mbf$clinq_diag)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Microvascular angina", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$clinq_diag=="Microvascular angina" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$clinq_diag=="Microvascular angina" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$clinq_diag=="Microvascular angina" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$clinq_diag=="Microvascular angina" & !is.na(prespec_mbf$clinq_diag)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Vasospastic angina", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$clinq_diag=="Vasospastic angina" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$clinq_diag=="Vasospastic angina" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$clinq_diag=="Vasospastic angina" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$clinq_diag=="Vasospastic angina" & !is.na(prespec_mbf$clinq_diag)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Non-cardiac chest pain", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_mbf$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_mbf$clinq_diag)], x.levels="Yes")
                                                   ), 
                                        list(Text="Pre-randomisation diagnosis and endocardial/epicardial MPR: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", pfun("cardiac_enepres", "clinq_diag", prespec_mbf), 
                                                   "", pfun("enmpr_241", "clinq_diag", prespec_mbf)),
                                        list(Text="Post-randomisation diagnosis"),
                                        cbindTable("", "Obstructive CAD", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$mridiag=="Obstructive CAD" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$mridiag=="Obstructive CAD" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$mridiag=="Obstructive CAD" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$mridiag=="Obstructive CAD" & !is.na(prespec_mbf$mridiag)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Microvascular angina", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$mridiag=="Microvascular angina" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$mridiag=="Microvascular angina" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$mridiag=="Microvascular angina" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$mridiag=="Microvascular angina" & !is.na(prespec_mbf$mridiag)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Vasospastic angina", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$mridiag=="Vasospastic angina" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$mridiag=="Vasospastic angina" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$mridiag=="Vasospastic angina" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$mridiag=="Vasospastic angina" & !is.na(prespec_mbf$mridiag)], x.levels="Yes")
                                                   ), 
                                        cbindTable("", "Other", 
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$mridiag=="Other" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_mbf$cardiac_enepres[prespec_mbf$mridiag=="Other" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=as.numeric(prespec_mbf$enmpr_241)[prespec_mbf$mridiag=="Other" & !is.na(prespec_mbf$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   npc.factor(x=prespec_mbf$enmpr_241[prespec_mbf$mridiag=="Other" & !is.na(prespec_mbf$mridiag)], x.levels="Yes")
                                                   ), 
                                        list(Text="Post-randomisation diagnosis and endocardial/epicardial MPR: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", pfun("cardiac_enepres", "mridiag", prespec_mbf), 
                                                   "",
                                                   pfun("enmpr_241", "mridiag", prespec_mbf)),
                                        end.row(disclaimer=T)
                                        )
                        )
ExportTable.HTML(prespec_tab_516$head, prespec_tab_516$body, horiz.fmt, filename=tables.file, first=F, last=F)

# MBF vars as predictors of PROMs
prespec_tab_517 <- list(head=rbindTable(list(Text="<b>Table 5.1.7: Pre-specified analyses - global MBF as a predictor of PROMs.</b>"), 
                                        list(Text=paste("In all cases, models have the 6-month follow-up value of the measure as the outcome,", 
                                                        "with the baseline value of the measure and the relevant global MBF variable as predictors.")), 
                                        cbindTable("Outcome measure", "Global MBF variable", "Global MBF effect estimate<br>(95 % CI)<br>p-value")), 
                        
                        body=rbindTable(cbindTable("EQ-5D score", "Global MBF (ml/min/g)", lm.summ(lm(prespec_mbf$eq5d_score ~ prespec_mbf$cardiac_strglmbf + prespec_mbf$eq5d_score_bl), term=2, ndp=3)), 
                                        cbindTable("EQ-5D score", "Global MBF &ge; 2.25", lm.summ(lm(prespec_mbf$eq5d_score ~ prespec_mbf$strglmbf_225 + prespec_mbf$eq5d_score_bl), term=2, ndp=3)),
                                        cbindTable("EQ-5D VAS", "Global MBF (ml/min/g)", lm.summ(lm(prespec_mbf$eq5d_health ~ prespec_mbf$cardiac_strglmbf + prespec_mbf$eq5d_health_bl), term=2, ndp=2)), 
                                        cbindTable("EQ-5D VAS", "Global MBF &ge; 2.25", lm.summ(lm(prespec_mbf$eq5d_health ~ prespec_mbf$strglmbf_225 + prespec_mbf$eq5d_health_bl), term=2, ndp=2)),
                                        cbindTable("PHQ-4 score", "Global MBF (ml/min/g)", lm.summ(lm(prespec_mbf$phq_score ~ prespec_mbf$cardiac_strglmbf + prespec_mbf$phq_score_bl), term=2, ndp=2)), 
                                        cbindTable("PHQ-4 score", "Global MBF &ge; 2.25", lm.summ(lm(prespec_mbf$phq_score ~ prespec_mbf$strglmbf_225 + prespec_mbf$phq_score_bl), term=2, ndp=2)),
                                        cbindTable("DASI score", "Global MBF (ml/min/g)", lm.summ(lm(prespec_mbf$dasi_calc ~ prespec_mbf$cardiac_strglmbf + prespec_mbf$dasi_calc_bl), term=2, ndp=2)), 
                                        cbindTable("DASI score", "Global MBF &ge; 2.25", lm.summ(lm(prespec_mbf$dasi_calc ~ prespec_mbf$strglmbf_225 + prespec_mbf$dasi_calc_bl), term=2, ndp=2)),
                                        cbindTable("IPAQ total weekly met-minutes", "Global MBF (ml/min/g)", lm.summ(lm(prespec_mbf$ipaq_totmetmin ~ prespec_mbf$cardiac_strglmbf + prespec_mbf$ipaqtotmetmin_bl), term=2, ndp=2)), 
                                        cbindTable("IPAQ total weekly met-minutes", "Global MBF &ge; 2.25", lm.summ(lm(prespec_mbf$ipaq_totmetmin ~ prespec_mbf$strglmbf_225 + prespec_mbf$ipaqtotmetmin_bl), term=2, ndp=2)),
                                        end.row(disclaimer=T))
)
ExportTable.HTML(prespec_tab_517$head, prespec_tab_517$body, horiz.fmt, filename=tables.file, first=F, last=F)
# diagnostics for above models
lm.diags(fit=lm(prespec_mbf$eq5d_score ~ prespec_mbf$cardiac_strglmbf + prespec_mbf$eq5d_score_bl), 
         vardesc="EQ-5D score (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.7.1")
lm.diags(fit=lm(prespec_mbf$eq5d_score ~ prespec_mbf$strglmbf_225 + prespec_mbf$eq5d_score_bl), 
         vardesc="EQ-5D score (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.7.2")
lm.diags(fit=lm(prespec_mbf$eq5d_health ~ prespec_mbf$cardiac_strglmbf + prespec_mbf$eq5d_health_bl), 
         vardesc="EQ-5D VAS (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.7.3")
lm.diags(fit=lm(prespec_mbf$eq5d_health ~ prespec_mbf$strglmbf_225 + prespec_mbf$eq5d_health_bl), 
         vardesc="EQ-5D VAS (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.7.4")
lm.diags(fit=lm(prespec_mbf$phq_score ~ prespec_mbf$cardiac_strglmbf + prespec_mbf$phq_score_bl), 
         vardesc="PHQ4 score (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.7.5")
lm.diags(fit=lm(prespec_mbf$phq_score ~ prespec_mbf$strglmbf_225 + prespec_mbf$phq_score_bl), 
         vardesc="PHQ4 score (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.7.6")
lm.diags(fit=lm(prespec_mbf$dasi_calc ~ prespec_mbf$cardiac_strglmbf + prespec_mbf$dasi_calc_bl), 
         vardesc="DASI score (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.7.7")
lm.diags(fit=lm(prespec_mbf$dasi_calc ~ prespec_mbf$strglmbf_225 + prespec_mbf$dasi_calc_bl), 
         vardesc="DASI score (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.7.8")
lm.diags(fit=lm(prespec_mbf$ipaq_totmetmin ~ prespec_mbf$cardiac_strglmbf + prespec_mbf$ipaqtotmetmin_bl), 
         vardesc="IPAQ met-minutes (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.7.9")
lm.diags(fit=lm(prespec_mbf$ipaq_totmetmin ~ prespec_mbf$strglmbf_225 + prespec_mbf$ipaqtotmetmin_bl), 
         vardesc="IPAQ met-minutes (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.7.10")

prespec_tab_518 <- list(head=rbindTable(list(Text="<b>Table 5.1.8: Pre-specified analyses - global MPR as a predictor of PROMs.</b>"), 
                                        list(Text=paste("In all cases, models have the 6-month follow-up value of the measure as the outcome,", 
                                                        "with the baseline value of the measure and the relevant global MPR variable as predictors.")), 
                                        cbindTable("Outcome measure", "Global MPR variable", "Global MPR effect estimate<br>(95 % CI)<br>p-value")), 
                        
                        body=rbindTable(cbindTable("EQ-5D score", "Global MPR (ml/min/g)", lm.summ(lm(prespec_mbf$eq5d_score ~ prespec_mbf$cardiac_glmpr + prespec_mbf$eq5d_score_bl), term=2, ndp=3)), 
                                        cbindTable("EQ-5D score", "Global MPR &ge; 2.2", lm.summ(lm(prespec_mbf$eq5d_score ~ prespec_mbf$glmpr_22 + prespec_mbf$eq5d_score_bl), term=2, ndp=3)),
                                        cbindTable("EQ-5D VAS", "Global MPR (ml/min/g)", lm.summ(lm(prespec_mbf$eq5d_health ~ prespec_mbf$cardiac_glmpr + prespec_mbf$eq5d_health_bl), term=2, ndp=2)), 
                                        cbindTable("EQ-5D VAS", "Global MPR &ge; 2.2", lm.summ(lm(prespec_mbf$eq5d_health ~ prespec_mbf$glmpr_22 + prespec_mbf$eq5d_health_bl), term=2, ndp=2)),
                                        cbindTable("PHQ-4 score", "Global MPR (ml/min/g)", lm.summ(lm(prespec_mbf$phq_score ~ prespec_mbf$cardiac_glmpr + prespec_mbf$phq_score_bl), term=2, ndp=2)), 
                                        cbindTable("PHQ-4 score", "Global MPR &ge; 2.2", lm.summ(lm(prespec_mbf$phq_score ~ prespec_mbf$glmpr_22 + prespec_mbf$phq_score_bl), term=2, ndp=2)),
                                        cbindTable("DASI score", "Global MPR (ml/min/g)", lm.summ(lm(prespec_mbf$dasi_calc ~ prespec_mbf$cardiac_glmpr + prespec_mbf$dasi_calc_bl), term=2, ndp=2)), 
                                        cbindTable("DASI score", "Global MPR &ge; 2.2", lm.summ(lm(prespec_mbf$dasi_calc ~ prespec_mbf$glmpr_22 + prespec_mbf$dasi_calc_bl), term=2, ndp=2)),
                                        cbindTable("IPAQ total weekly met-minutes", "Global MPR (ml/min/g)", lm.summ(lm(prespec_mbf$ipaq_totmetmin ~ prespec_mbf$cardiac_glmpr + prespec_mbf$ipaqtotmetmin_bl), term=2, ndp=2)), 
                                        cbindTable("IPAQ total weekly met-minutes", "Global MPR &ge; 2.2", lm.summ(lm(prespec_mbf$ipaq_totmetmin ~ prespec_mbf$glmpr_22 + prespec_mbf$ipaqtotmetmin_bl), term=2, ndp=2)),
                                        end.row(disclaimer=T))
)
ExportTable.HTML(prespec_tab_518$head, prespec_tab_518$body, horiz.fmt, filename=tables.file, first=F, last=F)

# diagnostics for above models
lm.diags(fit=lm(prespec_mbf$eq5d_score ~ prespec_mbf$cardiac_glmpr + prespec_mbf$eq5d_score_bl), 
         vardesc="EQ-5D score (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.8.1")
lm.diags(fit=lm(prespec_mbf$eq5d_score ~ prespec_mbf$glmpr_22 + prespec_mbf$eq5d_score_bl), 
         vardesc="EQ-5D score (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.8.2")
lm.diags(fit=lm(prespec_mbf$eq5d_health ~ prespec_mbf$cardiac_glmpr + prespec_mbf$eq5d_health_bl), 
         vardesc="EQ-5D VAS (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.8.3")
lm.diags(fit=lm(prespec_mbf$eq5d_health ~ prespec_mbf$glmpr_22 + prespec_mbf$eq5d_health_bl), 
         vardesc="EQ-5D VAS (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.8.4")
lm.diags(fit=lm(prespec_mbf$phq_score ~ prespec_mbf$cardiac_glmpr + prespec_mbf$phq_score_bl), 
         vardesc="PHQ4 score (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.8.5")
lm.diags(fit=lm(prespec_mbf$phq_score ~ prespec_mbf$glmpr_22 + prespec_mbf$phq_score_bl), 
         vardesc="PHQ4 score (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.8.6")
lm.diags(fit=lm(prespec_mbf$dasi_calc ~ prespec_mbf$cardiac_glmpr + prespec_mbf$dasi_calc_bl), 
         vardesc="DASI score (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.8.7")
lm.diags(fit=lm(prespec_mbf$dasi_calc ~ prespec_mbf$glmpr_22 + prespec_mbf$dasi_calc_bl), 
         vardesc="DASI score (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.8.8")
lm.diags(fit=lm(prespec_mbf$ipaq_totmetmin ~ prespec_mbf$cardiac_glmpr + prespec_mbf$ipaqtotmetmin_bl), 
         vardesc="IPAQ met-minutes (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.8.9")
lm.diags(fit=lm(prespec_mbf$ipaq_totmetmin ~ prespec_mbf$glmpr_22 + prespec_mbf$ipaqtotmetmin_bl), 
         vardesc="IPAQ met-minutes (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.8.10")

prespec_tab_519 <- list(head=rbindTable(list(Text="<b>Table 5.1.9: Pre-specified analyses - endocardial and epicardial myocardial perfusion reserve as predictors of PROMs.</b>"), 
                                        list(Text=paste("In all cases, models have the 6-month follow-up value of the measure as the outcome,", 
                                                        "with the baseline value of the measure and the relevant MPR variable as predictors.")), 
                                        cbindTable("Outcome measure", "MPR variable", "MPR effect estimate<br>(95 % CI)<br>p-value")), 
                        
                        body=rbindTable(cbindTable("EQ-5D score", "Endocardial/epicardial perfusion reserve", lm.summ(lm(prespec_mbf$eq5d_score ~ prespec_mbf$cardiac_enepres + prespec_mbf$eq5d_score_bl), term=2, ndp=3)), 
                                        cbindTable("EQ-5D score", "Endocardial MPR &ge; 2.41", lm.summ(lm(prespec_mbf$eq5d_score ~ prespec_mbf$enmpr_241 + prespec_mbf$eq5d_score_bl), term=2, ndp=3)),
                                        cbindTable("EQ-5D VAS", "Endocardial/epicardial perfusion reserve", lm.summ(lm(prespec_mbf$eq5d_health ~ prespec_mbf$cardiac_enepres + prespec_mbf$eq5d_health_bl), term=2, ndp=2)), 
                                        cbindTable("EQ-5D VAS", "Endocardial MPR &ge; 2.41", lm.summ(lm(prespec_mbf$eq5d_health ~ prespec_mbf$enmpr_241 + prespec_mbf$eq5d_health_bl), term=2, ndp=2)),
                                        cbindTable("PHQ-4 score", "Endocardial/epicardial perfusion reserve", lm.summ(lm(prespec_mbf$phq_score ~ prespec_mbf$cardiac_enepres + prespec_mbf$phq_score_bl), term=2, ndp=2)), 
                                        cbindTable("PHQ-4 score", "Endocardial MPR &ge; 2.41", lm.summ(lm(prespec_mbf$phq_score ~ prespec_mbf$enmpr_241 + prespec_mbf$phq_score_bl), term=2, ndp=2)),
                                        cbindTable("DASI score", "Endocardial/epicardial perfusion reserve", lm.summ(lm(prespec_mbf$dasi_calc ~ prespec_mbf$cardiac_enepres + prespec_mbf$dasi_calc_bl), term=2, ndp=2)), 
                                        cbindTable("DASI score", "Endocardial MPR &ge; 2.41", lm.summ(lm(prespec_mbf$dasi_calc ~ prespec_mbf$enmpr_241 + prespec_mbf$dasi_calc_bl), term=2, ndp=2)),
                                        cbindTable("IPAQ total weekly met-minutes", "Endocardial/epicardial perfusion reserve", lm.summ(lm(prespec_mbf$ipaq_totmetmin ~ prespec_mbf$cardiac_enepres + prespec_mbf$ipaqtotmetmin_bl), term=2, ndp=2)), 
                                        cbindTable("IPAQ total weekly met-minutes", "Endocardial MPR &ge; 2.41", lm.summ(lm(prespec_mbf$ipaq_totmetmin ~ prespec_mbf$enmpr_241 + prespec_mbf$ipaqtotmetmin_bl), term=2, ndp=2)),
                                        end.row(disclaimer=T))
)
ExportTable.HTML(prespec_tab_519$head, prespec_tab_519$body, horiz.fmt, filename=tables.file, first=F, last=F)
# diagnostics of above models
lm.diags(fit=lm(prespec_mbf$eq5d_score ~ prespec_mbf$cardiac_enepres + prespec_mbf$eq5d_score_bl), 
         vardesc="EQ-5D score (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.9.1")
lm.diags(fit=lm(prespec_mbf$eq5d_score ~ prespec_mbf$enmpr_241 + prespec_mbf$eq5d_score_bl), 
         vardesc="EQ-5D score (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.9.2")
lm.diags(fit=lm(prespec_mbf$eq5d_health ~ prespec_mbf$cardiac_enepres + prespec_mbf$eq5d_health_bl), 
         vardesc="EQ-5D VAS (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.9.3")
lm.diags(fit=lm(prespec_mbf$eq5d_health ~ prespec_mbf$enmpr_241 + prespec_mbf$eq5d_health_bl), 
         vardesc="EQ-5D VAS (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.9.4")
lm.diags(fit=lm(prespec_mbf$phq_score ~ prespec_mbf$cardiac_enepres + prespec_mbf$phq_score_bl), 
         vardesc="PHQ4 score (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.9.5")
lm.diags(fit=lm(prespec_mbf$phq_score ~ prespec_mbf$enmpr_241 + prespec_mbf$phq_score_bl), 
         vardesc="PHQ4 score (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.9.6")
lm.diags(fit=lm(prespec_mbf$dasi_calc ~ prespec_mbf$cardiac_enepres + prespec_mbf$dasi_calc_bl), 
         vardesc="DASI score (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.9.7")
lm.diags(fit=lm(prespec_mbf$dasi_calc ~ prespec_mbf$enmpr_241 + prespec_mbf$dasi_calc_bl), 
         vardesc="DASI score (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.9.8")
lm.diags(fit=lm(prespec_mbf$ipaq_totmetmin ~ prespec_mbf$cardiac_enepres + prespec_mbf$ipaqtotmetmin_bl), 
         vardesc="IPAQ met-minutes (global MBF continuous)", diagsfile=diags.file, tabnum="5.1.9.9")
lm.diags(fit=lm(prespec_mbf$ipaq_totmetmin ~ prespec_mbf$enmpr_241 + prespec_mbf$ipaqtotmetmin_bl), 
         vardesc="IPAQ met-minutes (global MBF indicator)", diagsfile=diags.file, tabnum="5.1.9.10")

# pre-specified analyses - treadmill stress testing
prespec_trd <- merge(screening[screening$trd_perf=="Yes" & !is.na(screening$trd_perf), #& !is.na(screening$randdate), 
                               c("sno", "trd_perf", "trd_when", "trd_res")], 
                     outcomes[outcomes$visittypeid==1, 
                              c("sno", "saq_af_bl", "saq_pl_bl", "saq_ql_bl", "saq_st_bl", "saq_ts_bl", "saq_summ_bl", 
                                "eq5d_score_bl", "eq5d_health_bl", "phq_score_bl", "dasi_calc_bl", "ipaqtotmetmin_bl")], 
                     by="sno", all.x=T)
prespec_trd <- merge(prespec_trd, diagnoses[, c("sno", "clinq_diag", "mridiag")], by="sno", all.x=T)
prespec_trd <- merge(prespec_trd, 
                     outcomes[outcomes$visittypeid==3, 
                              c("sno", "saq_af", "saq_pl", "saq_ql", "saq_st", "saq_ts", "saq_summ", 
                                "eq5d_score", "eq5d_health", "phq_score", "dasi_calc", "ipaq_totmetmin")], 
                     by="sno", all.x=T)
prespec_trd$saq_af_grp <- factor(ifelse(is.na(prespec_trd$saq_af_bl), NA, 
                                        ifelse(prespec_trd$saq_af_bl <= 30, 1, 
                                               ifelse(prespec_trd$saq_af_bl > 30 & prespec_trd$saq_af_bl <= 60, 2, 
                                                      ifelse(prespec_trd$saq_af_bl > 60 & prespec_trd$saq_af_bl <= 99, 3, 
                                                             ifelse(prespec_trd$saq_af_bl==100, 4, NA))))), 
                                 levels=c(1:4), labels=c("Daily angina", "Weekly angina", "Monthly angina", "No angina"))

prespec_trd$saq_summ_grp <- factor(ifelse(is.na(prespec_trd$saq_summ_bl), NA, 
                                          ifelse(prespec_trd$saq_summ_bl < 25, 1, 
                                                 ifelse(prespec_trd$saq_summ_bl >= 25 & prespec_trd$saq_summ_bl < 50, 2, 
                                                        ifelse(prespec_trd$saq_summ_bl >= 50 & prespec_trd$saq_summ_bl < 75, 3, 
                                                               ifelse(prespec_trd$saq_summ_bl >= 75, 4, NA))))), 
                                   levels=c(1:4), labels=c("Poor health", "Fair health", "Good health", "Excellent health"))
prespec_trd$saq_ql_grp <- factor(ifelse(is.na(prespec_trd$saq_ql_bl), NA, 
                                        ifelse(prespec_trd$saq_ql_bl < 25, 1, 
                                               ifelse(prespec_trd$saq_ql_bl >= 25 & prespec_trd$saq_ql_bl < 50, 2, 
                                                      ifelse(prespec_trd$saq_ql_bl >= 50 & prespec_trd$saq_ql_bl < 75, 3, 
                                                             ifelse(prespec_trd$saq_ql_bl >= 75, 4, NA))))), 
                                 levels=c(1:4), labels=c("Poor QOL", "Fair QOL", "Good QOL", "Excellent QOL"))

prespec_521 <- list(head=rbindTable(list(Text=paste("<b>Table 5.2.1: Pre-specified analyses - treadmill stress testing results",
                                                    "in relation to baseline measures (Seattle Angina Questionnaire as measures of",
                                                    "angina symptoms).</b>"), Other=list(colspan=5)),
                                    list(Text=paste0("These analyses are conducted on a subset of the analysis population who ",
                                                    "had treadmill stress testing performed, N=", nrow(prespec_trd), "."),
                                         Other=list(colspan=5)), 
                                    cbindTable("", "", list(Text="Treadmill testing results", Other=list(colspan=3))),
                                    cbindTable("", "Subgroup levels", "Nobs (Nmiss)", "Categories", "N (%)")
                                    ),
                    body=rbindTable(list(Text=paste("SAQ angina frequency score category:", 
                                                    summary.fun(x=as.numeric(prespec_trd$saq_af_grp), 
                                                                summary.text="@N observed, @MISS missing")),
                                         Other=list(colspan=5)),
                                    cbindTable("", "Daily angina (score &le; 30)", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$saq_af_grp=="Daily angina" & !is.na(prespec_trd$saq_af_grp)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$saq_af_grp=="Daily angina" & !is.na(prespec_trd$saq_af_grp)])),
                                    cbindTable("", "Weekly angina (score 31 - 60)", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$saq_af_grp=="Weekly angina" & !is.na(prespec_trd$saq_af_grp)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$saq_af_grp=="Weekly angina" & !is.na(prespec_trd$saq_af_grp)])),
                                    cbindTable("", "Monthly angina (score 61 - 99)", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$saq_af_grp=="Monthly angina" & !is.na(prespec_trd$saq_af_grp)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$saq_af_grp=="Monthly angina" & !is.na(prespec_trd$saq_af_grp)])),
                                    cbindTable("", "No angina (score 100)", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$saq_af_grp=="No angina" & !is.na(prespec_trd$saq_af_grp)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$saq_af_grp=="No angina" & !is.na(prespec_trd$saq_af_grp)])),
                                    cbindTable("", "SAQ angina frequency category and treadmill test results: p-value", 
                                               "", "", pfun(varname="trd_res", split="saq_af_grp", prespec_trd)),
                                    list(Text=paste("SAQ quality of life score category:", 
                                                    summary.fun(x=as.numeric(prespec_trd$saq_ql_grp), 
                                                                summary.text="@N observed, @MISS missing")),
                                         Other=list(colspan=5)),
                                    cbindTable("", "Poor QOL (score < 25)", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$saq_ql_grp=="Poor QOL" & !is.na(prespec_trd$saq_ql_grp)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$saq_ql_grp=="Poor QOL" & !is.na(prespec_trd$saq_ql_grp)])),
                                    cbindTable("", "Fair QOL (score 25 - 49)", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$saq_ql_grp=="Fair QOL" & !is.na(prespec_trd$saq_ql_grp)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$saq_ql_grp=="Fair QOL" & !is.na(prespec_trd$saq_ql_grp)])),
                                    cbindTable("", "Good QOL (score 50 -74)", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$saq_ql_grp=="Good QOL" & !is.na(prespec_trd$saq_ql_grp)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$saq_ql_grp=="Good QOL" & !is.na(prespec_trd$saq_ql_grp)])),
                                    cbindTable("", "Excellent QOL (score &ge; 75)", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$saq_ql_grp=="Excellent QOL" & !is.na(prespec_trd$saq_ql_grp)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$saq_ql_grp=="Excellent QOL" & !is.na(prespec_trd$saq_ql_grp)])),
                                    cbindTable("", "SAQ quality of life category and treadmill test results: p-value", 
                                               "", "", pfun(varname="trd_res", split="saq_ql_grp", prespec_trd)),
                                    list(Text=paste("SAQ summary score category:", 
                                                    summary.fun(x=as.numeric(prespec_trd$saq_summ_grp), 
                                                                summary.text="@N observed, @MISS missing")),
                                         Other=list(colspan=5)),
                                    cbindTable("", "Poor health (score < 25)", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$saq_summ_grp=="Poor health" & !is.na(prespec_trd$saq_summ_grp)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$saq_summ_grp=="Poor health" & !is.na(prespec_trd$saq_summ_grp)])),
                                    cbindTable("", "Fair health (score 25 - 49)", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$saq_summ_grp=="Fair health" & !is.na(prespec_trd$saq_summ_grp)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$saq_summ_grp=="Fair health" & !is.na(prespec_trd$saq_summ_grp)])),
                                    cbindTable("", "Good health (score 50 -74)", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$saq_summ_grp=="Good health" & !is.na(prespec_trd$saq_summ_grp)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$saq_summ_grp=="Good health" & !is.na(prespec_trd$saq_summ_grp)])),
                                    cbindTable("", "Excellent health (score &ge; 75)", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$saq_summ_grp=="Excellent health" & !is.na(prespec_trd$saq_summ_grp)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$saq_summ_grp=="Excellent health" & !is.na(prespec_trd$saq_summ_grp)])),
                                    cbindTable("", "SAQ summary category and treadmill test results: p-value", 
                                               "", "", pfun(varname="trd_res", split="saq_summ_grp", prespec_trd)),
                                    end.row(disclaimer=T)
                    )
)
ExportTable.HTML(prespec_521$head, prespec_521$body, horiz.fmt, filename=tables.file, first=F, last=F)

prespec_522 <- list(head=rbindTable(list(Text=paste("<b>Table 5.2.2: Pre-specified analyses - treadmill stress testing results",
                                                    "in relation to pre-randomisation and post-randomisation diagnoses.</b>"), Other=list(colspan=5)),
                                    list(Text=paste0("These analyses are conducted on a subset of the analysis population who ",
                                                     "had treadmill stress testing performed, N=", nrow(prespec_trd), "."),
                                         Other=list(colspan=5)), 
                                    cbindTable("", "", list(Text="Treadmill testing results", Other=list(colspan=3))),
                                    cbindTable("", "Subgroup levels", "Nobs (Nmiss)", "Categories", "N (%)")
                                    ),
                    body=rbindTable(list(Text=paste("Pre-randomisation diagnosis:", 
                                                    summary.fun(x=as.numeric(prespec_trd$clinq_diag), 
                                                                summary.text="@N observed, @MISS missing")),
                                         Other=list(colspan=5)),
                                    cbindTable("", "Obstructive CAD", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$clinq_diag=="Obstructive CAD" & !is.na(prespec_trd$clinq_diag)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$clinq_diag=="Obstructive CAD" & !is.na(prespec_trd$clinq_diag)])),
                                    cbindTable("", "Microvascular angina", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$clinq_diag=="Microvascular angina" & !is.na(prespec_trd$clinq_diag)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$clinq_diag=="Microvascular angina" & !is.na(prespec_trd$clinq_diag)])),
                                    cbindTable("", "Vasospastic angina", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$clinq_diag=="Vasospastic angina" & !is.na(prespec_trd$clinq_diag)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$clinq_diag=="Vasospastic angina" & !is.na(prespec_trd$clinq_diag)])),
                                    cbindTable("", "Non-cardiac chest pain", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_trd$clinq_diag)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_trd$clinq_diag)])),
                                    cbindTable("", "Pre-randomisation diagnosis and treadmill test results: p-value", 
                                               "", "", pfun(varname="trd_res", split="clinq_diag", prespec_trd)),
                                    list(Text=paste("Post-randomisation diagnosis:", 
                                                    summary.fun(x=as.numeric(prespec_trd$mridiag), 
                                                                summary.text="@N observed, @MISS missing")),
                                         Other=list(colspan=5)),
                                    cbindTable("", "Obstructive CAD", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$mridiag=="Obstructive CAD" & !is.na(prespec_trd$mridiag)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$mridiag=="Obstructive CAD" & !is.na(prespec_trd$mridiag)])),
                                    cbindTable("", "Microvascular angina", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$mridiag=="Microvascular angina" & !is.na(prespec_trd$mridiag)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$mridiag=="Microvascular angina" & !is.na(prespec_trd$mridiag)])),
                                    cbindTable("", "Vasospastic angina", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$mridiag=="Vasospastic angina" & !is.na(prespec_trd$mridiag)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$mridiag=="Vasospastic angina" & !is.na(prespec_trd$mridiag)])),
                                    cbindTable("", "Non-cardiac chest pain", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$mridiag=="Non-cardiac chest pain" & !is.na(prespec_trd$mridiag)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$mridiag=="Non-cardiac chest pain" & !is.na(prespec_trd$mridiag)])),
                                    cbindTable("", "Other", 
                                               summary.fun(x=as.numeric(prespec_trd$trd_res)[prespec_trd$mridiag=="Other" & !is.na(prespec_trd$mridiag)], 
                                                           summary.text="@N (@MISS)"),
                                               paste0(levels(prespec_trd$trd_res), collapse="<br>"),
                                               npc.factor(x=prespec_trd$trd_res[prespec_trd$mridiag=="Other" & !is.na(prespec_trd$mridiag)])),
                                    cbindTable("", "Post-randomisation diagnosis and treadmill test results: p-value", 
                                               "", "", pfun(varname="trd_res", split="mridiag", prespec_trd)),
                                    end.row(disclaimer=T)
                                    )
                    )
ExportTable.HTML(prespec_522$head, prespec_522$body, horiz.fmt, filename=tables.file, first=F, last=F)

prespec_trd$trd_res <- factor(prespec_trd$trd_res)
prespec_523 <- list(head=rbindTable(list(Text=paste("<b>Table 5.2.3: Pre-specified analyses - treadmill stress testing results",
                                                    "as a predictor of PROMs.</b>"), 
                                         Other=list(colspan=3)), 
                                    list(Text=paste0("These analyses are conducted on a subset of the analysis population who ", 
                                                     "had treadmill stress testing performed, N=", nrow(prespec_trd), "."), 
                                         Other=list(colspan=3)),
                                    list(Text=paste("In all cases, models have the 6-month follow-up value of the measure as the outcome,", 
                                                    "with the baseline value of the measure and the results of treadmill stress testing as predictors.")), 
                                    cbindTable("Outcome measure", "Treadmill testing results", "Treadmill testing result effect estimate (95 % CI), p-value")), 
                    body=rbindTable(cbindTable("EQ-5D score", paste(levels(prespec_trd$trd_res), collapse="<br>"), 
                                               paste(c("Reference category", 
                                                       oth.lm.summ(fit=lm(prespec_trd$eq5d_score ~ prespec_trd$trd_res + prespec_trd$eq5d_score_bl), 
                                                                   asTable=F, term=2:3, ndp=3))
                                                     )
                                               ),
                                    cbindTable("EQ-5D VAS", paste(levels(prespec_trd$trd_res), collapse="<br>"), 
                                               paste(c("Reference category", 
                                                       oth.lm.summ(fit=lm(prespec_trd$eq5d_health ~ prespec_trd$trd_res + prespec_trd$eq5d_health_bl), 
                                                                   asTable=F, term=2:3))
                                               )
                                    ),
                                    cbindTable("PHQ-4 score", paste(levels(prespec_trd$trd_res), collapse="<br>"), 
                                               paste(c("Reference category", 
                                                       oth.lm.summ(fit=lm(prespec_trd$phq_score ~ prespec_trd$trd_res + prespec_trd$phq_score_bl), 
                                                                   asTable=F, term=2:3))
                                               )
                                    ),
                                    cbindTable("DASI score", paste(levels(prespec_trd$trd_res), collapse="<br>"), 
                                               paste(c("Reference category", 
                                                       oth.lm.summ(fit=lm(prespec_trd$dasi_calc ~ prespec_trd$trd_res + prespec_trd$dasi_calc_bl), 
                                                                   asTable=F, term=2:3))
                                               )
                                    ),
                                    cbindTable("IPAQ weekly total met-minutes", paste(levels(prespec_trd$trd_res), collapse="<br>"), 
                                               paste(c("Reference category", 
                                                       oth.lm.summ(fit=lm(prespec_trd$ipaq_totmetmin ~ prespec_trd$trd_res + prespec_trd$ipaqtotmetmin_bl), 
                                                                   asTable=F, term=2:3))
                                               )
                                    ),
                                    end.row(disclaimer=T)
                    )
)
ExportTable.HTML(prespec_523$head, prespec_523$body, horiz.fmt, filename=tables.file, first=F, last=F)    
# diagnostics of above models
lm.diags(fit=lm(prespec_trd$eq5d_score ~ prespec_trd$trd_res + prespec_trd$eq5d_score_bl), 
         vardesc="EQ-5D score (treadmill stress testing results)", diagsfile=diags.file, tabnum="5.2.3.1")
lm.diags(fit=lm(prespec_trd$eq5d_health ~ prespec_trd$trd_res + prespec_trd$eq5d_health_bl), 
         vardesc="EQ-5D VAS (treadmill stress testing results)", diagsfile=diags.file, tabnum="5.2.3.2")
lm.diags(fit=lm(prespec_trd$phq_score ~ prespec_trd$trd_res + prespec_trd$phq_score_bl), 
         vardesc="PHQ4 score (treadmill stress testing results)", diagsfile=diags.file, tabnum="5.2.3.3")
lm.diags(fit=lm(prespec_trd$dasi_calc ~ prespec_trd$trd_res + prespec_trd$dasi_calc_bl), 
         vardesc="DASI score (treadmill stress testing results)", diagsfile=diags.file, tabnum="5.2.3.4")
lm.diags(fit=lm(prespec_trd$ipaq_totmetmin ~ prespec_trd$trd_res + prespec_trd$ipaqtotmetmin_bl), 
         vardesc="EQ-5D score (treadmill stress testing results)", diagsfile=diags.file, tabnum="5.2.3.5")
# 5.3.x: associations between sex and bl char, sex and prim out, sex and sec out
prespec_sex <- merge(screening[!is.na(screening$randdate), c("sno", "sex", "age", "simd_quintile", "ethnic_simple", "smoking", "qr3bmi", "assign_score", "qr3risksc_calc")], 
                     diagnoses[, c("sno", "clinq_diag", "mridiag", "diag_changed", "change_in_diag")], by="sno", all.x=T)
prespec_sex <- merge(prespec_sex, 
                     outcomes[outcomes$visittypeid==3, 
                              c("sno", "saq_af", "saq_af_bl", "saq_pl", "saq_pl_bl", 
                                "saq_ql", "saq_ql_bl", "saq_ts", "saq_ts_bl", "saq_st", 
                                "saq_st_bl", "saq_summ", "saq_summ_bl", "eq5d_health_bl", 
                                "eq5d_score_bl", "eq5d_health", "eq5d_score", "phq_score_bl", 
                                "phq_score", "ipaqtotmetmin_bl", "ipaq_totmetmin")], by="sno", all.x=T)

summary.table(tabnum="5.3.1", treat=prespec_sex$sex, out.file=tables.file,
              tabtext="Pre-specified analyses - associations between sex, baseline characteristics, and cardiovascular risk factors.", 
              basedata=list(
                list(x=prespec_sex$age, row.name="Age (years)"), 
                list(x=prespec_sex$simd_quintile, row.name="SIMD quintile"), 
                list(x=prespec_sex$ethnic_simple, row.name="Ethnicity"), 
                list(x=prespec_sex$smoking, row.name="Smoking status"), 
                list(x=prespec_sex$qr3bmi, row.name="BMI (kg/m<sup>2</sup>)"), 
                list(x=prespec_sex$assign_score, row.name="ASSIGN cardiovascular risk score"), 
                list(x=prespec_sex$qr3risksc_calc, row.name="QRISK3 cardiovascular risk score")
                
              )
)

summary.table(tabnum="5.3.2", treat=prespec_sex$sex, out.file=tables.file,
              tabtext="Pre-specified analyses - associations between sex, pre-randomisation and post-randomisation diagnoses.", 
              basedata=list(
                list(x=prespec_sex$clinq_diag, row.name="Pre-randomisation diagnosis"), 
                list(x=prespec_sex$mridiag, row.name="Post-randomisation diagnosis"), 
                list(x=prespec_sex$diag_changed, row.name="Diagnosis changed?", x.levels="Yes"), 
                list(x=prespec_sex$change_in_diag, row.name="Change in diagnosis", subset=prespec_sex$diag_changed=="Yes", 
                     x.levels=c("'Microvascular angina' to 'Non-cardiac chest pain'", "'Non-cardiac chest pain' to 'Microvascular angina'",
                                "'Non-cardiac chest pain' to 'Other'", "'Non-cardiac chest pain' to 'Vasospastic angina'",  
                                "'Obstructive CAD' to 'Microvascular angina'"))
              )
)

summary.table(tabnum="5.3.3", treat=prespec_sex$sex, out.file=tables.file,
              tabtext="Pre-specified analyses - associations between sex and baseline values of secondary outcomes.", 
              basedata=list(
                list(x=prespec_sex$saq_af_bl, row.name="SAQ angina frequency score"), 
                list(x=prespec_sex$saq_pl_bl, row.name="SAQ physical limitation score"), 
                list(x=prespec_sex$saq_ql_bl, row.name="SAQ quality of life score"), 
                list(x=prespec_sex$saq_st_bl, row.name="SAQ stability score"),
                list(x=prespec_sex$saq_ts_bl, row.name="SAQ treatment satisfaction score"), 
                list(x=prespec_sex$saq_summ_bl, row.name="SAQ summary score"),
                list(x=prespec_sex$eq5d_score_bl, row.name="EQ-5D score"),
                list(x=prespec_sex$eq5d_health_bl, row.name="EQ-5D VAS"),
                list(x=prespec_sex$phq_score_bl, row.name="PHQ-4 score"), 
                list(x=prespec_sex$ipaqtotmetmin_bl, row.name="IPAQ total weekly met-minutes")
                
              )
)

summary.table(tabnum="5.3.4", treat=prespec_sex$sex, out.file=tables.file,
              tabtext="Pre-specified analyses - associations between sex and 6 month follow-up values of secondary outcomes.", 
              basedata=list(
                list(x=prespec_sex$saq_af, row.name="SAQ angina frequency score"), 
                list(x=prespec_sex$saq_pl, row.name="SAQ physical limitation score"), 
                list(x=prespec_sex$saq_ql, row.name="SAQ quality of life score"), 
                list(x=prespec_sex$saq_st, row.name="SAQ stability score"),
                list(x=prespec_sex$saq_ts, row.name="SAQ treatment satisfaction score"), 
                list(x=prespec_sex$saq_summ, row.name="SAQ summary score"),
                list(x=prespec_sex$eq5d_score, row.name="EQ-5D score", ndp=2),
                list(x=prespec_sex$eq5d_health, row.name="EQ-5D VAS"),
                list(x=prespec_sex$phq_score, row.name="PHQ-4 score", ndp=2), 
                list(x=prespec_sex$ipaq_totmetmin, row.name="IPAQ total weekly met-minutes")
                
              )
)
# 5.4.x: bipq phq association w SAQ, diags, cardiovascular risk factors, proms at bl and fu
prespec_psych <- merge(outcomes[outcomes$visittypeid==1 & !is.na(outcomes$randdate),
                                c("sno", "bipq_tot_bl", "phq_score_bl", 
                                  "saq_af_bl", "saq_ql_bl", "saq_summ_bl")], 
                       outcomes[outcomes$visittypeid==3, c("sno", "saq_af", "saq_ql", "saq_summ")], 
                       by="sno", all.x=T)
prespec_psych <- merge(prespec_psych, 
                       diagnoses[, c("sno", "clinq_diag", "mridiag")], 
                       by="sno", all.x=T)
prespec_psych <- merge(prespec_psych, 
                       screening[, c("sno", "smoking", "qr3bmi", "qr3risksc_calc", "assign_score")], 
                       by="sno", all.x=T)
prespec_psych$saq_af_grp <- factor(ifelse(is.na(prespec_psych$saq_af_bl), NA, 
                                        ifelse(prespec_psych$saq_af_bl <= 30, 1, 
                                               ifelse(prespec_psych$saq_af_bl > 30 & prespec_psych$saq_af_bl <= 60, 2, 
                                                      ifelse(prespec_psych$saq_af_bl > 60 & prespec_psych$saq_af_bl <= 99, 3, 
                                                             ifelse(prespec_psych$saq_af_bl==100, 4, NA))))), 
                                 levels=c(1:4), labels=c("Daily angina", "Weekly angina", "Monthly angina", "No angina"))

prespec_psych$saq_summ_grp <- factor(ifelse(is.na(prespec_psych$saq_summ_bl), NA, 
                                          ifelse(prespec_psych$saq_summ_bl < 25, 1, 
                                                 ifelse(prespec_psych$saq_summ_bl >= 25 & prespec_psych$saq_summ_bl < 50, 2, 
                                                        ifelse(prespec_psych$saq_summ_bl >= 50 & prespec_psych$saq_summ_bl < 75, 3, 
                                                               ifelse(prespec_psych$saq_summ_bl >= 75, 4, NA))))), 
                                   levels=c(1:4), labels=c("Poor health", "Fair health", "Good health", "Excellent health"))
prespec_psych$saq_ql_grp <- factor(ifelse(is.na(prespec_psych$saq_ql_bl), NA, 
                                        ifelse(prespec_psych$saq_ql_bl < 25, 1, 
                                               ifelse(prespec_psych$saq_ql_bl >= 25 & prespec_psych$saq_ql_bl < 50, 2, 
                                                      ifelse(prespec_psych$saq_ql_bl >= 50 & prespec_psych$saq_ql_bl < 75, 3, 
                                                             ifelse(prespec_psych$saq_ql_bl >= 75, 4, NA))))), 
                                 levels=c(1:4), labels=c("Poor QOL", "Fair QOL", "Good QOL", "Excellent QOL"))

prespec_psych$bmi_grp <- factor(ifelse(is.na(prespec_psych$qr3bmi), NA, 
                                       ifelse(prespec_psych$qr3bmi < 18.5, "Underweight", 
                                              ifelse(prespec_psych$qr3bmi >= 18.5 & prespec_psych$qr3bmi < 25, "Healthy range", 
                                                     ifelse(prespec_psych$qr3bmi >= 25 & prespec_psych$qr3bmi < 30, "Overweight", 
                                                            ifelse(prespec_psych$qr3bmi >= 30 & prespec_psych$qr3bmi < 40, "Obese", 
                                                                   ifelse(prespec_psych$qr3bmi >= 40, "Severely obese", NA)))))), 
                                levels=c("Underweight", "Healthy range", "Overweight", "Obese", "Severely obese"))

prespec_psych$qr3sc_grp <- factor(ifelse(is.na(prespec_psych$qr3risksc_calc), NA, 
                                         ifelse(prespec_psych$qr3risksc_calc < 10, "Low risk (score < 10)", 
                                                ifelse(prespec_psych$qr3risksc_calc >= 10 & prespec_psych$qr3risksc_calc <= 20, "Moderate risk (score 10 - 20)", 
                                                       ifelse(prespec_psych$qr3risksc_calc > 20, "High risk (score > 20)", NA)))), 
                                  levels=c("Low risk (score < 10)", "Moderate risk (score 10 - 20)", "High risk (score > 20)"))

prespec_psych$assign_grp <- factor(ifelse(is.na(prespec_psych$assign_score), NA, 
                                          ifelse(prespec_psych$assign_score < 10, "Lower risk (score < 10)", 
                                                 ifelse(prespec_psych$assign_score >= 10, "Higher risk (score &ge; 10)", NA))), 
                                   levels=c("Lower risk (score < 10)", "Higher risk (score &ge; 10)"))

prespec_psych$saq_af_grp_fu <- factor(ifelse(is.na(prespec_psych$saq_af), NA, 
                                          ifelse(prespec_psych$saq_af <= 30, 1, 
                                                 ifelse(prespec_psych$saq_af > 30 & prespec_psych$saq_af <= 60, 2, 
                                                        ifelse(prespec_psych$saq_af > 60 & prespec_psych$saq_af <= 99, 3, 
                                                               ifelse(prespec_psych$saq_af==100, 4, NA))))), 
                                   levels=c(1:4), labels=c("Daily angina", "Weekly angina", "Monthly angina", "No angina"))

prespec_psych$saq_summ_grp_fu <- factor(ifelse(is.na(prespec_psych$saq_summ), NA, 
                                            ifelse(prespec_psych$saq_summ < 25, 1, 
                                                   ifelse(prespec_psych$saq_summ >= 25 & prespec_psych$saq_summ < 50, 2, 
                                                          ifelse(prespec_psych$saq_summ >= 50 & prespec_psych$saq_summ < 75, 3, 
                                                                 ifelse(prespec_psych$saq_summ >= 75, 4, NA))))), 
                                     levels=c(1:4), labels=c("Poor health", "Fair health", "Good health", "Excellent health"))
prespec_psych$saq_ql_grp_fu <- factor(ifelse(is.na(prespec_psych$saq_ql), NA, 
                                          ifelse(prespec_psych$saq_ql < 25, 1, 
                                                 ifelse(prespec_psych$saq_ql >= 25 & prespec_psych$saq_ql < 50, 2, 
                                                        ifelse(prespec_psych$saq_ql >= 50 & prespec_psych$saq_ql < 75, 3, 
                                                               ifelse(prespec_psych$saq_ql >= 75, 4, NA))))), 
                                   levels=c(1:4), labels=c("Poor QOL", "Fair QOL", "Good QOL", "Excellent QOL"))

prespec_tab_541 <- list(head=rbindTable(list(Text="<b>Table 5.4.1: Pre-specified analyses - baseline psychological wellbeing scores in relation to baseline measures (Seattle Angina Questionnaire as measures of angina symptoms).</b>"), 
                                        list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                        "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                        "&Chi;<sup>2</sup>.")),
                                        cbindTable("", "", 
                                                   list(Text="Brief Illness Perception Questionnaire score", Other=list(colspan=2)), 
                                                   list(Text="Patient Health Questionnaire 4 score", Other=list(colspan=2))),
                                        cbindTable("", "Subgroup levels", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)")), 
                        body=rbindTable(list(Text="SAQ angina frequency score category", Other=list(colspan=6)), 
                                        cbindTable("", "Daily angina (score &le; 30)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp=="Daily angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp=="Daily angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp=="Daily angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp=="Daily angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Weekly angina (score 31 - 60)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp=="Weekly angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp=="Weekly angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp=="Weekly angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp=="Weekly angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                                   ), 
                                        cbindTable("", "Monthly angina (score 61 - 99)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp=="Monthly angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp=="Monthly angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp=="Monthly angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp=="Monthly angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                                   ), 
                                        cbindTable("", "No angina (score 100)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp=="No angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp=="No angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp=="No angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp=="No angina" & !is.na(prespec_psych$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                                   ), 
                                        list(Text="SAQ angina frequency category and psychological wellbeing scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "",
                                                   pfun("bipq_tot_bl", "saq_af_grp", prespec_psych),
                                                   "",
                                                   pfun("phq_score_bl", "saq_af_grp", prespec_psych)), 
                                        list(Text="SAQ quality of life score category", Other=list(colspan=6)), 
                                        cbindTable("", "Poor QOL (score < 25)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp=="Poor QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp=="Poor QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp=="Poor QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp=="Poor QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Fair QOL (score 25 - 49)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp=="Fair QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp=="Fair QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp=="Fair QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp=="Fair QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Good QOL 50 - 74", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp=="Good QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp=="Good QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp=="Good QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp=="Good QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Excellent QOL (score &ge; 75)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp=="Excellent QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp=="Excellent QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp=="Excellent QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp=="Excellent QOL" & !is.na(prespec_psych$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="SAQ quality of life category and psychological wellbeing scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", 
                                                   pfun("bipq_tot_bl", "saq_ql_grp", prespec_psych),
                                                   "",
                                                   pfun("phq_score_bl", "saq_ql_grp", prespec_psych)), 
                                        list(Text="SAQ summary score category", Other=list(colspan=6)), 
                                        cbindTable("", "Poor health (score < 25)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp=="Poor health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp=="Poor health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp=="Poor health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp=="Poor health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Fair health (score < 25)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp=="Fair health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp=="Fair health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp=="Fair health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp=="Fair health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Good health (score < 25)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp=="Good health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp=="Good health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp=="Good health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp=="Good health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Excellent health (score < 25)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp=="Excellent health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp=="Excellent health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp=="Excellent health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp=="Excellent health" & !is.na(prespec_psych$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="SAQ summary category and psychological wellbeing scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "",
                                                   pfun("bipq_tot_bl", "saq_summ_grp", prespec_psych),
                                                   "",
                                                   pfun("phq_score_bl", "saq_summ_grp", prespec_psych)), 
                                        end.row(disclaimer=T)
                        )
)
ExportTable.HTML(prespec_tab_541$head, prespec_tab_541$body, horiz.fmt, filename=tables.file, first=F, last=F)

prespec_tab_542 <- list(head=rbindTable(list(Text=paste("<b>Table 5.4.2: Pre-specified analyses", 
                                                        "- psychological wellbeing scores in", 
                                                        "relation to pre-randomisation and post-randomisation", 
                                                        "diagnoses.</b>"), Other=list(colspan=6)),
                                        list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                        "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                        "&Chi;<sup>2</sup>."), Other=list(colspan=6)),
                                        cbindTable("", "", 
                                                   list(Text="Brief Illness Perception Questionnaire Score", Other=list(colspan=2)), 
                                                   list(Text="Patient Health Questionnaire 4 score", Other=list(colspan=2))),
                                        cbindTable("", "Subgroup levels", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)")
                                        ), 
                        body=rbindTable(list(Text="Pre-randomisation diagnosis"),
                                        cbindTable("", "Obstructive CAD", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$clinq_diag=="Obstructive CAD" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$clinq_diag=="Obstructive CAD" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$clinq_diag=="Obstructive CAD" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$clinq_diag=="Obstructive CAD" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Microvascular angina", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$clinq_diag=="Microvascular angina" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$clinq_diag=="Microvascular angina" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$clinq_diag=="Microvascular angina" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$clinq_diag=="Microvascular angina" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Vasospastic angina", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$clinq_diag=="Vasospastic angina" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$clinq_diag=="Vasospastic angina" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$clinq_diag=="Vasospastic angina" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$clinq_diag=="Vasospastic angina" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Non-cardiac chest pain", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="Pre-randomisation diagnosis and psychological wellbeing scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", pfun("bipq_tot_bl", "clinq_diag", prespec_psych), 
                                                   "", pfun("phq_score_bl", "clinq_diag", prespec_psych)),
                                        list(Text="Post-randomisation diagnosis"),
                                        cbindTable("", "Obstructive CAD", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$mridiag=="Obstructive CAD" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$mridiag=="Obstructive CAD" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$mridiag=="Obstructive CAD" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$mridiag=="Obstructive CAD" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Microvascular angina", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$mridiag=="Microvascular angina" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$mridiag=="Microvascular angina" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$mridiag=="Microvascular angina" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$mridiag=="Microvascular angina" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Vasospastic angina", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$mridiag=="Vasospastic angina" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$mridiag=="Vasospastic angina" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$mridiag=="Vasospastic angina" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$mridiag=="Vasospastic angina" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Other", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$mridiag=="Other" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$mridiag=="Other" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$mridiag=="Other" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$mridiag=="Other" & !is.na(prespec_psych$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="Post-randomisation diagnosis and psychological wellbeing scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", pfun("bipq_tot_bl", "mridiag", prespec_psych), 
                                                   "",
                                                   pfun("phq_score_bl", "mridiag", prespec_psych)),
                                        end.row(disclaimer=T)
                        )
)

ExportTable.HTML(prespec_tab_542$head, prespec_tab_542$body, horiz.fmt, filename=tables.file, first=F, last=F)


prespec_tab_543 <- list(head=rbindTable(list(Text=paste("<b>Table 5.4.3: Pre-specified analyses", 
                                                        "- psychological wellbeing scores in", 
                                                        "relation to cardiovascular risk factors.</b>"),
                                             Other=list(colspan=6)),
                                        list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                        "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                        "&Chi;<sup>2</sup>."),
                                             Other=list(colspan=6)),
                                        cbindTable("", "", 
                                                   list(Text="Brief Illness Perception Questionnaire Score", Other=list(colspan=2)), 
                                                   list(Text="Patient Health Questionnaire 4 score", Other=list(colspan=2))),
                                        cbindTable("", "Subgroup levels", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)")), 
                        body=rbindTable(list(Text="Smoking status"),
                                        cbindTable("", "Smokes every day", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$smoking=="Smokes every day" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$smoking=="Smokes every day" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$smoking=="Smokes every day" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$smoking=="Smokes every day" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Smokes, not every day", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$smoking=="Smokes, not every day" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$smoking=="Smokes, not every day" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$smoking=="Smokes, not every day" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$smoking=="Smokes, not every day" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Ex-smoker", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$smoking=="Ex-smoker" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$smoking=="Ex-smoker" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$smoking=="Ex-smoker" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$smoking=="Ex-smoker" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Never smoked", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$smoking=="Never smoked" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$smoking=="Never smoked" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$smoking=="Never smoked" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$smoking=="Never smoked" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="Smoking status and psychological wellbeing scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", paste("KW:", p.format(kruskal.test(prespec_psych$bipq_tot_bl ~ prespec_psych$smoking)$p.value)), 
                                                   "", pfun("phq_score_bl", "smoking", prespec_psych)),
                                        list(Text="BMI category"),
                                        cbindTable("", "Underweight", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$bmi_grp=="Underweight" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$bmi_grp=="Underweight" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$bmi_grp=="Underweight" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$bmi_grp=="Underweight" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Healthy range", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$bmi_grp=="Healthy range" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$bmi_grp=="Healthy range" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$bmi_grp=="Healthy range" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$bmi_grp=="Healthy range" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Overweight", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$bmi_grp=="Overweight" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$bmi_grp=="Overweight" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$bmi_grp=="Overweight" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$bmi_grp=="Overweight" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Obese", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$bmi_grp=="Obese" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$bmi_grp=="Obese" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$bmi_grp=="Obese" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$bmi_grp=="Obese" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Severely obese", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$bmi_grp=="Severely obese" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$bmi_grp=="Severely obese" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$bmi_grp=="Severely obese" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$bmi_grp=="Severely obese" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="BMI category and psychological wellbeing scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", paste("KW:",p.format(kruskal.test(prespec_psych$bipq_tot_bl ~ prespec_psych$bmi_grp)$p.value)), 
                                                   "", paste("KW:",p.format(kruskal.test(prespec_psych[, "phq_score_bl"],
                                                                                   prespec_psych[, "bmi_grp"])$p.value))),
                                        list(Text="ASSIGN score category"),
                                        cbindTable("", "Lower risk (score < 10)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$assign_grp=="Lower risk (score < 10)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$assign_grp=="Lower risk (score < 10)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$assign_grp=="Lower risk (score < 10)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$assign_grp=="Lower risk (score < 10)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Higher risk (score &ge; 10)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$assign_grp=="Higher risk (score &ge; 10)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$assign_grp=="Higher risk (score &ge; 10)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$assign_grp=="Higher risk (score &ge; 10)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$assign_grp=="Higher risk (score &ge; 10)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="ASSIGN score category and psychological wellbeing scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", pfun("bipq_tot_bl", "assign_grp", prespec_psych), 
                                                   "", pfun("phq_score_bl", "assign_grp", prespec_psych)),
                                        
                                        list(Text="QRISK3 score category"),
                                        cbindTable("", "Low risk (score < 10)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$qr3sc_grp=="Low risk (score < 10)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$qr3sc_grp=="Low risk (score < 10)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$qr3sc_grp=="Low risk (score < 10)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$qr3sc_grp=="Low risk (score < 10)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Moderate risk (score 10 - 20)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$qr3sc_grp=="Moderate risk (score 10 - 20)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$qr3sc_grp=="Moderate risk (score 10 - 20)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$qr3sc_grp=="Moderate risk (score 10 - 20)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$qr3sc_grp=="Moderate risk (score 10 - 20)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "High risk (score > 20)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$qr3sc_grp=="High risk (score > 20)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$qr3sc_grp=="High risk (score > 20)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$qr3sc_grp=="High risk (score > 20)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$qr3sc_grp=="High risk (score > 20)" & !is.na(prespec_psych$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="QRISK3 score category and psychological wellbeing scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", paste("KW:",p.format(kruskal.test(prespec_psych$bipq_tot_bl ~ prespec_psych$qr3sc_grp)$p.value)), 
                                                   "", pfun("phq_score_bl", "qr3sc_grp", prespec_psych)),
                                        end.row(disclaimer=T)
                        )
)
ExportTable.HTML(prespec_tab_543$head, prespec_tab_543$body, horiz.fmt, filename=tables.file, first=F, last=F)

prespec_tab_544 <- list(head=rbindTable(list(Text="<b>Table 5.4.4: Pre-specified analyses - baseline psychological wellbeing scores in relation to PROMs (Seattle Angina Questionnaire at 6 months).</b>"), 
                                        list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                        "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                        "&Chi;<sup>2</sup>.")),
                                        cbindTable("", "", 
                                                   list(Text="Brief Illness Perception Questionnaire score", Other=list(colspan=2)), 
                                                   list(Text="Patient Health Questionnaire 4 score", Other=list(colspan=2))),
                                        cbindTable("", "Subgroup levels", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)")), 
                        body=rbindTable(list(Text="SAQ angina frequency score category", Other=list(colspan=6)), 
                                        cbindTable("", "Daily angina (score &le; 30)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp_fu=="Daily angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp_fu=="Daily angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp_fu=="Daily angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp_fu=="Daily angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Weekly angina (score 31 - 60)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp_fu=="Weekly angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp_fu=="Weekly angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp_fu=="Weekly angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp_fu=="Weekly angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Monthly angina (score 61 - 99)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp_fu=="Monthly angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp_fu=="Monthly angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp_fu=="Monthly angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp_fu=="Monthly angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "No angina (score 100)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp_fu=="No angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_af_grp_fu=="No angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp_fu=="No angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_af_grp_fu=="No angina" & !is.na(prespec_psych$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="SAQ angina frequency category and psychological wellbeing scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "",
                                                   pfun("bipq_tot_bl", "saq_af_grp_fu", prespec_psych),
                                                   "",
                                                   pfun("phq_score_bl", "saq_af_grp_fu", prespec_psych)), 
                                        list(Text="SAQ quality of life score category", Other=list(colspan=6)), 
                                        cbindTable("", "Poor QOL (score < 25)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp_fu=="Poor QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp_fu=="Poor QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp_fu=="Poor QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp_fu=="Poor QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Fair QOL (score 25 - 49)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp_fu=="Fair QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp_fu=="Fair QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp_fu=="Fair QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp_fu=="Fair QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Good QOL 50 - 74", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp_fu=="Good QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp_fu=="Good QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp_fu=="Good QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp_fu=="Good QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Excellent QOL (score &ge; 75)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp_fu=="Excellent QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_ql_grp_fu=="Excellent QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp_fu=="Excellent QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_ql_grp_fu=="Excellent QOL" & !is.na(prespec_psych$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="SAQ quality of life category and psychological wellbeing scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", 
                                                   pfun("bipq_tot_bl", "saq_ql_grp_fu", prespec_psych),
                                                   "",
                                                   pfun("phq_score_bl", "saq_ql_grp_fu", prespec_psych)), 
                                        list(Text="SAQ summary score category", Other=list(colspan=6)), 
                                        cbindTable("", "Poor health (score < 25)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp_fu=="Poor health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp_fu=="Poor health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp_fu=="Poor health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp_fu=="Poor health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Fair health (score < 25)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp_fu=="Fair health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp_fu=="Fair health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp_fu=="Fair health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp_fu=="Fair health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Good health (score < 25)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp_fu=="Good health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp_fu=="Good health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp_fu=="Good health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp_fu=="Good health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Excellent health (score < 25)", 
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp_fu=="Excellent health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$bipq_tot_bl[prespec_psych$saq_summ_grp_fu=="Excellent health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp_fu=="Excellent health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_psych$phq_score_bl[prespec_psych$saq_summ_grp_fu=="Excellent health" & !is.na(prespec_psych$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="SAQ summary category and psychological wellbeing scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "",
                                                   pfun("bipq_tot_bl", "saq_summ_grp_fu", prespec_psych),
                                                   "",
                                                   pfun("phq_score_bl", "saq_summ_grp_fu", prespec_psych)), 
                                        end.row(disclaimer=T)
                        )
)
ExportTable.HTML(prespec_tab_544$head, prespec_tab_544$body, horiz.fmt, filename=tables.file, first=F, last=F)

# 5.5.x: treatment satisfaction associations
prespec_sat <- merge(outcomes[outcomes$visittypeid==1 & !is.na(outcomes$randdate), 
                              c("sno", "tsqm_sat_bl", "saq_ts_bl",
                                "saq_af_bl", "saq_ql_bl", "saq_summ_bl")], 
                     outcomes[outcomes$visittypeid==3, c("sno", "saq_af", "saq_ql", "saq_summ")], 
                     by="sno", all.x=T)
prespec_sat <- merge(prespec_sat, 
                     diagnoses[, c("sno", "clinq_diag", "mridiag")], 
                     by="sno", all.x=T)
prespec_sat <- merge(prespec_sat, 
                     screening[, c("sno", "smoking", "qr3bmi", "qr3risksc_calc", "assign_score")], 
                     by="sno", all.x=T)
prespec_sat$saq_af_grp <- factor(ifelse(is.na(prespec_sat$saq_af_bl), NA, 
                                        ifelse(prespec_sat$saq_af_bl <= 30, 1, 
                                               ifelse(prespec_sat$saq_af_bl > 30 & prespec_sat$saq_af_bl <= 60, 2, 
                                                      ifelse(prespec_sat$saq_af_bl > 60 & prespec_sat$saq_af_bl <= 99, 3, 
                                                             ifelse(prespec_sat$saq_af_bl==100, 4, NA))))), 
                                 levels=c(1:4), labels=c("Daily angina", "Weekly angina", "Monthly angina", "No angina"))

prespec_sat$saq_summ_grp <- factor(ifelse(is.na(prespec_sat$saq_summ_bl), NA, 
                                          ifelse(prespec_sat$saq_summ_bl < 25, 1, 
                                                 ifelse(prespec_sat$saq_summ_bl >= 25 & prespec_sat$saq_summ_bl < 50, 2, 
                                                        ifelse(prespec_sat$saq_summ_bl >= 50 & prespec_sat$saq_summ_bl < 75, 3, 
                                                               ifelse(prespec_sat$saq_summ_bl >= 75, 4, NA))))), 
                                   levels=c(1:4), labels=c("Poor health", "Fair health", "Good health", "Excellent health"))
prespec_sat$saq_ql_grp <- factor(ifelse(is.na(prespec_sat$saq_ql_bl), NA, 
                                        ifelse(prespec_sat$saq_ql_bl < 25, 1, 
                                               ifelse(prespec_sat$saq_ql_bl >= 25 & prespec_sat$saq_ql_bl < 50, 2, 
                                                      ifelse(prespec_sat$saq_ql_bl >= 50 & prespec_sat$saq_ql_bl < 75, 3, 
                                                             ifelse(prespec_sat$saq_ql_bl >= 75, 4, NA))))), 
                                 levels=c(1:4), labels=c("Poor QOL", "Fair QOL", "Good QOL", "Excellent QOL"))

prespec_sat$bmi_grp <- factor(ifelse(is.na(prespec_sat$qr3bmi), NA, 
                                     ifelse(prespec_sat$qr3bmi < 18.5, "Underweight", 
                                            ifelse(prespec_sat$qr3bmi >= 18.5 & prespec_sat$qr3bmi < 25, "Healthy range", 
                                                   ifelse(prespec_sat$qr3bmi >= 25 & prespec_sat$qr3bmi < 30, "Overweight", 
                                                          ifelse(prespec_sat$qr3bmi >= 30 & prespec_sat$qr3bmi < 40, "Obese", 
                                                                 ifelse(prespec_sat$qr3bmi >= 40, "Severely obese", NA)))))), 
                              levels=c("Underweight", "Healthy range", "Overweight", "Obese", "Severely obese"))

prespec_sat$qr3sc_grp <- factor(ifelse(is.na(prespec_sat$qr3risksc_calc), NA, 
                                       ifelse(prespec_sat$qr3risksc_calc < 10, "Low risk (score < 10)", 
                                              ifelse(prespec_sat$qr3risksc_calc >= 10 & prespec_sat$qr3risksc_calc <= 20, "Moderate risk (score 10 - 20)", 
                                                     ifelse(prespec_sat$qr3risksc_calc > 20, "High risk (score > 20)", NA)))), 
                                levels=c("Low risk (score < 10)", "Moderate risk (score 10 - 20)", "High risk (score > 20)"))

prespec_sat$assign_grp <- factor(ifelse(is.na(prespec_sat$assign_score), NA, 
                                        ifelse(prespec_sat$assign_score < 10, "Lower risk (score < 10)", 
                                               ifelse(prespec_sat$assign_score >= 10, "Higher risk (score &ge; 10)", NA))), 
                                 levels=c("Lower risk (score < 10)", "Higher risk (score &ge; 10)"))

prespec_sat$saq_af_grp_fu <- factor(ifelse(is.na(prespec_sat$saq_af), NA, 
                                           ifelse(prespec_sat$saq_af <= 30, 1, 
                                                  ifelse(prespec_sat$saq_af > 30 & prespec_sat$saq_af <= 60, 2, 
                                                         ifelse(prespec_sat$saq_af > 60 & prespec_sat$saq_af <= 99, 3, 
                                                                ifelse(prespec_sat$saq_af==100, 4, NA))))), 
                                    levels=c(1:4), labels=c("Daily angina", "Weekly angina", "Monthly angina", "No angina"))

prespec_sat$saq_summ_grp_fu <- factor(ifelse(is.na(prespec_sat$saq_summ), NA, 
                                             ifelse(prespec_sat$saq_summ < 25, 1, 
                                                    ifelse(prespec_sat$saq_summ >= 25 & prespec_sat$saq_summ < 50, 2, 
                                                           ifelse(prespec_sat$saq_summ >= 50 & prespec_sat$saq_summ < 75, 3, 
                                                                  ifelse(prespec_sat$saq_summ >= 75, 4, NA))))), 
                                      levels=c(1:4), labels=c("Poor health", "Fair health", "Good health", "Excellent health"))
prespec_sat$saq_ql_grp_fu <- factor(ifelse(is.na(prespec_sat$saq_ql), NA, 
                                           ifelse(prespec_sat$saq_ql < 25, 1, 
                                                  ifelse(prespec_sat$saq_ql >= 25 & prespec_sat$saq_ql < 50, 2, 
                                                         ifelse(prespec_sat$saq_ql >= 50 & prespec_sat$saq_ql < 75, 3, 
                                                                ifelse(prespec_sat$saq_ql >= 75, 4, NA))))), 
                                    levels=c(1:4), labels=c("Poor QOL", "Fair QOL", "Good QOL", "Excellent QOL"))

prespec_tab_551 <- list(head=rbindTable(list(Text="<b>Table 5.5.1: Pre-specified analyses - baseline treatment satisfaction scores in relation to baseline measures (Seattle Angina Questionnaire as measures of angina symptoms).</b>"), 
                                        list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                        "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                        "&Chi;<sup>2</sup>.")),
                                        cbindTable("", "", 
                                                   list(Text="TSQM-9 satisfaction score", Other=list(colspan=2)), 
                                                   list(Text="SAQ treatment satisfaction score", Other=list(colspan=2))),
                                        cbindTable("", "Subgroup levels", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)")), 
                        body=rbindTable(list(Text="SAQ angina frequency score category", Other=list(colspan=6)), 
                                        cbindTable("", "Daily angina (score &le; 30)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp=="Daily angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp=="Daily angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp=="Daily angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp=="Daily angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Weekly angina (score 31 - 60)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp=="Weekly angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp=="Weekly angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp=="Weekly angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp=="Weekly angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Monthly angina (score 61 - 99)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp=="Monthly angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp=="Monthly angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp=="Monthly angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp=="Monthly angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "No angina (score 100)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp=="No angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp=="No angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp=="No angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp=="No angina" & !is.na(prespec_sat$saq_af_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="SAQ angina frequency category and treatment satisfaction scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "",
                                                   pfun("tsqm_sat_bl", "saq_af_grp", prespec_sat),
                                                   "",
                                                   pfun("saq_ts_bl", "saq_af_grp", prespec_sat)), 
                                        list(Text="SAQ quality of life score category", Other=list(colspan=6)), 
                                        cbindTable("", "Poor QOL (score < 25)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp=="Poor QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp=="Poor QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp=="Poor QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp=="Poor QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Fair QOL (score 25 - 49)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp=="Fair QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp=="Fair QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp=="Fair QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp=="Fair QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Good QOL 50 - 74", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp=="Good QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp=="Good QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp=="Good QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp=="Good QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Excellent QOL (score &ge; 75)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp=="Excellent QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp=="Excellent QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp=="Excellent QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp=="Excellent QOL" & !is.na(prespec_sat$saq_ql_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="SAQ quality of life category and treatment satisfaction scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", 
                                                   pfun("tsqm_sat_bl", "saq_ql_grp", prespec_sat),
                                                   "",
                                                   pfun("saq_ts_bl", "saq_ql_grp", prespec_sat)), 
                                        list(Text="SAQ summary score category", Other=list(colspan=6)), 
                                        cbindTable("", "Poor health (score < 25)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp=="Poor health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp=="Poor health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp=="Poor health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp=="Poor health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Fair health (score < 25)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp=="Fair health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp=="Fair health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp=="Fair health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp=="Fair health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Good health (score < 25)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp=="Good health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp=="Good health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp=="Good health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp=="Good health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Excellent health (score < 25)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp=="Excellent health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp=="Excellent health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp=="Excellent health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp=="Excellent health" & !is.na(prespec_sat$saq_summ_grp)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="SAQ summary category and treatment satisfaction scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "",
                                                   pfun("tsqm_sat_bl", "saq_summ_grp", prespec_sat),
                                                   "",
                                                   pfun("saq_ts_bl", "saq_summ_grp", prespec_sat)), 
                                        end.row(disclaimer=T)
                        )
)
ExportTable.HTML(prespec_tab_551$head, prespec_tab_551$body, horiz.fmt, filename=tables.file, first=F, last=F)

prespec_tab_552 <- list(head=rbindTable(list(Text=paste("<b>Table 5.5.2: Pre-specified analyses", 
                                                        "- baseline treatment satisfaction scores in", 
                                                        "relation to pre-randomisation and post-randomisation", 
                                                        "diagnoses.</b>"), 
                                             Other=list(colspan=6)),
                                        list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                        "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                        "&Chi;<sup>2</sup>.")),
                                        cbindTable("", "", 
                                                   list(Text="TSQM-9 satisfaction score", Other=list(colspan=2)), 
                                                   list(Text="SAQ treatment satisfaction score", Other=list(colspan=2))),
                                        cbindTable("", "Subgroup levels", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)")), 
                        body=rbindTable(list(Text="Pre-randomisation diagnosis"),
                                        cbindTable("", "Obstructive CAD", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$clinq_diag=="Obstructive CAD" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$clinq_diag=="Obstructive CAD" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$clinq_diag=="Obstructive CAD" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$clinq_diag=="Obstructive CAD" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Microvascular angina", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$clinq_diag=="Microvascular angina" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$clinq_diag=="Microvascular angina" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$clinq_diag=="Microvascular angina" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$clinq_diag=="Microvascular angina" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Vasospastic angina", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$clinq_diag=="Vasospastic angina" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$clinq_diag=="Vasospastic angina" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$clinq_diag=="Vasospastic angina" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$clinq_diag=="Vasospastic angina" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Non-cardiac chest pain", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$clinq_diag=="Non-cardiac chest pain" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="Pre-randomisation diagnosis and treatment satisfaction scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", pfun("tsqm_sat_bl", "clinq_diag", prespec_sat), 
                                                   "", pfun("saq_ts_bl", "clinq_diag", prespec_sat)),
                                        list(Text="Post-randomisation diagnosis"),
                                        cbindTable("", "Obstructive CAD", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$mridiag=="Obstructive CAD" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$mridiag=="Obstructive CAD" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$mridiag=="Obstructive CAD" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$mridiag=="Obstructive CAD" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Microvascular angina", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$mridiag=="Microvascular angina" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$mridiag=="Microvascular angina" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$mridiag=="Microvascular angina" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$mridiag=="Microvascular angina" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Vasospastic angina", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$mridiag=="Vasospastic angina" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$mridiag=="Vasospastic angina" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$mridiag=="Vasospastic angina" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$mridiag=="Vasospastic angina" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Other", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$mridiag=="Other" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$mridiag=="Other" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$mridiag=="Other" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$mridiag=="Other" & !is.na(prespec_sat$mridiag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="Post-randomisation diagnosis and treatment satisfaction scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", paste("KW:", p.format(kruskal.test(prespec_sat[,"tsqm_sat_bl"],prespec_sat[,"mridiag"])$p.value)),
                                                   "",
                                                   pfun("saq_ts_bl", "mridiag", prespec_sat)),
                                        end.row(disclaimer=T)
                        )
)
ExportTable.HTML(prespec_tab_552$head, prespec_tab_552$body, horiz.fmt, filename=tables.file, first=F, last=F)

prespec_tab_553 <- list(head=rbindTable(list(Text=paste("<b>Table 5.5.3: Pre-specified analyses", 
                                                        "- treatment satisfaction scores at screening in", 
                                                        "relation to cardiovascular risk factors.</b>"), 
                                             Other=list(colspan=6)),
                                        list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                        "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                        "&Chi;<sup>2</sup>.")),
                                        cbindTable("", "", 
                                                   list(Text="TSQM-9 score", Other=list(colspan=2)), 
                                                   list(Text="SAQ treatment satisfaction score", Other=list(colspan=2))),
                                        cbindTable("", "Subgroup levels", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)")), 
                        body=rbindTable(list(Text="Smoking status"),
                                        cbindTable("", "Smokes every day", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$smoking=="Smokes every day" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$smoking=="Smokes every day" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$smoking=="Smokes every day" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$smoking=="Smokes every day" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Smokes, not every day", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$smoking=="Smokes, not every day" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$smoking=="Smokes, not every day" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$smoking=="Smokes, not every day" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$smoking=="Smokes, not every day" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Ex-smoker", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$smoking=="Ex-smoker" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$smoking=="Ex-smoker" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$smoking=="Ex-smoker" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$smoking=="Ex-smoker" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Never smoked", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$smoking=="Never smoked" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$smoking=="Never smoked" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$smoking=="Never smoked" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$smoking=="Never smoked" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="Smoking status and treatment satisfaction scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", paste("KW:", p.format(kruskal.test(prespec_sat$tsqm_sat_bl ~ prespec_sat$smoking)$p.value)), 
                                                   "", paste("KW:", p.format(kruskal.test(prespec_sat$saq_ts_bl ~ prespec_sat$smoking)$p.value))),
                                        list(Text="BMI category"),
                                        cbindTable("", "Underweight", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$bmi_grp=="Underweight" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$bmi_grp=="Underweight" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$bmi_grp=="Underweight" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$bmi_grp=="Underweight" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Healthy range", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$bmi_grp=="Healthy range" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$bmi_grp=="Healthy range" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$bmi_grp=="Healthy range" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$bmi_grp=="Healthy range" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Overweight", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$bmi_grp=="Overweight" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$bmi_grp=="Overweight" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$bmi_grp=="Overweight" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$bmi_grp=="Overweight" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Obese", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$bmi_grp=="Obese" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$bmi_grp=="Obese" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$bmi_grp=="Obese" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$bmi_grp=="Obese" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Severely obese", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$bmi_grp=="Severely obese" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$bmi_grp=="Severely obese" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$bmi_grp=="Severely obese" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$bmi_grp=="Severely obese" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="BMI category and treatment satisfaction scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", paste("KW:", p.format(kruskal.test(prespec_sat$tsqm_sat_bl ~ prespec_sat$bmi_grp)$p.value)), 
                                                   "", paste("KW:", p.format(kruskal.test(prespec_sat[, "saq_ts_bl"],
                                                                                   prespec_sat[, "bmi_grp"])$p.value))),
                                        list(Text="ASSIGN score category"),
                                        cbindTable("", "Lower risk (score < 10)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$assign_grp=="Lower risk (score < 10)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$assign_grp=="Lower risk (score < 10)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$assign_grp=="Lower risk (score < 10)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$assign_grp=="Lower risk (score < 10)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Higher risk (score &ge; 10)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$assign_grp=="Higher risk (score &ge; 10)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$assign_grp=="Higher risk (score &ge; 10)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$assign_grp=="Higher risk (score &ge; 10)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$assign_grp=="Higher risk (score &ge; 10)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="ASSIGN score category and treatment satisfaction scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", pfun("tsqm_sat_bl", "assign_grp", prespec_sat), 
                                                   "", pfun("saq_ts_bl", "assign_grp", prespec_sat)),
                                        
                                        list(Text="QRISK3 score category"),
                                        cbindTable("", "Low risk (score < 10)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$qr3sc_grp=="Low risk (score < 10)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$qr3sc_grp=="Low risk (score < 10)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$qr3sc_grp=="Low risk (score < 10)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$qr3sc_grp=="Low risk (score < 10)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Moderate risk (score 10 - 20)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$qr3sc_grp=="Moderate risk (score 10 - 20)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$qr3sc_grp=="Moderate risk (score 10 - 20)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$qr3sc_grp=="Moderate risk (score 10 - 20)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$qr3sc_grp=="Moderate risk (score 10 - 20)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "High risk (score > 20)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$qr3sc_grp=="High risk (score > 20)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$qr3sc_grp=="High risk (score > 20)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$qr3sc_grp=="High risk (score > 20)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$qr3sc_grp=="High risk (score > 20)" & !is.na(prespec_sat$clinq_diag)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="QRISK3 score category and treatment satisfaction scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", paste("KW:", p.format(kruskal.test(prespec_sat$tsqm_sat_bl ~ prespec_sat$qr3sc_grp)$p.value)), 
                                                   "", pfun("saq_ts_bl", "qr3sc_grp", prespec_sat)),
                                        end.row(disclaimer=T)
                        )
)
ExportTable.HTML(prespec_tab_553$head, prespec_tab_553$body, horiz.fmt, filename=tables.file, first=F, last=F)

prespec_tab_554 <- list(head=rbindTable(list(Text="<b>Table 5.5.4: Pre-specified analyses - baseline treatment satisfaction scores in relation to PROMs (Seattle Angina Questionnaire at 6 months).</b>"), 
                                        list(Text=paste("Text before p-values indicates the type of test used. AOV:", 
                                                        "analysis of variance; KW: Kruskal-Wallis; F: Fisher; &Chi;:", 
                                                        "&Chi;<sup>2</sup>.")),
                                        cbindTable("", "", 
                                                   list(Text="TSQM-9 satisfaction score", Other=list(colspan=2)), 
                                                   list(Text="SAQ treatment satisfaction score", Other=list(colspan=2))),
                                        cbindTable("", "Subgroup levels", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)", 
                                                   "Nobs (Nmiss)", "Median (Q1, Q3)")), 
                        body=rbindTable(list(Text="SAQ angina frequency score category", Other=list(colspan=6)), 
                                        cbindTable("", "Daily angina (score &le; 30)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp_fu=="Daily angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp_fu=="Daily angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp_fu=="Daily angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp_fu=="Daily angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Weekly angina (score 31 - 60)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp_fu=="Weekly angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp_fu=="Weekly angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp_fu=="Weekly angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp_fu=="Weekly angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Monthly angina (score 61 - 99)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp_fu=="Monthly angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp_fu=="Monthly angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp_fu=="Monthly angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp_fu=="Monthly angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "No angina (score 100)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp_fu=="No angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_af_grp_fu=="No angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp_fu=="No angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_af_grp_fu=="No angina" & !is.na(prespec_sat$saq_af_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="SAQ angina frequency category and treatment satisfaction scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "",
                                                   pfun("tsqm_sat_bl", "saq_af_grp_fu", prespec_sat),
                                                   "",
                                                   pfun("saq_ts_bl", "saq_af_grp_fu", prespec_sat)), 
                                        list(Text="SAQ quality of life score category", Other=list(colspan=6)), 
                                        cbindTable("", "Poor QOL (score < 25)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp_fu=="Poor QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp_fu=="Poor QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp_fu=="Poor QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp_fu=="Poor QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Fair QOL (score 25 - 49)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp_fu=="Fair QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp_fu=="Fair QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp_fu=="Fair QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp_fu=="Fair QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Good QOL 50 - 74", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp_fu=="Good QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp_fu=="Good QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp_fu=="Good QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp_fu=="Good QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Excellent QOL (score &ge; 75)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp_fu=="Excellent QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_ql_grp_fu=="Excellent QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp_fu=="Excellent QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_ql_grp_fu=="Excellent QOL" & !is.na(prespec_sat$saq_ql_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="SAQ quality of life category and treatment satisfaction scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "", 
                                                   pfun("tsqm_sat_bl", "saq_ql_grp_fu", prespec_sat),
                                                   "",
                                                   pfun("saq_ts_bl", "saq_ql_grp_fu", prespec_sat)), 
                                        list(Text="SAQ summary score category", Other=list(colspan=6)), 
                                        cbindTable("", "Poor health (score < 25)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp_fu=="Poor health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp_fu=="Poor health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp_fu=="Poor health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp_fu=="Poor health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Fair health (score < 25)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp_fu=="Fair health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp_fu=="Fair health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp_fu=="Fair health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp_fu=="Fair health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Good health (score < 25)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp_fu=="Good health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp_fu=="Good health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp_fu=="Good health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp_fu=="Good health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        cbindTable("", "Excellent health (score < 25)", 
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp_fu=="Excellent health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$tsqm_sat_bl[prespec_sat$saq_summ_grp_fu=="Excellent health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp_fu=="Excellent health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@N (@MISS)"),
                                                   summary.fun(x=prespec_sat$saq_ts_bl[prespec_sat$saq_summ_grp_fu=="Excellent health" & !is.na(prespec_sat$saq_summ_grp_fu)], 
                                                               summary.text="@MEDIAN (@LQ, @UQ)", ndp=2)
                                        ), 
                                        list(Text="SAQ summary category and treatment satisfaction scores: p-values", Other=list(colspan=6)),
                                        cbindTable("", "", "",
                                                   pfun("tsqm_sat_bl", "saq_summ_grp_fu", prespec_sat),
                                                   "",
                                                   pfun("saq_ts_bl", "saq_summ_grp_fu", prespec_sat)), 
                                        end.row(disclaimer=T)
                        )
)
ExportTable.HTML(prespec_tab_554$head, prespec_tab_554$body, horiz.fmt, filename=tables.file, first=F, last=F)

# 5.6.x: description of symptoms at baseline
summary.table(tabnum="5.6.1",
              tabtext="Pre-specified analyses - symptom log at screening (part 1) frequency and impact.",
              basedata=list(
                list(x=outcomes$ad_angsympoften, row.name="Frequency of angina symptoms",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_angepinum, row.name="Number of angina episodes in the past week",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_lifeimpact1, row.name="Impact of symptoms on day-to-day activity",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_lifeimpact2, row.name="Impact of symptoms on feelings of anxiety",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_lifeimpact3, row.name="Impact of symptoms on feelings of depression",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_lifeimpact4, row.name="Impact of symptoms on walking",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_lifeimpact5, row.name="Impact of symptoms on usual activities",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_lifeimpact6, row.name="Impact of symptoms on relations with other people",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_lifeimpact7, row.name="Impact of symptoms on sleep disturbance",
                     subset=outcomes$visittypeid==1)
              ),
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="5.6.2",
              tabtext="Pre-specified analyses - symptom log at screening (part 2) symptoms.",
              basedata=list(
                list(x=outcomes$ad_sympdesc1, row.name="Pain", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_sympdesc2, row.name="Tightness", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_sympdesc3, row.name="Heaviness", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_sympdesc4, row.name="Burning", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_sympdesc5, row.name="Stabbing", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_sympdesc6, row.name="Crushing", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_sympdesc7, row.name="Difficulty breathing", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_sympdesc8, row.name="Other", x.levels="Yes",
                     subset=outcomes$visittypeid==1)
              ),
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="5.6.3",
              tabtext="Pre-specified analyses - symptom log at screening (part 3) symptom triggers.",
              basedata=list(
                list(x=outcomes$ad_trigsymp1, row.name="Cold", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_trigsymp2, row.name="Walking", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_trigsymp3, row.name="Running", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_trigsymp4, row.name="Stairs", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_trigsymp5, row.name="Hill", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_trigsymp6, row.name="Housework or gardening", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_trigsymp7, row.name="Eating", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_trigsymp8, row.name="Stress or anxiety", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_trigsymp9, row.name="Sleep", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_trigsymp10, row.name="Sex", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_trigsymp11, row.name="Menstrual cycle", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_trigsymp12, row.name="None, spontaneous", x.levels="Yes",
                     subset=outcomes$visittypeid==1)
              ),
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="5.6.4",
              tabtext="Pre-specified analyses - symptom log at screening (part 4) location of symptoms.",
              basedata=list(
                list(x=outcomes$ad_locsymp1, row.name="Chest", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_locsymp2, row.name="Right arm", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_locsymp3, row.name="Left arm", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_locsymp4, row.name="Neck", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_locsymp5, row.name="Jaws", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_locsymp6, row.name="Back", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_locsymp7, row.name="Shoulder", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_locsymp8, row.name="Face", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_locsymp9, row.name="Other", x.levels="Yes",
                     subset=outcomes$visittypeid==1)
              ),
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="5.6.5",
              tabtext="Pre-specified analyses - symptom log at screening (part 5) treatment.",
              basedata=list(
                list(x=outcomes$ad_relieve, row.name="What relieved symptoms",
                     subset=outcomes$visittypeid==1),
                if(any(outcomes$ad_relieve=="GTN spray", na.rm=T)) list(x=outcomes$ad_gtnsymp, row.name="If GTN helped, how long did symptoms persist",
                                                                        subset=outcomes$visittypeid==1&outcomes$ad_relieve=="GTN spray"),
                list(x=outcomes$ad_sevsymp, row.name="Symptom severity",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_howlongsymp, row.name="Symptom duration",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_delayonset, row.name="Delayed onset of symptoms", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_usedgtn, row.name="Number of GTN uses (past week)",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_trthelps, row.name="Feel that treatment helps", x.levels="Yes",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_satisfied, row.name="Satisfied with treatment", x.levels="Yes",
                     subset=outcomes$visittypeid==1)
              ),
              treat=outcomes$trtgrp, out.file=tables.file)

summary.table(tabnum="5.6.6",
              tabtext="Pre-specified analyses - symptom log at screening (part 6) additional symptoms associated with angina.",
              basedata=list(
                list(x=outcomes$ad_addsymp1, row.name="Tiredness",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_addsymp2, row.name="Palpitations",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_addsymp3, row.name="Headache",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_addsymp4, row.name="Nausea",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_addsymp5, row.name="Fearful, sense of doom",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_addsymp6, row.name="Loss of libido",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_addsymp7, row.name="Low mood",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_addsymp8, row.name="Visual symptoms",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_addsymp9, row.name="Cold peripheries, numbness",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_addsymp10, row.name="Sweaty, clammy",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_addsymp11, row.name="Dizzy, lightheaded",
                     subset=outcomes$visittypeid==1),
                list(x=outcomes$ad_addsymp12, row.name="Breathlessness, difficulty breathing",
                     subset=outcomes$visittypeid==1)
              ),
              treat=outcomes$trtgrp, out.file=tables.file)

# 5.7.x: baseline predictors of change in diagnosis
prespec_diagch <- merge(diagnoses[!is.na(diagnoses$diag_changed), c("sno", "diag_changed", "clinq_diag")], 
                        screening[!is.na(screening$randdate), 
                                  c("sno", "age", "sex", "simd_quintile", 
                                    "ethnic_simple", "angina_ccs", "trtgrp")], 
                        by="sno", all.x=T)
prespec_diagch$ethnic_simple2 <- factor(ifelse(prespec_diagch$ethnic_simple=="White", "White", "Other"), levels=c("White", "Other"))
prespec_diagch <- merge(prespec_diagch, 
                        outcomes[outcomes$visittypeid==1, 
                                 c("sno", "esc_bpcat", "any_prevther", "any_angther")])

summary.table(tabnum="5.7.1", treat=prespec_diagch$diag_changed, out.file=tables.file,
              tabtext="Pre-specified analyses - baseline predictors of a change in diagnosis (summaries by change in diagnosis).", 
              basedata=list(
                list(x=prespec_diagch$age, row.name="Age"),
                list(x=prespec_diagch$sex, row.name="Sex"), 
                list(x=prespec_diagch$ethnic_simple2, row.name="Ethnicity"),
                list(x=prespec_diagch$simd_quintile, row.name="SIMD quintile"),
                list(x=prespec_diagch$clinq_diag, row.name="Pre-randomisation diagnosis"), 
                list(x=prespec_diagch$esc_bpcat, row.name="Blood pressure category (ESC 2024 guidelines)"), 
                list(x=prespec_diagch$angina_ccs, row.name="Canadian Cardiovascular Society angina classification"),
                list(x=prespec_diagch$any_prevther, row.name="Any preventative medication", x.levels="Yes"), 
                list(x=prespec_diagch$any_angther, row.name="Any angina medication", x.levels="Yes")
                )
              )
prespec_diagch$clinq_diag <- factor(prespec_diagch$clinq_diag)
prespec_diagch$angina_ccs <- factor(prespec_diagch$angina_ccs)
prespec_diagch$ethnic_simple <- factor(prespec_diagch$ethnic_simple)

prespec_572 <- list(
  head=rbindTable(
    list(Text="<b>Table 5.7.2: Pre-specified analyses - baseline predictors of a change in diagnosis.</b>", 
         Other=list(colspan=3)), 
    list(Text=paste("In each case, a logistic regression model is fitted with the change in diagnosis as the outcome,", 
                    "and the baseline variable and the randomised group as predictors."), 
         Other=list(colspan=3)), 
    cbindTable("Variable", "Categories", "Effect estimate (95% CI), p-value")
    ), 
  body=rbindTable(cbindTable("Age", "", 
                             oth.lm.summ_norm(glm(formula=prespec_diagch$diag_changed ~ prespec_diagch$age + prespec_diagch$trtgrp, 
                                             family=binomial(link="logit")), asTable=F, term=2, trans=function(x)exp(x))), 
                  cbindTable("Sex", paste(levels(prespec_diagch$sex), collapse="<br>"), 
                             paste(c("Reference category", 
                                     oth.lm.summ_norm(glm(formula=prespec_diagch$diag_changed ~ prespec_diagch$sex + prespec_diagch$trtgrp, 
                                             family=binomial(link="logit")), asTable=F, term=2, trans=function(x)exp(x))))), 
                  cbindTable("Ethnicity", paste(levels(prespec_diagch$ethnic_simple2), collapse="<br>"), 
                             paste(c("Reference category", 
                                     oth.lm.summ_norm(glm(formula=prespec_diagch$diag_changed ~ prespec_diagch$ethnic_simple2 + prespec_diagch$trtgrp, 
                                                     family=binomial(link="logit")), asTable=F, term=2, trans=function(x)exp(x))))), 
                  cbindTable("SIMD quintile", paste(levels(prespec_diagch$simd_quintile), collapse="<br>"), 
                             paste(c("Reference category", 
                                     oth.lm.summ_norm(glm(formula=prespec_diagch$diag_changed ~ prespec_diagch$simd_quintile + prespec_diagch$trtgrp, 
                                                     family=binomial(link="logit")), asTable=F, term=2:5, trans=function(x)exp(x))))), 
                  cbindTable("Blood pressure category (ESC 2024 guidelines)", paste(levels(prespec_diagch$esc_bpcat), collapse="<br>"), 
                             paste(c("Reference category", 
                                     oth.lm.summ_norm(glm(formula=prespec_diagch$diag_changed ~ prespec_diagch$esc_bpcat + prespec_diagch$trtgrp, 
                                                     family=binomial(link="logit")), asTable=F, term=2:3, trans=function(x)exp(x))))), 
                  cbindTable("Any preventative medication", paste(levels(prespec_diagch$any_prevther), collapse="<br>"), 
                             paste(c("Reference category", 
                                     oth.lm.summ_norm(glm(formula=prespec_diagch$diag_changed ~ prespec_diagch$any_prevther + prespec_diagch$trtgrp, 
                                                     family=binomial(link="logit")), asTable=F, term=2, trans=function(x)exp(x))))), 
                  cbindTable("Any angina medication", paste(levels(prespec_diagch$any_angther), collapse="<br>"), 
                             paste(c("Reference category", 
                                     oth.lm.summ_norm(glm(formula=prespec_diagch$diag_changed ~ prespec_diagch$any_angther + prespec_diagch$trtgrp, 
                                                     family=binomial(link="logit")), asTable=F, term=2, trans=function(x)exp(x))))), 
                  end.row(disclaimer=T)
                  )
  
)
ExportTable.HTML(prespec_572$head, prespec_572$body, horiz.fmt, filename=tables.file, first=F, last=F)

logistic.diags(fit=glm(formula=prespec_diagch$diag_changed ~ prespec_diagch$age + prespec_diagch$trtgrp, 
                       family=binomial(link="logit")), tabnum="5.7.2.1", diagsfile=diags.file, 
               desc="Change in diagnosis adjusted for age")
logistic.diags(fit=glm(formula=prespec_diagch$diag_changed ~ prespec_diagch$sex + prespec_diagch$trtgrp, 
                       family=binomial(link="logit")), tabnum="5.7.2.2", diagsfile=diags.file, 
               desc="Change in diagnosis adjusted for sex")
logistic.diags(fit=glm(formula=prespec_diagch$diag_changed ~ prespec_diagch$ethnic_simple2 + prespec_diagch$trtgrp, 
                       family=binomial(link="logit")), tabnum="5.7.2.3", diagsfile=diags.file, 
               desc="Change in diagnosis adjusted for ethnicity")
logistic.diags(fit=glm(formula=prespec_diagch$diag_changed ~ prespec_diagch$simd_quintile+ prespec_diagch$trtgrp, 
                       family=binomial(link="logit")), tabnum="5.7.2.4", diagsfile=diags.file, 
               desc="Change in diagnosis adjusted for SIMD quintile")
logistic.diags(fit=glm(formula=prespec_diagch$diag_changed ~ prespec_diagch$esc_bpcat + prespec_diagch$trtgrp, 
                       family=binomial(link="logit")), tabnum="5.7.2.5", diagsfile=diags.file, 
               desc="Change in diagnosis adjusted for blood pressure category")
logistic.diags(fit=glm(formula=prespec_diagch$diag_changed ~ prespec_diagch$any_prevther + prespec_diagch$trtgrp, 
                       family=binomial(link="logit")), tabnum="5.7.2.6", diagsfile=diags.file, 
               desc="Change in diagnosis adjusted for any preventative therapy")
logistic.diags(fit=glm(formula=prespec_diagch$diag_changed ~ prespec_diagch$any_angther + prespec_diagch$trtgrp, 
                       family=binomial(link="logit")), tabnum="5.7.2.7", diagsfile=diags.file, 
               desc="Change in diagnosis adjusted for any angina therapy")
#### 6.X: SUBGROUP ANALYSES ####
# Subgroup analysis on SAQ (summary score) and other PROMs: DASI, bipq, moca, phq4

# subgroups to look at:
# age tertiles
# sex
# simd 1/2, 3-5
# baseline saq summary score
# saq angina frequency
# mri diagnosis
# strglmbf_225
# glmpr_22
# enmpr_241

#### 6.1.X: ANALYSIS OF SAQ SUMMARY SCORE ####
saqsumm_subgrp <- merge(outcomes[outcomes$visittypeid==3, c("sno", "saq_summ_bl", "saq_summ", "saq_summ_ch", "site_simple")], 
                        outcomes[outcomes$visittypeid==4, c("sno", "saq_summ", "saq_summ_ch")], by="sno", 
                        all.x=T, suffixes=c("_6m", "_12m"))
saqsumm_subgrp <- merge(saqsumm_subgrp, 
                        randomised[, c("sno", "trtgrp", "rdesex", "rdedia", "rdepmi", "rdecadr", "rdelvsd", "site_simple")],
                        by="sno", all.x=T)
saqsumm_subgrp <- merge(saqsumm_subgrp, screening[, c("sno", "simd_quintile", "age")], by="sno")
saqsumm_subgrp$simd2 <- factor(saqsumm_subgrp$simd_quintile, levels=levels(saqsumm_subgrp$simd_quintile),
                               labels=c("1-2", "1-2", "3-5", "3-5", "3-5"))
saqsumm_subgrp$age_grp <- factor(ifelse(is.na(saqsumm_subgrp$age), NA, 
                                    ifelse(saqsumm_subgrp$age <= quantile(saqsumm_subgrp$age, probs=0.334, na.rm=T), 1, 
                                           ifelse(saqsumm_subgrp$age > quantile(saqsumm_subgrp$age, probs=0.334, na.rm=T) & saqsumm_subgrp$age <= quantile(saqsumm_subgrp$age, probs=0.667, na.rm=T), 2, 
                                                  ifelse(saqsumm_subgrp$age > quantile(saqsumm_subgrp$age, probs=0.667, na.rm=T), 3, NA)))), 
                             levels=c(1:3), labels=c("T1", "T2", "T3"))

saqsumm_subgrp$mridiag <- diagnoses$mridiag[match(saqsumm_subgrp$sno, diagnoses$sno)]
saqsumm_subgrp$mridiag_mva <- factor(ifelse(is.na(saqsumm_subgrp$mridiag), NA, 
                                            ifelse(saqsumm_subgrp$mridiag=="Microvascular angina", "Yes", "No")), 
                                     levels=c("Yes", "No"))
saqsumm_subgrp$mridiag_ncc <- factor(ifelse(is.na(saqsumm_subgrp$mridiag), NA, 
                                            ifelse(saqsumm_subgrp$mridiag=="Non-cardiac chest pain", "Yes", "No")), 
                                     levels=c("Yes", "No"))
saqsumm_subgrp <- merge(saqsumm_subgrp, 
                        mri[, c("sno", "strglmbf_225", "glmpr_22", "enmpr_241")], by="sno", all.x=T)

# 6.1.X: ANALYSIS OF SAQ SUMMARY SCORE
saqsumm_subgrp <- merge(outcomes[outcomes$visittypeid==3, c("sno", "saq_summ_bl", "saq_summ", "saq_summ_ch")], 
                        outcomes[outcomes$visittypeid==4, c("sno", "saq_summ", "saq_summ_ch")], by="sno", 
                        all.x=T, suffixes=c("_6m", "_12m"))
saqsumm_subgrp <- merge(saqsumm_subgrp, 
                        randomised[, c("sno", "trtgrp", "rdesex", "rdedia", "rdepmi", "rdecadr", "rdelvsd", "site_simple")],
                        by="sno", all.x=T)
saqsumm_subgrp <- merge(saqsumm_subgrp, screening[, c("sno", "simd_quintile", "age")], by="sno")
saqsumm_subgrp$simd2 <- factor(saqsumm_subgrp$simd_quintile, levels=levels(saqsumm_subgrp$simd_quintile),
                               labels=c("1-2", "1-2", "3-5", "3-5", "3-5"))
saqsumm_subgrp$age_grp <- factor(ifelse(is.na(saqsumm_subgrp$age), NA, 
                                        ifelse(saqsumm_subgrp$age <= quantile(saqsumm_subgrp$age, probs=0.334, na.rm=T), 1, 
                                               ifelse(saqsumm_subgrp$age > quantile(saqsumm_subgrp$age, probs=0.334, na.rm=T) & saqsumm_subgrp$age <= quantile(saqsumm_subgrp$age, probs=0.667, na.rm=T), 2, 
                                                      ifelse(saqsumm_subgrp$age > quantile(saqsumm_subgrp$age, probs=0.667, na.rm=T), 3, NA)))), 
                                 levels=c(1:3), labels=c("T1", "T2", "T3"))

saqsumm_subgrp$mridiag <- diagnoses$mridiag[match(saqsumm_subgrp$sno, diagnoses$sno)]
saqsumm_subgrp$mridiag_mva <- factor(ifelse(is.na(saqsumm_subgrp$mridiag), NA, 
                                            ifelse(saqsumm_subgrp$mridiag=="Microvascular angina", "Yes", "No")), 
                                     levels=c("Yes", "No"))
saqsumm_subgrp$mridiag_ncc <- factor(ifelse(is.na(saqsumm_subgrp$mridiag), NA, 
                                            ifelse(saqsumm_subgrp$mridiag=="Non-cardiac chest pain", "Yes", "No")), 
                                     levels=c("Yes", "No"))
saqsumm_subgrp <- merge(saqsumm_subgrp, 
                        mri[, c("sno", "strglmbf_225", "glmpr_22", "enmpr_241")], by="sno", all.x=T)

## 6.1.1.: subgroup analysis of SAQ summary - age tertiles
# SAQ SUMMARY AT 6 MONTHS
# model with no interaction
saq6mo_age <- lm(saq_summ_6m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                   rdelvsd + rdepmi + rdesex + age_grp + site_simple, 
                 data=saqsumm_subgrp[!is.na(saqsumm_subgrp$age_grp),])

# model including interaction term
saq6mo_age_int <- lm(saq_summ_6m ~ I((trtgrp=="Intervention")*(age_grp=="T1")) + 
                       I((trtgrp=="Intervention")*(age_grp=="T2")) + 
                       I((trtgrp=="Intervention")*(age_grp=="T3")) +
                       saq_summ_bl + rdecadr + rdedia +
                       rdelvsd + rdepmi + rdesex + age_grp + site_simple, 
                     data=saqsumm_subgrp[!is.na(saqsumm_subgrp$age_grp),])
# diagnostics for above
fig.set(fig.num="6.1.1.1", fig.path=diags.path)
qqnorm(resid(saq6mo_age_int))
qqline(resid(saq6mo_age_int))
dev.off()

fig.set(fig.num="6.1.1.2", fig.path=diags.path)
plot(predict(saq6mo_age_int), residuals(saq6mo_age_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.1.1"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 6 months (age subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.1.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.1.2"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 6 months (age subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.1.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq6mo_age_int_p <- anova(saq6mo_age, saq6mo_age_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
saq12mo_age <- lm(saq_summ_12m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + age_grp + site_simple, 
                  data=saqsumm_subgrp[!is.na(saqsumm_subgrp$age_grp),])

# model including interaction term
saq12mo_age_int <- lm(saq_summ_12m ~ I((trtgrp=="Intervention")*(age_grp=="T1")) + 
                        I((trtgrp=="Intervention")*(age_grp=="T2")) + 
                        I((trtgrp=="Intervention")*(age_grp=="T3")) +
                        saq_summ_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + age_grp + site_simple, 
                      data=saqsumm_subgrp[!is.na(saqsumm_subgrp$age_grp),])
# diagnostics for above
fig.set(fig.num="6.1.1.3", fig.path=diags.path)
qqnorm(resid(saq12mo_age_int))
qqline(resid(saq12mo_age_int))
dev.off()

fig.set(fig.num="6.1.1.4", fig.path=diags.path)
plot(predict(saq12mo_age_int), residuals(saq12mo_age_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.1.3"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 12 months (age subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.1.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.1.4"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 12 months (age subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.1.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq12mo_age_int_p <- anova(saq12mo_age, saq12mo_age_int)$`Pr(>F)`[2]

subgrp_611 <- list(head=rbindTable(
  list(Text="<b>Table 6.1.1: Primary outcome subgroup analysis - age tertile.<b>"), 
  list(Text=paste("The model for the primary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by age tertiles. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: age tertile", 
             "Change in SAQ summary score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable(paste("Tertile 1:", min(saqsumm_subgrp$age), "-", 
                   quantile(saqsumm_subgrp$age, probs=0.334, na.rm=T)), 
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$age_grp=="T1"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_age_int, term=2, asTable=F)),
  cbindTable(paste("Tertile 2:", quantile(saqsumm_subgrp$age, probs=0.334, na.rm=T) + 1, 
                   "-", quantile(saqsumm_subgrp$age, probs=0.667, na.rm=T)), 
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$age_grp=="T2"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_age_int, term=3, asTable=F)),
  cbindTable(paste("Tertile 3:", quantile(saqsumm_subgrp$age, probs=0.667, na.rm=T) + 1, 
                   "-", max(saqsumm_subgrp$age, na.rm=T)), 
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$age_grp=="T3"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_age_int, term=4, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq6mo_age_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable(paste("Tertile 1:", min(saqsumm_subgrp$age), "-", 
                   quantile(saqsumm_subgrp$age, probs=0.334, na.rm=T)), 
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$age_grp=="T1"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_age_int, term=2, asTable=F)),
  cbindTable(paste("Tertile 2:", quantile(saqsumm_subgrp$age, probs=0.334, na.rm=T) + 1, 
                   "-", quantile(saqsumm_subgrp$age, probs=0.667, na.rm=T)), 
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$age_grp=="T2"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_age_int, term=3, asTable=F)),
  cbindTable(paste("Tertile 3:", quantile(saqsumm_subgrp$age, probs=0.667, na.rm=T) + 1, 
                   "-", max(saqsumm_subgrp$age, na.rm=T)), 
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$age_grp=="T3"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_age_int, term=4, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq12mo_age_int_p)),
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_611$head, subgrp_611$body, horiz.fmt, tables.file, first=F, last=F)

## 6.1.2: subgroup analysis of SAQ summary - sex
# SAQ SUMMARY AT 6 MONTHS
# model with no interaction
saq6mo_sex <- lm(saq_summ_6m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                   rdelvsd + rdepmi + rdesex + site_simple, 
                 data=saqsumm_subgrp)

# model including interaction term
saq6mo_sex_int <- lm(saq_summ_6m ~ I((trtgrp=="Intervention")*(rdesex=="Male")) + 
                       I((trtgrp=="Intervention")*(rdesex=="Female")) +
                       saq_summ_bl + rdecadr + rdedia +
                       rdelvsd + rdepmi + rdesex + site_simple, 
                     data=saqsumm_subgrp)
# diagnostics for above
fig.set(fig.num="6.1.2.1", fig.path=diags.path)
qqnorm(resid(saq6mo_sex_int))
qqline(resid(saq6mo_sex_int))
dev.off()

fig.set(fig.num="6.1.2.2", fig.path=diags.path)
plot(predict(saq6mo_sex_int), residuals(saq6mo_sex_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.2.1"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 6 months (sex subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.2.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.2.2"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 6 months (sex subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.2.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq6mo_sex_int_p <- anova(saq6mo_sex, saq6mo_sex_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
saq12mo_sex <- lm(saq_summ_12m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + site_simple, 
                  data=saqsumm_subgrp[!is.na(saqsumm_subgrp$age_grp),])

# model including interaction term
saq12mo_sex_int <- lm(saq_summ_12m ~ I((trtgrp=="Intervention")*(age_grp=="T1")) + 
                        I((trtgrp=="Intervention")*(age_grp=="T2")) + 
                        I((trtgrp=="Intervention")*(age_grp=="T3")) +
                        saq_summ_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + site_simple, 
                      data=saqsumm_subgrp[!is.na(saqsumm_subgrp$age_grp),])
# diagnostics for above
fig.set(fig.num="6.1.2.3", fig.path=diags.path)
qqnorm(resid(saq12mo_sex_int))
qqline(resid(saq12mo_sex_int))
dev.off()

fig.set(fig.num="6.1.2.4", fig.path=diags.path)
plot(predict(saq12mo_sex_int), residuals(saq12mo_sex_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.2.3"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 12 months (sex subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.2.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.2.4"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 12 months (sex subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.2.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq12mo_sex_int_p <- anova(saq12mo_sex, saq12mo_sex_int)$`Pr(>F)`[2]

subgrp_612 <- list(head=rbindTable(
  list(Text="<b>Table 6.1.2: Primary outcome subgroup analysis - sex.<b>"), 
  list(Text=paste("The model for the primary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by sex. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: age tertile", 
             "Change in SAQ summary score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Male", 
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$rdesex=="Male"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_sex_int, term=2, asTable=F)),
  cbindTable("Female", 
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$rdesex=="Female"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_sex_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq6mo_sex_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Male", 
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$rdesex=="Male"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_sex_int, term=2, asTable=F)),
  cbindTable("Female", 
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$rdesex=="Female"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_sex_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq12mo_sex_int_p)
  ),
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_612$head, subgrp_612$body, horiz.fmt, tables.file, first=F, last=F)

## 6.1.3: subgroup analysis of SAQ summary - SIMD group
# SAQ SUMMARY AT 6 MONTHS
# model with no interaction
saq6mo_simd <- lm(saq_summ_6m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + simd2 + site_simple, 
                  data=saqsumm_subgrp[!is.na(saqsumm_subgrp$simd2),])

# model including interaction term
saq6mo_simd_int <- lm(saq_summ_6m ~ I((trtgrp=="Intervention")*(simd2=="1-2")) + 
                        I((trtgrp=="Intervention")*(simd2=="3-5")) + 
                        saq_summ_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + simd2 + site_simple, 
                      data=saqsumm_subgrp[!is.na(saqsumm_subgrp$simd2),])
# diagnostics for above
fig.set(fig.num="6.1.3.1", fig.path=diags.path)
qqnorm(resid(saq6mo_simd_int))
qqline(resid(saq6mo_simd_int))
dev.off()

fig.set(fig.num="6.1.3.2", fig.path=diags.path)
plot(predict(saq6mo_simd_int), residuals(saq6mo_simd_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.3.1"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 6 months (SIMD subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.3.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.3.2"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 6 months (SIMD subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.3.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq6mo_simd_int_p <- anova(saq6mo_simd, saq6mo_simd_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
saq12mo_simd <- lm(saq_summ_12m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + simd2 + site_simple, 
                   data=saqsumm_subgrp[!is.na(saqsumm_subgrp$simd2),])

# model including interaction term
saq12mo_simd_int <- lm(saq_summ_12m ~ I((trtgrp=="Intervention")*(simd2=="1-2")) + 
                         I((trtgrp=="Intervention")*(simd2=="3-5")) + 
                         saq_summ_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + simd2 + site_simple, 
                       data=saqsumm_subgrp[!is.na(saqsumm_subgrp$simd2),])
# diagnostics for above
fig.set(fig.num="6.1.3.3", fig.path=diags.path)
qqnorm(resid(saq12mo_simd_int))
qqline(resid(saq12mo_simd_int))
dev.off()

fig.set(fig.num="6.1.3.4", fig.path=diags.path)
plot(predict(saq12mo_simd_int), residuals(saq12mo_simd_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.3.3"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 12 months (SIMD subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.3.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.3.4"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 12 months (SIMD subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.3.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq12mo_simd_int_p <- anova(saq12mo_simd, saq12mo_simd_int)$`Pr(>F)`[2]

subgrp_613 <- list(head=rbindTable(
  list(Text="<b>Table 6.1.3: Primary outcome subgroup analysis - SIMD group.<b>"), 
  list(Text=paste("The model for the primary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by SIMD quintiles. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: SIMD group", 
             "Change in SAQ summary score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Quintile 1 or 2",
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$simd2=="1-2"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_simd_int, term=2, asTable=F)),
  cbindTable("Quintile 3, 4, or 5",
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$simd2=="3-5"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_simd_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq6mo_simd_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Quintile 1 or 2",
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$simd2=="1-2"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_simd_int, term=2, asTable=F)),
  cbindTable("Quintile 3, 4, or 5",
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$simd2=="3-5"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_simd_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq12mo_simd_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_613$head, subgrp_613$body, horiz.fmt, tables.file, first=F, last=F)

## 6.1.4: subgroup analysis of SAQ summary - MRi diag of MVA
# SAQ SUMMARY AT 6 MONTHS
# model with no interaction
saq6mo_mva <- lm(saq_summ_6m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                   rdelvsd + rdepmi + rdesex + mridiag_mva + site_simple, 
                 data=saqsumm_subgrp[!is.na(saqsumm_subgrp$mridiag_mva),])

# model including interaction term
saq6mo_mva_int <- lm(saq_summ_6m ~ I((trtgrp=="Intervention")*(mridiag_mva=="Yes")) + 
                       I((trtgrp=="Intervention")*(mridiag_mva=="No")) + 
                       saq_summ_bl + rdecadr + rdedia +
                       rdelvsd + rdepmi + rdesex + mridiag_mva + site_simple, 
                     data=saqsumm_subgrp[!is.na(saqsumm_subgrp$mridiag_mva),])
# diagnostics for above
fig.set(fig.num="6.1.4.1", fig.path=diags.path)
qqnorm(resid(saq6mo_mva_int))
qqline(resid(saq6mo_mva_int))
dev.off()

fig.set(fig.num="6.1.4.2", fig.path=diags.path)
plot(predict(saq6mo_mva_int), residuals(saq6mo_mva_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.4.1"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 6 months (MRI diagnosis of MVA subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.4.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.4.2"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 6 months (MRI diagnosis of MVA subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.4.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq6mo_mva_int_p <- anova(saq6mo_mva, saq6mo_mva_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
saq12mo_mva <- lm(saq_summ_12m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + mridiag_mva + site_simple, 
                  data=saqsumm_subgrp[!is.na(saqsumm_subgrp$mridiag_mva),])

# model including interaction term
saq12mo_mva_int <- lm(saq_summ_12m ~ I((trtgrp=="Intervention")*(mridiag_mva=="Yes")) + 
                        I((trtgrp=="Intervention")*(mridiag_mva=="No")) + 
                        saq_summ_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + mridiag_mva + site_simple, 
                      data=saqsumm_subgrp[!is.na(saqsumm_subgrp$mridiag_mva),])
# diagnostics for above
fig.set(fig.num="6.1.4.3", fig.path=diags.path)
qqnorm(resid(saq12mo_mva_int))
qqline(resid(saq12mo_mva_int))
dev.off()

fig.set(fig.num="6.1.4.4", fig.path=diags.path)
plot(predict(saq12mo_mva_int), residuals(saq12mo_mva_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.4.3"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 12 months (MRI diagnosis of MVA subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.4.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.4.4"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 12 months (MRI diagnosis of MVA subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.4.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq12mo_mva_int_p <- anova(saq12mo_mva, saq12mo_mva_int)$`Pr(>F)`[2]

subgrp_614 <- list(head=rbindTable(
  list(Text="<b>Table 6.1.4: Primary outcome subgroup analysis - MRI diagnosis of microvascular angina.<b>"), 
  list(Text=paste("The model for the primary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by MRI diagnosis. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: MRI diagnosis", 
             "Change in SAQ summary score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Microvascular angina",
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$mridiag_mva=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_mva_int, term=2, asTable=F)),
  cbindTable("Another diagnosis",
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$mridiag_mva=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_mva_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq6mo_mva_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Microvascular angina",
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$mridiag_mva=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_mva_int, term=2, asTable=F)),
  cbindTable("Another diagnosis",
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$mridiag_mva=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_mva_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq12mo_mva_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_614$head, subgrp_614$body, horiz.fmt, tables.file, first=F, last=F)

## 6.1.5: subgroup analysis of SAQ summary - MRi diag of non-cardiac chest pain
# SAQ SUMMARY AT 6 MONTHS
# model with no interaction
saq6mo_ncc <- lm(saq_summ_6m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                   rdelvsd + rdepmi + rdesex + mridiag_ncc + site_simple, 
                 data=saqsumm_subgrp[!is.na(saqsumm_subgrp$mridiag_ncc),])

# model including interaction term
saq6mo_ncc_int <- lm(saq_summ_6m ~ I((trtgrp=="Intervention")*(mridiag_ncc=="Yes")) + 
                       I((trtgrp=="Intervention")*(mridiag_ncc=="No")) + 
                       saq_summ_bl + rdecadr + rdedia +
                       rdelvsd + rdepmi + rdesex + mridiag_ncc + site_simple, 
                     data=saqsumm_subgrp[!is.na(saqsumm_subgrp$mridiag_ncc),])
# diagnostics for above
fig.set(fig.num="6.1.5.1", fig.path=diags.path)
qqnorm(resid(saq6mo_ncc_int))
qqline(resid(saq6mo_ncc_int))
dev.off()

fig.set(fig.num="6.1.5.2", fig.path=diags.path)
plot(predict(saq6mo_ncc_int), residuals(saq6mo_ncc_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.5.1"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 6 months (MRI diagnosis of non-cardiac chest pain subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.5.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.5.2"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 6 months (MRI diagnosis of non-cardiac chest pain subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.5.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq6mo_ncc_int_p <- anova(saq6mo_ncc, saq6mo_ncc_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
saq12mo_ncc <- lm(saq_summ_12m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + mridiag_ncc + site_simple, 
                  data=saqsumm_subgrp[!is.na(saqsumm_subgrp$mridiag_ncc),])

# model including interaction term
saq12mo_ncc_int <- lm(saq_summ_12m ~ I((trtgrp=="Intervention")*(mridiag_ncc=="Yes")) + 
                        I((trtgrp=="Intervention")*(mridiag_ncc=="No")) + 
                        saq_summ_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + mridiag_ncc + site_simple, 
                      data=saqsumm_subgrp[!is.na(saqsumm_subgrp$mridiag_ncc),])
# diagnostics for above
fig.set(fig.num="6.1.5.3", fig.path=diags.path)
qqnorm(resid(saq12mo_ncc_int))
qqline(resid(saq12mo_ncc_int))
dev.off()

fig.set(fig.num="6.1.5.4", fig.path=diags.path)
plot(predict(saq12mo_ncc_int), residuals(saq12mo_ncc_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.5.3"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 12 months (MRI diagnosis of non-cardiac chest pain subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.5.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.5.4"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 12 months (MRI diagnosis of non-cardiac chest pain subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.5.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq12mo_ncc_int_p <- anova(saq12mo_ncc, saq12mo_ncc_int)$`Pr(>F)`[2]

subgrp_615 <- list(head=rbindTable(
  list(Text="<b>Table 6.1.5: Primary outcome subgroup analysis - MRI diagnosis of non-cardiac chest pain.<b>"), 
  list(Text=paste("The model for the primary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by MRI diagnosis. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: MRI diagnosis", 
             "Change in SAQ summary score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Non-cardiac chest pain",
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$mridiag_ncc=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_ncc_int, term=2, asTable=F)),
  cbindTable("Another diagnosis",
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$mridiag_ncc=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_ncc_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq6mo_ncc_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Non-cardiac chest pain",
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$mridiag_ncc=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_ncc_int, term=2, asTable=F)),
  cbindTable("Another diagnosis",
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$mridiag_ncc=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_ncc_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq12mo_ncc_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_615$head, subgrp_615$body, horiz.fmt, tables.file, first=F, last=F)

## 6.1.6: subgroup analysis of SAQ summary - GLOBAL MBF UNDER STRESS
# SAQ SUMMARY AT 6 MONTHS
# model with no interaction
saq6mo_mbf <- lm(saq_summ_6m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                   rdelvsd + rdepmi + rdesex + strglmbf_225 + site_simple, 
                 data=saqsumm_subgrp[!is.na(saqsumm_subgrp$strglmbf_225),])

# model including interaction term
saq6mo_mbf_int <- lm(saq_summ_6m ~ I((trtgrp=="Intervention")*(strglmbf_225=="Yes")) + 
                       I((trtgrp=="Intervention")*(strglmbf_225=="No")) + 
                       saq_summ_bl + rdecadr + rdedia +
                       rdelvsd + rdepmi + rdesex + strglmbf_225 + site_simple, 
                     data=saqsumm_subgrp[!is.na(saqsumm_subgrp$strglmbf_225),])
# diagnostics for above
fig.set(fig.num="6.1.6.1", fig.path=diags.path)
qqnorm(resid(saq6mo_mbf_int))
qqline(resid(saq6mo_mbf_int))
dev.off()

fig.set(fig.num="6.1.6.2", fig.path=diags.path)
plot(predict(saq6mo_mbf_int), residuals(saq6mo_mbf_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.6.1"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 6 months (global MBF under stress subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.6.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.6.2"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 6 months (global MBF under stress subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.6.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq6mo_mbf_int_p <- anova(saq6mo_mbf, saq6mo_mbf_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
saq12mo_mbf <- lm(saq_summ_12m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + strglmbf_225 + site_simple, 
                  data=saqsumm_subgrp[!is.na(saqsumm_subgrp$strglmbf_225),])

# model including interaction term
saq12mo_mbf_int <- lm(saq_summ_12m ~ I((trtgrp=="Intervention")*(strglmbf_225=="Yes")) + 
                        I((trtgrp=="Intervention")*(strglmbf_225=="No")) + 
                        saq_summ_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + strglmbf_225 + site_simple, 
                      data=saqsumm_subgrp[!is.na(saqsumm_subgrp$strglmbf_225),])
# diagnostics for above
fig.set(fig.num="6.1.6.3", fig.path=diags.path)
qqnorm(resid(saq12mo_mbf_int))
qqline(resid(saq12mo_mbf_int))
dev.off()

fig.set(fig.num="6.1.6.4", fig.path=diags.path)
plot(predict(saq12mo_mbf_int), residuals(saq12mo_mbf_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.6.3"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 12 months (global MBF under stress subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.6.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.6.4"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 12 months (global MBF under stress subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.6.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq12mo_mbf_int_p <- anova(saq12mo_mbf, saq12mo_mbf_int)$`Pr(>F)`[2]

subgrp_616 <- list(head=rbindTable(
  list(Text="<b>Table 6.1.6: Primary outcome subgroup analysis - global MBF under stress.<b>"), 
  list(Text=paste("The model for the primary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by global MBF. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: global MBF", 
             "Change in SAQ summary score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("MBF < 2.25",
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$strglmbf_225=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_mbf_int, term=2, asTable=F)),
  cbindTable("MBF &ge; 2.25",
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$strglmbf_225=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_mbf_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq6mo_mbf_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("MBF < 2.25",
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$strglmbf_225=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_mbf_int, term=2, asTable=F)),
  cbindTable("MBF &ge; 2.25",
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$strglmbf_225=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_mbf_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq12mo_mbf_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_616$head, subgrp_616$body, horiz.fmt, tables.file, first=F, last=F)

## 6.1.7: subgroup analysis of SAQ summary - global MPR
# SAQ SUMMARY AT 6 MONTHS
# model with no interaction
saq6mo_mpr <- lm(saq_summ_6m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                   rdelvsd + rdepmi + rdesex + glmpr_22 + site_simple, 
                 data=saqsumm_subgrp[!is.na(saqsumm_subgrp$glmpr_22),])

# model including interaction term
saq6mo_mpr_int <- lm(saq_summ_6m ~ I((trtgrp=="Intervention")*(glmpr_22=="Yes")) + 
                       I((trtgrp=="Intervention")*(glmpr_22=="No")) + 
                       saq_summ_bl + rdecadr + rdedia +
                       rdelvsd + rdepmi + rdesex + glmpr_22 + site_simple, 
                     data=saqsumm_subgrp[!is.na(saqsumm_subgrp$glmpr_22),])
# diagnostics for above
fig.set(fig.num="6.1.7.1", fig.path=diags.path)
qqnorm(resid(saq6mo_mpr_int))
qqline(resid(saq6mo_mpr_int))
dev.off()

fig.set(fig.num="6.1.7.2", fig.path=diags.path)
plot(predict(saq6mo_mpr_int), residuals(saq6mo_mpr_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.7.1"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 6 months (global MPR subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.7.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.7.2"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 6 months (global MPR subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.7.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq6mo_mpr_int_p <- anova(saq6mo_mpr, saq6mo_mpr_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
saq12mo_mpr <- lm(saq_summ_12m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + glmpr_22 + site_simple, 
                  data=saqsumm_subgrp[!is.na(saqsumm_subgrp$glmpr_22),])

# model including interaction term
saq12mo_mpr_int <- lm(saq_summ_12m ~ I((trtgrp=="Intervention")*(glmpr_22=="Yes")) + 
                        I((trtgrp=="Intervention")*(glmpr_22=="No")) + 
                        saq_summ_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + glmpr_22 + site_simple, 
                      data=saqsumm_subgrp[!is.na(saqsumm_subgrp$glmpr_22),])
# diagnostics for above
fig.set(fig.num="6.1.7.3", fig.path=diags.path)
qqnorm(resid(saq12mo_mpr_int))
qqline(resid(saq12mo_mpr_int))
dev.off()

fig.set(fig.num="6.1.7.4", fig.path=diags.path)
plot(predict(saq12mo_mpr_int), residuals(saq12mo_mpr_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.7.3"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 12 months (global MPR subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.7.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.7.4"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 12 months (global MPR subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.7.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq12mo_mpr_int_p <- anova(saq12mo_mpr, saq12mo_mpr_int)$`Pr(>F)`[2]

subgrp_617 <- list(head=rbindTable(
  list(Text="<b>Table 6.1.7: Primary outcome subgroup analysis - global MPR.<b>"), 
  list(Text=paste("The model for the primary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by global MPR. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: global MPR", 
             "Change in SAQ summary score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("MPR < 2.2",
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$glmpr_22=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_mpr_int, term=2, asTable=F)),
  cbindTable("MPR &ge; 2.2",
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$glmpr_22=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_mpr_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq6mo_mpr_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("MPR < 2.2",
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$glmpr_22=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_mpr_int, term=2, asTable=F)),
  cbindTable("MPR &ge; 2.2",
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$glmpr_22=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_mpr_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq12mo_mpr_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_617$head, subgrp_617$body, horiz.fmt, tables.file, first=F, last=F)

## 6.1.8: subgroup analysis of SAQ summary - endocardial MPR
# SAQ SUMMARY AT 6 MONTHS
# model with no interaction
saq6mo_mpr <- lm(saq_summ_6m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                   rdelvsd + rdepmi + rdesex + enmpr_241 + site_simple, 
                 data=saqsumm_subgrp[!is.na(saqsumm_subgrp$enmpr_241),])

# model including interaction term
saq6mo_mpr_int <- lm(saq_summ_6m ~ I((trtgrp=="Intervention")*(enmpr_241=="Yes")) + 
                       I((trtgrp=="Intervention")*(enmpr_241=="No")) + 
                       saq_summ_bl + rdecadr + rdedia +
                       rdelvsd + rdepmi + rdesex + enmpr_241 + site_simple, 
                     data=saqsumm_subgrp[!is.na(saqsumm_subgrp$enmpr_241),])
# diagnostics for above
fig.set(fig.num="6.1.8.1", fig.path=diags.path)
qqnorm(resid(saq6mo_mpr_int))
qqline(resid(saq6mo_mpr_int))
dev.off()

fig.set(fig.num="6.1.8.2", fig.path=diags.path)
plot(predict(saq6mo_mpr_int), residuals(saq6mo_mpr_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.8.1"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 6 months (endocardial MPR subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.8.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.8.2"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 6 months (endocardial MPR subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.8.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq6mo_mpr_int_p <- anova(saq6mo_mpr, saq6mo_mpr_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
saq12mo_mpr <- lm(saq_summ_12m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + enmpr_241 + site_simple, 
                  data=saqsumm_subgrp[!is.na(saqsumm_subgrp$enmpr_241),])

# model including interaction term
saq12mo_mpr_int <- lm(saq_summ_12m ~ I((trtgrp=="Intervention")*(enmpr_241=="Yes")) + 
                        I((trtgrp=="Intervention")*(enmpr_241=="No")) + 
                        saq_summ_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + enmpr_241 + site_simple, 
                      data=saqsumm_subgrp[!is.na(saqsumm_subgrp$enmpr_241),])
# diagnostics for above
fig.set(fig.num="6.1.8.3", fig.path=diags.path)
qqnorm(resid(saq12mo_mpr_int))
qqline(resid(saq12mo_mpr_int))
dev.off()

fig.set(fig.num="6.1.8.4", fig.path=diags.path)
plot(predict(saq12mo_mpr_int), residuals(saq12mo_mpr_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.8.3"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 12 months (endocardial MPR subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.8.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.8.4"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 12 months (endocardial MPR subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.8.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq12mo_mpr_int_p <- anova(saq12mo_mpr, saq12mo_mpr_int)$`Pr(>F)`[2]

subgrp_618 <- list(head=rbindTable(
  list(Text="<b>Table 6.1.8: Primary outcome subgroup analysis - endocardial MPR.<b>"), 
  list(Text=paste("The model for the primary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by endocardial MPR. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: endocardial MPR", 
             "Change in SAQ summary score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("MPR<sub>ENDO</sub> < 2.41",
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$enmpr_241=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_mpr_int, term=2, asTable=F)),
  cbindTable("MPR<sub>ENDO</sub> &ge; 2.41",
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$enmpr_241=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_mpr_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq6mo_mpr_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("MPR<sub>ENDO</sub> < 2.41",
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$enmpr_241=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_mpr_int, term=2, asTable=F)),
  cbindTable("MPR<sub>ENDO</sub> &ge; 2.41",
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$enmpr_241=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_mpr_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq12mo_mpr_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_618$head, subgrp_618$body, horiz.fmt, tables.file, first=F, last=F)

## subgroups defined by change in diagnosis from angio to CMR
saqsumm_subgrp <- merge(outcomes[outcomes$visittypeid==3, c("sno", "saq_summ_bl", "saq_summ", "saq_summ_ch", "site_simple")], 
                        outcomes[outcomes$visittypeid==4, c("sno", "saq_summ", "saq_summ_ch")], by="sno", 
                        all.x=T, suffixes=c("_6m", "_12m"))
saqsumm_subgrp <- merge(saqsumm_subgrp, 
                        randomised[, c("sno", "trtgrp", "rdesex", "rdedia", "rdepmi", "rdecadr", "rdelvsd")],
                        by="sno", all.x=T)
saqsumm_subgrp <- merge(saqsumm_subgrp, screening[, c("sno", "simd_quintile", "age")], by="sno")
saqsumm_subgrp <- merge(saqsumm_subgrp, diagnoses[, c("sno", "diag_changed")], by="sno", all.x=T)

# model with no interaction
saq6mo_diag <- lm(saq_summ_6m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + diag_changed + site_simple, 
                  data=saqsumm_subgrp[!is.na(saqsumm_subgrp$diag_changed),])

# model including interaction term
saq6mo_diag_int <- lm(saq_summ_6m ~ I((trtgrp=="Intervention")*(diag_changed=="Yes")) + 
                        I((trtgrp=="Intervention")*(diag_changed=="No")) + 
                        saq_summ_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + diag_changed + site_simple, 
                      data=saqsumm_subgrp[!is.na(saqsumm_subgrp$diag_changed),])

# diagnostics for above
fig.set(fig.num="6.1.9.1", fig.path=diags.path)
qqnorm(resid(saq6mo_diag_int))
qqline(resid(saq6mo_diag_int))
dev.off()

fig.set(fig.num="6.1.9.2", fig.path=diags.path)
plot(predict(saq6mo_diag_int), residuals(saq6mo_diag_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.9.1"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 6 months (diagnosis change subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.9.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.9.2"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 6 months (diagnosis change subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.9.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq6mo_diag_int_p <- anova(saq6mo_diag, saq6mo_diag_int)$`Pr(>F)`[2]

# model with no interaction
saq12mo_diag <- lm(saq_summ_12m ~ trtgrp + saq_summ_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + diag_changed + site_simple, 
                   data=saqsumm_subgrp[!is.na(saqsumm_subgrp$diag_changed),])

# model including interaction term
saq12mo_diag_int <- lm(saq_summ_12m ~ I((trtgrp=="Intervention")*(diag_changed=="Yes")) + 
                         I((trtgrp=="Intervention")*(diag_changed=="No")) + 
                         saq_summ_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + diag_changed + site_simple, 
                       data=saqsumm_subgrp[!is.na(saqsumm_subgrp$diag_changed),])
# diagnostics for above
fig.set(fig.num="6.1.9.3", fig.path=diags.path)
qqnorm(resid(saq12mo_diag_int))
qqline(resid(saq12mo_diag_int))
dev.off()

fig.set(fig.num="6.1.9.4", fig.path=diags.path)
plot(predict(saq12mo_diag_int), residuals(saq12mo_diag_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.9.3"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 12 months (diagnosis change subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.9.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.9.4"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 12 months (diagnosis change subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.9.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)
# assess interaction effect
saq12mo_diag_int_p <- anova(saq12mo_diag, saq12mo_diag_int)$`Pr(>F)`[2]

# same again but with reduced covariate list (just baseline value and treatment)
# model with no interaction
saq6mo_diag_simple <- lm(saq_summ_6m ~ trtgrp + saq_summ_bl + diag_changed, 
                         data=saqsumm_subgrp[!is.na(saqsumm_subgrp$diag_changed),])

# model including interaction term
saq6mo_diag_int_simple <- lm(saq_summ_6m ~ I((trtgrp=="Intervention")*(diag_changed=="Yes")) + 
                               I((trtgrp=="Intervention")*(diag_changed=="No")) + 
                               saq_summ_bl + diag_changed, 
                             data=saqsumm_subgrp[!is.na(saqsumm_subgrp$diag_changed),])

# diagnostics for above
fig.set(fig.num="6.1.9.5", fig.path=diags.path)
qqnorm(resid(saq6mo_diag_int))
qqline(resid(saq6mo_diag_int))
dev.off()

fig.set(fig.num="6.1.9.6", fig.path=diags.path)
plot(predict(saq6mo_diag_int), residuals(saq6mo_diag_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.9.5"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 6 months (diagnosis change subgroup analysis with reduced covariates)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.9.5", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.9.6"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 6 months (diagnosis change subgroup analysis with reduced covariates):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.9.6", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
saq6mo_diag_int_p_simple <- anova(saq6mo_diag_simple, saq6mo_diag_int_simple)$`Pr(>F)`[2]

# model with no interaction
saq12mo_diag_simple <- lm(saq_summ_12m ~ trtgrp + saq_summ_bl + diag_changed, 
                          data=saqsumm_subgrp[!is.na(saqsumm_subgrp$diag_changed),])

# model including interaction term
saq12mo_diag_int_simple <- lm(saq_summ_12m ~ I((trtgrp=="Intervention")*(diag_changed=="Yes")) + 
                                I((trtgrp=="Intervention")*(diag_changed=="No")) + 
                                saq_summ_bl + diag_changed, 
                              data=saqsumm_subgrp[!is.na(saqsumm_subgrp$diag_changed),])
# diagnostics for above
fig.set(fig.num="6.1.9.7", fig.path=diags.path)
qqnorm(resid(saq12mo_diag_int))
qqline(resid(saq12mo_diag_int))
dev.off()

fig.set(fig.num="6.1.9.8", fig.path=diags.path)
plot(predict(saq12mo_diag_int), residuals(saq12mo_diag_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.9.7"), 
                             tabtext=paste("Normal QQ plot for SAQ summary score at 12 months (diagnosis change subgroup analysis with reduced covariates)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.9.7", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.1.9.8"), 
                             tabtext=paste("Residuals and fitted values plot for SAQ summary score at 12 months (diagnosis change subgroup analysis with reduced covariates):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.1.9.8", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)
# assess interaction effect
saq12mo_diag_int_p_simple <- anova(saq12mo_diag_simple, saq12mo_diag_int_simple)$`Pr(>F)`[2]


# table with results
subgrp_619 <- list(head=rbindTable(
  list(Text="<b>Table 6.1.9: Primary outcome subgroup analysis - change in diagnosis.<b>"), 
  list(Text=paste("The model for the primary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by a change in diagnosis between the angiography and CMR.", 
                  "The interaction p-value assesses if there is an interaction effect.")),
  list(Text=paste("The original model adjusts for adjusted for baseline SAQ summary score,", 
                  "age, sex, diabetes, prior myocardial infarction, coronary artery disease,", 
                  "LV systolic function, and site (lead vs other). The reduced covariate model", 
                  "adjusts for the baseline SAQ summary score only.")),
  cbindTable("", "", "Original Model", "Reduced Covariate Model"),
  cbindTable("Subgroup: change in diagnosis", 
             "Change in SAQ summary score:<br>Median (Q1, Q3)", 
             list(Text="Intervention effect estimate, (95% CI), p-value", Other=list(colspan=2))
  )
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=4)), 
  cbindTable("Diagnosis changed",
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$diag_changed=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_diag_int, term=2, asTable=F), 
             oth.lm.summ(saq6mo_diag_int_simple, term=2, asTable=F)),
  cbindTable("Diagnosis unchanged",
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$diag_changed=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_diag_int, term=3, asTable=F), 
             oth.lm.summ(saq6mo_diag_int_simple, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-values:", Other=list(colspan=2)), 
             p.format(saq6mo_diag_int_p), 
             p.format(saq6mo_diag_int_p_simple)), 
  list(Text="Timepoint: 12 months", Other=list(colspan=4)), 
  cbindTable("Diagnosis changed",
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$diag_changed=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_diag_int, term=2, asTable=F), 
             oth.lm.summ(saq12mo_diag_int_simple, term=2, asTable=F)),
  cbindTable("Diagnosis unchanged",
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$diag_changed=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_diag_int, term=3, asTable=F), 
             oth.lm.summ(saq12mo_diag_int_simple, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq12mo_diag_int_p), 
             p.format(saq12mo_diag_int_p_simple)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_619$head, subgrp_619$body, horiz.fmt, tables.file, first=F, last=F)

#### 6.2.X: SUBGROUP ANALYSIS OF DASI SCORE ####
dasi_subgrp <- merge(outcomes[outcomes$visittypeid==3, c("sno", "saq_summ_bl", "saq_af_bl", "dasi_calc_bl", "dasi_calc", "dasi_calc_ch")], 
                     outcomes[outcomes$visittypeid==4, c("sno", "dasi_calc", "dasi_calc_ch")], by="sno", 
                     all.x=T, suffixes=c("_6m", "_12m"))
dasi_subgrp <- merge(dasi_subgrp, 
                     randomised[, c("sno", "trtgrp", "rdesex", "rdedia", "rdepmi", "rdecadr", "rdelvsd", "site_simple")],
                     by="sno", all.x=T)
dasi_subgrp <- merge(dasi_subgrp, screening[, c("sno", "simd_quintile", "age")], by="sno")
dasi_subgrp$simd2 <- factor(dasi_subgrp$simd_quintile, levels=levels(dasi_subgrp$simd_quintile),
                            labels=c("1-2", "1-2", "3-5", "3-5", "3-5"))
dasi_subgrp$age_grp <- factor(ifelse(is.na(dasi_subgrp$age), NA, 
                                     ifelse(dasi_subgrp$age <= quantile(dasi_subgrp$age, probs=0.334, na.rm=T), 1, 
                                            ifelse(dasi_subgrp$age > quantile(dasi_subgrp$age, probs=0.334, na.rm=T) & dasi_subgrp$age <= quantile(dasi_subgrp$age, probs=0.667, na.rm=T), 2, 
                                                   ifelse(dasi_subgrp$age > quantile(dasi_subgrp$age, probs=0.667, na.rm=T), 3, NA)))), 
                              levels=c(1:3), labels=c("T1", "T2", "T3"))

dasi_subgrp$mridiag <- diagnoses$mridiag[match(dasi_subgrp$sno, diagnoses$sno)]
dasi_subgrp$mridiag_mva <- factor(ifelse(is.na(dasi_subgrp$mridiag), NA, 
                                         ifelse(dasi_subgrp$mridiag=="Microvascular angina", "Yes", "No")), 
                                  levels=c("Yes", "No"))
dasi_subgrp$mridiag_ncc <- factor(ifelse(is.na(dasi_subgrp$mridiag), NA, 
                                         ifelse(dasi_subgrp$mridiag=="Non-cardiac chest pain", "Yes", "No")), 
                                  levels=c("Yes", "No"))
dasi_subgrp <- merge(dasi_subgrp, 
                     mri[, c("sno", "strglmbf_225", "glmpr_22", "enmpr_241")], by="sno", all.x=T)
dasi_subgrp$saq_af_grp <- factor(ifelse(is.na(dasi_subgrp$saq_af_bl), NA, 
                                        ifelse(dasi_subgrp$saq_af_bl <= 30, 1, 
                                               ifelse(dasi_subgrp$saq_af_bl > 30 & dasi_subgrp$saq_af_bl <= 60, 2, 
                                                      ifelse(dasi_subgrp$saq_af_bl > 60 & dasi_subgrp$saq_af_bl <= 99, 3, 
                                                             ifelse(dasi_subgrp$saq_af_bl==100, 4, NA))))), 
                                 levels=c(1:4), labels=c("Daily angina", "Weekly angina", "Monthly angina", "No angina"))

dasi_subgrp$saq_summ_grp <- factor(ifelse(is.na(dasi_subgrp$saq_summ_bl), NA, 
                                          ifelse(dasi_subgrp$saq_summ_bl < 25, 1, 
                                                 ifelse(dasi_subgrp$saq_summ_bl >= 25 & dasi_subgrp$saq_summ_bl < 50, 2, 
                                                        ifelse(dasi_subgrp$saq_summ_bl >= 50 & dasi_subgrp$saq_summ_bl < 75, 3, 
                                                               ifelse(dasi_subgrp$saq_summ_bl >= 75, 4, NA))))), 
                                   levels=c(1:4), labels=c("Poor health", "Fair health", "Good health", "Excellent health"))

## 6.2.1 DASI SCORE, AGE SUBGROUP
dasi6mo_age <- lm(dasi_calc_6m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + age_grp + site_simple, 
                  data=dasi_subgrp[!is.na(dasi_subgrp$age_grp),])

# model including interaction term
dasi6mo_age_int <- lm(dasi_calc_6m ~ I((trtgrp=="Intervention")*(age_grp=="T1")) + 
                        I((trtgrp=="Intervention")*(age_grp=="T2")) + 
                        I((trtgrp=="Intervention")*(age_grp=="T3")) +
                        dasi_calc_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + age_grp + site_simple, 
                      data=dasi_subgrp[!is.na(dasi_subgrp$age_grp),])
# diagnostics for above
fig.set(fig.num="6.2.1.1", fig.path=diags.path)
qqnorm(resid(dasi6mo_age_int))
qqline(resid(dasi6mo_age_int))
dev.off()

fig.set(fig.num="6.2.1.2", fig.path=diags.path)
plot(predict(dasi6mo_age_int), residuals(dasi6mo_age_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.1.1"), 
                             tabtext=paste("Normal QQ plot for DASI score at 6 months (age subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.1.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.1.2"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 6 months (age subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.1.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi6mo_age_int_p <- anova(dasi6mo_age, dasi6mo_age_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
dasi12mo_age <- lm(dasi_calc_12m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + age_grp + site_simple, 
                   data=dasi_subgrp[!is.na(dasi_subgrp$age_grp),])

# model including interaction term
dasi12mo_age_int <- lm(dasi_calc_12m ~ I((trtgrp=="Intervention")*(age_grp=="T1")) + 
                         I((trtgrp=="Intervention")*(age_grp=="T2")) + 
                         I((trtgrp=="Intervention")*(age_grp=="T3")) +
                         dasi_calc_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + age_grp + site_simple, 
                       data=dasi_subgrp[!is.na(dasi_subgrp$age_grp),])
# diagnostics for above
fig.set(fig.num="6.2.1.3", fig.path=diags.path)
qqnorm(resid(dasi12mo_age_int))
qqline(resid(dasi12mo_age_int))
dev.off()

fig.set(fig.num="6.2.1.4", fig.path=diags.path)
plot(predict(dasi12mo_age_int), residuals(dasi12mo_age_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.1.3"), 
                             tabtext=paste("Normal QQ plot for DASI score at 12 months (age subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.1.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.1.4"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 12 months (age subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.1.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi12mo_age_int_p <- anova(dasi12mo_age, dasi12mo_age_int)$`Pr(>F)`[2]

subgrp_621 <- list(head=rbindTable(
  list(Text="<b>Table 6.2.1: Duke Activity Status Index subgroup analysis - age tertile.<b>"), 
  list(Text=paste("The model for the DASI secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by age tertiles. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: age tertile", 
             "Change in DASI score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable(paste("Tertile 1:", min(dasi_subgrp$age), "-", 
                   quantile(dasi_subgrp$age, probs=0.334, na.rm=T)), 
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$age_grp=="T1"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_age_int, term=2, asTable=F)),
  cbindTable(paste("Tertile 2:", quantile(dasi_subgrp$age, probs=0.334, na.rm=T) + 1, 
                   "-", quantile(dasi_subgrp$age, probs=0.667, na.rm=T)), 
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$age_grp=="T2"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_age_int, term=3, asTable=F)),
  cbindTable(paste("Tertile 3:", quantile(dasi_subgrp$age, probs=0.667, na.rm=T) + 1, 
                   "-", max(dasi_subgrp$age, na.rm=T)), 
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$age_grp=="T3"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_age_int, term=4, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi6mo_age_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable(paste("Tertile 1:", min(dasi_subgrp$age), "-", 
                   quantile(dasi_subgrp$age, probs=0.334, na.rm=T)), 
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$age_grp=="T1"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_age_int, term=2, asTable=F)),
  cbindTable(paste("Tertile 2:", quantile(dasi_subgrp$age, probs=0.334, na.rm=T) + 1, 
                   "-", quantile(dasi_subgrp$age, probs=0.667, na.rm=T)), 
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$age_grp=="T2"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_age_int, term=3, asTable=F)),
  cbindTable(paste("Tertile 3:", quantile(dasi_subgrp$age, probs=0.667, na.rm=T) + 1, 
                   "-", max(dasi_subgrp$age, na.rm=T)), 
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$age_grp=="T3"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_age_int, term=4, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi12mo_age_int_p)),
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_621$head, subgrp_621$body, horiz.fmt, tables.file, first=F, last=F)

## 6.2.x: DASI BY SEX SUBGROUP
dasi6mo_sex <- lm(dasi_calc_6m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + site_simple, 
                  data=dasi_subgrp)

# model including interaction term
dasi6mo_sex_int <- lm(dasi_calc_6m ~ I((trtgrp=="Intervention")*(rdesex=="Male")) + 
                        I((trtgrp=="Intervention")*(rdesex=="Female")) + 
                        dasi_calc_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + site_simple,
                      data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.2.1", fig.path=diags.path)
qqnorm(resid(dasi6mo_sex_int))
qqline(resid(dasi6mo_sex_int))
dev.off()

fig.set(fig.num="6.2.2.2", fig.path=diags.path)
plot(predict(dasi6mo_sex_int), residuals(dasi6mo_sex_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.2.1"), 
                             tabtext=paste("Normal QQ plot for DASI score at 6 months (age subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.2.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.2.2"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 6 months (age subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.2.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi6mo_sex_int_p <- anova(dasi6mo_sex, dasi6mo_sex_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
dasi12mo_sex <- lm(dasi_calc_12m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + site_simple, 
                   data=dasi_subgrp)

# model including interaction term
dasi12mo_sex_int <- lm(dasi_calc_12m ~ I((trtgrp=="Intervention")*(rdesex=="Male")) + 
                         I((trtgrp=="Intervention")*(rdesex=="Female")) + 
                         dasi_calc_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + site_simple, 
                       data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.2.3", fig.path=diags.path)
qqnorm(resid(dasi12mo_sex_int))
qqline(resid(dasi12mo_sex_int))
dev.off()

fig.set(fig.num="6.2.2.4", fig.path=diags.path)
plot(predict(dasi12mo_sex_int), residuals(dasi12mo_sex_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.2.3"), 
                             tabtext=paste("Normal QQ plot for DASI score at 12 months (age subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.2.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.2.4"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 12 months (age subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.2.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi12mo_sex_int_p <- anova(dasi12mo_sex, dasi12mo_sex_int)$`Pr(>F)`[2]

subgrp_622 <- list(head=rbindTable(
  list(Text="<b>Table 6.2.2: Duke Activity Status Index subgroup analysis - sex.<b>"), 
  list(Text=paste("The model for the DASI secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by sex. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: sex", 
             "Change in DASI score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Male",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$rdesex=="Male"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_sex_int, term=2, asTable=F)),
  cbindTable("Female",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$rdesex=="Female"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_sex_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi6mo_sex_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Male",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$rdesex=="Male"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_sex_int, term=2, asTable=F)),
  cbindTable("Female",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$rdesex=="Female"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_sex_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi12mo_sex_int_p)
  ),
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_622$head, subgrp_622$body, horiz.fmt, tables.file, first=F, last=F)

## 6.2.3: DASI BY SIMD SUBGROUP
dasi6mo_simd <- lm(dasi_calc_6m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + simd2 + site_simple, 
                   data=dasi_subgrp)

# model including interaction term
dasi6mo_simd_int <- lm(dasi_calc_6m ~ I((trtgrp=="Intervention")*(simd2=="1-2")) + 
                         I((trtgrp=="Intervention")*(simd2=="3-5")) + 
                         dasi_calc_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + simd2 + site_simple,
                       data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.3.1", fig.path=diags.path)
qqnorm(resid(dasi6mo_simd_int))
qqline(resid(dasi6mo_simd_int))
dev.off()

fig.set(fig.num="6.2.3.2", fig.path=diags.path)
plot(predict(dasi6mo_simd_int), residuals(dasi6mo_simd_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.3.1"), 
                             tabtext=paste("Normal QQ plot for DASI score at 6 months (SIMD subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.3.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.3.2"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 6 months (SIMD subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.3.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi6mo_simd_int_p <- anova(dasi6mo_simd, dasi6mo_simd_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
dasi12mo_simd <- lm(dasi_calc_12m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                      rdelvsd + rdepmi + rdesex + simd2 + site_simple, 
                    data=dasi_subgrp)

# model including interaction term
dasi12mo_simd_int <- lm(dasi_calc_12m ~ I((trtgrp=="Intervention")*(simd2=="1-2")) + 
                          I((trtgrp=="Intervention")*(simd2=="3-5")) + 
                          dasi_calc_bl + rdecadr + rdedia +
                          rdelvsd + rdepmi + rdesex + simd2 + site_simple, 
                        data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.3.3", fig.path=diags.path)
qqnorm(resid(dasi12mo_simd_int))
qqline(resid(dasi12mo_simd_int))
dev.off()

fig.set(fig.num="6.2.3.4", fig.path=diags.path)
plot(predict(dasi12mo_simd_int), residuals(dasi12mo_simd_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.3.3"), 
                             tabtext=paste("Normal QQ plot for DASI score at 12 months (SIMD subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.3.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.3.4"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 12 months (SIMD subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.3.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi12mo_simd_int_p <- anova(dasi12mo_simd, dasi12mo_simd_int)$`Pr(>F)`[2]

subgrp_623 <- list(head=rbindTable(
  list(Text="<b>Table 6.2.3: Duke Activity Status Index subgroup analysis - SIMD group.<b>"), 
  list(Text=paste("The model for the DASI secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by SIMD quintile. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: SIMD group", 
             "Change in DASI score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Quintiles 1 and 2",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$simd2=="1-2"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_simd_int, term=2, asTable=F)),
  cbindTable("Quintiles 3, 4, and 5",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$simd2=="3-5"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_simd_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi6mo_simd_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Quintiles 1 and 2",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$simd2=="1-2"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_simd_int, term=2, asTable=F)),
  cbindTable("Quintiles 3, 4, and 5",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$simd2=="3-5"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_simd_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi12mo_simd_int_p)
  ),
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_623$head, subgrp_623$body, horiz.fmt, tables.file, first=F, last=F)

## 6.2.4: DASI BY SAQ SUMMARY SCORE
dasi6mo_saqsumm <- lm(dasi_calc_6m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + saq_summ_grp + site_simple, 
                      data=dasi_subgrp)

# model including interaction term
dasi6mo_saqsumm_int <- lm(dasi_calc_6m ~ I((trtgrp=="Intervention")*(saq_summ_grp=="Poor health")) + 
                            I((trtgrp=="Intervention")*(saq_summ_grp=="Fair health")) + 
                            I((trtgrp=="Intervention")*(saq_summ_grp=="Good health")) + 
                            I((trtgrp=="Intervention")*(saq_summ_grp=="Excellent health")) + 
                            dasi_calc_bl + rdecadr + rdedia +
                            rdelvsd + rdepmi + rdesex + saq_summ_grp + site_simple,
                          data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.4.1", fig.path=diags.path)
qqnorm(resid(dasi6mo_saqsumm_int))
qqline(resid(dasi6mo_saqsumm_int))
dev.off()

fig.set(fig.num="6.2.4.2", fig.path=diags.path)
plot(predict(dasi6mo_saqsumm_int), residuals(dasi6mo_saqsumm_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.4.1"), 
                             tabtext=paste("Normal QQ plot for DASI score at 6 months (SAQ summary subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.4.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.4.2"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 6 months (SAQ summary subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.4.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi6mo_saqsumm_int_p <- anova(dasi6mo_saqsumm, dasi6mo_saqsumm_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
dasi12mo_saqsumm <- lm(dasi_calc_12m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + saq_summ_grp + site_simple, 
                       data=dasi_subgrp)

# model including interaction term
dasi12mo_saqsumm_int <- lm(dasi_calc_12m ~ I((trtgrp=="Intervention")*(saq_summ_grp=="Poor health")) + 
                             I((trtgrp=="Intervention")*(saq_summ_grp=="Fair health")) + 
                             I((trtgrp=="Intervention")*(saq_summ_grp=="Good health")) + 
                             I((trtgrp=="Intervention")*(saq_summ_grp=="Excellent health")) + 
                             dasi_calc_bl + rdecadr + rdedia +
                             rdelvsd + rdepmi + rdesex + saq_summ_grp + site_simple, 
                           data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.4.3", fig.path=diags.path)
qqnorm(resid(dasi12mo_saqsumm_int))
qqline(resid(dasi12mo_saqsumm_int))
dev.off()

fig.set(fig.num="6.2.4.4", fig.path=diags.path)
plot(predict(dasi12mo_saqsumm_int), residuals(dasi12mo_saqsumm_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.4.3"), 
                             tabtext=paste("Normal QQ plot for DASI score at 12 months (SAQ summary subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.4.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.4.4"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 12 months (SAQ summary subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.4.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi12mo_saqsumm_int_p <- anova(dasi12mo_saqsumm, dasi12mo_saqsumm_int)$`Pr(>F)`[2]

subgrp_624 <- list(head=rbindTable(
  list(Text="<b>Table 6.2.4: Duke Activity Status Index subgroup analysis - SAQ summary score.<b>"), 
  list(Text=paste("The model for the DASI secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by baseline SAQ summary score. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: SAQ summary score health status", 
             "Change in DASI score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Poor health (score < 25)",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$saq_summ_grp=="Poor health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_saqsumm_int, term=2, asTable=F)),
  cbindTable("Fair health (score 25 - 49)",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$saq_summ_grp=="Fair health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_saqsumm_int, term=3, asTable=F)),
  cbindTable("Good health (score 50 - 74)",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$saq_summ_grp=="Good health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_saqsumm_int, term=4, asTable=F)),
  cbindTable("Excellent health (score &ge; 75)",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$saq_summ_grp=="Excellent health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_saqsumm_int, term=5, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi6mo_saqsumm_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Poor health (score < 25)",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$saq_summ_grp=="Poor health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_saqsumm_int, term=2, asTable=F)),
  cbindTable("Fair health (score 25 - 49)",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$saq_summ_grp=="Fair health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_saqsumm_int, term=3, asTable=F)),
  cbindTable("Good health (score 50 - 74)",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$saq_summ_grp=="Good health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_saqsumm_int, term=4, asTable=F)),
  cbindTable("Excellent health (score &ge; 75)",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$saq_summ_grp=="Excellent health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_saqsumm_int, term=5, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi12mo_saqsumm_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_624$head, subgrp_624$body, horiz.fmt, tables.file, first=F, last=F)

## 6.2.5: DASI BY SAQ SUMMARY SCORE
dasi6mo_saqaf <- lm(dasi_calc_6m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                      rdelvsd + rdepmi + rdesex + saq_af_grp + site_simple, 
                    data=dasi_subgrp)

# model including interaction term
dasi6mo_saqaf_int <- lm(dasi_calc_6m ~ I((trtgrp=="Intervention")*(saq_af_grp=="Daily angina")) + 
                          I((trtgrp=="Intervention")*(saq_af_grp=="Weekly angina")) + 
                          I((trtgrp=="Intervention")*(saq_af_grp=="Monthly angina")) + 
                          I((trtgrp=="Intervention")*(saq_af_grp=="No angina")) + 
                          dasi_calc_bl + rdecadr + rdedia +
                          rdelvsd + rdepmi + rdesex + saq_af_grp + site_simple,
                        data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.5.1", fig.path=diags.path)
qqnorm(resid(dasi6mo_saqaf_int))
qqline(resid(dasi6mo_saqaf_int))
dev.off()

fig.set(fig.num="6.2.5.2", fig.path=diags.path)
plot(predict(dasi6mo_saqaf_int), residuals(dasi6mo_saqaf_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.5.1"), 
                             tabtext=paste("Normal QQ plot for DASI score at 6 months (SAQ summary subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.5.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.5.2"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 6 months (SAQ summary subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.5.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi6mo_saqaf_int_p <- anova(dasi6mo_saqaf, dasi6mo_saqaf_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
dasi12mo_saqaf <- lm(dasi_calc_12m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                       rdelvsd + rdepmi + rdesex + saq_af_grp + site_simple, 
                     data=dasi_subgrp)

# model including interaction term
dasi12mo_saqaf_int <- lm(dasi_calc_12m ~ I((trtgrp=="Intervention")*(saq_af_grp=="Daily angina")) + 
                           I((trtgrp=="Intervention")*(saq_af_grp=="Weekly angina")) + 
                           I((trtgrp=="Intervention")*(saq_af_grp=="Monthly angina")) + 
                           I((trtgrp=="Intervention")*(saq_af_grp=="No angina")) + 
                           dasi_calc_bl + rdecadr + rdedia +
                           rdelvsd + rdepmi + rdesex + saq_af_grp + site_simple, 
                         data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.5.3", fig.path=diags.path)
qqnorm(resid(dasi12mo_saqaf_int))
qqline(resid(dasi12mo_saqaf_int))
dev.off()

fig.set(fig.num="6.2.5.4", fig.path=diags.path)
plot(predict(dasi12mo_saqaf_int), residuals(dasi12mo_saqaf_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.5.3"), 
                             tabtext=paste("Normal QQ plot for DASI score at 12 months (SAQ summary subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.5.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.5.4"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 12 months (SAQ summary subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.5.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi12mo_saqaf_int_p <- anova(dasi12mo_saqaf, dasi12mo_saqaf_int)$`Pr(>F)`[2]

subgrp_625 <- list(head=rbindTable(
  list(Text="<b>Table 6.2.5: Duke Activity Status Index subgroup analysis - SAQ angina frequency score.<b>"), 
  list(Text=paste("The model for the DASI secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by baseline SAQ angina frequency score. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: SAQ angina frequency", 
             "Change in DASI score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Daily angina (score &le; 30)",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$saq_af_grp=="Daily angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_saqaf_int, term=2, asTable=F)),
  cbindTable("Weekly angina (score 31 - 60)",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$saq_af_grp=="Weekly angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_saqaf_int, term=3, asTable=F)),
  cbindTable("Monthly angina (score 61 - 99)",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$saq_af_grp=="Monthly angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_saqaf_int, term=4, asTable=F)),
  cbindTable("No angina (score 100)",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$saq_af_grp=="No angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_saqaf_int, term=5, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi6mo_saqaf_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Daily angina (score &le; 30)",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$saq_af_grp=="Daily angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_saqaf_int, term=2, asTable=F)),
  cbindTable("Weekly angina (score 31 - 60)",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$saq_af_grp=="Weekly angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_saqaf_int, term=3, asTable=F)),
  cbindTable("Monthly angina (score 61 - 99)",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$saq_af_grp=="Monthly angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_saqaf_int, term=4, asTable=F)),
  cbindTable("No angina (score 100)",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$saq_af_grp=="No angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_saqaf_int, term=5, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi12mo_saqaf_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_625$head, subgrp_625$body, horiz.fmt, tables.file, first=F, last=F)

## 6.2.6: DASI BY MRI MVA
dasi6mo_mva <- lm(dasi_calc_6m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + mridiag_mva + site_simple, 
                  data=dasi_subgrp)

# model including interaction term
dasi6mo_mva_int <- lm(dasi_calc_6m ~ I((trtgrp=="Intervention")*(mridiag_mva=="Yes")) + 
                        I((trtgrp=="Intervention")*(mridiag_mva=="No")) + 
                        dasi_calc_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + mridiag_mva + site_simple,
                      data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.6.1", fig.path=diags.path)
qqnorm(resid(dasi6mo_mva_int))
qqline(resid(dasi6mo_mva_int))
dev.off()

fig.set(fig.num="6.2.6.2", fig.path=diags.path)
plot(predict(dasi6mo_mva_int), residuals(dasi6mo_mva_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.6.1"), 
                             tabtext=paste("Normal QQ plot for DASI score at 6 months (MRI MVA subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.6.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.6.2"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 6 months (MRI MVA subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.6.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi6mo_mva_int_p <- anova(dasi6mo_mva, dasi6mo_mva_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
dasi12mo_mva <- lm(dasi_calc_12m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + mridiag_mva + site_simple, 
                   data=dasi_subgrp)

# model including interaction term
dasi12mo_mva_int <- lm(dasi_calc_12m ~ I((trtgrp=="Intervention")*(mridiag_mva=="Yes")) + 
                         I((trtgrp=="Intervention")*(mridiag_mva=="No")) + 
                         dasi_calc_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + mridiag_mva + site_simple, 
                       data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.6.3", fig.path=diags.path)
qqnorm(resid(dasi12mo_mva_int))
qqline(resid(dasi12mo_mva_int))
dev.off()

fig.set(fig.num="6.2.6.4", fig.path=diags.path)
plot(predict(dasi12mo_mva_int), residuals(dasi12mo_mva_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.6.3"), 
                             tabtext=paste("Normal QQ plot for DASI score at 12 months (MRI MVA subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.6.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.6.4"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 12 months (MRI MVA subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.6.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi12mo_mva_int_p <- anova(dasi12mo_mva, dasi12mo_mva_int)$`Pr(>F)`[2]

subgrp_626 <- list(head=rbindTable(
  list(Text="<b>Table 6.2.6: Duke Activity Status Index subgroup analysis - MRI diagnosis of microvascular angina.<b>"), 
  list(Text=paste("The model for the DASI secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by an MRI diagnosis of MVA. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: MRI diagnosis of MVA", 
             "Change in DASI score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$mridiag_mva=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_mva_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$mridiag_mva=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_mva_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi6mo_mva_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$mridiag_mva=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_mva_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$mridiag_mva=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_mva_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi12mo_mva_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_626$head, subgrp_626$body, horiz.fmt, tables.file, first=F, last=F)

## 6.2.7: DASI BY MRI NON-CARDIAC CHEST PAIN
dasi6mo_ncc <- lm(dasi_calc_6m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + mridiag_ncc + site_simple, 
                  data=dasi_subgrp)

# model including interaction term
dasi6mo_ncc_int <- lm(dasi_calc_6m ~ I((trtgrp=="Intervention")*(mridiag_ncc=="Yes")) + 
                        I((trtgrp=="Intervention")*(mridiag_ncc=="No")) + 
                        dasi_calc_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + mridiag_ncc + site_simple,
                      data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.7.1", fig.path=diags.path)
qqnorm(resid(dasi6mo_ncc_int))
qqline(resid(dasi6mo_ncc_int))
dev.off()

fig.set(fig.num="6.2.7.2", fig.path=diags.path)
plot(predict(dasi6mo_ncc_int), residuals(dasi6mo_ncc_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.7.1"), 
                             tabtext=paste("Normal QQ plot for DASI score at 6 months (MRI non-cardiac chest pain analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.7.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.7.2"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 6 months (MRI non-cardiac chest pain analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.7.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi6mo_ncc_int_p <- anova(dasi6mo_ncc, dasi6mo_ncc_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
dasi12mo_ncc <- lm(dasi_calc_12m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + mridiag_ncc + site_simple, 
                   data=dasi_subgrp)

# model including interaction term
dasi12mo_ncc_int <- lm(dasi_calc_12m ~ I((trtgrp=="Intervention")*(mridiag_ncc=="Yes")) + 
                         I((trtgrp=="Intervention")*(mridiag_ncc=="No")) + 
                         dasi_calc_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + mridiag_ncc + site_simple, 
                       data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.7.3", fig.path=diags.path)
qqnorm(resid(dasi12mo_ncc_int))
qqline(resid(dasi12mo_ncc_int))
dev.off()

fig.set(fig.num="6.2.7.4", fig.path=diags.path)
plot(predict(dasi12mo_ncc_int), residuals(dasi12mo_ncc_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.7.3"), 
                             tabtext=paste("Normal QQ plot for DASI score at 12 months (MRI non-cardiac chest pain analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.7.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.7.4"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 12 months (MRI non-cardiac chest pain analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.7.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi12mo_ncc_int_p <- anova(dasi12mo_ncc, dasi12mo_ncc_int)$`Pr(>F)`[2]

subgrp_627 <- list(head=rbindTable(
  list(Text="<b>Table 6.2.7: Duke Activity Status Index subgroup analysis - MRI diagnosis of non-cardiac chest pain.<b>"), 
  list(Text=paste("The model for the DASI secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by an MRI diagnosis of non-cardiac chest pain. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: MRI diagnosis of non-cardiac chest pain", 
             "Change in DASI score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$mridiag_ncc=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_ncc_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$mridiag_ncc=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_ncc_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi6mo_ncc_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$mridiag_ncc=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_ncc_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$mridiag_ncc=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_ncc_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi12mo_ncc_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_627$head, subgrp_627$body, horiz.fmt, tables.file, first=F, last=F)

## 6.2.8: DASI BY global MBF under stress
dasi6mo_mbf <- lm(dasi_calc_6m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + strglmbf_225 + site_simple, 
                  data=dasi_subgrp)

# model including interaction term
dasi6mo_mbf_int <- lm(dasi_calc_6m ~ I((trtgrp=="Intervention")*(strglmbf_225=="Yes")) + 
                        I((trtgrp=="Intervention")*(strglmbf_225=="No")) + 
                        dasi_calc_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + strglmbf_225 + site_simple,
                      data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.8.1", fig.path=diags.path)
qqnorm(resid(dasi6mo_mbf_int))
qqline(resid(dasi6mo_mbf_int))
dev.off()

fig.set(fig.num="6.2.8.2", fig.path=diags.path)
plot(predict(dasi6mo_mbf_int), residuals(dasi6mo_mbf_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.8.1"), 
                             tabtext=paste("Normal QQ plot for DASI score at 6 months (global MBF under stress analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.8.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.8.2"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 6 months (global MBF under stress analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.8.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi6mo_mbf_int_p <- anova(dasi6mo_mbf, dasi6mo_mbf_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
dasi12mo_mbf <- lm(dasi_calc_12m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + strglmbf_225 + site_simple, 
                   data=dasi_subgrp)

# model including interaction term
dasi12mo_mbf_int <- lm(dasi_calc_12m ~ I((trtgrp=="Intervention")*(strglmbf_225=="Yes")) + 
                         I((trtgrp=="Intervention")*(strglmbf_225=="No")) + 
                         dasi_calc_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + strglmbf_225 + site_simple, 
                       data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.8.3", fig.path=diags.path)
qqnorm(resid(dasi12mo_mbf_int))
qqline(resid(dasi12mo_mbf_int))
dev.off()

fig.set(fig.num="6.2.8.4", fig.path=diags.path)
plot(predict(dasi12mo_mbf_int), residuals(dasi12mo_mbf_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.8.3"), 
                             tabtext=paste("Normal QQ plot for DASI score at 12 months (global MBF under stress analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.8.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.8.4"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 12 months (global MBF under stress analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.8.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi12mo_mbf_int_p <- anova(dasi12mo_mbf, dasi12mo_mbf_int)$`Pr(>F)`[2]

subgrp_628 <- list(head=rbindTable(
  list(Text="<b>Table 6.2.8: Duke Activity Status Index subgroup analysis - global MBF under stress.<b>"), 
  list(Text=paste("The model for the DASI secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by an global MBF under stress. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: global MBF under stress < 2.25", 
             "Change in DASI score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$strglmbf_225=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_mbf_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$strglmbf_225=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_mbf_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi6mo_mbf_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$strglmbf_225=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_mbf_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$strglmbf_225=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_mbf_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi12mo_mbf_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_628$head, subgrp_628$body, horiz.fmt, tables.file, first=F, last=F)

## 6.2.9: DASI BY global MPR
dasi6mo_mpr <- lm(dasi_calc_6m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + glmpr_22 + site_simple, 
                  data=dasi_subgrp)

# model including interaction term
dasi6mo_mpr_int <- lm(dasi_calc_6m ~ I((trtgrp=="Intervention")*(glmpr_22=="Yes")) + 
                        I((trtgrp=="Intervention")*(glmpr_22=="No")) + 
                        dasi_calc_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + glmpr_22 + site_simple,
                      data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.9.1", fig.path=diags.path)
qqnorm(resid(dasi6mo_mpr_int))
qqline(resid(dasi6mo_mpr_int))
dev.off()

fig.set(fig.num="6.2.9.2", fig.path=diags.path)
plot(predict(dasi6mo_mpr_int), residuals(dasi6mo_mpr_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.9.1"), 
                             tabtext=paste("Normal QQ plot for DASI score at 6 months (global MPR subgroup)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.9.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.9.2"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 6 months (global MPR subgroup):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.9.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi6mo_mpr_int_p <- anova(dasi6mo_mpr, dasi6mo_mpr_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
dasi12mo_mpr <- lm(dasi_calc_12m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + glmpr_22 + site_simple, 
                   data=dasi_subgrp)

# model including interaction term
dasi12mo_mpr_int <- lm(dasi_calc_12m ~ I((trtgrp=="Intervention")*(glmpr_22=="Yes")) + 
                         I((trtgrp=="Intervention")*(glmpr_22=="No")) + 
                         dasi_calc_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + glmpr_22 + site_simple, 
                       data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.9.3", fig.path=diags.path)
qqnorm(resid(dasi12mo_mpr_int))
qqline(resid(dasi12mo_mpr_int))
dev.off()

fig.set(fig.num="6.2.9.4", fig.path=diags.path)
plot(predict(dasi12mo_mpr_int), residuals(dasi12mo_mpr_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.9.3"), 
                             tabtext=paste("Normal QQ plot for DASI score at 12 months (global MPR subgroup)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.9.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.9.4"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 12 months (global MPR subgroup):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.9.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi12mo_mpr_int_p <- anova(dasi12mo_mpr, dasi12mo_mpr_int)$`Pr(>F)`[2]

subgrp_629 <- list(head=rbindTable(
  list(Text="<b>Table 6.2.9: Duke Activity Status Index subgroup analysis - global MPR.<b>"), 
  list(Text=paste("The model for the DASI secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by global MPR. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: global MPR < 2.2", 
             "Change in DASI score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$glmpr_22=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_mpr_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$glmpr_22=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_mpr_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi6mo_mpr_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$glmpr_22=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_mpr_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$glmpr_22=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_mpr_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi12mo_mpr_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_629$head, subgrp_629$body, horiz.fmt, tables.file, first=F, last=F)

## 6.2.10: DASI BY endocardial MPR
dasi6mo_enmpr <- lm(dasi_calc_6m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                      rdelvsd + rdepmi + rdesex + enmpr_241 + site_simple, 
                    data=dasi_subgrp)

# model including interaction term
dasi6mo_enmpr_int <- lm(dasi_calc_6m ~ I((trtgrp=="Intervention")*(enmpr_241=="Yes")) + 
                          I((trtgrp=="Intervention")*(enmpr_241=="No")) + 
                          dasi_calc_bl + rdecadr + rdedia +
                          rdelvsd + rdepmi + rdesex + enmpr_241 + site_simple,
                        data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.10.1", fig.path=diags.path)
qqnorm(resid(dasi6mo_enmpr_int))
qqline(resid(dasi6mo_enmpr_int))
dev.off()

fig.set(fig.num="6.2.10.2", fig.path=diags.path)
plot(predict(dasi6mo_enmpr_int), residuals(dasi6mo_enmpr_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.10.1"), 
                             tabtext=paste("Normal QQ plot for DASI score at 6 months (endocardial MPR subgroup)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.10.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.10.2"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 6 months (endocardial MPR subgroup):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.10.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi6mo_enmpr_int_p <- anova(dasi6mo_enmpr, dasi6mo_enmpr_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
dasi12mo_enmpr <- lm(dasi_calc_12m ~ trtgrp + dasi_calc_bl + rdecadr + rdedia +
                       rdelvsd + rdepmi + rdesex + enmpr_241 + site_simple, 
                     data=dasi_subgrp)

# model including interaction term
dasi12mo_enmpr_int <- lm(dasi_calc_12m ~ I((trtgrp=="Intervention")*(enmpr_241=="Yes")) + 
                           I((trtgrp=="Intervention")*(enmpr_241=="No")) + 
                           dasi_calc_bl + rdecadr + rdedia +
                           rdelvsd + rdepmi + rdesex + enmpr_241 + site_simple, 
                         data=dasi_subgrp)
# diagnostics for above
fig.set(fig.num="6.2.10.3", fig.path=diags.path)
qqnorm(resid(dasi12mo_enmpr_int))
qqline(resid(dasi12mo_enmpr_int))
dev.off()

fig.set(fig.num="6.2.10.4", fig.path=diags.path)
plot(predict(dasi12mo_enmpr_int), residuals(dasi12mo_enmpr_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.10.3"), 
                             tabtext=paste("Normal QQ plot for DASI score at 12 months (endocardial MPR subgroup)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.10.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.2.10.4"), 
                             tabtext=paste("Residuals and fitted values plot for DASI score at 12 months (endocardial MPR subgroup):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.2.10.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
dasi12mo_enmpr_int_p <- anova(dasi12mo_enmpr, dasi12mo_enmpr_int)$`Pr(>F)`[2]

subgrp_6210 <- list(head=rbindTable(
  list(Text="<b>Table 6.2.10: Duke Activity Status Index subgroup analysis - endocardial MPR.<b>"), 
  list(Text=paste("The model for the DASI secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by endocardial MPR. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: endocardial MPR < 2.41", 
             "Change in DASI score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$enmpr_241=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_enmpr_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(dasi_subgrp$dasi_calc_ch_6m[dasi_subgrp$enmpr_241=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi6mo_enmpr_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi6mo_enmpr_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$enmpr_241=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_enmpr_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(dasi_subgrp$dasi_calc_ch_12m[dasi_subgrp$enmpr_241=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(dasi12mo_enmpr_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(dasi12mo_enmpr_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_6210$head, subgrp_6210$body, horiz.fmt, tables.file, first=F, last=F)

#### 6.3.X: SUBGROUP ANALYSIS OF BIPQ score ####
bipq_subgrp <- merge(outcomes[outcomes$visittypeid==3, c("sno", "saq_summ_bl", "saq_af_bl", "bipq_tot_bl", "bipq_tot", "bipq_tot_ch")], 
                     outcomes[outcomes$visittypeid==4, c("sno", "bipq_tot", "bipq_tot_ch")], by="sno", 
                     all.x=T, suffixes=c("_6m", "_12m"))
bipq_subgrp <- merge(bipq_subgrp, 
                     randomised[, c("sno", "trtgrp", "rdesex", "rdedia", "rdepmi", "rdecadr", "rdelvsd", "site_simple")],
                     by="sno", all.x=T)
bipq_subgrp <- merge(bipq_subgrp, screening[, c("sno", "simd_quintile", "age")], by="sno")
bipq_subgrp$simd2 <- factor(bipq_subgrp$simd_quintile, levels=levels(bipq_subgrp$simd_quintile),
                            labels=c("1-2", "1-2", "3-5", "3-5", "3-5"))
bipq_subgrp$age_grp <- factor(ifelse(is.na(bipq_subgrp$age), NA, 
                                     ifelse(bipq_subgrp$age <= quantile(bipq_subgrp$age, probs=0.334, na.rm=T), 1, 
                                            ifelse(bipq_subgrp$age > quantile(bipq_subgrp$age, probs=0.334, na.rm=T) & bipq_subgrp$age <= quantile(bipq_subgrp$age, probs=0.667, na.rm=T), 2, 
                                                   ifelse(bipq_subgrp$age > quantile(bipq_subgrp$age, probs=0.667, na.rm=T), 3, NA)))), 
                              levels=c(1:3), labels=c("T1", "T2", "T3"))

bipq_subgrp$mridiag <- diagnoses$mridiag[match(bipq_subgrp$sno, diagnoses$sno)]
bipq_subgrp$mridiag_mva <- factor(ifelse(is.na(bipq_subgrp$mridiag), NA, 
                                         ifelse(bipq_subgrp$mridiag=="Microvascular angina", "Yes", "No")), 
                                  levels=c("Yes", "No"))
bipq_subgrp$mridiag_ncc <- factor(ifelse(is.na(bipq_subgrp$mridiag), NA, 
                                         ifelse(bipq_subgrp$mridiag=="Non-cardiac chest pain", "Yes", "No")), 
                                  levels=c("Yes", "No"))
bipq_subgrp <- merge(bipq_subgrp, 
                     mri[, c("sno", "strglmbf_225", "glmpr_22", "enmpr_241")], by="sno", all.x=T)
bipq_subgrp$saq_af_grp <- factor(ifelse(is.na(bipq_subgrp$saq_af_bl), NA, 
                                        ifelse(bipq_subgrp$saq_af_bl <= 30, 1, 
                                               ifelse(bipq_subgrp$saq_af_bl > 30 & bipq_subgrp$saq_af_bl <= 60, 2, 
                                                      ifelse(bipq_subgrp$saq_af_bl > 60 & bipq_subgrp$saq_af_bl <= 99, 3, 
                                                             ifelse(bipq_subgrp$saq_af_bl==100, 4, NA))))), 
                                 levels=c(1:4), labels=c("Daily angina", "Weekly angina", "Monthly angina", "No angina"))

bipq_subgrp$saq_summ_grp <- factor(ifelse(is.na(bipq_subgrp$saq_summ_bl), NA, 
                                          ifelse(bipq_subgrp$saq_summ_bl < 25, 1, 
                                                 ifelse(bipq_subgrp$saq_summ_bl >= 25 & bipq_subgrp$saq_summ_bl < 50, 2, 
                                                        ifelse(bipq_subgrp$saq_summ_bl >= 50 & bipq_subgrp$saq_summ_bl < 75, 3, 
                                                               ifelse(bipq_subgrp$saq_summ_bl >= 75, 4, NA))))), 
                                   levels=c(1:4), labels=c("Poor health", "Fair health", "Good health", "Excellent health"))

## 6.3.1 BIPQ score, AGE SUBGROUP
bipq6mo_age <- lm(bipq_tot_6m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + age_grp + site_simple, 
                  data=bipq_subgrp[!is.na(bipq_subgrp$age_grp),])

# model including interaction term
bipq6mo_age_int <- lm(bipq_tot_6m ~ I((trtgrp=="Intervention")*(age_grp=="T1")) + 
                        I((trtgrp=="Intervention")*(age_grp=="T2")) + 
                        I((trtgrp=="Intervention")*(age_grp=="T3")) +
                        bipq_tot_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + age_grp + site_simple, 
                      data=bipq_subgrp[!is.na(bipq_subgrp$age_grp),])
# diagnostics for above
fig.set(fig.num="6.3.1.1", fig.path=diags.path)
qqnorm(resid(bipq6mo_age_int))
qqline(resid(bipq6mo_age_int))
dev.off()

fig.set(fig.num="6.3.1.2", fig.path=diags.path)
plot(predict(bipq6mo_age_int), residuals(bipq6mo_age_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.1.1"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 6 months (age subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.1.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.1.2"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 6 months (age subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.1.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq6mo_age_int_p <- anova(bipq6mo_age, bipq6mo_age_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
bipq12mo_age <- lm(bipq_tot_12m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + age_grp + site_simple, 
                   data=bipq_subgrp[!is.na(bipq_subgrp$age_grp),])

# model including interaction term
bipq12mo_age_int <- lm(bipq_tot_12m ~ I((trtgrp=="Intervention")*(age_grp=="T1")) + 
                         I((trtgrp=="Intervention")*(age_grp=="T2")) + 
                         I((trtgrp=="Intervention")*(age_grp=="T3")) +
                         bipq_tot_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + age_grp + site_simple, 
                       data=bipq_subgrp[!is.na(bipq_subgrp$age_grp),])
# diagnostics for above
fig.set(fig.num="6.3.1.3", fig.path=diags.path)
qqnorm(resid(bipq12mo_age_int))
qqline(resid(bipq12mo_age_int))
dev.off()

fig.set(fig.num="6.3.1.4", fig.path=diags.path)
plot(predict(bipq12mo_age_int), residuals(bipq12mo_age_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.1.3"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 12 months (age subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.1.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.1.4"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 12 months (age subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.1.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq12mo_age_int_p <- anova(bipq12mo_age, bipq12mo_age_int)$`Pr(>F)`[2]

subgrp_631 <- list(head=rbindTable(
  list(Text="<b>Table 6.3.1: Brief Illness Perception Questionnaire subgroup analysis - age tertile.<b>"), 
  list(Text=paste("The model for the BIPQ secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by age tertiles. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: age tertile", 
             "Change in BIPQ score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable(paste("Tertile 1:", min(bipq_subgrp$age), "-", 
                   quantile(bipq_subgrp$age, probs=0.334, na.rm=T)), 
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$age_grp=="T1"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_age_int, term=2, asTable=F)),
  cbindTable(paste("Tertile 2:", quantile(bipq_subgrp$age, probs=0.334, na.rm=T) + 1, 
                   "-", quantile(bipq_subgrp$age, probs=0.667, na.rm=T)), 
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$age_grp=="T2"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_age_int, term=3, asTable=F)),
  cbindTable(paste("Tertile 3:", quantile(bipq_subgrp$age, probs=0.667, na.rm=T) + 1, 
                   "-", max(bipq_subgrp$age, na.rm=T)), 
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$age_grp=="T3"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_age_int, term=4, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq6mo_age_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable(paste("Tertile 1:", min(bipq_subgrp$age), "-", 
                   quantile(bipq_subgrp$age, probs=0.334, na.rm=T)), 
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$age_grp=="T1"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_age_int, term=2, asTable=F)),
  cbindTable(paste("Tertile 2:", quantile(bipq_subgrp$age, probs=0.334, na.rm=T) + 1, 
                   "-", quantile(bipq_subgrp$age, probs=0.667, na.rm=T)), 
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$age_grp=="T2"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_age_int, term=3, asTable=F)),
  cbindTable(paste("Tertile 3:", quantile(bipq_subgrp$age, probs=0.667, na.rm=T) + 1, 
                   "-", max(bipq_subgrp$age, na.rm=T)), 
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$age_grp=="T3"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_age_int, term=4, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq12mo_age_int_p)),
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_631$head, subgrp_631$body, horiz.fmt, tables.file, first=F, last=F)

## 6.3.x: bipq BY SEX SUBGROUP
bipq6mo_sex <- lm(bipq_tot_6m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + site_simple, 
                  data=bipq_subgrp)

# model including interaction term
bipq6mo_sex_int <- lm(bipq_tot_6m ~ I((trtgrp=="Intervention")*(rdesex=="Male")) + 
                        I((trtgrp=="Intervention")*(rdesex=="Female")) + 
                        bipq_tot_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + site_simple,
                      data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.2.1", fig.path=diags.path)
qqnorm(resid(bipq6mo_sex_int))
qqline(resid(bipq6mo_sex_int))
dev.off()

fig.set(fig.num="6.3.2.2", fig.path=diags.path)
plot(predict(bipq6mo_sex_int), residuals(bipq6mo_sex_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.2.1"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 6 months (age subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.2.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.2.2"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 6 months (age subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.2.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq6mo_sex_int_p <- anova(bipq6mo_sex, bipq6mo_sex_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
bipq12mo_sex <- lm(bipq_tot_12m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex, 
                   data=bipq_subgrp)

# model including interaction term
bipq12mo_sex_int <- lm(bipq_tot_12m ~ I((trtgrp=="Intervention")*(rdesex=="Male")) + 
                         I((trtgrp=="Intervention")*(rdesex=="Female")) + 
                         bipq_tot_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex, 
                       data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.2.3", fig.path=diags.path)
qqnorm(resid(bipq12mo_sex_int))
qqline(resid(bipq12mo_sex_int))
dev.off()

fig.set(fig.num="6.3.2.4", fig.path=diags.path)
plot(predict(bipq12mo_sex_int), residuals(bipq12mo_sex_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.2.3"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 12 months (age subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.2.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.2.4"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 12 months (age subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.2.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq12mo_sex_int_p <- anova(bipq12mo_sex, bipq12mo_sex_int)$`Pr(>F)`[2]

subgrp_632 <- list(head=rbindTable(
  list(Text="<b>Table 6.3.2: Brief Illness Perception Questionnaire subgroup analysis - sex.<b>"), 
  list(Text=paste("The model for the BIPQ secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by sex. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: sex", 
             "Change in BIPQ score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Male",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$rdesex=="Male"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_sex_int, term=2, asTable=F)),
  cbindTable("Female",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$rdesex=="Female"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_sex_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq6mo_sex_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Male",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$rdesex=="Male"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_sex_int, term=2, asTable=F)),
  cbindTable("Female",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$rdesex=="Female"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_sex_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq12mo_sex_int_p)
  ),
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_632$head, subgrp_632$body, horiz.fmt, tables.file, first=F, last=F)

## 6.3.3: bipq BY SIMD SUBGROUP
bipq6mo_simd <- lm(bipq_tot_6m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + simd2 + site_simple, 
                   data=bipq_subgrp)

# model including interaction term
bipq6mo_simd_int <- lm(bipq_tot_6m ~ I((trtgrp=="Intervention")*(simd2=="1-2")) + 
                         I((trtgrp=="Intervention")*(simd2=="3-5")) + 
                         bipq_tot_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + simd2 + site_simple,
                       data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.3.1", fig.path=diags.path)
qqnorm(resid(bipq6mo_simd_int))
qqline(resid(bipq6mo_simd_int))
dev.off()

fig.set(fig.num="6.3.3.2", fig.path=diags.path)
plot(predict(bipq6mo_simd_int), residuals(bipq6mo_simd_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.3.1"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 6 months (SIMD subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.3.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.3.2"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 6 months (SIMD subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.3.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq6mo_simd_int_p <- anova(bipq6mo_simd, bipq6mo_simd_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
bipq12mo_simd <- lm(bipq_tot_12m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                      rdelvsd + rdepmi + rdesex + simd2 + site_simple, 
                    data=bipq_subgrp)

# model including interaction term
bipq12mo_simd_int <- lm(bipq_tot_12m ~ I((trtgrp=="Intervention")*(simd2=="1-2")) + 
                          I((trtgrp=="Intervention")*(simd2=="3-5")) + 
                          bipq_tot_bl + rdecadr + rdedia +
                          rdelvsd + rdepmi + rdesex + simd2 + site_simple, 
                        data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.3.3", fig.path=diags.path)
qqnorm(resid(bipq12mo_simd_int))
qqline(resid(bipq12mo_simd_int))
dev.off()

fig.set(fig.num="6.3.3.4", fig.path=diags.path)
plot(predict(bipq12mo_simd_int), residuals(bipq12mo_simd_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.3.3"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 12 months (SIMD subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.3.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.3.4"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 12 months (SIMD subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.3.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq12mo_simd_int_p <- anova(bipq12mo_simd, bipq12mo_simd_int)$`Pr(>F)`[2]

subgrp_633 <- list(head=rbindTable(
  list(Text="<b>Table 6.3.3: Brief Illness Perception Questionnaire subgroup analysis - SIMD group.<b>"), 
  list(Text=paste("The model for the BIPQ secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by SIMD quintile. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: SIMD group", 
             "Change in BIPQ score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Quintiles 1 and 2",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$simd2=="1-2"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_simd_int, term=2, asTable=F)),
  cbindTable("Quintiles 3, 4, and 5",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$simd2=="3-5"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_simd_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq6mo_simd_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Quintiles 1 and 2",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$simd2=="1-2"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_simd_int, term=2, asTable=F)),
  cbindTable("Quintiles 3, 4, and 5",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$simd2=="3-5"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_simd_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq12mo_simd_int_p)
  ),
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_633$head, subgrp_633$body, horiz.fmt, tables.file, first=F, last=F)

## 6.3.4: bipq BY SAQ SUMMARY SCORE
bipq6mo_saqsumm <- lm(bipq_tot_6m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + saq_summ_grp + site_simple, 
                      data=bipq_subgrp)

# model including interaction term
bipq6mo_saqsumm_int <- lm(bipq_tot_6m ~ I((trtgrp=="Intervention")*(saq_summ_grp=="Poor health")) + 
                            I((trtgrp=="Intervention")*(saq_summ_grp=="Fair health")) + 
                            I((trtgrp=="Intervention")*(saq_summ_grp=="Good health")) + 
                            I((trtgrp=="Intervention")*(saq_summ_grp=="Excellent health")) + 
                            bipq_tot_bl + rdecadr + rdedia +
                            rdelvsd + rdepmi + rdesex + saq_summ_grp + site_simple,
                          data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.4.1", fig.path=diags.path)
qqnorm(resid(bipq6mo_saqsumm_int))
qqline(resid(bipq6mo_saqsumm_int))
dev.off()

fig.set(fig.num="6.3.4.2", fig.path=diags.path)
plot(predict(bipq6mo_saqsumm_int), residuals(bipq6mo_saqsumm_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.4.1"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 6 months (SAQ summary subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.4.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.4.2"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 6 months (SAQ summary subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.4.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq6mo_saqsumm_int_p <- anova(bipq6mo_saqsumm, bipq6mo_saqsumm_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
bipq12mo_saqsumm <- lm(bipq_tot_12m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + saq_summ_grp + site_simple, 
                       data=bipq_subgrp)

# model including interaction term
bipq12mo_saqsumm_int <- lm(bipq_tot_12m ~ I((trtgrp=="Intervention")*(saq_summ_grp=="Poor health")) + 
                             I((trtgrp=="Intervention")*(saq_summ_grp=="Fair health")) + 
                             I((trtgrp=="Intervention")*(saq_summ_grp=="Good health")) + 
                             I((trtgrp=="Intervention")*(saq_summ_grp=="Excellent health")) + 
                             bipq_tot_bl + rdecadr + rdedia +
                             rdelvsd + rdepmi + rdesex + saq_summ_grp + site_simple, 
                           data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.4.3", fig.path=diags.path)
qqnorm(resid(bipq12mo_saqsumm_int))
qqline(resid(bipq12mo_saqsumm_int))
dev.off()

fig.set(fig.num="6.3.4.4", fig.path=diags.path)
plot(predict(bipq12mo_saqsumm_int), residuals(bipq12mo_saqsumm_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.4.3"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 12 months (SAQ summary subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.4.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.4.4"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 12 months (SAQ summary subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.4.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq12mo_saqsumm_int_p <- anova(bipq12mo_saqsumm, bipq12mo_saqsumm_int)$`Pr(>F)`[2]

subgrp_634 <- list(head=rbindTable(
  list(Text="<b>Table 6.3.4: Brief Illness Perception Questionnaire subgroup analysis - SAQ summary score.<b>"), 
  list(Text=paste("The model for the BIPQ secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by baseline SAQ summary score. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: SAQ summary score health status", 
             "Change in BIPQ score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Poor health (score < 25)",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$saq_summ_grp=="Poor health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_saqsumm_int, term=2, asTable=F)),
  cbindTable("Fair health (score 25 - 49)",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$saq_summ_grp=="Fair health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_saqsumm_int, term=3, asTable=F)),
  cbindTable("Good health (score 50 - 74)",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$saq_summ_grp=="Good health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_saqsumm_int, term=4, asTable=F)),
  cbindTable("Excellent health (score &ge; 75)",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$saq_summ_grp=="Excellent health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_saqsumm_int, term=5, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq6mo_saqsumm_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Poor health (score < 25)",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$saq_summ_grp=="Poor health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_saqsumm_int, term=2, asTable=F)),
  cbindTable("Fair health (score 25 - 49)",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$saq_summ_grp=="Fair health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_saqsumm_int, term=3, asTable=F)),
  cbindTable("Good health (score 50 - 74)",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$saq_summ_grp=="Good health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_saqsumm_int, term=4, asTable=F)),
  cbindTable("Excellent health (score &ge; 75)",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$saq_summ_grp=="Excellent health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_saqsumm_int, term=5, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq12mo_saqsumm_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_634$head, subgrp_634$body, horiz.fmt, tables.file, first=F, last=F)

## 6.3.5: bipq BY SAQ SUMMARY SCORE
bipq6mo_saqaf <- lm(bipq_tot_6m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                      rdelvsd + rdepmi + rdesex + saq_af_grp + site_simple, 
                    data=bipq_subgrp)

# model including interaction term
bipq6mo_saqaf_int <- lm(bipq_tot_6m ~ I((trtgrp=="Intervention")*(saq_af_grp=="Daily angina")) + 
                          I((trtgrp=="Intervention")*(saq_af_grp=="Weekly angina")) + 
                          I((trtgrp=="Intervention")*(saq_af_grp=="Monthly angina")) + 
                          I((trtgrp=="Intervention")*(saq_af_grp=="No angina")) + 
                          bipq_tot_bl + rdecadr + rdedia +
                          rdelvsd + rdepmi + rdesex + saq_af_grp + site_simple,
                        data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.5.1", fig.path=diags.path)
qqnorm(resid(bipq6mo_saqaf_int))
qqline(resid(bipq6mo_saqaf_int))
dev.off()

fig.set(fig.num="6.3.5.2", fig.path=diags.path)
plot(predict(bipq6mo_saqaf_int), residuals(bipq6mo_saqaf_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.5.1"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 6 months (SAQ summary subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.5.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.5.2"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 6 months (SAQ summary subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.5.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq6mo_saqaf_int_p <- anova(bipq6mo_saqaf, bipq6mo_saqaf_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
bipq12mo_saqaf <- lm(bipq_tot_12m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                       rdelvsd + rdepmi + rdesex + saq_af_grp + site_simple, 
                     data=bipq_subgrp)

# model including interaction term
bipq12mo_saqaf_int <- lm(bipq_tot_12m ~ I((trtgrp=="Intervention")*(saq_af_grp=="Daily angina")) + 
                           I((trtgrp=="Intervention")*(saq_af_grp=="Weekly angina")) + 
                           I((trtgrp=="Intervention")*(saq_af_grp=="Monthly angina")) + 
                           I((trtgrp=="Intervention")*(saq_af_grp=="No angina")) + 
                           bipq_tot_bl + rdecadr + rdedia +
                           rdelvsd + rdepmi + rdesex + saq_af_grp + site_simple, 
                         data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.5.3", fig.path=diags.path)
qqnorm(resid(bipq12mo_saqaf_int))
qqline(resid(bipq12mo_saqaf_int))
dev.off()

fig.set(fig.num="6.3.5.4", fig.path=diags.path)
plot(predict(bipq12mo_saqaf_int), residuals(bipq12mo_saqaf_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.5.3"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 12 months (SAQ summary subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.5.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.5.4"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 12 months (SAQ summary subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.5.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq12mo_saqaf_int_p <- anova(bipq12mo_saqaf, bipq12mo_saqaf_int)$`Pr(>F)`[2]

subgrp_635 <- list(head=rbindTable(
  list(Text="<b>Table 6.3.5: Brief Illness Perception Questionnaire subgroup analysis - SAQ angina frequency score.<b>"), 
  list(Text=paste("The model for the BIPQ secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by baseline SAQ angina frequency score. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: SAQ angina frequency", 
             "Change in BIPQ score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Daily angina (score &le; 30)",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$saq_af_grp=="Daily angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_saqaf_int, term=2, asTable=F)),
  cbindTable("Weekly angina (score 31 - 60)",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$saq_af_grp=="Weekly angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_saqaf_int, term=3, asTable=F)),
  cbindTable("Monthly angina (score 61 - 99)",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$saq_af_grp=="Monthly angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_saqaf_int, term=4, asTable=F)),
  cbindTable("No angina (score 100)",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$saq_af_grp=="No angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_saqaf_int, term=5, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq6mo_saqaf_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Daily angina (score &le; 30)",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$saq_af_grp=="Daily angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_saqaf_int, term=2, asTable=F)),
  cbindTable("Weekly angina (score 31 - 60)",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$saq_af_grp=="Weekly angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_saqaf_int, term=3, asTable=F)),
  cbindTable("Monthly angina (score 61 - 99)",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$saq_af_grp=="Monthly angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_saqaf_int, term=4, asTable=F)),
  cbindTable("No angina (score 100)",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$saq_af_grp=="No angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_saqaf_int, term=5, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq12mo_saqaf_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_635$head, subgrp_635$body, horiz.fmt, tables.file, first=F, last=F)

## 6.3.6: bipq BY MRI MVA
bipq6mo_mva <- lm(bipq_tot_6m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + mridiag_mva + site_simple, 
                  data=bipq_subgrp)

# model including interaction term
bipq6mo_mva_int <- lm(bipq_tot_6m ~ I((trtgrp=="Intervention")*(mridiag_mva=="Yes")) + 
                        I((trtgrp=="Intervention")*(mridiag_mva=="No")) + 
                        bipq_tot_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + mridiag_mva + site_simple,
                      data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.6.1", fig.path=diags.path)
qqnorm(resid(bipq6mo_mva_int))
qqline(resid(bipq6mo_mva_int))
dev.off()

fig.set(fig.num="6.3.6.2", fig.path=diags.path)
plot(predict(bipq6mo_mva_int), residuals(bipq6mo_mva_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.6.1"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 6 months (MRI MVA subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.6.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.6.2"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 6 months (MRI MVA subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.6.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq6mo_mva_int_p <- anova(bipq6mo_mva, bipq6mo_mva_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
bipq12mo_mva <- lm(bipq_tot_12m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + mridiag_mva + site_simple, 
                   data=bipq_subgrp)

# model including interaction term
bipq12mo_mva_int <- lm(bipq_tot_12m ~ I((trtgrp=="Intervention")*(mridiag_mva=="Yes")) + 
                         I((trtgrp=="Intervention")*(mridiag_mva=="No")) + 
                         bipq_tot_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + mridiag_mva + site_simple, 
                       data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.6.3", fig.path=diags.path)
qqnorm(resid(bipq12mo_mva_int))
qqline(resid(bipq12mo_mva_int))
dev.off()

fig.set(fig.num="6.3.6.4", fig.path=diags.path)
plot(predict(bipq12mo_mva_int), residuals(bipq12mo_mva_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.6.3"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 12 months (MRI MVA subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.6.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.6.4"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 12 months (MRI MVA subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.6.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq12mo_mva_int_p <- anova(bipq12mo_mva, bipq12mo_mva_int)$`Pr(>F)`[2]

subgrp_636 <- list(head=rbindTable(
  list(Text="<b>Table 6.3.6: Brief Illness Perception Questionnaire subgroup analysis - MRI diagnosis of microvascular angina.<b>"), 
  list(Text=paste("The model for the BIPQ secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by an MRI diagnosis of MVA. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: MRI diagnosis of MVA", 
             "Change in BIPQ score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$mridiag_mva=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_mva_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$mridiag_mva=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_mva_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq6mo_mva_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$mridiag_mva=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_mva_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$mridiag_mva=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_mva_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq12mo_mva_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_636$head, subgrp_636$body, horiz.fmt, tables.file, first=F, last=F)

## 6.3.7: bipq BY MRI NON-CARDIAC CHEST PAIN
bipq6mo_ncc <- lm(bipq_tot_6m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + mridiag_ncc + site_simple, 
                  data=bipq_subgrp)

# model including interaction term
bipq6mo_ncc_int <- lm(bipq_tot_6m ~ I((trtgrp=="Intervention")*(mridiag_ncc=="Yes")) + 
                        I((trtgrp=="Intervention")*(mridiag_ncc=="No")) + 
                        bipq_tot_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + mridiag_ncc + site_simple,
                      data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.7.1", fig.path=diags.path)
qqnorm(resid(bipq6mo_ncc_int))
qqline(resid(bipq6mo_ncc_int))
dev.off()

fig.set(fig.num="6.3.7.2", fig.path=diags.path)
plot(predict(bipq6mo_ncc_int), residuals(bipq6mo_ncc_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.7.1"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 6 months (MRI non-cardiac chest pain analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.7.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.7.2"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 6 months (MRI non-cardiac chest pain analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.7.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq6mo_ncc_int_p <- anova(bipq6mo_ncc, bipq6mo_ncc_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
bipq12mo_ncc <- lm(bipq_tot_12m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + mridiag_ncc + site_simple, 
                   data=bipq_subgrp)

# model including interaction term
bipq12mo_ncc_int <- lm(bipq_tot_12m ~ I((trtgrp=="Intervention")*(mridiag_ncc=="Yes")) + 
                         I((trtgrp=="Intervention")*(mridiag_ncc=="No")) + 
                         bipq_tot_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + mridiag_ncc + site_simple, 
                       data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.7.3", fig.path=diags.path)
qqnorm(resid(bipq12mo_ncc_int))
qqline(resid(bipq12mo_ncc_int))
dev.off()

fig.set(fig.num="6.3.7.4", fig.path=diags.path)
plot(predict(bipq12mo_ncc_int), residuals(bipq12mo_ncc_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.7.3"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 12 months (MRI non-cardiac chest pain analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.7.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.7.4"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 12 months (MRI non-cardiac chest pain analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.7.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq12mo_ncc_int_p <- anova(bipq12mo_ncc, bipq12mo_ncc_int)$`Pr(>F)`[2]

subgrp_637 <- list(head=rbindTable(
  list(Text="<b>Table 6.3.7: Brief Illness Perception Questionnaire subgroup analysis - MRI diagnosis of non-cardiac chest pain.<b>"), 
  list(Text=paste("The model for the BIPQ secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by an MRI diagnosis of non-cardiac chest pain. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: MRI diagnosis of non-cardiac chest pain", 
             "Change in BIPQ score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$mridiag_ncc=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_ncc_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$mridiag_ncc=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_ncc_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq6mo_ncc_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$mridiag_ncc=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_ncc_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$mridiag_ncc=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_ncc_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq12mo_ncc_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_637$head, subgrp_637$body, horiz.fmt, tables.file, first=F, last=F)

## 6.3.8: bipq BY global MBF under stress
bipq6mo_mbf <- lm(bipq_tot_6m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + strglmbf_225 + site_simple, 
                  data=bipq_subgrp)

# model including interaction term
bipq6mo_mbf_int <- lm(bipq_tot_6m ~ I((trtgrp=="Intervention")*(strglmbf_225=="Yes")) + 
                        I((trtgrp=="Intervention")*(strglmbf_225=="No")) + 
                        bipq_tot_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + strglmbf_225 + site_simple,
                      data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.8.1", fig.path=diags.path)
qqnorm(resid(bipq6mo_mbf_int))
qqline(resid(bipq6mo_mbf_int))
dev.off()

fig.set(fig.num="6.3.8.2", fig.path=diags.path)
plot(predict(bipq6mo_mbf_int), residuals(bipq6mo_mbf_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.8.1"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 6 months (global MBF under stress analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.8.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.8.2"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 6 months (global MBF under stress analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.8.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq6mo_mbf_int_p <- anova(bipq6mo_mbf, bipq6mo_mbf_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
bipq12mo_mbf <- lm(bipq_tot_12m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + strglmbf_225 + site_simple, 
                   data=bipq_subgrp)

# model including interaction term
bipq12mo_mbf_int <- lm(bipq_tot_12m ~ I((trtgrp=="Intervention")*(strglmbf_225=="Yes")) + 
                         I((trtgrp=="Intervention")*(strglmbf_225=="No")) + 
                         bipq_tot_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + strglmbf_225 + site_simple, 
                       data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.8.3", fig.path=diags.path)
qqnorm(resid(bipq12mo_mbf_int))
qqline(resid(bipq12mo_mbf_int))
dev.off()

fig.set(fig.num="6.3.8.4", fig.path=diags.path)
plot(predict(bipq12mo_mbf_int), residuals(bipq12mo_mbf_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.8.3"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 12 months (global MBF under stress analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.8.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.8.4"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 12 months (global MBF under stress analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.8.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq12mo_mbf_int_p <- anova(bipq12mo_mbf, bipq12mo_mbf_int)$`Pr(>F)`[2]

subgrp_638 <- list(head=rbindTable(
  list(Text="<b>Table 6.3.8: Brief Illness Perception Questionnaire subgroup analysis - global MBF under stress.<b>"), 
  list(Text=paste("The model for the BIPQ secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by an global MBF under stress. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: global MBF under stress < 2.25", 
             "Change in BIPQ score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$strglmbf_225=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_mbf_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$strglmbf_225=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_mbf_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq6mo_mbf_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$strglmbf_225=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_mbf_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$strglmbf_225=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_mbf_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq12mo_mbf_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_638$head, subgrp_638$body, horiz.fmt, tables.file, first=F, last=F)

## 6.3.9: bipq BY global MPR
bipq6mo_mpr <- lm(bipq_tot_6m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + glmpr_22 + site_simple, 
                  data=bipq_subgrp)

# model including interaction term
bipq6mo_mpr_int <- lm(bipq_tot_6m ~ I((trtgrp=="Intervention")*(glmpr_22=="Yes")) + 
                        I((trtgrp=="Intervention")*(glmpr_22=="No")) + 
                        bipq_tot_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + glmpr_22 + site_simple,
                      data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.9.1", fig.path=diags.path)
qqnorm(resid(bipq6mo_mpr_int))
qqline(resid(bipq6mo_mpr_int))
dev.off()

fig.set(fig.num="6.3.9.2", fig.path=diags.path)
plot(predict(bipq6mo_mpr_int), residuals(bipq6mo_mpr_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.9.1"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 6 months (global MPR subgroup)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.9.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.9.2"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 6 months (global MPR subgroup):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.9.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq6mo_mpr_int_p <- anova(bipq6mo_mpr, bipq6mo_mpr_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
bipq12mo_mpr <- lm(bipq_tot_12m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + glmpr_22 + site_simple, 
                   data=bipq_subgrp)

# model including interaction term
bipq12mo_mpr_int <- lm(bipq_tot_12m ~ I((trtgrp=="Intervention")*(glmpr_22=="Yes")) + 
                         I((trtgrp=="Intervention")*(glmpr_22=="No")) + 
                         bipq_tot_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + glmpr_22 + site_simple, 
                       data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.9.3", fig.path=diags.path)
qqnorm(resid(bipq12mo_mpr_int))
qqline(resid(bipq12mo_mpr_int))
dev.off()

fig.set(fig.num="6.3.9.4", fig.path=diags.path)
plot(predict(bipq12mo_mpr_int), residuals(bipq12mo_mpr_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.9.3"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 12 months (global MPR subgroup)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.9.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.9.4"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 12 months (global MPR subgroup):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.9.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq12mo_mpr_int_p <- anova(bipq12mo_mpr, bipq12mo_mpr_int)$`Pr(>F)`[2]

subgrp_639 <- list(head=rbindTable(
  list(Text="<b>Table 6.3.9: Brief Illness Perception Questionnaire subgroup analysis - global MPR.<b>"), 
  list(Text=paste("The model for the BIPQ secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by global MPR. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: global MPR < 2.2", 
             "Change in BIPQ score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$glmpr_22=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_mpr_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$glmpr_22=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_mpr_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq6mo_mpr_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$glmpr_22=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_mpr_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$glmpr_22=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_mpr_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq12mo_mpr_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_639$head, subgrp_639$body, horiz.fmt, tables.file, first=F, last=F)

## 6.3.10: bipq BY endocardial MPR
bipq6mo_enmpr <- lm(bipq_tot_6m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                      rdelvsd + rdepmi + rdesex + enmpr_241 + site_simple, 
                    data=bipq_subgrp)

# model including interaction term
bipq6mo_enmpr_int <- lm(bipq_tot_6m ~ I((trtgrp=="Intervention")*(enmpr_241=="Yes")) + 
                          I((trtgrp=="Intervention")*(enmpr_241=="No")) + 
                          bipq_tot_bl + rdecadr + rdedia +
                          rdelvsd + rdepmi + rdesex + enmpr_241 + site_simple,
                        data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.10.1", fig.path=diags.path)
qqnorm(resid(bipq6mo_enmpr_int))
qqline(resid(bipq6mo_enmpr_int))
dev.off()

fig.set(fig.num="6.3.10.2", fig.path=diags.path)
plot(predict(bipq6mo_enmpr_int), residuals(bipq6mo_enmpr_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.10.1"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 6 months (endocardial MPR subgroup)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.10.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.10.2"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 6 months (endocardial MPR subgroup):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.10.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq6mo_enmpr_int_p <- anova(bipq6mo_enmpr, bipq6mo_enmpr_int)$`Pr(>F)`[2]

# SAQ SUMMARY AT 12 MONTHS
# model with no interaction
bipq12mo_enmpr <- lm(bipq_tot_12m ~ trtgrp + bipq_tot_bl + rdecadr + rdedia +
                       rdelvsd + rdepmi + rdesex + enmpr_241 + site_simple, 
                     data=bipq_subgrp)

# model including interaction term
bipq12mo_enmpr_int <- lm(bipq_tot_12m ~ I((trtgrp=="Intervention")*(enmpr_241=="Yes")) + 
                           I((trtgrp=="Intervention")*(enmpr_241=="No")) + 
                           bipq_tot_bl + rdecadr + rdedia +
                           rdelvsd + rdepmi + rdesex + enmpr_241 + site_simple, 
                         data=bipq_subgrp)
# diagnostics for above
fig.set(fig.num="6.3.10.3", fig.path=diags.path)
qqnorm(resid(bipq12mo_enmpr_int))
qqline(resid(bipq12mo_enmpr_int))
dev.off()

fig.set(fig.num="6.3.10.4", fig.path=diags.path)
plot(predict(bipq12mo_enmpr_int), residuals(bipq12mo_enmpr_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.10.3"), 
                             tabtext=paste("Normal QQ plot for BIPQ score at 12 months (endocardial MPR subgroup)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.10.3", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.3.10.4"), 
                             tabtext=paste("Residuals and fitted values plot for BIPQ score at 12 months (endocardial MPR subgroup):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.3.10.4", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
bipq12mo_enmpr_int_p <- anova(bipq12mo_enmpr, bipq12mo_enmpr_int)$`Pr(>F)`[2]

subgrp_6310 <- list(head=rbindTable(
  list(Text="<b>Table 6.3.10: Brief Illness Perception Questionnaire subgroup analysis - endocardial MPR.<b>"), 
  list(Text=paste("The model for the BIPQ secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by endocardial MPR. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: endocardial MPR < 2.41", 
             "Change in BIPQ score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$enmpr_241=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_enmpr_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(bipq_subgrp$bipq_tot_ch_6m[bipq_subgrp$enmpr_241=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq6mo_enmpr_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq6mo_enmpr_int_p)
  ), 
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$enmpr_241=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_enmpr_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(bipq_subgrp$bipq_tot_ch_12m[bipq_subgrp$enmpr_241=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(bipq12mo_enmpr_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(bipq12mo_enmpr_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_6310$head, subgrp_6310$body, horiz.fmt, tables.file, first=F, last=F)

#### 6.4.X: SUBGROUP ANALYSIS OF MOCA score ####
moc_subgrp <- merge(outcomes[outcomes$visittypeid==4, c("sno", "moc_sc", "moc_sc_ch", "moc_sc_bl", "saq_af_bl", "saq_summ_bl")], 
                    randomised[, c("sno", "trtgrp", "rdesex", "rdedia", "rdepmi", "rdecadr", "rdelvsd", "site_simple")],
                    by="sno", all.x=T)
moc_subgrp <- merge(moc_subgrp, screening[, c("sno", "simd_quintile", "age")], by="sno")
moc_subgrp$simd2 <- factor(moc_subgrp$simd_quintile, levels=levels(moc_subgrp$simd_quintile),
                           labels=c("1-2", "1-2", "3-5", "3-5", "3-5"))
moc_subgrp$age_grp <- factor(ifelse(is.na(moc_subgrp$age), NA, 
                                    ifelse(moc_subgrp$age <= quantile(moc_subgrp$age, probs=0.334, na.rm=T), 1, 
                                           ifelse(moc_subgrp$age > quantile(moc_subgrp$age, probs=0.334, na.rm=T) & moc_subgrp$age <= quantile(moc_subgrp$age, probs=0.667, na.rm=T), 2, 
                                                  ifelse(moc_subgrp$age > quantile(moc_subgrp$age, probs=0.667, na.rm=T), 3, NA)))), 
                             levels=c(1:3), labels=c("T1", "T2", "T3"))

moc_subgrp$mridiag <- diagnoses$mridiag[match(moc_subgrp$sno, diagnoses$sno)]
moc_subgrp$mridiag_mva <- factor(ifelse(is.na(moc_subgrp$mridiag), NA, 
                                        ifelse(moc_subgrp$mridiag=="Microvascular angina", "Yes", "No")), 
                                 levels=c("Yes", "No"))
moc_subgrp$mridiag_ncc <- factor(ifelse(is.na(moc_subgrp$mridiag), NA, 
                                        ifelse(moc_subgrp$mridiag=="Non-cardiac chest pain", "Yes", "No")), 
                                 levels=c("Yes", "No"))
moc_subgrp <- merge(moc_subgrp, 
                    mri[, c("sno", "strglmbf_225", "glmpr_22", "enmpr_241")], by="sno", all.x=T)
moc_subgrp$saq_af_grp <- factor(ifelse(is.na(moc_subgrp$saq_af_bl), NA, 
                                       ifelse(moc_subgrp$saq_af_bl <= 30, 1, 
                                              ifelse(moc_subgrp$saq_af_bl > 30 & moc_subgrp$saq_af_bl <= 60, 2, 
                                                     ifelse(moc_subgrp$saq_af_bl > 60 & moc_subgrp$saq_af_bl <= 99, 3, 
                                                            ifelse(moc_subgrp$saq_af_bl==100, 4, NA))))), 
                                levels=c(1:4), labels=c("Daily angina", "Weekly angina", "Monthly angina", "No angina"))

moc_subgrp$saq_summ_grp <- factor(ifelse(is.na(moc_subgrp$saq_summ_bl), NA, 
                                         ifelse(moc_subgrp$saq_summ_bl < 25, 1, 
                                                ifelse(moc_subgrp$saq_summ_bl >= 25 & moc_subgrp$saq_summ_bl < 50, 2, 
                                                       ifelse(moc_subgrp$saq_summ_bl >= 50 & moc_subgrp$saq_summ_bl < 75, 3, 
                                                              ifelse(moc_subgrp$saq_summ_bl >= 75, 4, NA))))), 
                                  levels=c(1:4), labels=c("Poor health", "Fair health", "Good health", "Excellent health"))

## 6.4.1 MOCA score, AGE SUBGROUP
# model with no interaction
moc12mo_age <- lm(moc_sc ~ trtgrp + moc_sc_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + age_grp + site_simple, 
                  data=moc_subgrp[!is.na(moc_subgrp$age_grp),])

# model including interaction term
moc12mo_age_int <- lm(moc_sc ~ I((trtgrp=="Intervention")*(age_grp=="T1")) + 
                        I((trtgrp=="Intervention")*(age_grp=="T2")) + 
                        I((trtgrp=="Intervention")*(age_grp=="T3")) +
                        moc_sc_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + age_grp + site_simple, 
                      data=moc_subgrp[!is.na(moc_subgrp$age_grp),])
# diagnostics for above
fig.set(fig.num="6.4.1.1", fig.path=diags.path)
qqnorm(resid(moc12mo_age_int))
qqline(resid(moc12mo_age_int))
dev.off()

fig.set(fig.num="6.4.1.2", fig.path=diags.path)
plot(predict(moc12mo_age_int), residuals(moc12mo_age_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.1.1"), 
                             tabtext=paste("Normal QQ plot for MOCA score at 12 months (age subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.1.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.1.2"), 
                             tabtext=paste("Residuals and fitted values plot for MOCA score at 12 months (age subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.1.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
moc12mo_age_int_p <- anova(moc12mo_age, moc12mo_age_int)$`Pr(>F)`[2]

subgrp_641 <- list(head=rbindTable(
  list(Text="<b>Table 6.4.1: Montreal Cognitive Assessment subgroup analysis - age tertile.<b>"), 
  list(Text=paste("The model for the MOCA secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by age tertiles. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: age tertile", 
             "Change in MOCA score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable(paste("Tertile 1:", min(moc_subgrp$age), "-", 
                   quantile(moc_subgrp$age, probs=0.334, na.rm=T)), 
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$age_grp=="T1"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_age_int, term=2, asTable=F)),
  cbindTable(paste("Tertile 2:", quantile(moc_subgrp$age, probs=0.334, na.rm=T) + 1, 
                   "-", quantile(moc_subgrp$age, probs=0.667, na.rm=T)), 
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$age_grp=="T2"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_age_int, term=3, asTable=F)),
  cbindTable(paste("Tertile 3:", quantile(moc_subgrp$age, probs=0.667, na.rm=T) + 1, 
                   "-", max(moc_subgrp$age, na.rm=T)), 
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$age_grp=="T3"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_age_int, term=4, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(moc12mo_age_int_p)),
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_641$head, subgrp_641$body, horiz.fmt, tables.file, first=F, last=F)
# MOCA NOT DONE AT 6MO, TAKE OUT REFS TO 6MO
## 6.4.x: moc BY SEX SUBGROUP
# model with no interaction
moc12mo_sex <- lm(moc_sc ~ trtgrp + moc_sc_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + site_simple, 
                  data=moc_subgrp)

# model including interaction term
moc12mo_sex_int <- lm(moc_sc ~ I((trtgrp=="Intervention")*(rdesex=="Male")) + 
                        I((trtgrp=="Intervention")*(rdesex=="Female")) + 
                        moc_sc_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + site_simple, 
                      data=moc_subgrp)
# diagnostics for above
fig.set(fig.num="6.4.2.1", fig.path=diags.path)
qqnorm(resid(moc12mo_sex_int))
qqline(resid(moc12mo_sex_int))
dev.off()

fig.set(fig.num="6.4.2.2", fig.path=diags.path)
plot(predict(moc12mo_sex_int), residuals(moc12mo_sex_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.2.1"), 
                             tabtext=paste("Normal QQ plot for MOCA score at 12 months (age subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.2.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.2.2"), 
                             tabtext=paste("Residuals and fitted values plot for MOCA score at 12 months (age subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.2.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
moc12mo_sex_int_p <- anova(moc12mo_sex, moc12mo_sex_int)$`Pr(>F)`[2]

subgrp_642 <- list(head=rbindTable(
  list(Text="<b>Table 6.4.2: Montreal Cognitive Assessment subgroup analysis - sex.<b>"), 
  list(Text=paste("The model for the MOCA secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by sex. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: sex", 
             "Change in MOCA score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Male",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$rdesex=="Male"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_sex_int, term=2, asTable=F)),
  cbindTable("Female",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$rdesex=="Female"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_sex_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(moc12mo_sex_int_p)
  ),
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_642$head, subgrp_642$body, horiz.fmt, tables.file, first=F, last=F)

## 6.4.3: moc BY SIMD SUBGROUP
# model with no interaction
moc12mo_simd <- lm(moc_sc ~ trtgrp + moc_sc_bl + rdecadr + rdedia +
                     rdelvsd + rdepmi + rdesex + simd2 + site_simple, 
                   data=moc_subgrp)

# model including interaction term
moc12mo_simd_int <- lm(moc_sc ~ I((trtgrp=="Intervention")*(simd2=="1-2")) + 
                         I((trtgrp=="Intervention")*(simd2=="3-5")) + 
                         moc_sc_bl + rdecadr + rdedia +
                         rdelvsd + rdepmi + rdesex + simd2 + site_simple, 
                       data=moc_subgrp)
# diagnostics for above
fig.set(fig.num="6.4.3.1", fig.path=diags.path)
qqnorm(resid(moc12mo_simd_int))
qqline(resid(moc12mo_simd_int))
dev.off()

fig.set(fig.num="6.4.3.2", fig.path=diags.path)
plot(predict(moc12mo_simd_int), residuals(moc12mo_simd_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.3.1"), 
                             tabtext=paste("Normal QQ plot for MOCA score at 12 months (SIMD subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.3.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.3.2"), 
                             tabtext=paste("Residuals and fitted values plot for MOCA score at 12 months (SIMD subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.3.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
moc12mo_simd_int_p <- anova(moc12mo_simd, moc12mo_simd_int)$`Pr(>F)`[2]

subgrp_643 <- list(head=rbindTable(
  list(Text="<b>Table 6.4.3: Montreal Cognitive Assessment subgroup analysis - SIMD group.<b>"), 
  list(Text=paste("The model for the MOCA secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by SIMD quintile. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: SIMD group", 
             "Change in MOCA score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Quintiles 1 and 2",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$simd2=="1-2"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_simd_int, term=2, asTable=F)),
  cbindTable("Quintiles 3, 4, and 5",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$simd2=="3-5"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_simd_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(moc12mo_simd_int_p)
  ),
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_643$head, subgrp_643$body, horiz.fmt, tables.file, first=F, last=F)

## 6.4.4: moc BY SAQ SUMMARY SCORE
# model with no interaction
moc12mo_saqsumm <- lm(moc_sc ~ trtgrp + moc_sc_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + saq_summ_grp + site_simple, 
                      data=moc_subgrp)

# model including interaction term
moc12mo_saqsumm_int <- lm(moc_sc ~ I((trtgrp=="Intervention")*(saq_summ_grp=="Poor health")) + 
                            I((trtgrp=="Intervention")*(saq_summ_grp=="Fair health")) + 
                            I((trtgrp=="Intervention")*(saq_summ_grp=="Good health")) + 
                            I((trtgrp=="Intervention")*(saq_summ_grp=="Excellent health")) + 
                            moc_sc_bl + rdecadr + rdedia +
                            rdelvsd + rdepmi + rdesex + saq_summ_grp + site_simple, 
                          data=moc_subgrp)
# diagnostics for above
fig.set(fig.num="6.4.4.1", fig.path=diags.path)
qqnorm(resid(moc12mo_saqsumm_int))
qqline(resid(moc12mo_saqsumm_int))
dev.off()

fig.set(fig.num="6.4.4.2", fig.path=diags.path)
plot(predict(moc12mo_saqsumm_int), residuals(moc12mo_saqsumm_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.4.1"), 
                             tabtext=paste("Normal QQ plot for MOCA score at 12 months (SAQ summary subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.4.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.4.2"), 
                             tabtext=paste("Residuals and fitted values plot for MOCA score at 12 months (SAQ summary subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.4.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
moc12mo_saqsumm_int_p <- anova(moc12mo_saqsumm, moc12mo_saqsumm_int)$`Pr(>F)`[2]

subgrp_644 <- list(head=rbindTable(
  list(Text="<b>Table 6.4.4: Montreal Cognitive Assessment subgroup analysis - SAQ summary score.<b>"), 
  list(Text=paste("The model for the MOCA secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by baseline SAQ summary score. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: SAQ summary score health status", 
             "Change in MOCA score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Poor health (score < 25)",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$saq_summ_grp=="Poor health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_saqsumm_int, term=2, asTable=F)),
  cbindTable("Fair health (score 25 - 49)",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$saq_summ_grp=="Fair health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_saqsumm_int, term=3, asTable=F)),
  cbindTable("Good health (score 50 - 74)",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$saq_summ_grp=="Good health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_saqsumm_int, term=4, asTable=F)),
  cbindTable("Excellent health (score &ge; 75)",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$saq_summ_grp=="Excellent health"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_saqsumm_int, term=5, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(moc12mo_saqsumm_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_644$head, subgrp_644$body, horiz.fmt, tables.file, first=F, last=F)

## 6.4.5: moc BY SAQ SUMMARY SCORE
# model with no interaction
moc12mo_saqaf <- lm(moc_sc ~ trtgrp + moc_sc_bl + rdecadr + rdedia +
                      rdelvsd + rdepmi + rdesex + saq_af_grp + site_simple, 
                    data=moc_subgrp)

# model including interaction term
moc12mo_saqaf_int <- lm(moc_sc ~ I((trtgrp=="Intervention")*(saq_af_grp=="Daily angina")) + 
                          I((trtgrp=="Intervention")*(saq_af_grp=="Weekly angina")) + 
                          I((trtgrp=="Intervention")*(saq_af_grp=="Monthly angina")) + 
                          I((trtgrp=="Intervention")*(saq_af_grp=="No angina")) + 
                          moc_sc_bl + rdecadr + rdedia +
                          rdelvsd + rdepmi + rdesex + saq_af_grp + site_simple, 
                        data=moc_subgrp)
# diagnostics for above
fig.set(fig.num="6.4.5.1", fig.path=diags.path)
qqnorm(resid(moc12mo_saqaf_int))
qqline(resid(moc12mo_saqaf_int))
dev.off()

fig.set(fig.num="6.4.5.2", fig.path=diags.path)
plot(predict(moc12mo_saqaf_int), residuals(moc12mo_saqaf_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.5.1"), 
                             tabtext=paste("Normal QQ plot for MOCA score at 12 months (SAQ summary subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.5.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.5.2"), 
                             tabtext=paste("Residuals and fitted values plot for MOCA score at 12 months (SAQ summary subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.5.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
moc12mo_saqaf_int_p <- anova(moc12mo_saqaf, moc12mo_saqaf_int)$`Pr(>F)`[2]

subgrp_645 <- list(head=rbindTable(
  list(Text="<b>Table 6.4.5: Montreal Cognitive Assessment subgroup analysis - SAQ angina frequency score.<b>"), 
  list(Text=paste("The model for the MOCA secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by baseline SAQ angina frequency score. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: SAQ angina frequency", 
             "Change in MOCA score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Daily angina (score &le; 30)",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$saq_af_grp=="Daily angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_saqaf_int, term=2, asTable=F)),
  cbindTable("Weekly angina (score 31 - 60)",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$saq_af_grp=="Weekly angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_saqaf_int, term=3, asTable=F)),
  cbindTable("Monthly angina (score 61 - 99)",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$saq_af_grp=="Monthly angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_saqaf_int, term=4, asTable=F)),
  cbindTable("No angina (score 100)",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$saq_af_grp=="No angina"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_saqaf_int, term=5, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(moc12mo_saqaf_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_645$head, subgrp_645$body, horiz.fmt, tables.file, first=F, last=F)

## 6.4.6: moc BY MRI MVA
# model with no interaction
moc12mo_mva <- lm(moc_sc ~ trtgrp + moc_sc_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + mridiag_mva + site_simple, 
                  data=moc_subgrp)

# model including interaction term
moc12mo_mva_int <- lm(moc_sc ~ I((trtgrp=="Intervention")*(mridiag_mva=="Yes")) + 
                        I((trtgrp=="Intervention")*(mridiag_mva=="No")) + 
                        moc_sc_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + mridiag_mva + site_simple, 
                      data=moc_subgrp)
# diagnostics for above
fig.set(fig.num="6.4.6.1", fig.path=diags.path)
qqnorm(resid(moc12mo_mva_int))
qqline(resid(moc12mo_mva_int))
dev.off()

fig.set(fig.num="6.4.6.2", fig.path=diags.path)
plot(predict(moc12mo_mva_int), residuals(moc12mo_mva_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.6.1"), 
                             tabtext=paste("Normal QQ plot for MOCA score at 12 months (MRI MVA subgroup analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.6.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.6.2"), 
                             tabtext=paste("Residuals and fitted values plot for MOCA score at 12 months (MRI MVA subgroup analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.6.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
moc12mo_mva_int_p <- anova(moc12mo_mva, moc12mo_mva_int)$`Pr(>F)`[2]

subgrp_646 <- list(head=rbindTable(
  list(Text="<b>Table 6.4.6: Montreal Cognitive Assessment subgroup analysis - MRI diagnosis of microvascular angina.<b>"), 
  list(Text=paste("The model for the MOCA secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by an MRI diagnosis of MVA. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: MRI diagnosis of MVA", 
             "Change in MOCA score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$mridiag_mva=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_mva_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$mridiag_mva=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_mva_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(moc12mo_mva_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_646$head, subgrp_646$body, horiz.fmt, tables.file, first=F, last=F)

## 6.4.7: moc BY MRI NON-CARDIAC CHEST PAIN
moc12mo_ncc <- lm(moc_sc ~ trtgrp + moc_sc_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + mridiag_ncc + site_simple, 
                  data=moc_subgrp)

# model including interaction term
moc12mo_ncc_int <- lm(moc_sc ~ I((trtgrp=="Intervention")*(mridiag_ncc=="Yes")) + 
                        I((trtgrp=="Intervention")*(mridiag_ncc=="No")) + 
                        moc_sc_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + mridiag_ncc + site_simple, 
                      data=moc_subgrp)
# diagnostics for above
fig.set(fig.num="6.4.7.1", fig.path=diags.path)
qqnorm(resid(moc12mo_ncc_int))
qqline(resid(moc12mo_ncc_int))
dev.off()

fig.set(fig.num="6.4.7.2", fig.path=diags.path)
plot(predict(moc12mo_ncc_int), residuals(moc12mo_ncc_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.7.1"), 
                             tabtext=paste("Normal QQ plot for MOCA score at 12 months (MRI non-cardiac chest pain analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.7.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.7.2"), 
                             tabtext=paste("Residuals and fitted values plot for MOCA score at 12 months (MRI non-cardiac chest pain analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.7.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
moc12mo_ncc_int_p <- anova(moc12mo_ncc, moc12mo_ncc_int)$`Pr(>F)`[2]

subgrp_647 <- list(head=rbindTable(
  list(Text="<b>Table 6.4.7: Montreal Cognitive Assessment subgroup analysis - MRI diagnosis of non-cardiac chest pain.<b>"), 
  list(Text=paste("The model for the MOCA secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by an MRI diagnosis of non-cardiac chest pain. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: MRI diagnosis of non-cardiac chest pain", 
             "Change in MOCA score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$mridiag_ncc=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_ncc_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$mridiag_ncc=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_ncc_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(moc12mo_ncc_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_647$head, subgrp_647$body, horiz.fmt, tables.file, first=F, last=F)

## 6.4.8: moc BY global MBF under stress
# model with no interaction
moc12mo_mbf <- lm(moc_sc ~ trtgrp + moc_sc_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + strglmbf_225 + site_simple, 
                  data=moc_subgrp)

# model including interaction term
moc12mo_mbf_int <- lm(moc_sc ~ I((trtgrp=="Intervention")*(strglmbf_225=="Yes")) + 
                        I((trtgrp=="Intervention")*(strglmbf_225=="No")) + 
                        moc_sc_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + strglmbf_225 + site_simple, 
                      data=moc_subgrp)
# diagnostics for above
fig.set(fig.num="6.4.8.1", fig.path=diags.path)
qqnorm(resid(moc12mo_mbf_int))
qqline(resid(moc12mo_mbf_int))
dev.off()

fig.set(fig.num="6.4.8.2", fig.path=diags.path)
plot(predict(moc12mo_mbf_int), residuals(moc12mo_mbf_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.8.1"), 
                             tabtext=paste("Normal QQ plot for MOCA score at 12 months (global MBF under stress analysis)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.8.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.8.2"), 
                             tabtext=paste("Residuals and fitted values plot for MOCA score at 12 months (global MBF under stress analysis):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.8.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
moc12mo_mbf_int_p <- anova(moc12mo_mbf, moc12mo_mbf_int)$`Pr(>F)`[2]

subgrp_648 <- list(head=rbindTable(
  list(Text="<b>Table 6.4.8: Montreal Cognitive Assessment subgroup analysis - global MBF under stress.<b>"), 
  list(Text=paste("The model for the MOCA secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by an global MBF under stress. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: global MBF under stress < 2.25", 
             "Change in MOCA score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$strglmbf_225=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_mbf_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$strglmbf_225=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_mbf_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(moc12mo_mbf_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_648$head, subgrp_648$body, horiz.fmt, tables.file, first=F, last=F)

## 6.4.9: moc BY global MPR
# model with no interaction
moc12mo_mpr <- lm(moc_sc ~ trtgrp + moc_sc_bl + rdecadr + rdedia +
                    rdelvsd + rdepmi + rdesex + glmpr_22 + site_simple, 
                  data=moc_subgrp)

# model including interaction term
moc12mo_mpr_int <- lm(moc_sc ~ I((trtgrp=="Intervention")*(glmpr_22=="Yes")) + 
                        I((trtgrp=="Intervention")*(glmpr_22=="No")) + 
                        moc_sc_bl + rdecadr + rdedia +
                        rdelvsd + rdepmi + rdesex + glmpr_22 + site_simple, 
                      data=moc_subgrp)
# diagnostics for above
fig.set(fig.num="6.4.9.1", fig.path=diags.path)
qqnorm(resid(moc12mo_mpr_int))
qqline(resid(moc12mo_mpr_int))
dev.off()

fig.set(fig.num="6.4.9.2", fig.path=diags.path)
plot(predict(moc12mo_mpr_int), residuals(moc12mo_mpr_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.9.1"), 
                             tabtext=paste("Normal QQ plot for MOCA score at 12 months (global MPR subgroup)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.9.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.9.2"), 
                             tabtext=paste("Residuals and fitted values plot for MOCA score at 12 months (global MPR subgroup):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.9.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
moc12mo_mpr_int_p <- anova(moc12mo_mpr, moc12mo_mpr_int)$`Pr(>F)`[2]

subgrp_649 <- list(head=rbindTable(
  list(Text="<b>Table 6.4.9: Montreal Cognitive Assessment subgroup analysis - global MPR.<b>"), 
  list(Text=paste("The model for the MOCA secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by global MPR. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: global MPR < 2.2", 
             "Change in MOCA score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$glmpr_22=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_mpr_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$glmpr_22=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_mpr_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(moc12mo_mpr_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_649$head, subgrp_649$body, horiz.fmt, tables.file, first=F, last=F)

## 6.4.10: moc BY endocardial MPR
# model with no interaction
moc12mo_enmpr <- lm(moc_sc ~ trtgrp + moc_sc_bl + rdecadr + rdedia +
                      rdelvsd + rdepmi + rdesex + enmpr_241 + site_simple, 
                    data=moc_subgrp)

# model including interaction term
moc12mo_enmpr_int <- lm(moc_sc ~ I((trtgrp=="Intervention")*(enmpr_241=="Yes")) + 
                          I((trtgrp=="Intervention")*(enmpr_241=="No")) + 
                          moc_sc_bl + rdecadr + rdedia +
                          rdelvsd + rdepmi + rdesex + enmpr_241 + site_simple, 
                        data=moc_subgrp)
# diagnostics for above
fig.set(fig.num="6.4.10.1", fig.path=diags.path)
qqnorm(resid(moc12mo_enmpr_int))
qqline(resid(moc12mo_enmpr_int))
dev.off()

fig.set(fig.num="6.4.10.2", fig.path=diags.path)
plot(predict(moc12mo_enmpr_int), residuals(moc12mo_enmpr_int), xlab="predicted values", ylab="residual values")
dev.off()
# add diagnostics to diagnostics file
temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.10.1"), 
                             tabtext=paste("Normal QQ plot for MOCA score at 12 months (endocardial MPR subgroup)", 
                                           "model residuals: original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.10.1", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

temp <- list(
  head=as.Table(figure.title(tabnum=paste0("6.4.10.2"), 
                             tabtext=paste("Residuals and fitted values plot for MOCA score at 12 months (endocardial MPR subgroup):", 
                                           "original data"))),
  body=rbindTable(fig.tag(fig.num="6.4.10.2", fig.path=diags.path), 
                  end.row(disclaimer=T)
  )
)
ExportTable.HTML(temp$head, temp$body, horiz.fmt, diags.file, first=F, last=F)

# assess interaction effect
moc12mo_enmpr_int_p <- anova(moc12mo_enmpr, moc12mo_enmpr_int)$`Pr(>F)`[2]

subgrp_6410 <- list(head=rbindTable(
  list(Text="<b>Table 6.4.10: Montreal Cognitive Assessment subgroup analysis - endocardial MPR.<b>"), 
  list(Text=paste("The model for the MOCA secondary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by endocardial MPR. The interaction p-value assesses", 
                  "if there is an interaction effect.")), 
  cbindTable("Subgroup: endocardial MPR < 2.41", 
             "Change in MOCA score:<br>Median (Q1, Q3)", 
             "Intervention effect estimate (95% CI), p-value")
), 
body=rbindTable(
  list(Text="Timepoint: 12 months", Other=list(colspan=3)), 
  cbindTable("Yes",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$enmpr_241=="Yes"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_enmpr_int, term=2, asTable=F)),
  cbindTable("No",
             summary.fun(moc_subgrp$moc_sc_ch[moc_subgrp$enmpr_241=="No"], 
                         summary.text="@MEDIAN (@LQ, @UQ)", ndp=2), 
             oth.lm.summ(moc12mo_enmpr_int, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(moc12mo_enmpr_int_p)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(subgrp_6410$head, subgrp_6410$body, horiz.fmt, tables.file, first=F, last=F)

#### 7.X: SAEs ####
# fix this
aes_count <- aes %>% group_by(sno) %>% summarise(count_all=n()) %>% ungroup()
aes_card_count <- aes[aes$aetype=="Cardiac",] %>% group_by(sno) %>% summarise(count_cardiac=n()) %>% ungroup()
aes <- merge(aes, aes_count[, c("sno", "count_all")], by="sno", all.x=T)
aes <- merge(aes, aes_card_count[, c("sno", "count_cardiac")], by="sno", all.x=T)
aes$count_cardiac <- ifelse(is.na(aes$count_cardiac), 0, aes$count_cardiac)

summary.table(
  tabnum="7.1", 
  tabtext="Non-serious Adverse Events.", 
  basedata=list(
    list(x=aes$sitename, row.name="Number of AEs", nrow=T), 
    list(x=aes$aetype, row.name="AE type", showN=F), 
    list(x=aes$count_all, row.name="All AEs: number of events per subject", subset=!duplicated(aes$sno)), 
    list(x=aes$count_cardiac, row.name="Cardiac AEs: number of events per subject (of those with a cardiac AE)", subset=!duplicated(aes$sno)&aes$count_cardiac>0)
  ),   
  treat=aes$trtgrp,
  out.file=tables.file
)
saes$macce <- sae_coded$macce[match(saes$caseno, sae_coded$caseno)]
summary.table(
  tabnum="7.2",
  tabtext="Serious Adverse Events. N (%) show people with at least one event of each type.",
  basedata=list(
    list(x=saes$sitename,row.name="Number of SAEs",nrow=T),
    list(x=saes$macce, row.name="SAEs classed as MACCE", showN=F, x.levels="Yes"),
    list(x=saes$mace, row.name="SAEs classed as MACE", showN=F, x.levels="Yes"),
    list(x=saes$ser_death,row.name="Seriousness Criterion: Death",showN=F,x.levels="Yes"),
    if(any(saes$ser_death=="Yes", na.rm=T)) list(x=saes$causedeath, row.name="Cause of death", subset=saes$ser_death=="Yes"),
    list(x=saes$ser_life,row.name="Seriousness Criterion: Life threatening",showN=F,x.levels="Yes"),
    list(x=saes$ser_hosp,row.name="Seriousness Criterion: Hospitalisation",showN=F,x.levels="Yes"),
    if(any(saes$ser_hosp=="Yes", na.rm=T)) list(x=as.numeric(saes$hospduration), row.name="Duration of hospitalisation (days)", subset=saes$ser_hosp=="Yes", ndp=1),
    list(x=saes$ser_disab,row.name="Seriousness Criterion: Disability",showN=F,x.levels="Yes"),
    list(x=saes$ser_cong,row.name="Seriousness Criterion: Congenital abnormality",showN=F,x.levels="Yes"),
    list(x=saes$ser_omic,row.name="Seriousness Criterion: Other important medical event",showN=F,x.levels="Yes"),
    list(x=saes$severity,row.name="Severity"),
    list(x=saes$relation,row.name="Causality"),
    if(any(saes$relation=="Yes",na.rm=T)) list(x=saes$expected,row.name="Expectedness (if related)",subset=saes$relation=="Yes"),
    list(x=saes$outcome,row.name="Outcome"),
    list(x=as.numeric(saes$duration),row.name="Duration (days)",subset=saes$outcome %in% c("Recovered","Recovered with sequelae","Fatal"),ndp=1)),
  treat=saes$trtgrp,
  out.file=tables.file)

safety.table(
  tabnum="7.3",
  tabtext="MedDRA Coded Serious Adverse Events.",
  safety.id=sae_coded$sno,
  safety.subset=NULL,
  safety.treat=sae_coded$trtgrp,
  safety.class1=sae_coded$soc_name,
  safety.class2=sae_coded$pt_name,
  pop.id=randomised$sno,
  pop.subset=NULL,
  pop.treat=randomised$trtgrp,
  treat.levels=levels(randomised$trtgrp),
  treat.names=levels(randomised$trtgrp),
  type="Event",
  out.file=tables.file)

#### LISTINGS ####
# Listing 1: Withdrawals
wd_list_dat <- withdrawals
colnames(wd_list_dat)
colnames(wd_list_dat) <- c("Subject ID", "Randomised", "Treatment group", "Screening date", "Randomisation date", "Withdrawn from further follow-up", 
                           "Date withdrawn from further follow-up", "Time to withdrawal from further follow-up (days)", 
                           "Reason for withdrawal from further follow-up", "Other reason for withdrawal from further follow-up", 
                           "Withdrawn from follow-up through medical records", "Date withdrawn from follow-up through medical records", 
                           "Time to withdrawal from follow-up through medical records (days)", "Reason for withdrawal from follow-up through medical records", 
                           "Other reason for withdrawal from follow-up through medical records", "Withdrawn consent to store blood for future research", 
                           "Date consent withdrawn to store blood for future research", 
                           "Time to withdrawal of consent to store blood for future research (days)", 
                           "Reason for withdrawal of consent to store blood for future research", 
                           "Other reason for withdrawal of consent to store blood for future research")
write.csv(wd_list_dat, row.names=F,
          file=paste0(table.path, "/", project.name, "_Listing01_Withdrawals_", Version, "_", 
                      gsub("-","",Sys.Date()),"_",substring(datetime,12,13),
                      substring(datetime,15,16), ".csv"))
# Listing 2: SAEs
sae_list_dat <- merge(randomised[, c("sno", "randdate")], saes[,c("sno", "caseno", "trtgrp", "sitename", 
                                                                  "awaredate", "seriousdate", "recovdate", "diagnosis", 
                                                                  "ser_death", "ser_life", "ser_disab", "ser_cong",
                                                                  "ser_hosp", "ser_omic", "severity", "causedeath", 
                                                                  "deathdate", "hospadmdate", "hospdischdate", 
                                                                  "duration", "hospduration", "relation", "expected", 
                                                                  "outcome", "saeconf", "rusaeconf", "mace", "macce")], by="sno")

sae_list_dat <- merge(sae_list_dat, sae_coded[, c("sno", "caseno", "soc_name", "pt_name")], by=c("sno", "caseno"), all.x=T)
colnames(sae_list_dat)
colnames(sae_list_dat) <- c("Subject ID", "SAE case number", "Randomisation date", "Treatment group", "Site name", 
                            "Date of SAE awareness", "Date SAE became serious", "Date of recovery", "Diagnosis", "Seriousness: death", 
                            "Seriousness: life-threatening", "Seriousness: persistent/significant disability/incapacity", 
                            "Seriousness: congenital anomaly", "Seriousness: hospitalisation/prolongation of hospitalisation", 
                            "Seriousness: other medically important condition", "Severity", "Cause of death", "Date of death", 
                            "Date of hospital admission", "Date of hospital discharge", "SAE duration (days)", 
                            "Hospitalisation duration (days)", "Related to intervention", "Expected", "Outcome", "Confirmed as SAE", 
                            "Confirmed as SUSAR", "Classed as MACE", "Classed as MACCE", "System organ class", "Preferred term")
write.csv(sae_list_dat, row.names=F,
          file=paste0(table.path, "/", project.name, "_Listing02_SAEs_", Version, "_", 
                      gsub("-","",Sys.Date()),"_",substring(datetime,12,13),
                      substring(datetime,15,16), ".csv"))

# add in AE listing
ae_list_dat <- aes[, c("sno", "randdate", "trtgrp", "sitename", "aedate", "aedesc", "aetype")]
colnames(ae_list_dat)
colnames(ae_list_dat) <- c("Subject ID", "Randomisation date", "Treatment group", "Site name", 
                           "Adverse event date", "Adverse event description", "Adverse event classification")
write.csv(ae_list_dat, row.names=F,
          file=paste0(table.path, "/", project.name, "_Listing03_AEs_", Version, "_", 
                      gsub("-","",Sys.Date()),"_",substring(datetime,12,13),
                      substring(datetime,15,16), ".csv"))

#### FIGURES #### ### 
# scatterplots: 0 - 6 months
# SAQ summary
fig.set(fig.num="1.1")
plot(outcomes$saq_summ_bl[outcomes$visittypeid==3], outcomes$saq_summ[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline SAQ summary score", 
     ylab="6m follow-up SAQ summary score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$saq_summ[outcomes$trtgrp=="Control"] ~ outcomes$saq_summ_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$saq_summ[outcomes$trtgrp=="Intervention"] ~ outcomes$saq_summ_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()
# SAQ subscores
fig.set(fig.num="1.2")
plot(outcomes$saq_af_bl[outcomes$visittypeid==3], outcomes$saq_af[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline SAQ angina frequency score", 
     ylab="6m follow-up SAQ angina frequency score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$saq_af[outcomes$trtgrp=="Control"] ~ outcomes$saq_af_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$saq_af[outcomes$trtgrp=="Intervention"] ~ outcomes$saq_af_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

fig.set(fig.num="1.3")
plot(outcomes$saq_pl_bl[outcomes$visittypeid==3], outcomes$saq_pl[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline SAQ physical limitation score", 
     ylab="6m follow-up SAQ physical limitation score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$saq_pl[outcomes$trtgrp=="Control"] ~ outcomes$saq_pl_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$saq_pl[outcomes$trtgrp=="Intervention"] ~ outcomes$saq_pl_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

fig.set(fig.num="1.4")
plot(outcomes$saq_ql_bl[outcomes$visittypeid==3], outcomes$saq_ql[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline SAQ quality of life score", 
     ylab="6m follow-up SAQ quality of life score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$saq_ql[outcomes$trtgrp=="Control"] ~ outcomes$saq_ql_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$saq_ql[outcomes$trtgrp=="Intervention"] ~ outcomes$saq_ql_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

fig.set(fig.num="1.5")
plot(outcomes$saq_st_bl[outcomes$visittypeid==3], outcomes$saq_st[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline SAQ stability score", 
     ylab="6m follow-up SAQ stability score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$saq_st[outcomes$trtgrp=="Control"] ~ outcomes$saq_st_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$saq_st[outcomes$trtgrp=="Intervention"] ~ outcomes$saq_st_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

fig.set(fig.num="1.6")
plot(outcomes$saq_ts_bl[outcomes$visittypeid==3], outcomes$saq_ts[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline SAQ treatment satisfaction score", 
     ylab="6m follow-up SAQ treatment satisfaction score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$saq_ts[outcomes$trtgrp=="Control"] ~ outcomes$saq_ts_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$saq_ts[outcomes$trtgrp=="Intervention"] ~ outcomes$saq_ts_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

# EQ5D
fig.set(fig.num="2.1")
plot(outcomes$eq5d_score_bl[outcomes$visittypeid==3], outcomes$eq5d_score[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline EQ-5D score", 
     ylab="6m follow-up EQ-5D score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$eq5d_score[outcomes$trtgrp=="Control"] ~ outcomes$eq5d_score_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$eq5d_score[outcomes$trtgrp=="Intervention"] ~ outcomes$eq5d_score_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

fig.set(fig.num="2.2")
plot(outcomes$eq5d_health_bl[outcomes$visittypeid==3], outcomes$eq5d_health[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline EQ-5D VAS", 
     ylab="6m follow-up EQ-5D VAS")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$eq5d_health[outcomes$trtgrp=="Control"] ~ outcomes$eq5d_health_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$eq5d_health[outcomes$trtgrp=="Intervention"] ~ outcomes$eq5d_health_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

# BIPQ
fig.set(fig.num="2.3")
plot(outcomes$bipq_tot_bl[outcomes$visittypeid==3], outcomes$bipq_tot[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline BIPQ score", 
     ylab="6m follow-up BIPQ score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$bipq_tot[outcomes$trtgrp=="Control"] ~ outcomes$bipq_tot_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$bipq_tot[outcomes$trtgrp=="Intervention"] ~ outcomes$bipq_tot_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

# PHQ
fig.set(fig.num="2.4")
plot(outcomes$phq_score_bl[outcomes$visittypeid==3], outcomes$phq_score[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline PHQ-4 score", 
     ylab="6m follow-up PHQ-4 score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$phq_score[outcomes$trtgrp=="Control"] ~ outcomes$phq_score_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$phq_score[outcomes$trtgrp=="Intervention"] ~ outcomes$phq_score_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

# TSQM-9
fig.set(fig.num="2.5")
plot(outcomes$tsqm_eff_bl[outcomes$visittypeid==3], outcomes$tsqm_eff[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline TSQM-9 effectiveness score", 
     ylab="6m follow-up TSQM-9 effectiveness score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$tsqm_eff[outcomes$trtgrp=="Control"] ~ outcomes$tsqm_eff_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$tsqm_eff[outcomes$trtgrp=="Intervention"] ~ outcomes$tsqm_eff_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

fig.set(fig.num="2.6")
plot(outcomes$tsqm_conv_bl[outcomes$visittypeid==3], outcomes$tsqm_conv[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline TSQM-9 convenience score", 
     ylab="6m follow-up TSQM-9 convenience score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$tsqm_conv[outcomes$trtgrp=="Control"] ~ outcomes$tsqm_conv_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$tsqm_conv[outcomes$trtgrp=="Intervention"] ~ outcomes$tsqm_conv_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

fig.set(fig.num="2.7")
plot(outcomes$tsqm_sat_bl[outcomes$visittypeid==3], outcomes$tsqm_sat[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline TSQM-9 satisfaction score", 
     ylab="6m follow-up TSQM-9 satisfaction score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$tsqm_sat[outcomes$trtgrp=="Control"] ~ outcomes$tsqm_sat_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$tsqm_sat[outcomes$trtgrp=="Intervention"] ~ outcomes$tsqm_sat_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

# DASI
fig.set(fig.num="2.8")
plot(outcomes$dasi_calc_bl[outcomes$visittypeid==3], outcomes$dasi_calc[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline DASI score", 
     ylab="6m follow-up DASI score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$dasi_calc[outcomes$trtgrp=="Control"] ~ outcomes$dasi_calc_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$dasi_calc[outcomes$trtgrp=="Intervention"] ~ outcomes$dasi_calc_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

# IPAQ
fig.set(fig.num="2.9")
plot(outcomes$ipaqtotmetmin_bl[outcomes$visittypeid==3], outcomes$ipaq_totmetmin[outcomes$visittypeid==3], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline IPAQ total weekly met-minutes", 
     ylab="6m follow-up IPAQ total weekly met-minutes")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$ipaq_totmetmin[outcomes$trtgrp=="Control"] ~ outcomes$ipaqtotmetmin_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$ipaq_totmetmin[outcomes$trtgrp=="Intervention"] ~ outcomes$ipaqtotmetmin_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

# scatterplots: 0 - 12 months
# SAQ summary
fig.set(fig.num="3.1")
plot(outcomes$saq_summ_bl[outcomes$visittypeid==4], outcomes$saq_summ[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline SAQ summary score", 
     ylab="12m follow-up SAQ summary score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$saq_summ[outcomes$trtgrp=="Control"] ~ outcomes$saq_summ_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$saq_summ[outcomes$trtgrp=="Intervention"] ~ outcomes$saq_summ_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()
# SAQ subscores
fig.set(fig.num="3.2")
plot(outcomes$saq_af_bl[outcomes$visittypeid==4], outcomes$saq_af[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline SAQ angina frequency score", 
     ylab="12m follow-up SAQ angina frequency score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$saq_af[outcomes$trtgrp=="Control"] ~ outcomes$saq_af_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$saq_af[outcomes$trtgrp=="Intervention"] ~ outcomes$saq_af_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

fig.set(fig.num="3.3")
plot(outcomes$saq_pl_bl[outcomes$visittypeid==4], outcomes$saq_pl[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline SAQ physical limitation score", 
     ylab="12m follow-up SAQ physical limitation score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$saq_pl[outcomes$trtgrp=="Control"] ~ outcomes$saq_pl_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$saq_pl[outcomes$trtgrp=="Intervention"] ~ outcomes$saq_pl_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

fig.set(fig.num="3.4")
plot(outcomes$saq_ql_bl[outcomes$visittypeid==4], outcomes$saq_ql[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline SAQ quality of life score", 
     ylab="12m follow-up SAQ quality of life score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$saq_ql[outcomes$trtgrp=="Control"] ~ outcomes$saq_ql_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$saq_ql[outcomes$trtgrp=="Intervention"] ~ outcomes$saq_ql_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

fig.set(fig.num="3.5")
plot(outcomes$saq_st_bl[outcomes$visittypeid==4], outcomes$saq_st[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline SAQ stability score", 
     ylab="12m follow-up SAQ stability score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$saq_st[outcomes$trtgrp=="Control"] ~ outcomes$saq_st_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$saq_st[outcomes$trtgrp=="Intervention"] ~ outcomes$saq_st_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

fig.set(fig.num="3.6")
plot(outcomes$saq_ts_bl[outcomes$visittypeid==4], outcomes$saq_ts[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline SAQ treatment satisfaction score", 
     ylab="12m follow-up SAQ treatment satisfaction score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$saq_ts[outcomes$trtgrp=="Control"] ~ outcomes$saq_ts_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$saq_ts[outcomes$trtgrp=="Intervention"] ~ outcomes$saq_ts_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

# EQ5D
fig.set(fig.num="4.1")
plot(outcomes$eq5d_score_bl[outcomes$visittypeid==4], outcomes$eq5d_score[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline EQ-5D score", 
     ylab="12m follow-up EQ-5D score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$eq5d_score[outcomes$trtgrp=="Control"] ~ outcomes$eq5d_score_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$eq5d_score[outcomes$trtgrp=="Intervention"] ~ outcomes$eq5d_score_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

fig.set(fig.num="4.2")
plot(outcomes$eq5d_health_bl[outcomes$visittypeid==4], outcomes$eq5d_health[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline EQ-5D VAS", 
     ylab="12m follow-up EQ-5D VAS")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$eq5d_health[outcomes$trtgrp=="Control"] ~ outcomes$eq5d_health_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$eq5d_health[outcomes$trtgrp=="Intervention"] ~ outcomes$eq5d_health_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

# BIPQ
fig.set(fig.num="4.3")
plot(outcomes$bipq_tot_bl[outcomes$visittypeid==4], outcomes$bipq_tot[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline BIPQ score", 
     ylab="12m follow-up BIPQ score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$bipq_tot[outcomes$trtgrp=="Control"] ~ outcomes$bipq_tot_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$bipq_tot[outcomes$trtgrp=="Intervention"] ~ outcomes$bipq_tot_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

# PHQ
fig.set(fig.num="4.4")
plot(outcomes$phq_score_bl[outcomes$visittypeid==4], outcomes$phq_score[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline PHQ-4 score", 
     ylab="12m follow-up PHQ-4 score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$phq_score[outcomes$trtgrp=="Control"] ~ outcomes$phq_score_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$phq_score[outcomes$trtgrp=="Intervention"] ~ outcomes$phq_score_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

# TSQM-9
fig.set(fig.num="4.5")
plot(outcomes$tsqm_eff_bl[outcomes$visittypeid==4], outcomes$tsqm_eff[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline TSQM-9 effectiveness score", 
     ylab="12m follow-up TSQM-9 effectiveness score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$tsqm_eff[outcomes$trtgrp=="Control"] ~ outcomes$tsqm_eff_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$tsqm_eff[outcomes$trtgrp=="Intervention"] ~ outcomes$tsqm_eff_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

fig.set(fig.num="4.6")
plot(outcomes$tsqm_conv_bl[outcomes$visittypeid==4], outcomes$tsqm_conv[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline TSQM-9 convenience score", 
     ylab="12m follow-up TSQM-9 convenience score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$tsqm_conv[outcomes$trtgrp=="Control"] ~ outcomes$tsqm_conv_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$tsqm_conv[outcomes$trtgrp=="Intervention"] ~ outcomes$tsqm_conv_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

fig.set(fig.num="4.7")
plot(outcomes$tsqm_sat_bl[outcomes$visittypeid==4], outcomes$tsqm_sat[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline TSQM-9 satisfaction score", 
     ylab="12m follow-up TSQM-9 satisfaction score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$tsqm_sat[outcomes$trtgrp=="Control"] ~ outcomes$tsqm_sat_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$tsqm_sat[outcomes$trtgrp=="Intervention"] ~ outcomes$tsqm_sat_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

# DASI
fig.set(fig.num="4.8")
plot(outcomes$dasi_calc_bl[outcomes$visittypeid==4], outcomes$dasi_calc[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline DASI score", 
     ylab="12m follow-up DASI score")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$dasi_calc[outcomes$trtgrp=="Control"] ~ outcomes$dasi_calc_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$dasi_calc[outcomes$trtgrp=="Intervention"] ~ outcomes$dasi_calc_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

# IPAQ
fig.set(fig.num="4.9")
plot(outcomes$ipaqtotmetmin_bl[outcomes$visittypeid==4], outcomes$ipaq_totmetmin[outcomes$visittypeid==4], 
     col=ifelse(outcomes$trtgrp=="Control", "blue", "red"), pch=1, xlab="Baseline IPAQ total weekly met-minutes", 
     ylab="12m follow-up IPAQ total weekly met-minutes")
legend("topleft", bty="n", legend=c("Control", "Intervention"), col=c("blue", "red"), pch=1)
abline(lm(outcomes$ipaq_totmetmin[outcomes$trtgrp=="Control"] ~ outcomes$ipaqtotmetmin_bl[outcomes$trtgrp=="Control"]), col="blue")
abline(lm(outcomes$ipaq_totmetmin[outcomes$trtgrp=="Intervention"] ~ outcomes$ipaqtotmetmin_bl[outcomes$trtgrp=="Intervention"]), col="red")
dev.off()

# tables with scatterplots
figtab1 <- list(head=rbindTable(list(Text="<b>Figures 1.1 - 1.6: Scatterplots of SAQ scores from baseline to 6 months.</b>")), 
                body=rbindTable(fig.tag(fig.num="1.1"), 
                                fig.tag(fig.num="1.2"), 
                                fig.tag(fig.num="1.3"), 
                                fig.tag(fig.num="1.4"), 
                                fig.tag(fig.num="1.5"), 
                                fig.tag(fig.num="1.6"), 
                                end.row())
                )
ExportTable.HTML(figtab1$head, figtab1$body, filename=figure.file, horiz.fmt, first=F, last=F)

figtab2 <- list(head=rbindTable(list(Text="<b>Figures 2.1 - 2.9: Scatterplots of continuous secondary outcomes from baseline to 6 months.</b>")), 
                body=rbindTable(fig.tag(fig.num="2.1"), 
                                fig.tag(fig.num="2.2"), 
                                fig.tag(fig.num="2.3"), 
                                fig.tag(fig.num="2.4"), 
                                fig.tag(fig.num="2.5"), 
                                fig.tag(fig.num="2.6"), 
                                fig.tag(fig.num="2.7"), 
                                fig.tag(fig.num="2.8"), 
                                fig.tag(fig.num="2.9"), 
                                end.row())
)
ExportTable.HTML(figtab2$head, figtab2$body, filename=figure.file, horiz.fmt, first=F, last=F)

figtab3 <- list(head=rbindTable(list(Text="<b>Figures 3.1 - 3.6: Scatterplots of SAQ scores from baseline to 12 months.</b>")), 
                body=rbindTable(fig.tag(fig.num="3.1"), 
                                fig.tag(fig.num="3.2"), 
                                fig.tag(fig.num="3.3"), 
                                fig.tag(fig.num="3.4"), 
                                fig.tag(fig.num="3.5"), 
                                fig.tag(fig.num="3.6"), 
                                end.row())
)
ExportTable.HTML(figtab3$head, figtab3$body, filename=figure.file, horiz.fmt, first=F, last=F)

figtab4 <- list(head=rbindTable(list(Text="<b>Figures 4.1 - 4.9: Scatterplots of continuous secondary outcomes from baseline to 12 months.</b>")), 
                body=rbindTable(fig.tag(fig.num="4.1"), 
                                fig.tag(fig.num="4.2"), 
                                fig.tag(fig.num="4.3"), 
                                fig.tag(fig.num="4.4"), 
                                fig.tag(fig.num="4.5"), 
                                fig.tag(fig.num="4.6"), 
                                fig.tag(fig.num="4.7"), 
                                fig.tag(fig.num="4.8"), 
                                fig.tag(fig.num="4.9"), 
                                end.row())
)
ExportTable.HTML(figtab4$head, figtab4$body, filename=figure.file, horiz.fmt, first=F, last=F)

# standardised effect estimate plots

standardise_est <- function(fit, change, term, out){
  x_est <- summary(fit)$coefficients[term,,drop=F][,1]
  x_est <- x_est/sd(change, na.rm=T)
  
  x_lcl <- summary(fit)$coefficients[term,,drop=F][,1]+qnorm(0.025)*summary(fit)$coefficients[term,,drop=F][,2]
  x_lcl <- x_lcl/sd(change, na.rm=T)
  
  x_ucl <- summary(fit)$coefficients[term,,drop=F][,1]+qnorm(0.975)*summary(fit)$coefficients[term,,drop=F][,2]
  x_ucl <- x_ucl/sd(change, na.rm=T)
  
  final <- ifelse(out=="est", x_est, 
                  ifelse(out=="lcl", x_lcl, 
                         ifelse(out=="ucl", x_ucl, "out input is not defined")))
  final
}
outcomes <- merge(outcomes, randomised[, c("sno", "rdesex", "rdedia", "rdepmi", "rdecadr", "rdelvsd")], 
                  by="sno", all.x=T)
outcomes <- merge(outcomes, screening[, c("sno", "age")], by="sno", all.x=T)

lm.summ(fit=lm(saq_summ ~ trtgrp + saq_summ_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, data=outcomes[outcomes$visittypeid==3,]), 
        term=2)

standardise_est(fit=lm(saq_summ ~ trtgrp + saq_summ_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, data=outcomes[outcomes$visittypeid==3,]), 
                change=outcomes$saq_summ_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est")
std_est_dat_6m <- data.frame(names=c("SAQ summary score", "SAQ angina frequency", "SAQ physical limitation", 
                                     "SAQ quality of life", "SAQ stability", "SAQ treatment satisfaction", 
                                     "EQ-5D score", "EQ-5D VAS", "BIPQ score", "PHQ-4 score",
                                     "TSQM-9 effectiveness", "TSQM-9 convenience", "TSQM-9 satisfaction",
                                     "DASI score", "IPAQ weekly met-minutes"), 
                             est=c(standardise_est(fit=lm(saq_summ ~ trtgrp + saq_summ_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_summ_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(saq_af ~ trtgrp + saq_af_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_af_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(saq_pl ~ trtgrp + saq_pl_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_pl_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(saq_ql ~ trtgrp + saq_ql_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_ql_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(saq_st ~ trtgrp + saq_st_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_st_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(saq_ts ~ trtgrp + saq_ts_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_ts_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(eq5d_score ~ trtgrp + eq5d_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$eq5d_score_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(eq5d_health ~ trtgrp + eq5d_health_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$eq5d_health_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(bipq_tot ~ trtgrp + bipq_tot_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$bipq_tot_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(phq_score ~ trtgrp + phq_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$phq_score_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(tsqm_eff ~ trtgrp + tsqm_eff_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$tsqm_eff_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(tsqm_conv ~ trtgrp + tsqm_conv_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$tsqm_conv_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(tsqm_sat ~ trtgrp + tsqm_sat_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$tsqm_sat_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(dasi_calc ~ trtgrp + dasi_calc_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$dasi_calc_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(ipaq_totmetmin ~ trtgrp + ipaqtotmetmin_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$ipaqtotmetmin_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est")), 
                             lcl=c(standardise_est(fit=lm(saq_summ ~ trtgrp + saq_summ_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_summ_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(saq_af ~ trtgrp + saq_af_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_af_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(saq_pl ~ trtgrp + saq_pl_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_pl_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(saq_ql ~ trtgrp + saq_ql_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_ql_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(saq_st ~ trtgrp + saq_st_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_st_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(saq_ts ~ trtgrp + saq_ts_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_ts_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(eq5d_score ~ trtgrp + eq5d_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$eq5d_score_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(eq5d_health ~ trtgrp + eq5d_health_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$eq5d_health_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(bipq_tot ~ trtgrp + bipq_tot_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$bipq_tot_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(phq_score ~ trtgrp + phq_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$phq_score_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(tsqm_eff ~ trtgrp + tsqm_eff_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$tsqm_eff_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(tsqm_conv ~ trtgrp + tsqm_conv_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$tsqm_conv_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(tsqm_sat ~ trtgrp + tsqm_sat_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$tsqm_sat_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(dasi_calc ~ trtgrp + dasi_calc_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$dasi_calc_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(ipaq_totmetmin ~ trtgrp + ipaqtotmetmin_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$ipaqtotmetmin_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl")), 
                             ucl=c(standardise_est(fit=lm(saq_summ ~ trtgrp + saq_summ_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_summ_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(saq_af ~ trtgrp + saq_af_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_af_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(saq_pl ~ trtgrp + saq_pl_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_pl_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(saq_ql ~ trtgrp + saq_ql_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_ql_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(saq_st ~ trtgrp + saq_st_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_st_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(saq_ts ~ trtgrp + saq_ts_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_ts_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(eq5d_score ~ trtgrp + eq5d_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$eq5d_score_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(eq5d_health ~ trtgrp + eq5d_health_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$eq5d_health_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(bipq_tot ~ trtgrp + bipq_tot_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$bipq_tot_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(phq_score ~ trtgrp + phq_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$phq_score_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(tsqm_eff ~ trtgrp + tsqm_eff_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$tsqm_eff_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(tsqm_conv ~ trtgrp + tsqm_conv_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$tsqm_conv_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(tsqm_sat ~ trtgrp + tsqm_sat_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$tsqm_sat_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(dasi_calc ~ trtgrp + dasi_calc_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$dasi_calc_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(ipaq_totmetmin ~ trtgrp + ipaqtotmetmin_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$ipaqtotmetmin_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"))
)

std_est_dat_6m[std_est_dat_6m$names=="BIPQ score", c("est", "lcl", "ucl")] <- -1*std_est_dat_6m[std_est_dat_6m$names=="BIPQ score", c("est", "lcl", "ucl")]
std_est_dat_6m[std_est_dat_6m$names=="PHQ-4 score", c("est", "lcl", "ucl")] <- -1*std_est_dat_6m[std_est_dat_6m$names=="PHQ-4 score", c("est", "lcl", "ucl")]
std_est_dat_6m$names <- factor(std_est_dat_6m$names, 
                               levels=rev(c("SAQ summary score", "SAQ angina frequency", "SAQ physical limitation", 
                                            "SAQ quality of life", "SAQ stability", "SAQ treatment satisfaction", 
                                            "EQ-5D score", "EQ-5D VAS", "BIPQ score", "PHQ-4 score",
                                            "TSQM-9 effectiveness", "TSQM-9 convenience", "TSQM-9 satisfaction",
                                            "DASI score", "IPAQ weekly met-minutes")))
fig.set(fig.num="5", fig.path=figure.path)
ggplot(data=std_est_dat_6m, aes(x=est, y=names))+
  geom_point(size=2)+geom_errorbarh(aes(xmin=lcl, xmax=ucl), height=0)+
  theme_bw()+geom_vline(xintercept=0, linetype="dashed", colour="blue")+
  xlab("Effect")+ylab("Outcome")+ggtitle("Standardised intervention effect estimates and 95% CIs: baseline to 6 months")
dev.off()

std_est_dat_12m <- data.frame(names=c("SAQ summary score", "SAQ angina frequency", "SAQ physical limitation", 
                                     "SAQ quality of life", "SAQ stability", "SAQ treatment satisfaction", 
                                     "EQ-5D score", "EQ-5D VAS", "BIPQ score", "PHQ-4 score",
                                     "TSQM-9 effectiveness", "TSQM-9 convenience", "TSQM-9 satisfaction",
                                     "DASI score", "IPAQ weekly met-minutes"), 
                             est=c(standardise_est(fit=lm(saq_summ ~ trtgrp + saq_summ_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_summ_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(saq_af ~ trtgrp + saq_af_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_af_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(saq_pl ~ trtgrp + saq_pl_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_pl_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(saq_ql ~ trtgrp + saq_ql_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_ql_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(saq_st ~ trtgrp + saq_st_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_st_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(saq_ts ~ trtgrp + saq_ts_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_ts_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(eq5d_score ~ trtgrp + eq5d_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$eq5d_score_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(eq5d_health ~ trtgrp + eq5d_health_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$eq5d_health_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(bipq_tot ~ trtgrp + bipq_tot_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$bipq_tot_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(phq_score ~ trtgrp + phq_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$phq_score_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(tsqm_eff ~ trtgrp + tsqm_eff_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$tsqm_eff_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(tsqm_conv ~ trtgrp + tsqm_conv_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$tsqm_conv_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(tsqm_sat ~ trtgrp + tsqm_sat_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$tsqm_sat_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(dasi_calc ~ trtgrp + dasi_calc_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$dasi_calc_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(ipaq_totmetmin ~ trtgrp + ipaqtotmetmin_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$ipaqtotmetmin_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est")), 
                             lcl=c(standardise_est(fit=lm(saq_summ ~ trtgrp + saq_summ_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_summ_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(saq_af ~ trtgrp + saq_af_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_af_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(saq_pl ~ trtgrp + saq_pl_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_pl_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(saq_ql ~ trtgrp + saq_ql_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_ql_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(saq_st ~ trtgrp + saq_st_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_st_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(saq_ts ~ trtgrp + saq_ts_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_ts_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(eq5d_score ~ trtgrp + eq5d_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$eq5d_score_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(eq5d_health ~ trtgrp + eq5d_health_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$eq5d_health_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(bipq_tot ~ trtgrp + bipq_tot_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$bipq_tot_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(phq_score ~ trtgrp + phq_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$phq_score_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(tsqm_eff ~ trtgrp + tsqm_eff_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$tsqm_eff_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(tsqm_conv ~ trtgrp + tsqm_conv_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$tsqm_conv_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(tsqm_sat ~ trtgrp + tsqm_sat_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$tsqm_sat_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(dasi_calc ~ trtgrp + dasi_calc_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$dasi_calc_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(ipaq_totmetmin ~ trtgrp + ipaqtotmetmin_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$ipaqtotmetmin_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl")), 
                             ucl=c(standardise_est(fit=lm(saq_summ ~ trtgrp + saq_summ_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_af_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(saq_af ~ trtgrp + saq_af_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_af_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(saq_pl ~ trtgrp + saq_pl_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_pl_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(saq_ql ~ trtgrp + saq_ql_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_ql_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(saq_st ~ trtgrp + saq_st_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_st_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(saq_ts ~ trtgrp + saq_ts_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$saq_ts_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(eq5d_score ~ trtgrp + eq5d_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$eq5d_score_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(eq5d_health ~ trtgrp + eq5d_health_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$eq5d_health_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(bipq_tot ~ trtgrp + bipq_tot_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$bipq_tot_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(phq_score ~ trtgrp + phq_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$phq_score_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(tsqm_eff ~ trtgrp + tsqm_eff_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$tsqm_eff_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(tsqm_conv ~ trtgrp + tsqm_conv_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$tsqm_conv_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(tsqm_sat ~ trtgrp + tsqm_sat_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$tsqm_sat_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(dasi_calc ~ trtgrp + dasi_calc_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$dasi_calc_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(ipaq_totmetmin ~ trtgrp + ipaqtotmetmin_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==4,]), 
                                                   change=outcomes$ipaqtotmetmin_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"))
)

std_est_dat_12m[std_est_dat_12m$names=="BIPQ score", c("est", "lcl", "ucl")] <- -1*std_est_dat_12m[std_est_dat_12m$names=="BIPQ score", c("est", "lcl", "ucl")]
std_est_dat_12m[std_est_dat_12m$names=="PHQ-4 score", c("est", "lcl", "ucl")] <- -1*std_est_dat_12m[std_est_dat_12m$names=="PHQ-4 score", c("est", "lcl", "ucl")]
std_est_dat_12m$names <- factor(std_est_dat_12m$names, 
                               levels=rev(c("SAQ summary score", "SAQ angina frequency", "SAQ physical limitation", 
                                            "SAQ quality of life", "SAQ stability", "SAQ treatment satisfaction", 
                                            "EQ-5D score", "EQ-5D VAS", "BIPQ score", "PHQ-4 score",
                                            "TSQM-9 effectiveness", "TSQM-9 convenience", "TSQM-9 satisfaction",
                                            "DASI score", "IPAQ weekly met-minutes")))


fig.set(fig.num="6", fig.path=figure.path)
ggplot(data=std_est_dat_12m, aes(x=est, y=names))+
  geom_point(size=2)+geom_errorbarh(aes(xmin=lcl, xmax=ucl), height=0)+
  theme_bw()+geom_vline(xintercept=0, linetype="dashed", colour="blue")+
  xlab("Effect")+ylab("Outcome")+ggtitle("Standardised intervention effect estimates and 95% CIs:\nbaseline to 12 months")
dev.off()

figtab5 <- list(head=rbindTable(list(Text="<b>Figure 5: Forest plot of standardised intervention effect estimates and 95% CIs: baseline to 6 months.</b>"), 
                                list(Text="Effect estimates and corresponding confidence intervals have been standardised via dividing by the standard deviation of the change in outcome in the control population.")), 
                body=rbindTable(fig.tag(fig.num="5"), 
                                end.row())
)
ExportTable.HTML(figtab5$head, figtab5$body, filename=figure.file, horiz.fmt, first=F, last=F)

figtab6 <- list(head=rbindTable(list(Text="<b>Figure 6: Forest plot of standardised intervention effect estimates and 95% CIs: baseline to 12 months.</b>"), 
                                list(Text="Effect estimates and corresponding confidence intervals have been standardised via dividing by the standard deviation of the change in outcome in the control population.")), 
                body=rbindTable(fig.tag(fig.num="6"), 
                                end.row())
)
ExportTable.HTML(figtab6$head, figtab6$body, filename=figure.file, horiz.fmt, first=F, last=F)

std_est_dat_6m <- data.frame(names=c("SAQ summary score", "SAQ angina frequency", "SAQ physical limitation", 
                                     "SAQ quality of life", "SAQ stability", "SAQ treatment satisfaction", 
                                     "EQ-5D score", "EQ-5D VAS"), 
                             est=c(standardise_est(fit=lm(saq_summ ~ trtgrp + saq_summ_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_summ_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(saq_af ~ trtgrp + saq_af_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_af_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(saq_pl ~ trtgrp + saq_pl_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_pl_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                   standardise_est(fit=lm(saq_ql ~ trtgrp + saq_ql_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_ql_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(saq_st ~ trtgrp + saq_st_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_st_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(saq_ts ~ trtgrp + saq_ts_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_ts_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(eq5d_score ~ trtgrp + eq5d_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$eq5d_score_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                   standardise_est(fit=lm(eq5d_health ~ trtgrp + eq5d_health_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$eq5d_health_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="est")
                             ), 
                             lcl=c(standardise_est(fit=lm(saq_summ ~ trtgrp + saq_summ_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_summ_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(saq_af ~ trtgrp + saq_af_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_af_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(saq_pl ~ trtgrp + saq_pl_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_pl_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                   standardise_est(fit=lm(saq_ql ~ trtgrp + saq_ql_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_ql_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(saq_st ~ trtgrp + saq_st_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_st_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(saq_ts ~ trtgrp + saq_ts_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_ts_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(eq5d_score ~ trtgrp + eq5d_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$eq5d_score_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                   standardise_est(fit=lm(eq5d_health ~ trtgrp + eq5d_health_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$eq5d_health_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="lcl")), 
                             ucl=c(standardise_est(fit=lm(saq_summ ~ trtgrp + saq_summ_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_summ_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(saq_af ~ trtgrp + saq_af_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_af_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(saq_pl ~ trtgrp + saq_pl_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_pl_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                   standardise_est(fit=lm(saq_ql ~ trtgrp + saq_ql_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_ql_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(saq_st ~ trtgrp + saq_st_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_st_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(saq_ts ~ trtgrp + saq_ts_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$saq_ts_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(eq5d_score ~ trtgrp + eq5d_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$eq5d_score_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                   standardise_est(fit=lm(eq5d_health ~ trtgrp + eq5d_health_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                          data=outcomes[outcomes$visittypeid==3,]), 
                                                   change=outcomes$eq5d_health_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], term=2, out="ucl"))
)
std_est_dat_6m$names <- factor(std_est_dat_6m$names, levels=rev(c("SAQ summary score", "SAQ angina frequency", "SAQ physical limitation", 
                                                                  "SAQ quality of life", "SAQ stability", "SAQ treatment satisfaction", 
                                                                  "EQ-5D score", "EQ-5D VAS")))
fig.set(fig.num="7", fig.path=figure.path)
ggplot(data=std_est_dat_6m, aes(x=est, y=names)) +
  geom_point(size=2)+geom_errorbarh(aes(xmin=lcl, xmax=ucl), height=0)+
  theme_bw()+geom_vline(xintercept=0, linetype="dashed", colour="blue")+
  xlab("Effect")+ylab("Outcome")+ggtitle("Standardised intervention effect estimates and 95% CIs:\nbaseline to 6 months")
dev.off()

figtab7 <- list(head=rbindTable(list(Text="<b>Figure 7: Forest plot of standardised intervention effect estimates and 95% CIs: baseline to 6 months.</b>"), 
                                list(Text="Effect estimates and corresponding confidence intervals have been standardised via dividing by the standard deviation of the change in outcome in the control population.")), 
                body=rbindTable(fig.tag(fig.num="7"), 
                                end.row())
)
ExportTable.HTML(figtab7$head, figtab7$body, filename=figure.file, horiz.fmt, first=F, last=F)

std_est_dat_12m <- data.frame(names=c("SAQ summary score", "SAQ angina frequency", "SAQ physical limitation", 
                                      "SAQ quality of life", "SAQ stability", "SAQ treatment satisfaction", 
                                      "EQ-5D score", "EQ-5D VAS"), 
                              est=c(standardise_est(fit=lm(saq_summ ~ trtgrp + saq_summ_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_summ_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                    standardise_est(fit=lm(saq_af ~ trtgrp + saq_af_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_af_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                    standardise_est(fit=lm(saq_pl ~ trtgrp + saq_pl_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_pl_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"),
                                    standardise_est(fit=lm(saq_ql ~ trtgrp + saq_ql_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_ql_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                    standardise_est(fit=lm(saq_st ~ trtgrp + saq_st_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_st_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                    standardise_est(fit=lm(saq_ts ~ trtgrp + saq_ts_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_ts_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                    standardise_est(fit=lm(eq5d_score ~ trtgrp + eq5d_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$eq5d_score_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est"), 
                                    standardise_est(fit=lm(eq5d_health ~ trtgrp + eq5d_health_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$eq5d_health_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="est")
                              ), 
                              lcl=c(standardise_est(fit=lm(saq_summ ~ trtgrp + saq_summ_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_summ_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                    standardise_est(fit=lm(saq_af ~ trtgrp + saq_af_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_af_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                    standardise_est(fit=lm(saq_pl ~ trtgrp + saq_pl_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_pl_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"),
                                    standardise_est(fit=lm(saq_ql ~ trtgrp + saq_ql_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_ql_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                    standardise_est(fit=lm(saq_st ~ trtgrp + saq_st_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_st_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                    standardise_est(fit=lm(saq_ts ~ trtgrp + saq_ts_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_ts_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                    standardise_est(fit=lm(eq5d_score ~ trtgrp + eq5d_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$eq5d_score_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl"), 
                                    standardise_est(fit=lm(eq5d_health ~ trtgrp + eq5d_health_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$eq5d_health_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="lcl")), 
                              ucl=c(standardise_est(fit=lm(saq_summ ~ trtgrp + saq_summ_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_summ_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                    standardise_est(fit=lm(saq_af ~ trtgrp + saq_af_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_af_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                    standardise_est(fit=lm(saq_pl ~ trtgrp + saq_pl_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_pl_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"),
                                    standardise_est(fit=lm(saq_ql ~ trtgrp + saq_ql_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_ql_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                    standardise_est(fit=lm(saq_st ~ trtgrp + saq_st_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_st_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                    standardise_est(fit=lm(saq_ts ~ trtgrp + saq_ts_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$saq_ts_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                    standardise_est(fit=lm(eq5d_score ~ trtgrp + eq5d_score_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$eq5d_score_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"), 
                                    standardise_est(fit=lm(eq5d_health ~ trtgrp + eq5d_health_bl + rdesex + age + rdedia + rdepmi + rdecadr + rdelvsd + site_simple, 
                                                           data=outcomes[outcomes$visittypeid==4,]), 
                                                    change=outcomes$eq5d_health_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], term=2, out="ucl"))
)
std_est_dat_12m$names <- factor(std_est_dat_12m$names, levels=rev(c("SAQ summary score", "SAQ angina frequency", "SAQ physical limitation", 
                                                                    "SAQ quality of life", "SAQ stability", "SAQ treatment satisfaction", 
                                                                    "EQ-5D score", "EQ-5D VAS")))
fig.set(fig.num="8", fig.path=figure.path)
ggplot(data=std_est_dat_12m, aes(x=est, y=names)) +
  geom_point(size=2)+geom_errorbarh(aes(xmin=lcl, xmax=ucl), height=0)+
  theme_bw()+geom_vline(xintercept=0, linetype="dashed", colour="blue")+
  xlab("Effect")+ylab("Outcome")+ggtitle("Standardised intervention effect estimates and 95% CIs:\nbaseline to 12 months")
dev.off()

figtab8 <- list(head=rbindTable(list(Text="<b>Figure 8: Forest plot of standardised intervention effect estimates and 95% CIs: baseline to 12 months.</b>"), 
                                list(Text="Effect estimates and corresponding confidence intervals have been standardised via dividing by the standard deviation of the change in outcome in the control population.")), 
                body=rbindTable(fig.tag(fig.num="8"), 
                                end.row())
)
ExportTable.HTML(figtab8$head, figtab8$body, filename=figure.file, horiz.fmt, first=F, last=F)

#### TABLES AS IN CORCTCA PUBLICATION ####
#### OUTPUTS ####
# define output files
datetime<-gsub(" ","_",date())
datetime<-gsub(":","_",datetime)
manuscript.file <- paste0(out.path, "/Tables/", project.name, "_", analysis.name, "_ManuscriptTables_", Version, "_", gsub("-","",Sys.Date()),"_",substring(datetime,12,13),substring(datetime,15,16), ".doc")

#### Title Pages ####
snapshot.date.text <- "05/07/2025"
# Tables
ExportTable.HTML(
  as.Table(list(Text=project.name,Style=list("font-size"=16))),
  rbindTable(
    "",
    as.Table(list(Text=paste("<b>",project.title,"</b>"),Style=list("font-size"=14))),
    "",
    paste("Final Analysis: Manuscript Tables"),
    "",
    paste("Based on a snapshot of the study database, taken on",snapshot.date.text),
    "",
    paste("Program run by",stats.name,"on",substring(date(),1,10)),
    "",
    "Robertson Centre for Biostatistics",
    "",
    "For further information about the data collected in the study eCRF, see:",
    "",
    paste("<a href='",demo.url,"'>Demo eCRF</a>",sep=""),
    "",
    paste("Login: '",demo.login,"'",sep=""),
    paste("Password: '",demo.password,"'",sep="")),
  none.fmt,manuscript.file,T,F,T)
#### MANUSCRIPT TABLES OUTPUT ####
tab1 <- list(head=rbindTable(
  list(Text="<b>Table 1: Baseline demographic and clinical characteristics of the randomised population.</b>", Other=list(colspan=4)),
  cbindTable("Characteristic", 
             paste0("All<br>N=", nrow(outcomes[outcomes$visittypeid==1,])), 
             paste0("Control<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Control",])),  
             paste0("Intervention<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Intervention",])) 
  )), 
  body=rbindTable(
    list(Text="<i>Demographics</i>", Other=list(colspan=4)),
    cbindTable("Age (years), Mean (SD)", summary.fun(screening$age[screening$randyn=="Yes"], summary.text="@MEAN (@SD)"), 
               summary.fun(screening$age[screening$randyn=="Yes" & screening$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
               summary.fun(screening$age[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], summary.text="@MEAN (@SD)")), 
    cbindTable("Sex", "", "", ""),
    cbindTable("Male, n (%)", npc.factor(screening$sex[screening$randyn=="Yes"], x.levels="Male"), 
               npc.factor(screening$sex[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Male"), 
               npc.factor(screening$sex[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Male")),
    cbindTable("Female, n (%)", npc.factor(screening$sex[screening$randyn=="Yes"], x.levels="Female"), 
               npc.factor(screening$sex[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Female"), 
               npc.factor(screening$sex[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Female")),
    cbindTable("Ethnicity", "", "", ""),
    cbindTable("White, n (%)", npc.factor(screening$ethnic_simple[screening$randyn=="Yes"], x.levels="White"), 
               npc.factor(screening$ethnic_simple[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="White"), 
               npc.factor(screening$ethnic_simple[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="White")),
    cbindTable("Asian, n (%)", npc.factor(screening$ethnic_simple[screening$randyn=="Yes"], x.levels="Asian"), 
               npc.factor(screening$ethnic_simple[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Asian"), 
               npc.factor(screening$ethnic_simple[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Asian")),
    cbindTable("Black, n (%)", npc.factor(screening$ethnic_simple[screening$randyn=="Yes"], x.levels="Black"), 
               npc.factor(screening$ethnic_simple[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Black"), 
               npc.factor(screening$ethnic_simple[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Black")),
    cbindTable("BMI (kg/m<sup>2</sup>), Mean (SD)", summary.fun(screening$qr3bmi[screening$randyn=="Yes"], summary.text="@MEAN (@SD)"), 
               summary.fun(screening$qr3bmi[screening$randyn=="Yes" & screening$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
               summary.fun(screening$qr3bmi[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], summary.text="@MEAN (@SD)")), 
    cbindTable("BMI &ge; 30 kg/m<sup>2</sup>, n (%)", npc.factor(screening$bmi_30plus[screening$randyn=="Yes"], x.levels="Yes"), 
               npc.factor(screening$bmi_30plus[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Yes"), 
               npc.factor(screening$bmi_30plus[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Yes")),
    cbindTable("Waist circumference (cm), Mean (SD)", summary.fun(outcomes$waist[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$waist[outcomes$randyn=="Yes" & outcomes$visittypeid==1 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$waist[outcomes$randyn=="Yes" & outcomes$visittypeid==1 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)")), 
    cbindTable("Smoking status", "", "", ""),
    cbindTable("Current smoker, n (%)", npc.factor(screening$smoking_simple[screening$randyn=="Yes"], x.levels="Current smoker"), 
               npc.factor(screening$smoking_simple[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Current smoker"), 
               npc.factor(screening$smoking_simple[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Current smoker")),
    cbindTable("Former smoker, n (%)", npc.factor(screening$smoking_simple[screening$randyn=="Yes"], x.levels="Former smoker"), 
               npc.factor(screening$smoking_simple[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Former smoker"), 
               npc.factor(screening$smoking_simple[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Former smoker")),
    cbindTable("Never smoked, n (%)", npc.factor(screening$smoking_simple[screening$randyn=="Yes"], x.levels="Never smoked"), 
               npc.factor(screening$smoking_simple[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Never smoked"), 
               npc.factor(screening$smoking_simple[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Never smoked")),
    cbindTable("Previous coronary angiogram, n (%)", npc.factor(screening$corang[screening$randyn=="Yes"], x.levels="Yes"), 
               npc.factor(screening$corang[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Yes"), 
               npc.factor(screening$corang[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Yes")),
    cbindTable("Previous percutaneous coronary Control, n (%)", npc.factor(screening$pci[screening$randyn=="Yes"], x.levels="Yes"), 
               npc.factor(screening$pci[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Yes"), 
               npc.factor(screening$pci[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Yes")),
    cbindTable("Previous myocardial infarction, n (%)", npc.factor(screening$myoinf[screening$randyn=="Yes"], x.levels="Yes"), 
               npc.factor(screening$myoinf[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Yes"), 
               npc.factor(screening$myoinf[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Yes")),
    cbindTable("Previous stroke or transient ischaemic attack, n (%)", npc.factor(screening$stroke[screening$randyn=="Yes"], x.levels="Yes"), 
               npc.factor(screening$stroke[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Yes"), 
               npc.factor(screening$stroke[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Yes")),
    cbindTable("Hospitalisation for chest pain, n (%)", npc.factor(screening$cphosp[screening$randyn=="Yes"], x.levels="Yes"), 
               npc.factor(screening$cphosp[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Yes"), 
               npc.factor(screening$cphosp[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Yes")),
    cbindTable("History of valve disease, n (%)", npc.factor(screening$valvdis[screening$randyn=="Yes"], x.levels="Yes"), 
               npc.factor(screening$valvdis[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Yes"), 
               npc.factor(screening$valvdis[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Yes")),
    cbindTable("Hypertension, n (%)", npc.factor(screening$hyperten[screening$randyn=="Yes"], x.levels="Yes"), 
               npc.factor(screening$hyperten[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Yes"), 
               npc.factor(screening$hyperten[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Yes")),
    cbindTable("Diabetes, n (%)", npc.factor(screening$diab[screening$randyn=="Yes"], x.levels="Yes"), 
               npc.factor(screening$diab[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Yes"), 
               npc.factor(screening$diab[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Yes")),
    cbindTable("Atrial fibrillation, n (%)", npc.factor(screening$afib[screening$randyn=="Yes"], x.levels="Yes"), 
               npc.factor(screening$afib[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Yes"), 
               npc.factor(screening$afib[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Yes")),
    cbindTable("COPD, n (%)", npc.factor(screening$copd[screening$randyn=="Yes"], x.levels="Yes"), 
               npc.factor(screening$copd[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Yes"), 
               npc.factor(screening$copd[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Yes")),
    cbindTable("SBP (mmHg), Mean (SD)", summary.fun(outcomes$sbp_avg[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$sbp_avg[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$sbp_avg[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)")), 
    cbindTable("DBP (mmHg), Mean (SD)", summary.fun(outcomes$dbp_avg[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$dbp_avg[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$dbp_avg[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)")), 
    cbindTable("Charlson comorbidity index, Mean (SD)", summary.fun(screening$charlson_sc[screening$randyn=="Yes"], summary.text="@MEAN (@SD)"), 
               summary.fun(screening$charlson_sc[screening$randyn=="Yes" & screening$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
               summary.fun(screening$charlson_sc[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], summary.text="@MEAN (@SD)")), 
    cbindTable("QRISK3 predicted 10-year risk of MI or stroke, Mean (SD)", summary.fun(screening$qr3risksc_calc[screening$randyn=="Yes"], summary.text="@MEAN (@SD)"), 
               summary.fun(screening$qr3risksc_calc[screening$randyn=="Yes" & screening$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
               summary.fun(screening$qr3risksc_calc[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], summary.text="@MEAN (@SD)")), 
    cbindTable("Preventative therapy", "", "", ""),
    cbindTable("Aspirin, n (%)", npc.factor(outcomes$asp[outcomes$randyn=="Yes" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$asp[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$asp[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], x.levels="Yes")), 
    cbindTable("Statin, n (%)", npc.factor(outcomes$stat[outcomes$randyn=="Yes" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$stat[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$stat[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], x.levels="Yes")), 
    cbindTable("Ezetimibe, n (%)", npc.factor(outcomes$ezem[outcomes$randyn=="Yes" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$ezem[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$ezem[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], x.levels="Yes")), 
    cbindTable("ACE inhibitor, n (%)", npc.factor(outcomes$ace[outcomes$randyn=="Yes" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$ace[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$ace[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], x.levels="Yes")), 
    cbindTable("ARB, n (%)", npc.factor(outcomes$arb[outcomes$randyn=="Yes" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$arb[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$arb[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], x.levels="Yes")), 
    cbindTable("Angina medication", "", "", ""),
    cbindTable("Beta blocker, n (%)", npc.factor(outcomes$beta[outcomes$randyn=="Yes" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$beta[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$beta[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], x.levels="Yes")), 
    cbindTable("Calcium channel blocker, n (%)", npc.factor(outcomes$ccb_any[outcomes$randyn=="Yes" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$ccb_any[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$ccb_any[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], x.levels="Yes")), 
    cbindTable("Nitrates, n (%)", npc.factor(outcomes$nitr[outcomes$randyn=="Yes" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$nitr[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$nitr[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], x.levels="Yes")), 
    cbindTable("Nicorandil, n (%)", npc.factor(outcomes$nico[outcomes$randyn=="Yes" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$nico[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], x.levels="Yes"), 
               npc.factor(outcomes$nico[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], x.levels="Yes")), 
    cbindTable("GTN spray, n (%)", npc.factor(outcomes$gtn[outcomes$randyn=="Yes" & outcomes$visittypeid==1 & outcomes$gtn_type=="Spray"], x.levels="Yes"), 
               npc.factor(outcomes$gtn[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1 & outcomes$gtn_type=="Spray"], x.levels="Yes"), 
               npc.factor(outcomes$gtn[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1 & outcomes$gtn_type=="Spray"], x.levels="Yes")), 
    list(Text="<i>Clinical characteristics</i>", Other=list(colspan=4)),
    cbindTable("Cholesterol and lipid profile", "", "", ""),
    cbindTable("Total cholesterol (mmol/L), Mean (SD)", summary.fun(outcomes$sbl_totchol[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$sbl_totchol[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$sbl_totchol[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)")), 
    cbindTable("HDL cholesterol (mmol/L), Median [Q1, Q3]", summary.fun(outcomes$sbl_hdl[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]"), 
               summary.fun(outcomes$sbl_hdl[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]"), 
               summary.fun(outcomes$sbl_hdl[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]")), 
    cbindTable("LDL cholesterol (mmol/L), Median [Q1, Q3]", summary.fun(outcomes$sbl_ldl[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]"), 
               summary.fun(outcomes$sbl_ldl[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]"), 
               summary.fun(outcomes$sbl_ldl[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]")), 
    cbindTable("Triglycerides (mmol/L), Median [Q1, Q3]", summary.fun(outcomes$sbl_trig[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]"), 
               summary.fun(outcomes$sbl_trig[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]"), 
               summary.fun(outcomes$sbl_trig[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]")), 
    cbindTable("HbA1C, Median [Q1, Q3]", summary.fun(outcomes$sbl_hba1c[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]"), 
               summary.fun(outcomes$sbl_hba1c[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]"), 
               summary.fun(outcomes$sbl_hba1c[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]")), 
    cbindTable("Canadian Cardiovascular Society angina class", "", "", ""),
    cbindTable("Class 0: asymptomatic angina, n (%)", npc.factor(screening$angina_ccs[screening$randyn=="Yes"], x.levels="Class 0: Asymptomatic Angina"), 
               npc.factor(screening$angina_ccs[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Class 0: Asymptomatic Angina"), 
               npc.factor(screening$angina_ccs[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Class 0: Asymptomatic Angina")),
    cbindTable("Class I: angina with strenuous exertion, n (%)", npc.factor(screening$angina_ccs[screening$randyn=="Yes"], x.levels="Class I: Angina only with strenuous exertion"), 
               npc.factor(screening$angina_ccs[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Class I: Angina only with strenuous exertion"), 
               npc.factor(screening$angina_ccs[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Class I: Angina only with strenuous exertion")),
    cbindTable("Class II: angina with moderate exertion, n (%)", npc.factor(screening$angina_ccs[screening$randyn=="Yes"], x.levels="Class II: Angina with moderate exertion"), 
               npc.factor(screening$angina_ccs[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Class II: Angina with moderate exertion"), 
               npc.factor(screening$angina_ccs[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Class II: Angina with moderate exertion")),
    cbindTable("Class III: angina with mild exertion, n (%)", npc.factor(screening$angina_ccs[screening$randyn=="Yes"], x.levels="Class III: Angina with mild exertion"), 
               npc.factor(screening$angina_ccs[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Class III: Angina with mild exertion"), 
               npc.factor(screening$angina_ccs[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Class III: Angina with mild exertion")),
    cbindTable("Class IV: angina at rest, n (%)", npc.factor(screening$angina_ccs[screening$randyn=="Yes"], x.levels="Class IV:  Angina at rest"), 
               npc.factor(screening$angina_ccs[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Class IV:  Angina at rest"), 
               npc.factor(screening$angina_ccs[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Class IV:  Angina at rest")),
    cbindTable("Rose Angina Questionnaire", "", "", ""),
    cbindTable("Rose Angina, n (%)", npc.factor(outcomes$raq_angina[outcomes$randyn=="Yes" & outcomes$visittypeid==1], x.levels="Angina"), 
               npc.factor(outcomes$raq_angina[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], x.levels="Angina"), 
               npc.factor(outcomes$raq_angina[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], x.levels="Angina")), 
    cbindTable("Rose Angina Grade I, n (%)", npc.factor(outcomes$raq_angina_sev[outcomes$randyn=="Yes" & outcomes$visittypeid==1], x.levels="Grade I"), 
               npc.factor(outcomes$raq_angina_sev[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], x.levels="Grade I"), 
               npc.factor(outcomes$raq_angina_sev[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], x.levels="Grade I")), 
    cbindTable("Rose Angina Grade II, n (%)", npc.factor(outcomes$raq_angina_sev[outcomes$randyn=="Yes" & outcomes$visittypeid==1], x.levels="Grade II"), 
               npc.factor(outcomes$raq_angina_sev[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], x.levels="Grade II"), 
               npc.factor(outcomes$raq_angina_sev[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], x.levels="Grade II")), 
    list(Text="<i>Seattle Angina Questionnaire</i>", Other=list(colspan=4)), 
    cbindTable("SAQ summary, Mean (SD)", summary.fun(outcomes$saq_summ[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$saq_summ[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$saq_summ[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)")), 
    cbindTable("SAQ angina frequency, Mean (SD)", summary.fun(outcomes$saq_af[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$saq_af[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$saq_af[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)")), 
    cbindTable("SAQ physical limitation, Mean (SD)", summary.fun(outcomes$saq_pl[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$saq_pl[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$saq_pl[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)")), 
    cbindTable("SAQ quality of life, Mean (SD)", summary.fun(outcomes$saq_ql[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$saq_ql[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$saq_ql[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)")), 
    cbindTable("SAQ stability, Mean (SD)", summary.fun(outcomes$saq_st[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$saq_st[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$saq_st[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)")), 
    cbindTable("SAQ treatment satisfaction, Mean (SD)", summary.fun(outcomes$saq_ts[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$saq_ts[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$saq_ts[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)")), 
    list(Text="<i>Quality of life (EQ-5D-5L)</i>", Other=list(colspan=4)), 
    cbindTable("Index score, Mean (SD)", summary.fun(outcomes$eq5d_score[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$eq5d_score[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
               summary.fun(outcomes$eq5d_score[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)")), 
    cbindTable("Visual Analogue Scale, Median [Q1, Q3]", summary.fun(outcomes$eq5d_health[outcomes$randyn=="Yes" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]"), 
               summary.fun(outcomes$eq5d_health[outcomes$randyn=="Yes" & outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]"), 
               summary.fun(outcomes$eq5d_health[outcomes$randyn=="Yes" & outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEDIAN [@LQ, @UQ]")),
    list(Text="<i>Non-invasive diagnostic stress testing</i>", Other=list(colspan=4)), 
    cbindTable("Any stress testing performed, n (%)", npc.factor(screening$str_perf[screening$randyn=="Yes"], x.levels="Yes"), 
               npc.factor(screening$str_perf[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Yes"), 
               npc.factor(screening$str_perf[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Yes")),
    cbindTable("Treadmill stress testing performed, n (%)", npc.factor(screening$trd_perf[screening$randyn=="Yes" & screening$str_perf=="Yes"], x.levels="Yes"), 
               npc.factor(screening$trd_perf[screening$randyn=="Yes" & screening$trtgrp=="Control" & screening$str_perf=="Yes"], x.levels="Yes"), 
               npc.factor(screening$trd_perf[screening$randyn=="Yes" & screening$trtgrp=="Intervention" & screening$str_perf=="Yes"], x.levels="Yes")),
    cbindTable("Abnormal treadmill stress testing results, n (%)", npc.factor(screening$trd_res[screening$randyn=="Yes" & screening$str_perf=="Yes" & screening$trd_perf=="Yes"], x.levels="Abnormal"), 
               npc.factor(screening$trd_res[screening$randyn=="Yes" & screening$trtgrp=="Control" & screening$str_perf=="Yes" & screening$trd_perf=="Yes"], x.levels="Abnormal"), 
               npc.factor(screening$trd_res[screening$randyn=="Yes" & screening$trtgrp=="Intervention" & screening$str_perf=="Yes" & screening$trd_perf=="Yes"], x.levels="Abnormal")),
    cbindTable("Stress SPECT performed, n (%)", npc.factor(screening$strspect_perf[screening$randyn=="Yes" & screening$str_perf=="Yes"], x.levels="Yes"), 
               npc.factor(screening$strspect_perf[screening$randyn=="Yes" & screening$trtgrp=="Control" & screening$str_perf=="Yes"], x.levels="Yes"), 
               npc.factor(screening$strspect_perf[screening$randyn=="Yes" & screening$trtgrp=="Intervention" & screening$str_perf=="Yes"], x.levels="Yes")),
    cbindTable("Abnormal stress SPECT results, n (%)", npc.factor(screening$strspect_res[screening$randyn=="Yes" & screening$str_perf=="Yes" & screening$strspect_perf=="Yes"], x.levels="Abnormal"), 
               npc.factor(screening$strspect_res[screening$randyn=="Yes" & screening$trtgrp=="Control" & screening$str_perf=="Yes" & screening$strspect_perf=="Yes"], x.levels="Abnormal"), 
               npc.factor(screening$strspect_res[screening$randyn=="Yes" & screening$trtgrp=="Intervention" & screening$str_perf=="Yes" & screening$strspect_perf=="Yes"], x.levels="Abnormal")),
    cbindTable("Stress echocardiogram performed, n (%)", npc.factor(screening$strecho_perf[screening$randyn=="Yes" & screening$str_perf=="Yes"], x.levels="Yes"), 
               npc.factor(screening$strecho_perf[screening$randyn=="Yes" & screening$trtgrp=="Control" & screening$str_perf=="Yes"], x.levels="Yes"), 
               npc.factor(screening$strecho_perf[screening$randyn=="Yes" & screening$trtgrp=="Intervention" & screening$str_perf=="Yes"], x.levels="Yes")),
    cbindTable("Abnormal stress echocardiogram results, n (%)", npc.factor(screening$strecho_res[screening$randyn=="Yes" & screening$str_perf=="Yes" & screening$strecho_perf=="Yes"], x.levels="Abnormal"), 
               npc.factor(screening$strecho_res[screening$randyn=="Yes" & screening$trtgrp=="Control" & screening$str_perf=="Yes" & screening$strecho_perf=="Yes"], x.levels="Abnormal"), 
               npc.factor(screening$strecho_res[screening$randyn=="Yes" & screening$trtgrp=="Intervention" & screening$str_perf=="Yes" & screening$strecho_perf=="Yes"], x.levels="Abnormal")),
    list(Text="<i>Coronary CTA</i>", Other=list(colspan=4)),
    cbindTable("Coronary CTA performed, n (%)", npc.factor(screening$ctca_perf[screening$randyn=="Yes"], x.levels="Yes"), 
               npc.factor(screening$ctca_perf[screening$randyn=="Yes" & screening$trtgrp=="Control"], x.levels="Yes"), 
               npc.factor(screening$ctca_perf[screening$randyn=="Yes" & screening$trtgrp=="Intervention"], x.levels="Yes")),
    cbindTable("cCTA normal, n (%)", npc.factor(screening$ctca_res[screening$randyn=="Yes" & screening$ctca_perf=="Yes"], x.levels="Normal (no coronary artery disease)"), 
               npc.factor(screening$ctca_res[screening$randyn=="Yes" & screening$trtgrp=="Control" & screening$ctca_perf=="Yes"], x.levels="Normal (no coronary artery disease)"), 
               npc.factor(screening$ctca_res[screening$randyn=="Yes" & screening$trtgrp=="Intervention" & screening$ctca_perf=="Yes"], x.levels="Normal (no coronary artery disease)")),
    cbindTable("Intermediate coronary artery disease, n (%)", npc.factor(screening$ctca_res[screening$randyn=="Yes" & screening$ctca_perf=="Yes"], x.levels="Coronary artery disease: intermediate severity"), 
               npc.factor(screening$ctca_res[screening$randyn=="Yes" & screening$trtgrp=="Control" & screening$ctca_perf=="Yes"], x.levels="Coronary artery disease: intermediate severity"), 
               npc.factor(screening$ctca_res[screening$randyn=="Yes" & screening$trtgrp=="Intervention" & screening$ctca_perf=="Yes"], x.levels="Coronary artery disease: intermediate severity")),
    cbindTable("Obstructive coronary artery disease, n (%)", npc.factor(screening$ctca_res[screening$randyn=="Yes" & screening$ctca_perf=="Yes"], x.levels="Coronary artery disease: obstructive"), 
               npc.factor(screening$ctca_res[screening$randyn=="Yes" & screening$trtgrp=="Control" & screening$ctca_perf=="Yes"], x.levels="Coronary artery disease: obstructive"), 
               npc.factor(screening$ctca_res[screening$randyn=="Yes" & screening$trtgrp=="Intervention" & screening$ctca_perf=="Yes"], x.levels="Coronary artery disease: obstructive")),
    end.row()
  )
)
ExportTable.HTML(tab1$head, tab1$body, horiz.fmt, manuscript.file, first=F, last=F)

diagnoses$macce <- sae_coded$macce[match(diagnoses$sno, sae_coded$sno)]
diagnoses$macce[is.na(diagnoses$macce)] <- "No"
diagnoses$mace <- sae_coded$mace[match(diagnoses$sno, sae_coded$sno)]
diagnoses$mace[is.na(diagnoses$mace)] <- "No"
diagnoses$dth <- "No"
diagnoses$dth <- factor(diagnoses$dth, levels=c("Yes", "No"))
diagnoses$mi <- factor(is.element(diagnoses$sno, saes$sno[saes$diagnosis=="Myocardial infarction"]), levels=c(T, F), labels=c("Yes", "No"))
diagnoses$tia <- factor(is.element(diagnoses$sno, saes$sno[saes$diagnosis=="TIA"]), levels=c(T, F), labels=c("Yes", "No"))
diagnoses$saehosp <- factor(is.element(diagnoses$sno, saes$sno[saes$ser_hosp=="Yes"]), levels=c(T, F), labels=c("Yes", "No"))
diagnoses$saehospdur <- saes$hospduration[match(diagnoses$sno, saes$sno)]
diagnoses$card_ae <- factor(is.element(diagnoses$sno, aes$sno[aes$aetype=="Cardiac"]), levels=c(T, F), labels=c("Yes", "No"))
diagnoses$count_cardiac <- aes$count_cardiac[match(diagnoses$sno, aes$sno)]
# diag2: "working" diagnosis after MRI. 
# this is the MRI diagnosis in the intervention group, clinician questionnaire diagnosis in the control group as MRI is blinded 
diagnoses$diag2 <- factor(ifelse(diagnoses$trtgrp=="Control", diagnoses$clinq_diag, diagnoses$mridiag), levels=c(1:5), 
                          labels=c("Obstructive CAD", "Microvascular angina", "Vasospastic angina", "Non-cardiac chest pain", "Other"))
# if diag2 and mridiag don't match, there has been a missed diagnosis since diag2 is the one disclosed to the patient
diagnoses$missed_diag <- factor(ifelse(diagnoses$diag2==diagnoses$mridiag, "No", "Yes"), levels=c("Yes", "No"))
# a change in diagnosis is not observed in the control group as their MRI diagnosis is blinded
diagnoses$diag_change_obs <- factor(ifelse(diagnoses$trtgrp=="Control", 1, diagnoses$diag_changed), levels=c(1,2), labels=c("No", "Yes"))

tab2 <- list(head=
               rbindTable(list(Text="<b>Table 2: Non-invasive coronary endotyping in the randomised population.</b>", Other=list(colspan=5)), 
                          list(Text="P-values are all two-sided, and are from the Fisher's Exact test for categorical variables, or the Mann-Whitney U test for continuous variables.", Other=list(colspan=5)),
                          cbindTable("", 
                                     paste0("All<br>N=", nrow(outcomes[outcomes$visittypeid==1,])), 
                                     paste0("Control<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Control",])),  
                                     paste0("Intervention<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Intervention",])), 
                                     "p-value"
                          )
                          ), 
             body=
               rbindTable(list(Text="<i>CMR imaging</i>", Other=list(colspan=5)), 
                          cbindTable("CMR performed, n (%)", npc.factor(!is.na(mri$cardiac_lvef[!is.na(mri$trtgrp)]), x.levels=T), 
                                     npc.factor(!is.na(mri$cardiac_lvef[!is.na(mri$trtgrp) & mri$trtgrp=="Control"]), x.levels=T), 
                                     npc.factor(!is.na(mri$cardiac_lvef[!is.na(mri$trtgrp) & mri$trtgrp=="Intervention"]), x.levels=T), ""), 
                          cbindTable("Left ventricular ejection fraction (%), Mean (SD)", summary.fun(mri$cardiac_lvef[!is.na(mri$trtgrp)], summary.text="@MEAN (@SD)"),
                                     summary.fun(mri$cardiac_lvef[!is.na(mri$trtgrp) & mri$trtgrp=="Control"], summary.text="@MEAN (@SD)"),
                                     summary.fun(mri$cardiac_lvef[!is.na(mri$trtgrp) & mri$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), ""), 
                          cbindTable("Abnormal late gadolinium enhancement, n (%)", npc.factor(mri$cardiac_abnormlge[!is.na(mri$trtgrp)], x.levels="Yes"),
                                     npc.factor(mri$cardiac_abnormlge[!is.na(mri$trtgrp) & mri$trtgrp=="Control"], x.levels="Yes"),
                                     npc.factor(mri$cardiac_abnormlge[!is.na(mri$trtgrp) & mri$trtgrp=="Intervention"], x.levels="Yes"), ""), 
                          cbindTable("Ischaemic LGE, n (%)", npc.factor(mri$cardiac_lgepattern[!is.na(mri$trtgrp) & mri$cardiac_abnormlge=="Yes"], x.levels="Ischaemic"),
                                     npc.factor(mri$cardiac_lgepattern[!is.na(mri$trtgrp) & mri$trtgrp=="Control" & mri$cardiac_abnormlge=="Yes"], x.levels="Ischaemic"),
                                     npc.factor(mri$cardiac_lgepattern[!is.na(mri$trtgrp) & mri$trtgrp=="Intervention" & mri$cardiac_abnormlge=="Yes"], x.levels="Ischaemic"), ""), 
                          cbindTable("Non-ischaemic LGE, n (%)", npc.factor(mri$cardiac_lgepattern[!is.na(mri$trtgrp) & mri$cardiac_abnormlge=="Yes"], x.levels="Non-ischaemic"),
                                     npc.factor(mri$cardiac_lgepattern[!is.na(mri$trtgrp) & mri$trtgrp=="Control" & mri$cardiac_abnormlge=="Yes"], x.levels="Non-ischaemic"),
                                     npc.factor(mri$cardiac_lgepattern[!is.na(mri$trtgrp) & mri$trtgrp=="Intervention" & mri$cardiac_abnormlge=="Yes"], x.levels="Non-ischaemic"), ""), 
                          cbindTable("LGE pattern missing, n (%)", npc.factor(is.na(mri$cardiac_lgepattern[!is.na(mri$trtgrp) & mri$cardiac_abnormlge=="Yes"]), x.levels=T), 
                                     npc.factor(is.na(mri$cardiac_lgepattern[!is.na(mri$trtgrp) & mri$cardiac_abnormlge=="Yes" & mri$trtgrp=="Control"]), x.levels=T), 
                                     npc.factor(is.na(mri$cardiac_lgepattern[!is.na(mri$trtgrp) & mri$cardiac_abnormlge=="Yes" & mri$trtgrp=="Intervention"]), x.levels=T), ""), 
                          list(Text="<i>Myocardial perfusion imaging</i>", Other=list(colspan=5)), 
                          cbindTable("Global myocardial blood flow during stress (ml/min/g), Mean (SD)", summary.fun(mri$cardiac_strglmbf[!is.na(mri$trtgrp)], summary.text="@MEAN (@SD)"), 
                                     summary.fun(mri$cardiac_strglmbf[!is.na(mri$trtgrp) & mri$trtgrp=="Control"], summary.text="@MEAN (@SD)"),
                                     summary.fun(mri$cardiac_strglmbf[!is.na(mri$trtgrp) & mri$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), ""), 
                          cbindTable("Global MPR, Mean (SD)", summary.fun(mri$cardiac_glmpr[!is.na(mri$trtgrp)], summary.text="@MEAN (@SD)"), 
                                     summary.fun(mri$cardiac_glmpr[!is.na(mri$trtgrp) & mri$trtgrp=="Control"], summary.text="@MEAN (@SD)"),
                                     summary.fun(mri$cardiac_glmpr[!is.na(mri$trtgrp) & mri$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), ""), 
                          cbindTable("Endocardial MPR, Mean (SD)", summary.fun(mri$cardiac_enmpr[!is.na(mri$trtgrp)], summary.text="@MEAN (@SD)"), 
                                     summary.fun(mri$cardiac_enmpr[!is.na(mri$trtgrp) & mri$trtgrp=="Control"], summary.text="@MEAN (@SD)"),
                                     summary.fun(mri$cardiac_enmpr[!is.na(mri$trtgrp) & mri$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), ""), 
                          list(Text="<i>Coronary microvascular dysfunction</i>", Other=list(colspan=5)), 
                          cbindTable("Global MBF under stress < 2.25, n (%)", npc.factor(mri$strglmbf_225[!is.na(mri$trtgrp) & !is.na(mri$cardiac_strglmbf)], x.levels="Yes"),
                                     npc.factor(mri$strglmbf_225[!is.na(mri$trtgrp) & mri$trtgrp=="Control" & !is.na(mri$cardiac_strglmbf)], x.levels="Yes"),
                                     npc.factor(mri$strglmbf_225[!is.na(mri$trtgrp) & mri$trtgrp=="Intervention" & !is.na(mri$cardiac_strglmbf)], x.levels="Yes"), ""), 
                          cbindTable("Global MPR < 2.2, n (%)", npc.factor(mri$glmpr_22[!is.na(mri$trtgrp) & !is.na(mri$cardiac_glmpr)], x.levels="Yes"),
                                     npc.factor(mri$glmpr_22[!is.na(mri$trtgrp) & mri$trtgrp=="Control" & !is.na(mri$cardiac_glmpr)], x.levels="Yes"),
                                     npc.factor(mri$glmpr_22[!is.na(mri$trtgrp) & mri$trtgrp=="Intervention" & !is.na(mri$cardiac_glmpr)], x.levels="Yes"), ""), 
                          cbindTable("Endocardial MPR < 2.41, n (%)", npc.factor(mri$enmpr_241[!is.na(mri$trtgrp) & !is.na(mri$cardiac_enmpr)], x.levels="Yes"),
                                     npc.factor(mri$enmpr_241[!is.na(mri$trtgrp) & mri$trtgrp=="Control" & !is.na(mri$cardiac_enmpr)], x.levels="Yes"),
                                     npc.factor(mri$enmpr_241[!is.na(mri$trtgrp) & mri$trtgrp=="Intervention" & !is.na(mri$cardiac_enmpr)], x.levels="Yes"), ""), 
                          cbindTable(list(Text="<i>Post-angiogram, pre-randomisation endotype</i>", Other=list(colspan=4)),
                                     list(Text=p.format(fisher.test(diagnoses$clinq_diag, diagnoses$trtgrp)$p.value), Other=list(colspan=1))),
                          cbindTable("Obstructive CAD, n (%)", npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp)], x.levels="Obstructive CAD"),
                                     npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Obstructive CAD"),
                                     npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Obstructive CAD"), ""),
                          cbindTable("Microvascular angina, n (%)", npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp)], x.levels="Microvascular angina"),
                                     npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Microvascular angina"),
                                     npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Microvascular angina"), ""),
                          cbindTable("Vasospastic angina, n (%)", npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp)], x.levels="Vasospastic angina"),
                                     npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Vasospastic angina"),
                                     npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Vasospastic angina"), ""),
                          cbindTable("Non-cardiac chest pain, n (%)", npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp)], x.levels="Non-cardiac chest pain"),
                                     npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Non-cardiac chest pain"),
                                     npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Non-cardiac chest pain"), ""),
                          cbindTable("Other, n (%)", npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp)], x.levels="Other"),
                                     npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Other"),
                                     npc.factor(diagnoses$clinq_diag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Other"), ""),
                          cbindTable(list(Text="<i>Post-angiogram, post-randomisation, post-CMR endotype</i>", Other=list(colspan=4)),
                                     list(Text=p.format(fisher.test(diagnoses$mridiag, diagnoses$trtgrp)$p.value), Other=list(colspan=1))),
                          cbindTable("Obstructive CAD, n (%)", npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp)], x.levels="Obstructive CAD"),
                                     npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Obstructive CAD"),
                                     npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Obstructive CAD"), ""),
                          cbindTable("Microvascular angina, n (%)", npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp)], x.levels="Microvascular angina"),
                                     npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Microvascular angina"),
                                     npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Microvascular angina"), ""),
                          cbindTable("Vasospastic angina, n (%)", npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp)], x.levels="Vasospastic angina"),
                                     npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Vasospastic angina"),
                                     npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Vasospastic angina"), ""),
                          cbindTable("Non-cardiac chest pain, n (%)", npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp)], x.levels="Non-cardiac chest pain"),
                                     npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Non-cardiac chest pain"),
                                     npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Non-cardiac chest pain"), ""),
                          cbindTable("Other, n (%)", npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp)], x.levels="Other"),
                                     npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Other"),
                                     npc.factor(diagnoses$mridiag[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Other"), ""),
                          cbindTable(list(Text="<i>Working diagnosis following randomisation</i>", Other=list(colspan=4)),
                                     list(Text=p.format(fisher.test(diagnoses$diag2, diagnoses$trtgrp)$p.value), Other=list(colspan=1))),
                          cbindTable("Obstructive CAD, n (%)", npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp)], x.levels="Obstructive CAD"),
                                     npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Obstructive CAD"),
                                     npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Obstructive CAD"), ""),
                          cbindTable("Microvascular angina, n (%)", npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp)], x.levels="Microvascular angina"),
                                     npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Microvascular angina"),
                                     npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Microvascular angina"), ""),
                          cbindTable("Vasospastic angina, n (%)", npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp)], x.levels="Vasospastic angina"),
                                     npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Vasospastic angina"),
                                     npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Vasospastic angina"), ""),
                          cbindTable("Non-cardiac chest pain, n (%)", npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp)], x.levels="Non-cardiac chest pain"),
                                     npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Non-cardiac chest pain"),
                                     npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Non-cardiac chest pain"), ""),
                          cbindTable("Other, n (%)", npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp)], x.levels="Other"),
                                     npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Control"], x.levels="Other"),
                                     npc.factor(diagnoses$diag2[!is.na(diagnoses$trtgrp) & diagnoses$trtgrp=="Intervention"], x.levels="Other"), ""),
                          
                          end.row()
               )
)
ExportTable.HTML(tab2$head, tab2$body, horiz.fmt, manuscript.file, first=F, last=F)

tab3 <- list(
  head=
    rbindTable(list(Text="<b>Table 3: Differences between original diagnosis (based on clinical history and invasive coronary angiogram) and diagnosis based on additional MRI information. The 'final working diagnosis' is the diagnosis used to guide treatment decisions after randomisation.</b>", Other=list(colspan=9)), 
               list(Text="P-values are all two-sided, and are from the Fisher's Exact test for categorical variables, or the Mann-Whitney U test for continuous variables.", Other=list(colspan=9))
               ), 
  body=
    rbindTable(cbindTable("", "", "", list(Text="Post-CMR diagnosis", Other=list(colspan=5)), ""),
               cbindTable("", "", "", "Obstructive CAD", "Microvascular angina", "Vasospastic angina", "Non-cardiac chest pain", "Other diagnosis", "Final working diagnosis (control group)"),
               cbindTable(list(Text=paste("Control<br>N=", nrow(randomised[randomised$trtgrp=="Control",]))), 
                          "Original diagnosis", "Obstructive CAD", 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Obstructive CAD" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Obstructive CAD" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Obstructive CAD" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Microvascular angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Obstructive CAD" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Vasospastic angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Obstructive CAD" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Non-cardiac chest pain" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Obstructive CAD" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Other" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Obstructive CAD" & !is.na(diagnoses$clinq_diag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),]))
                          ), 
               cbindTable("", "", "Microvascular angina", 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Microvascular angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Obstructive CAD" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Microvascular angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Microvascular angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Microvascular angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Vasospastic angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Microvascular angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Non-cardiac chest pain" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Microvascular angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Other" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Microvascular angina" & !is.na(diagnoses$clinq_diag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),]))
                          ), 
               cbindTable("", "", "Vasospastic angina", 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Vasospastic angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Obstructive CAD" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Vasospastic angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Microvascular angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Vasospastic angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Vasospastic angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Vasospastic angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Non-cardiac chest pain" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Vasospastic angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Other" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Vasospastic angina" & !is.na(diagnoses$clinq_diag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),]))
               ), 
               cbindTable("", "", "Non-cardiac chest pain", 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Non-cardiac chest pain" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Obstructive CAD" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Non-cardiac chest pain" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Microvascular angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Non-cardiac chest pain" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Vasospastic angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Non-cardiac chest pain" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Non-cardiac chest pain" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Non-cardiac chest pain" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Other" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Non-cardiac chest pain" & !is.na(diagnoses$clinq_diag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),]))
               ), 
               cbindTable("", "", "Other", 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Other" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Obstructive CAD" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Other" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Microvascular angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Other" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Vasospastic angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Other" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Non-cardiac chest pain" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Other" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Other" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Other" & !is.na(diagnoses$clinq_diag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),]))
               ), 
               cbindTable("", "", "", 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$mridiag=="Obstructive CAD" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$mridiag=="Microvascular angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])),
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$mridiag=="Vasospastic angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$mridiag=="Non-cardiac chest pain" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$mridiag=="Other" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Control" & !is.na(diagnoses$trtgrp),])), 
                          ""
                          ),
               
               cbindTable("", "", "", "Obstructive CAD", "Microvascular angina", "Vasospastic angina", "Non-cardiac chest pain", "Other diagnosis", ""),
               cbindTable(list(Text=paste("Intervention<br>N=", nrow(randomised[randomised$trtgrp=="Intervention",]))), 
                          "Original diagnosis", "Obstructive CAD", 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Obstructive CAD" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Obstructive CAD" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Obstructive CAD" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Microvascular angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Obstructive CAD" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Vasospastic angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Obstructive CAD" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Non-cardiac chest pain" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Obstructive CAD" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Other" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Obstructive CAD" & !is.na(diagnoses$clinq_diag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),]))
               ), 
               cbindTable("", "", "Microvascular angina", 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Microvascular angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Obstructive CAD" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Microvascular angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Microvascular angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Microvascular angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Vasospastic angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Microvascular angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Non-cardiac chest pain" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Microvascular angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Other" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Microvascular angina" & !is.na(diagnoses$clinq_diag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),]))
               ), 
               cbindTable("", "", "Vasospastic angina", 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Vasospastic angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Obstructive CAD" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Vasospastic angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Microvascular angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Vasospastic angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Vasospastic angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Vasospastic angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Non-cardiac chest pain" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Vasospastic angina" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Other" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Vasospastic angina" & !is.na(diagnoses$clinq_diag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),]))
               ), 
               cbindTable("", "", "Non-cardiac chest pain", 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Non-cardiac chest pain" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Obstructive CAD" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Non-cardiac chest pain" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Microvascular angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Non-cardiac chest pain" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Vasospastic angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Non-cardiac chest pain" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Non-cardiac chest pain" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Non-cardiac chest pain" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Other" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Non-cardiac chest pain" & !is.na(diagnoses$clinq_diag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),]))
               ), 
               cbindTable("", "", "Other", 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Other" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Obstructive CAD" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Other" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Microvascular angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Other" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Vasospastic angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Other" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Non-cardiac chest pain" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Other" & !is.na(diagnoses$clinq_diag)
                                                           & diagnoses$mridiag=="Other" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$clinq_diag=="Other" & !is.na(diagnoses$clinq_diag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),]))
               ), 
               cbindTable("", "", "Final working diagnosis (intervention group)", 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$mridiag=="Obstructive CAD" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$mridiag=="Microvascular angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])),
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$mridiag=="Vasospastic angina" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$mridiag=="Non-cardiac chest pain" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          perc.from.num(num=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp)
                                                           & diagnoses$mridiag=="Other" & !is.na(diagnoses$mridiag),]), 
                                        denom=nrow(diagnoses[diagnoses$trtgrp=="Intervention" & !is.na(diagnoses$trtgrp),])), 
                          ""
               ),
               list(Text=paste("Comparison of final working diagnosis between randomized groups:", 
                               p.format(fisher.test(diagnoses$diag2, diagnoses$trtgrp)$p.value)), 
                    Other=list(colspan=9)),
               end.row()
               )
)
ExportTable.HTML(tab3$head, tab3$body, horiz.fmt, manuscript.file, first=F, last=F)

tab4 <- list(head=
               rbindTable(list(Text="<b>Table 4: Seattle Angina Questionnaire model results.</b>", Other=list(colspan=7)), 
                          list(Text=paste("In each case, a linear regression intervention effect estimate for the 6-months",
                                          "and 12-months value of the score are presented. In the original model, this estimate is adjusted for the", 
                                          "baseline value of the score, age, sex, diabetes, prior myocardial infarction, coronary", 
                                          "artery disease, LV systolic function, and site (lead vs other). In the reduced covariates model, this estimate is adjusted for the baseline value of the score only."), 
                               Other=list(colspan=7)), 
                          cbindTable("Timepoint", 
                                     list(Text=paste0("Control<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Control",])), Other=list(colspan=2)), 
                                     list(Text=paste0("Intervention<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Intervention",])), Other=list(colspan=2)), 
                                     "Original model: Estimate (95% CI), p-value", 
                                     "Reduced model: Estimate (95% CI), p-value"), 
                          cbindTable("", "Follow-up value", "Change from baseline", "Follow-up value", "Change from baseline", "", "")
                          ), 
             body=
               rbindTable(list(Text="<i>SAQ summary score</i>", Other=list(colspan=7)),
                          cbindTable("6 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$saq_summ[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_summ_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_summ[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$saq_summ_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("6 months<br>Mean (SD)", 
                                     summary.fun(outcomes$saq_summ[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_summ_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_summ[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$saq_summ_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="saq_summ", blvis="visit_1", fuvis="visit_3", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="saq_summ", blvis="visit_1", fuvis="visit_3", digits.summ=2)
                                     ),
                          cbindTable("12 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$saq_summ[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_summ_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_summ[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$saq_summ_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("12 months<br>Mean (SD)", 
                                     summary.fun(outcomes$saq_summ[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_summ_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_summ[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$saq_summ_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="saq_summ", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="saq_summ", blvis="visit_1", fuvis="visit_4", digits.summ=2)
                                     ), 
                          list(Text="<i>SAQ angina frequency score</i>", Other=list(colspan=7)),
                          cbindTable("6 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$saq_af[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_af_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_af[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$saq_af_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("6 months<br>Mean (SD)", 
                                     summary.fun(outcomes$saq_af[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_af_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_af[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$saq_af_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="saq_af", blvis="visit_1", fuvis="visit_3", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="saq_af", blvis="visit_1", fuvis="visit_3", digits.summ=2)), 
                          cbindTable("12 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$saq_af[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_af_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_af[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$saq_af_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("12 months<br>Mean (SD)", 
                                     summary.fun(outcomes$saq_af[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_af_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_af[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$saq_af_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="saq_af", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="saq_af", blvis="visit_1", fuvis="visit_4", digits.summ=2)),
                          list(Text="<i>SAQ physical limitation score</i>", Other=list(colspan=7)),
                          cbindTable("6 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$saq_pl[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_pl_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_pl[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$saq_pl_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("6 months<br>Mean (SD)", 
                                     summary.fun(outcomes$saq_pl[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_pl_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_pl[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$saq_pl_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="saq_pl", blvis="visit_1", fuvis="visit_3", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="saq_pl", blvis="visit_1", fuvis="visit_3", digits.summ=2)), 
                          cbindTable("12 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$saq_pl[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_pl_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_pl[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$saq_pl_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("12 months<br>Mean (SD)", 
                                     summary.fun(outcomes$saq_pl[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_pl_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_pl[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$saq_pl_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="saq_pl", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="saq_pl", blvis="visit_1", fuvis="visit_4", digits.summ=2)), 
                          list(Text="<i>SAQ quality of life score</i>", Other=list(colspan=7)),
                          cbindTable("6 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$saq_ql[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_ql_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_ql[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$saq_ql_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("6 months<br>Mean (SD)", 
                                     summary.fun(outcomes$saq_ql[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_ql_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_ql[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$saq_ql_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="saq_ql", blvis="visit_1", fuvis="visit_3", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="saq_ql", blvis="visit_1", fuvis="visit_3", digits.summ=2)), 
                          cbindTable("12 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$saq_ql[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_ql_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_ql[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$saq_ql_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("12 months<br>Mean (SD)", 
                                     summary.fun(outcomes$saq_ql[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_ql_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_ql[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$saq_ql_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="saq_ql", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="saq_ql", blvis="visit_1", fuvis="visit_4", digits.summ=2)), 
                          list(Text="<i>SAQ stability score</i>", Other=list(colspan=7)),
                          cbindTable("6 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$saq_st[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_st_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_st[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$saq_st_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("6 months<br>Mean (SD)", 
                                     summary.fun(outcomes$saq_st[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_st_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_st[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$saq_st_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="saq_st", blvis="visit_1", fuvis="visit_3", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="saq_st", blvis="visit_1", fuvis="visit_3", digits.summ=2)), 
                          cbindTable("12 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$saq_st[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_st_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_st[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$saq_st_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("12 months<br>Mean (SD)", 
                                     summary.fun(outcomes$saq_st[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_st_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_st[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$saq_st_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="saq_st", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="saq_st", blvis="visit_1", fuvis="visit_4", digits.summ=2)), 
                          list(Text="<i>SAQ treatment satisfaction score</i>", Other=list(colspan=7)),
                          cbindTable("6 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$saq_ts[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_ts_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_ts[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$saq_ts_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("6 months<br>Mean (SD)", 
                                     summary.fun(outcomes$saq_ts[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_ts_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_ts[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$saq_ts_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="saq_ts", blvis="visit_1", fuvis="visit_3", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="saq_ts", blvis="visit_1", fuvis="visit_3", digits.summ=2)), 
                          cbindTable("12 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$saq_ts[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_ts_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$saq_ts[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$saq_ts_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("12 months<br>Mean (SD)", 
                                     summary.fun(outcomes$saq_ts[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_ts_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$saq_ts[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$saq_ts_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="saq_ts", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="saq_ts", blvis="visit_1", fuvis="visit_4", digits.summ=2)), 
                          end.row())
             )
ExportTable.HTML(tab4$head, tab4$body, horiz.fmt, manuscript.file, first=F, last=F)

tab5 <- list(head=
               rbindTable(list(Text="<b>Table 5: Cardiovascular risk factors by randomised group.</b>", Other=list(colspan=7)),
                          list(Text=paste("In each case, a linear regression intervention effect estimate for the 6-months",
                                          "and 12-months value of the score are presented. In the original model, this estimate is adjusted for the", 
                                          "baseline value of the outcome, age, sex, diabetes, prior myocardial infarction, coronary", 
                                          "artery disease, LV systolic function, and site (lead vs other). In the reduced covariates model, this estimate is adjusted for the baseline value of the outcome only."), 
                               Other=list(colspan=7)), 
                          cbindTable("", "", "", "", "", "Original model", "Reduced model"),
                          cbindTable("Treatment group", 
                                     list(Text=paste0("Control<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Control",])), Other=list(colspan=2)), 
                                     list(Text=paste0("Intervention<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Intervention",])) , Other=list(colspan=2)), 
                                     "Estimate (95% CI), p-value", "Estimate (95% CI), p-value"), 
                          cbindTable("Timepoint", "Baseline", "12 month follow-up", "Baseline", "12 month follow-up", "", "")
                          ), 
             body=
               rbindTable(
                 cbindTable("Systolic blood pressure (mmHg), Mean (SD)", 
                            summary.fun(outcomes$sbp_avg[outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sbp_avg[outcomes$trtgrp=="Control" & outcomes$visittypeid==4], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sbp_avg[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sbp_avg[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==4], summary.text="@MEAN (@SD)"), 
                            analysis.cts.txt(xname="sbp_avg", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                            analysis.cts.txt.simple(xname="sbp_avg", blvis="visit_1", fuvis="visit_4", digits.summ=2)),
                 cbindTable("Systolic blood pressure < 130 mmHg, n (%)", 
                            npc.factor(outcomes$sbp_130[outcomes$trtgrp=="Control" & outcomes$visittypeid==1], x.levels="Yes"), 
                            npc.factor(outcomes$sbp_130[outcomes$trtgrp=="Control" & outcomes$visittypeid==4], x.levels="Yes"), 
                            npc.factor(outcomes$sbp_130[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], x.levels="Yes"), 
                            npc.factor(outcomes$sbp_130[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==4], x.levels="Yes"),
                            "", ""), 
                 cbindTable("BMI (kg/m<sup>2</sup>), Mean (SD)", 
                            summary.fun(outcomes$bmi[outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$bmi[outcomes$trtgrp=="Control" & outcomes$visittypeid==4], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$bmi[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$bmi[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==4], summary.text="@MEAN (@SD)"), 
                            analysis.cts.txt(xname="bmi", blvis="visit_1", fuvis="visit_4", digits.summ=2),
                            analysis.cts.txt.simple(xname="bmi", blvis="visit_1", fuvis="visit_4", digits.summ=2)),
                 cbindTable("BMI < 30 kg/m<sup>2</sup>, n (%)", 
                            npc.factor(outcomes$bmi_less30[outcomes$trtgrp=="Control" & outcomes$visittypeid==1], x.levels="Yes"), 
                            npc.factor(outcomes$bmi_less30[outcomes$trtgrp=="Control" & outcomes$visittypeid==4], x.levels="Yes"), 
                            npc.factor(outcomes$bmi_less30[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], x.levels="Yes"), 
                            npc.factor(outcomes$bmi_less30[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==4], x.levels="Yes"),
                            "", ""),
                 cbindTable("Waist circumference (cm), Mean (SD)", 
                            summary.fun(outcomes$waist[outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$waist[outcomes$trtgrp=="Control" & outcomes$visittypeid==4], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$waist[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$waist[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==4], summary.text="@MEAN (@SD)"), 
                            analysis.cts.txt(xname="waist", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                            analysis.cts.txt.simple(xname="waist", blvis="visit_1", fuvis="visit_4", digits.summ=2)),
                 cbindTable("Total cholesterol (mmol/L), Mean (SD)", 
                            summary.fun(outcomes$sbl_totchol[outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sbl_totchol[outcomes$trtgrp=="Control" & outcomes$visittypeid==4], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sbl_totchol[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sbl_totchol[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==4], summary.text="@MEAN (@SD)"), 
                            analysis.cts.txt(xname="sbl_totchol", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                            analysis.cts.txt.simple(xname="sbl_totchol", blvis="visit_1", fuvis="visit_4", digits.summ=2)), 
                 cbindTable("LDL cholesterol (mmol/L), Mean (SD)", 
                            summary.fun(outcomes$sbl_ldl[outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sbl_ldl[outcomes$trtgrp=="Control" & outcomes$visittypeid==4], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sbl_ldl[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sbl_ldl[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==4], summary.text="@MEAN (@SD)"), 
                            analysis.cts.txt(xname="sbl_ldl", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                            analysis.cts.txt.simple(xname="sbl_ldl", blvis="visit_1", fuvis="visit_4", digits.summ=2)), 
                 cbindTable("Triglyceride (mmol/L), Mean (SD)", 
                            summary.fun(outcomes$sbl_trig[outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sbl_trig[outcomes$trtgrp=="Control" & outcomes$visittypeid==4], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sbl_trig[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sbl_trig[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==4], summary.text="@MEAN (@SD)"), 
                            analysis.cts.txt(xname="sbl_trig", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                            analysis.cts.txt.simple(xname="sbl_trig", blvis="visit_1", fuvis="visit_4", digits.summ=2)), 
                 cbindTable("SCORE2/SCORE2-OlderPersons predicted 10-year cardiovascular risk (%), Mean (SD)", 
                            summary.fun(outcomes$sc2_sop_score[outcomes$trtgrp=="Control" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sc2_sop_score[outcomes$trtgrp=="Control" & outcomes$visittypeid==4], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sc2_sop_score[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==1], summary.text="@MEAN (@SD)"), 
                            summary.fun(outcomes$sc2_sop_score[outcomes$trtgrp=="Intervention" & outcomes$visittypeid==4], summary.text="@MEAN (@SD)"), 
                            analysis.cts.txt(xname="sc2_sop_score", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                            analysis.cts.txt.simple(xname="sc2_sop_score", blvis="visit_1", fuvis="visit_4", digits.summ=2)), 
                 end.row()
                 )
             )
ExportTable.HTML(tab5$head, tab5$body, horiz.fmt, manuscript.file, first=F, last=F)
# get a corfunctest dataset w/ everyone included instead of just those with testing performed
corfunctest <- merge(randomised[, c("sno", "trtgrp")], 
                     corfunctest, by=c("sno", "trtgrp"), all.x=T)
corfunctest$perf <- factor(!is.na(corfunctest$rfr) | !is.na(corfunctest$ffr) | !is.na(corfunctest$cfr) | !is.na(corfunctest$imr), 
                           levels=c(T,F), labels=c("Yes", "No"))
tabs1 <- list(head=
                rbindTable(list(Text="<b>Table S1: Invasive coronary angiography in the randomised population.</b>", 
                                Other=list(colspan=4)), 
                           cbindTable("", paste0("All<br>N=", nrow(outcomes[outcomes$visittypeid==1,])), 
                                      paste0("Control<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Control",])),  
                                      paste0("Intervention<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Intervention",]))) 
                           ), 
              body=
                rbindTable(list(Text="<i>Coronary angiogram</i>", Other=list(colspan=4)), 
                           cbindTable("Right coronary artery stenosis severity, n (%)", "", "", ""),
                           cbindTable(paste(levels(factor(screening$rca_stensev[!is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%"))), collapse="<br>"), 
                                      npc.factor(factor(screening$rca_stensev[!is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%"))), 
                                      npc.factor(factor(screening$rca_stensev[screening$trtgrp=="Control" & !is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%"))), 
                                      npc.factor(factor(screening$rca_stensev[screening$trtgrp=="Intervention" & !is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%")))), 
                           cbindTable("Left main coronary artery stenosis severity, n (%)", "", "", ""),
                           cbindTable(paste(levels(factor(screening$stensev5_simple1[!is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%"))), collapse="<br>"), 
                                      npc.factor(factor(screening$stensev5_simple1[!is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%"))), 
                                      npc.factor(factor(screening$stensev5_simple1[screening$trtgrp=="Control" & !is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%"))), 
                                      npc.factor(factor(screening$stensev5_simple1[screening$trtgrp=="Intervention" & !is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%")))), 
                           cbindTable("Left anterior descending coronary artery stenosis severity, n (%)", "", "", ""),
                           cbindTable(paste(levels(factor(screening$lad_stensev[!is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%"))), collapse="<br>"), 
                                      npc.factor(factor(screening$lad_stensev[!is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%"))), 
                                      npc.factor(factor(screening$lad_stensev[screening$trtgrp=="Control" & !is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%"))), 
                                      npc.factor(factor(screening$lad_stensev[screening$trtgrp=="Intervention" & !is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%")))), 
                           cbindTable("Circumflex stenosis severity, n (%)", "", "", ""),
                           cbindTable(paste(levels(factor(screening$circum_stensev[!is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%"))), collapse="<br>"), 
                                      npc.factor(factor(screening$circum_stensev[!is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%"))), 
                                      npc.factor(factor(screening$circum_stensev[screening$trtgrp=="Control" & !is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%"))), 
                                      npc.factor(factor(screening$circum_stensev[screening$trtgrp=="Intervention" & !is.na(screening$trtgrp)], levels=c("0%", "1-24%", "25-49%", "50-69%", "70-99%", "100%")))), 
                           cbindTable("Angiographically normal, n (%)", 
                                      npc.factor(screening$ang_normal[!is.na(screening$trtgrp)], x.levels="Yes"), 
                                      npc.factor(screening$ang_normal[!is.na(screening$trtgrp) & screening$trtgrp=="Control"], x.levels="Yes"), 
                                      npc.factor(screening$ang_normal[!is.na(screening$trtgrp) & screening$trtgrp=="Intervention"], x.levels="Yes")), 
                           cbindTable("Coronary dominance, n (%)", "", "", ""), 
                           cbindTable(paste(levels(screening$cordom[!is.na(screening$trtgrp)])), 
                                      npc.factor(screening$cordom[!is.na(screening$trtgrp)]), 
                                      npc.factor(screening$cordom[!is.na(screening$trtgrp) & screening$trtgrp=="Control"]), 
                                      npc.factor(screening$cordom[!is.na(screening$trtgrp) & screening$trtgrp=="Intervention"])), 
                           list(Text="<i>Invasive coronary function test</i>", Other=list(colspan=4)),
                           cbindTable("Any coronary function test performed, n (%)", 
                                      npc.factor(corfunctest$perf[!is.na(corfunctest$trtgrp)], x.levels="Yes"), 
                                      npc.factor(corfunctest$perf[!is.na(corfunctest$trtgrp) & corfunctest$trtgrp=="Control"], x.levels="Yes"),
                                      npc.factor(corfunctest$perf[!is.na(corfunctest$trtgrp) & corfunctest$trtgrp=="Intervention"], x.levels="Yes")),
                           cbindTable("Fractional flow reserve", "", "", ""), 
                           cbindTable("Nobs (Nmiss)<br>Median [Q1, Q3]", 
                                      summary.fun(corfunctest$ffr[!is.na(corfunctest$trtgrp)], summary.text="@N (@MISS)<br>@MEDIAN [@LQ, @UQ]"), 
                                      summary.fun(corfunctest$ffr[!is.na(corfunctest$trtgrp) & corfunctest$trtgrp=="Control"], summary.text="@N (@MISS)<br>@MEDIAN [@LQ, @UQ]"),
                                      summary.fun(corfunctest$ffr[!is.na(corfunctest$trtgrp) & corfunctest$trtgrp=="Intervention"], summary.text="@N (@MISS)<br>@MEDIAN [@LQ, @UQ]")), 
                           cbindTable("Index of microvascular resistance", "", "", ""), 
                           cbindTable("Nobs (Nmiss)<br>Median [Q1, Q3]", 
                                      summary.fun(corfunctest$imr[!is.na(corfunctest$trtgrp)], summary.text="@N (@MISS)<br>@MEDIAN [@LQ, @UQ]"), 
                                      summary.fun(corfunctest$imr[!is.na(corfunctest$trtgrp) & corfunctest$trtgrp=="Control"], summary.text="@N (@MISS)<br>@MEDIAN [@LQ, @UQ]"),
                                      summary.fun(corfunctest$imr[!is.na(corfunctest$trtgrp) & corfunctest$trtgrp=="Intervention"], summary.text="@N (@MISS)<br>@MEDIAN [@LQ, @UQ]")), 
                           cbindTable("Resting full-cycle ratio", "", "", ""), 
                           cbindTable("Nobs (Nmiss)<br>Median [Q1, Q3]", 
                                      summary.fun(corfunctest$rfr[!is.na(corfunctest$trtgrp)], summary.text="@N (@MISS)<br>@MEDIAN [@LQ, @UQ]"), 
                                      summary.fun(corfunctest$rfr[!is.na(corfunctest$trtgrp) & corfunctest$trtgrp=="Control"], summary.text="@N (@MISS)<br>@MEDIAN [@LQ, @UQ]"),
                                      summary.fun(corfunctest$rfr[!is.na(corfunctest$trtgrp) & corfunctest$trtgrp=="Intervention"], summary.text="@N (@MISS)<br>@MEDIAN [@LQ, @UQ]")), 
                           cbindTable("Coronary flow reserve", "", "", ""), 
                           cbindTable("Nobs (Nmiss)<br>Median [Q1, Q3]", 
                                      summary.fun(corfunctest$cfr[!is.na(corfunctest$trtgrp)], summary.text="@N (@MISS)<br>@MEDIAN [@LQ, @UQ]"), 
                                      summary.fun(corfunctest$cfr[!is.na(corfunctest$trtgrp) & corfunctest$trtgrp=="Control"], summary.text="@N (@MISS)<br>@MEDIAN [@LQ, @UQ]"),
                                      summary.fun(corfunctest$cfr[!is.na(corfunctest$trtgrp) & corfunctest$trtgrp=="Intervention"], summary.text="@N (@MISS)<br>@MEDIAN [@LQ, @UQ]")), 
                           end.row())
              )
ExportTable.HTML(tabs1$head, tabs1$body, horiz.fmt, manuscript.file, first=F, last=F)

outcomes$ttvis <- as.numeric(difftime(outcomes$visitdate, outcomes$randdate, units="days"))
tabs2 <- list(head=
               rbindTable(list(Text="<b>Table S2: Health-related quality of life model results.</b>", Other=list(colspan=7)), 
                          list(Text=paste("In each case, a linear regression intervention effect estimate for the 6-months",
                                          "and 12-months value of the score are presented. In the original model, this estimate is adjusted for the", 
                                          "baseline value of the outcome, age, sex, diabetes, prior myocardial infarction, coronary", 
                                          "artery disease, LV systolic function, and site (lead vs other). In the reduced covariates model, this estimate is adjusted for the baseline value of the outcome only."), 
                               Other=list(colspan=7)), 
                          cbindTable("", "", "", "", "", "Original model", "Reduced covariates model"),
                          cbindTable("Timepoint", 
                                     list(Text=paste0("Control<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Control",])), Other=list(colspan=2)), 
                                     list(Text=paste0("Intervention<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Intervention",])), Other=list(colspan=2)), 
                                     "Estimate (95% CI), p-value", 
                                     "Estimate (95% CI), p-value"), 
                          cbindTable("", "Follow-up value", "Change from baseline", "Follow-up value", "Change from baseline", "", "")
               ), 
             body=
               rbindTable(list(Text="<i>Time from randomisation to follow-up visit (days)</i>", Other=list(colspan=7)),
                          cbindTable("6 month visit<br>Median [Q1, Q3]", 
                                     summary.fun(outcomes$ttvis[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEDIAN [@LQ, @UQ]"), 
                                     "", 
                                     summary.fun(outcomes$ttvis[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEDIAN [@LQ, @UQ]"), 
                                     "", "", ""),
                          cbindTable("12 month visit<br>Median [Q1, Q3]", 
                                     summary.fun(outcomes$ttvis[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEDIAN [@LQ, @UQ]"), 
                                     "", 
                                     summary.fun(outcomes$ttvis[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEDIAN [@LQ, @UQ]"), 
                                     "", "", ""),
                          list(Text="<i>EQ-5D-5L health utility index</i>", Other=list(colspan=7)),
                          cbindTable("6 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$eq5d_score[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$eq5d_score_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$eq5d_score[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$eq5d_score_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("6 months<br>Mean (SD)", 
                                     summary.fun(outcomes$eq5d_score[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$eq5d_score_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$eq5d_score[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$eq5d_score_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="eq5d_score", blvis="visit_1", fuvis="visit_3", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="eq5d_score", blvis="visit_1", fuvis="visit_3", digits.summ=2)), 
                          cbindTable("12 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$eq5d_score[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$eq5d_score_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$eq5d_score[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$eq5d_score_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("12 months<br>Mean (SD)", 
                                     summary.fun(outcomes$eq5d_score[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$eq5d_score_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$eq5d_score[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$eq5d_score_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="eq5d_score", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="eq5d_score", blvis="visit_1", fuvis="visit_4", digits.summ=2)), 
                          list(Text="<i>EQ-5D-5L visual analogue scale</i>", Other=list(colspan=7)),
                          cbindTable("6 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$eq5d_health[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$eq5d_health_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$eq5d_health[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$eq5d_health_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("6 months<br>Mean (SD)", 
                                     summary.fun(outcomes$eq5d_health[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$eq5d_health_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$eq5d_health[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$eq5d_health_ch[outcomes$visittypeid==3 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="eq5d_health", blvis="visit_1", fuvis="visit_3", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="eq5d_health", blvis="visit_1", fuvis="visit_3", digits.summ=2)), 
                          cbindTable("12 months<br>Nobs (Nmiss)", 
                                     summary.fun(outcomes$eq5d_health[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$eq5d_health_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@N (@MISS)"), 
                                     summary.fun(outcomes$eq5d_health[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"),
                                     summary.fun(outcomes$eq5d_health_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@N (@MISS)"), 
                                     "", ""), 
                          cbindTable("12 months<br>Mean (SD)", 
                                     summary.fun(outcomes$eq5d_health[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$eq5d_health_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                                     summary.fun(outcomes$eq5d_health[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"),
                                     summary.fun(outcomes$eq5d_health_ch[outcomes$visittypeid==4 & outcomes$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                                     analysis.cts.txt(xname="eq5d_health", blvis="visit_1", fuvis="visit_4", digits.summ=2), 
                                     analysis.cts.txt.simple(xname="eq5d_health", blvis="visit_1", fuvis="visit_4", digits.summ=2)),
                          end.row()
               )
)
ExportTable.HTML(tabs2$head, tabs2$body, horiz.fmt, manuscript.file, first=F, last=F)

tabs3 <- list(head=
                rbindTable(
                  list(Text="<b>Table S3: Medications in the randomised population at baseline and 12 months.</b>", 
                       Other=list(colspan=5)), 
                  list(Text="Medication use is compared between randomised groups using Fisher tests.", Other=list(colspan=5)),
                  cbindTable("Medication", paste0("All<br>N=", nrow(outcomes[outcomes$visittypeid==1,])), 
                             paste0("Control<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Control",])),  
                             paste0("Intervention<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Intervention",])), 
                             "p-value")
                ), 
              body=
                rbindTable(
                  list(Text="<i>Medication at baseline</i>", Other=list(colspan=5)), 
                  cbindTable("Any preventative therapy, n (%)", 
                             npc.factor(outcomes$any_prevther[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp)], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$any_prevther[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Control"], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$any_prevther[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Intervention"], 
                                        x.levels="Yes"), 
                             p.format(fisher.test(outcomes$any_prevther[outcomes$visittypeid==1], outcomes$trtgrp[outcomes$visittypeid==1])$p.value)),
                  cbindTable("Preventative therapy: aspirin, n (%)", 
                             npc.factor(outcomes$asp[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp)], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$asp[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Control"], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$asp[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Intervention"], 
                                        x.levels="Yes"), 
                             p.format(fisher.test(outcomes$asp[outcomes$visittypeid==1], outcomes$trtgrp[outcomes$visittypeid==1])$p.value)),
                  cbindTable("Preventative therapy: statin, n (%)", 
                             npc.factor(outcomes$stat[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp)], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$stat[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Control"], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$stat[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Intervention"], 
                                        x.levels="Yes"), 
                             p.format(fisher.test(outcomes$stat[outcomes$visittypeid==1], outcomes$trtgrp[outcomes$visittypeid==1])$p.value)),
                  cbindTable("Any angina therapy, n (%)", 
                             npc.factor(outcomes$any_angther[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp)], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$any_angther[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Control"], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$any_angther[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Intervention"], 
                                        x.levels="Yes"), 
                             p.format(fisher.test(outcomes$any_angther[outcomes$visittypeid==1], outcomes$trtgrp[outcomes$visittypeid==1])$p.value)),
                  cbindTable("Angina therapy: beta blocker, n (%)", 
                             npc.factor(outcomes$beta[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp)], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$beta[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Control"], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$beta[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Intervention"], 
                                        x.levels="Yes"), 
                             p.format(fisher.test(outcomes$beta[outcomes$visittypeid==1], outcomes$trtgrp[outcomes$visittypeid==1])$p.value)),
                  cbindTable("Angina therapy: calcium-channel blocker, n (%)", 
                             npc.factor(outcomes$ccb_any[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp)], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$ccb_any[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Control"], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$ccb_any[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Intervention"], 
                                        x.levels="Yes"), 
                             p.format(fisher.test(outcomes$ccb_any[outcomes$visittypeid==1], outcomes$trtgrp[outcomes$visittypeid==1])$p.value)),
                  cbindTable("Angina therapy: nitrate, n (%)", 
                             npc.factor(outcomes$nitr[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp)], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$nitr[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Control"], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$nitr[outcomes$visittypeid==1 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Intervention"], 
                                        x.levels="Yes"), 
                             p.format(fisher.test(outcomes$nitr[outcomes$visittypeid==1], outcomes$trtgrp[outcomes$visittypeid==1])$p.value)),
                  
                  list(Text="<i>Medication at 12 months</i>", Other=list(colspan=5)), 
                  cbindTable("Any preventative therapy, n (%)", 
                             npc.factor(outcomes$any_prevther[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp)], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$any_prevther[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Control"], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$any_prevther[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Intervention"], 
                                        x.levels="Yes"), 
                             p.format(fisher.test(outcomes$any_prevther[outcomes$visittypeid==4], outcomes$trtgrp[outcomes$visittypeid==4])$p.value)),
                  cbindTable("Preventative therapy: aspirin, n (%)", 
                             npc.factor(outcomes$asp[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp)], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$asp[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Control"], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$asp[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Intervention"], 
                                        x.levels="Yes"), 
                             p.format(fisher.test(outcomes$asp[outcomes$visittypeid==4], outcomes$trtgrp[outcomes$visittypeid==4])$p.value)),
                  cbindTable("Preventative therapy: statin, n (%)", 
                             npc.factor(outcomes$stat[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp)], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$stat[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Control"], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$stat[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Intervention"], 
                                        x.levels="Yes"), 
                             p.format(fisher.test(outcomes$stat[outcomes$visittypeid==4], outcomes$trtgrp[outcomes$visittypeid==4])$p.value)),
                  cbindTable("Any angina therapy, n (%)", 
                             npc.factor(outcomes$any_angther[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp)], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$any_angther[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Control"], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$any_angther[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Intervention"], 
                                        x.levels="Yes"), 
                             p.format(fisher.test(outcomes$any_angther[outcomes$visittypeid==4], outcomes$trtgrp[outcomes$visittypeid==4])$p.value)),
                  cbindTable("Angina therapy: beta blocker, n (%)", 
                             npc.factor(outcomes$beta[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp)], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$beta[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Control"], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$beta[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Intervention"], 
                                        x.levels="Yes"), 
                             p.format(fisher.test(outcomes$beta[outcomes$visittypeid==4], outcomes$trtgrp[outcomes$visittypeid==4])$p.value)),
                  cbindTable("Angina therapy: calcium-channel blocker, n (%)", 
                             npc.factor(outcomes$ccb_any[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp)], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$ccb_any[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Control"], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$ccb_any[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Intervention"], 
                                        x.levels="Yes"), 
                             p.format(fisher.test(outcomes$ccb_any[outcomes$visittypeid==4], outcomes$trtgrp[outcomes$visittypeid==4])$p.value)),
                  cbindTable("Angina therapy: nitrate, n (%)", 
                             npc.factor(outcomes$nitr[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp)], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$nitr[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Control"], 
                                        x.levels="Yes"), 
                             npc.factor(outcomes$nitr[outcomes$visittypeid==4 & !is.na(outcomes$trtgrp) & outcomes$trtgrp=="Intervention"], 
                                        x.levels="Yes"), 
                             p.format(fisher.test(outcomes$nitr[outcomes$visittypeid==4], outcomes$trtgrp[outcomes$visittypeid==4])$p.value)),
                  end.row()
                )
              )
ExportTable.HTML(tabs3$head, tabs3$body, horiz.fmt, manuscript.file, first=F, last=F)

# table s4 matches t6.1.9 in larger report doc
tabs4 <- list(head=rbindTable(
  list(Text="<b>Table S4: Primary outcome (trial) subgroup analysis - change in diagnosis.<b>"), 
  list(Text=paste("The model for the primary outcome analysis is extended to include", 
                  "terms which estimate the interaction between treatment effect and", 
                  "subgroups defined by a change in diagnosis between the angiography and CMR.", 
                  "The interaction p-value assesses if there is an interaction effect.")),
  list(Text=paste("The original model adjusts for adjusted for baseline SAQ summary score,", 
                  "age, sex, diabetes, prior myocardial infarction, coronary artery disease,", 
                  "LV systolic function, and site (lead vs other). The reduced covariate model", 
                  "adjusts for the baseline SAQ summary score only.")),
  cbindTable("", "", "Original Model", "Reduced Covariate Model"),
  cbindTable("Subgroup: change in diagnosis", 
             "Change in SAQ summary score:<br>Median (Q1, Q3)", 
             list(Text="Intervention effect estimate, (95% CI), p-value", Other=list(colspan=2))
  )
), 
body=rbindTable(
  list(Text="Timepoint: 6 months", Other=list(colspan=4)), 
  cbindTable(paste0("Diagnosis changed<br>N=", nrow(saqsumm_subgrp[saqsumm_subgrp$diag_changed=="Yes" & !is.na(saqsumm_subgrp$diag_changed),])),
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$diag_changed=="Yes" & !is.na(saqsumm_subgrp$diag_changed)], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_diag_int, term=2, asTable=F), 
             oth.lm.summ(saq6mo_diag_int_simple, term=2, asTable=F)),
  cbindTable(paste0("Diagnosis unchanged<br>N=", nrow(saqsumm_subgrp[saqsumm_subgrp$diag_changed=="No" & !is.na(saqsumm_subgrp$diag_changed),])),
             summary.fun(saqsumm_subgrp$saq_summ_ch_6m[saqsumm_subgrp$diag_changed=="No" & !is.na(saqsumm_subgrp$diag_changed)], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq6mo_diag_int, term=3, asTable=F), 
             oth.lm.summ(saq6mo_diag_int_simple, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-values:", Other=list(colspan=2)), 
             p.format(saq6mo_diag_int_p), 
             p.format(saq6mo_diag_int_p_simple)), 
  list(Text="Timepoint: 12 months", Other=list(colspan=4)), 
  cbindTable(paste0("Diagnosis changed<br>N=", nrow(saqsumm_subgrp[saqsumm_subgrp$diag_changed=="Yes" & !is.na(saqsumm_subgrp$diag_changed),])),
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$diag_changed=="Yes" & !is.na(saqsumm_subgrp$diag_changed)], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_diag_int, term=2, asTable=F), 
             oth.lm.summ(saq12mo_diag_int_simple, term=2, asTable=F)),
  cbindTable(paste0("Diagnosis unchanged<br>N=", nrow(saqsumm_subgrp[saqsumm_subgrp$diag_changed=="No" & !is.na(saqsumm_subgrp$diag_changed),])),
             summary.fun(saqsumm_subgrp$saq_summ_ch_12m[saqsumm_subgrp$diag_changed=="No" & !is.na(saqsumm_subgrp$diag_changed)], 
                         summary.text="@MEDIAN (@LQ, @UQ)"), 
             oth.lm.summ(saq12mo_diag_int, term=3, asTable=F), 
             oth.lm.summ(saq12mo_diag_int_simple, term=3, asTable=F)),
  cbindTable(list(Text="Interaction p-value:", Other=list(colspan=2)), 
             p.format(saq12mo_diag_int_p), 
             p.format(saq12mo_diag_int_p_simple)
  ), 
  end.row(disclaimer=T)
)  
)
ExportTable.HTML(tabs4$head, tabs4$body, horiz.fmt, manuscript.file, first=F, last=F)

tabs5 <- list(
  head=
    rbindTable(list(Text="<b>Table S5: Clinical events in the randomised population.</b>", Other=list(colspan=4)), 
               list(Text="P-values are all two-sided, and are from the Fisher's Exact test for categorical variables, or the Mann-Whitney U test for continuous variables.", Other=list(colspan=4)),
               cbindTable("", 
                          paste0("Control<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Control",])),  
                          paste0("Intervention<br>N=", nrow(outcomes[outcomes$visittypeid==1 & outcomes$trtgrp=="Intervention",])),
                          "p-value")), 
  body=
    rbindTable(cbindTable("MACCE, n (%)", 
                          npc.factor(diagnoses$macce[diagnoses$trtgrp=="Control"], x.levels="Yes"), 
                          npc.factor(diagnoses$macce[diagnoses$trtgrp=="Intervention"], x.levels="Yes"),
                          p.format(fisher.test(diagnoses$macce, diagnoses$trtgrp)$p.value)), 
               cbindTable("MACE, n (%)", 
                          npc.factor(diagnoses$mace[diagnoses$trtgrp=="Control"], x.levels="Yes"), 
                          npc.factor(diagnoses$mace[diagnoses$trtgrp=="Intervention"], x.levels="Yes"),
                          p.format(fisher.test(diagnoses$mace, diagnoses$trtgrp)$p.value)),
               cbindTable("All-cause mortality, n (%)", 
                          npc.factor(diagnoses$dth[diagnoses$trtgrp=="Control"], x.levels="Yes"), 
                          npc.factor(diagnoses$dth[diagnoses$trtgrp=="Intervention"], x.levels="Yes"), 
                          p.format(fisher.test(diagnoses$dth, diagnoses$trtgrp)$p.value)), 
               cbindTable("Non-fatal myocardial infarction, n (%)", 
                          npc.factor(diagnoses$mi[diagnoses$trtgrp=="Control"], x.levels="Yes"), 
                          npc.factor(diagnoses$mi[diagnoses$trtgrp=="Intervention"], x.levels="Yes"), 
                          p.format(fisher.test(diagnoses$mi, diagnoses$trtgrp)$p.value)), 
               cbindTable("Cerebrovascular event, n (%)", 
                          npc.factor(diagnoses$tia[diagnoses$trtgrp=="Control"], x.levels="Yes"), 
                          npc.factor(diagnoses$tia[diagnoses$trtgrp=="Intervention"], x.levels="Yes"), 
                          p.format(fisher.test(diagnoses$tia, diagnoses$trtgrp)$p.value)), 
               cbindTable("SAE requiring hospitalisation, n (%)", 
                          npc.factor(diagnoses$saehosp[diagnoses$trtgrp=="Control"], x.levels="Yes"), 
                          npc.factor(diagnoses$saehosp[diagnoses$trtgrp=="Intervention"], x.levels="Yes"), 
                          p.format(fisher.test(diagnoses$saehosp, diagnoses$trtgrp)$p.value)), 
               cbindTable("Duration of SAE hospital stay (days), Median [Q1, Q3]", 
                          summary.fun(as.numeric(diagnoses$saehospdur[diagnoses$saehosp=="Yes" & diagnoses$trtgrp=="Control"]), summary.text="@MEDIAN [@LQ, @UQ]"), 
                          summary.fun(as.numeric(diagnoses$saehospdur[diagnoses$saehosp=="Yes" & diagnoses$trtgrp=="Intervention"]), summary.text="@MEDIAN [@LQ, @UQ]"), 
                          p.format(wilcox.test(as.numeric(diagnoses$saehospdur)~diagnoses$trtgrp)$p.value)), 
               cbindTable("Cardiac adverse event (hospital attendance for chest pain), n (%)", 
                          npc.factor(diagnoses$card_ae[diagnoses$trtgrp=="Control"], x.levels="Yes"), 
                          npc.factor(diagnoses$card_ae[diagnoses$trtgrp=="Intervention"], x.levels="Yes"), 
                          p.format(fisher.test(diagnoses$card_ae, diagnoses$trtgrp)$p.value)),
               cbindTable("Number of cardiac adverse events (in those with at least 1), Mean (SD)", 
                          summary.fun(diagnoses$count_cardiac[diagnoses$card_ae=="Yes" & diagnoses$trtgrp=="Control"], summary.text="@MEAN (@SD)"), 
                          summary.fun(diagnoses$count_cardiac[diagnoses$card_ae=="Yes" & diagnoses$trtgrp=="Intervention"], summary.text="@MEAN (@SD)"), 
                          p.format(wilcox.test(diagnoses$count_cardiac[diagnoses$card_ae=="Yes"]~diagnoses$trtgrp[diagnoses$card_ae=="Yes"])$p.value)), 
               end.row()
    )
)
ExportTable.HTML(tabs5$head, tabs5$body, horiz.fmt, manuscript.file, first=F, last=F)

clinq_perc_int <- c(as.numeric(prop.table(table(diagnoses$clinq_diag[diagnoses$trtgrp=="Intervention"]))*100))
clinq_perc_ctr <- c(as.numeric(prop.table(table(diagnoses$clinq_diag[diagnoses$trtgrp=="Control"]))*100))
#working_perc_int <- c(as.numeric(prop.table(table(diagnoses$diag2[diagnoses$trtgrp=="Intervention"]))*100))
#working_perc_ctr <- c(as.numeric(prop.table(table(diagnoses$diag2[diagnoses$trtgrp=="Control"]))*100))
mri_perc_int <- c(as.numeric(prop.table(table(diagnoses$mridiag[diagnoses$trtgrp=="Intervention"]))*100))
mri_perc_ctr <- c(as.numeric(prop.table(table(diagnoses$mridiag[diagnoses$trtgrp=="Control"]))*100))

# diagnoses pre-rand
prerand_cad_int <- 100*(sum(table(diagnoses$clinq_diag,diagnoses$trtgrp)[c("Obstructive CAD"), "Intervention"])/sum(table(diagnoses$clinq_diag, diagnoses$trtgrp)[,"Intervention"]))
prerand_cad_ctl <- 100*(sum(table(diagnoses$clinq_diag,diagnoses$trtgrp)[c("Obstructive CAD"), "Control"])/sum(table(diagnoses$clinq_diag, diagnoses$trtgrp)[,"Control"]))
prerand_mva_int <- 100*(sum(table(diagnoses$clinq_diag,diagnoses$trtgrp)[c("Microvascular angina"), "Intervention"])/sum(table(diagnoses$clinq_diag, diagnoses$trtgrp)[,"Intervention"]))
prerand_mva_ctl <- 100*(sum(table(diagnoses$clinq_diag,diagnoses$trtgrp)[c("Microvascular angina"), "Control"])/sum(table(diagnoses$clinq_diag, diagnoses$trtgrp)[,"Control"]))
prerand_vsa_int <- 100*(sum(table(diagnoses$clinq_diag,diagnoses$trtgrp)[c("Vasospastic angina"), "Intervention"])/sum(table(diagnoses$clinq_diag, diagnoses$trtgrp)[,"Intervention"]))
prerand_vsa_ctl <- 100*(sum(table(diagnoses$clinq_diag,diagnoses$trtgrp)[c("Vasospastic angina"), "Control"])/sum(table(diagnoses$clinq_diag, diagnoses$trtgrp)[,"Control"]))
prerand_ncc_int <- 100*(sum(table(diagnoses$clinq_diag,diagnoses$trtgrp)[c("Non-cardiac chest pain"), "Intervention"])/sum(table(diagnoses$clinq_diag, diagnoses$trtgrp)[,"Intervention"]))
prerand_ncc_ctl <- 100*(sum(table(diagnoses$clinq_diag,diagnoses$trtgrp)[c("Non-cardiac chest pain"), "Control"])/sum(table(diagnoses$clinq_diag, diagnoses$trtgrp)[,"Control"]))
prerand_oth_int <- 100*(sum(table(diagnoses$clinq_diag,diagnoses$trtgrp)[c("Other"), "Intervention"])/sum(table(diagnoses$clinq_diag, diagnoses$trtgrp)[,"Intervention"]))
prerand_oth_ctl <- 100*(sum(table(diagnoses$clinq_diag,diagnoses$trtgrp)[c("Other"), "Control"])/sum(table(diagnoses$clinq_diag, diagnoses$trtgrp)[,"Control"]))

# working diagnoses post-rand
postrand_cad_int <- 100*(sum(table(diagnoses$diag2,diagnoses$trtgrp)[c("Obstructive CAD"), "Intervention"])/sum(table(diagnoses$diag2, diagnoses$trtgrp)[,"Intervention"]))
postrand_cad_ctl <- 100*(sum(table(diagnoses$diag2,diagnoses$trtgrp)[c("Obstructive CAD"), "Control"])/sum(table(diagnoses$diag2, diagnoses$trtgrp)[,"Control"]))
postrand_mva_int <- 100*(sum(table(diagnoses$diag2,diagnoses$trtgrp)[c("Microvascular angina"), "Intervention"])/sum(table(diagnoses$diag2, diagnoses$trtgrp)[,"Intervention"]))
postrand_mva_ctl <- 100*(sum(table(diagnoses$diag2,diagnoses$trtgrp)[c("Microvascular angina"), "Control"])/sum(table(diagnoses$diag2, diagnoses$trtgrp)[,"Control"]))
postrand_vsa_int <- 100*(sum(table(diagnoses$diag2,diagnoses$trtgrp)[c("Vasospastic angina"), "Intervention"])/sum(table(diagnoses$diag2, diagnoses$trtgrp)[,"Intervention"]))
postrand_vsa_ctl <- 100*(sum(table(diagnoses$diag2,diagnoses$trtgrp)[c("Vasospastic angina"), "Control"])/sum(table(diagnoses$diag2, diagnoses$trtgrp)[,"Control"]))
postrand_ncc_int <- 100*(sum(table(diagnoses$diag2,diagnoses$trtgrp)[c("Non-cardiac chest pain"), "Intervention"])/sum(table(diagnoses$diag2, diagnoses$trtgrp)[,"Intervention"]))
postrand_ncc_ctl <- 100*(sum(table(diagnoses$diag2,diagnoses$trtgrp)[c("Non-cardiac chest pain"), "Control"])/sum(table(diagnoses$diag2, diagnoses$trtgrp)[,"Control"]))
postrand_oth_int <- 100*(sum(table(diagnoses$diag2,diagnoses$trtgrp)[c("Other"), "Intervention"])/sum(table(diagnoses$diag2, diagnoses$trtgrp)[,"Intervention"]))
postrand_oth_ctl <- 100*(sum(table(diagnoses$diag2,diagnoses$trtgrp)[c("Other"), "Control"])/sum(table(diagnoses$diag2, diagnoses$trtgrp)[,"Control"]))

# true endotypes
truediag_cad_int <- 100*(sum(table(diagnoses$mridiag,diagnoses$trtgrp)[c("Obstructive CAD"), "Intervention"])/sum(table(diagnoses$mridiag, diagnoses$trtgrp)[,"Intervention"]))
truediag_cad_ctl <- 100*(sum(table(diagnoses$mridiag,diagnoses$trtgrp)[c("Obstructive CAD"), "Control"])/sum(table(diagnoses$mridiag, diagnoses$trtgrp)[,"Control"]))
truediag_mva_int <- 100*(sum(table(diagnoses$mridiag,diagnoses$trtgrp)[c("Microvascular angina"), "Intervention"])/sum(table(diagnoses$mridiag, diagnoses$trtgrp)[,"Intervention"]))
truediag_mva_ctl <- 100*(sum(table(diagnoses$mridiag,diagnoses$trtgrp)[c("Microvascular angina"), "Control"])/sum(table(diagnoses$mridiag, diagnoses$trtgrp)[,"Control"]))
truediag_vsa_int <- 100*(sum(table(diagnoses$mridiag,diagnoses$trtgrp)[c("Vasospastic angina"), "Intervention"])/sum(table(diagnoses$mridiag, diagnoses$trtgrp)[,"Intervention"]))
truediag_vsa_ctl <- 100*(sum(table(diagnoses$mridiag,diagnoses$trtgrp)[c("Vasospastic angina"), "Control"])/sum(table(diagnoses$mridiag, diagnoses$trtgrp)[,"Control"]))
truediag_ncc_int <- 100*(sum(table(diagnoses$mridiag,diagnoses$trtgrp)[c("Non-cardiac chest pain"), "Intervention"])/sum(table(diagnoses$mridiag, diagnoses$trtgrp)[,"Intervention"]))
truediag_ncc_ctl <- 100*(sum(table(diagnoses$mridiag,diagnoses$trtgrp)[c("Non-cardiac chest pain"), "Control"])/sum(table(diagnoses$mridiag, diagnoses$trtgrp)[,"Control"]))
truediag_oth_int <- 100*(sum(table(diagnoses$mridiag,diagnoses$trtgrp)[c("Other"), "Intervention"])/sum(table(diagnoses$mridiag, diagnoses$trtgrp)[,"Intervention"]))
truediag_oth_ctl <- 100*(sum(table(diagnoses$mridiag,diagnoses$trtgrp)[c("Other"), "Control"])/sum(table(diagnoses$mridiag, diagnoses$trtgrp)[,"Control"]))

# midpoint of rectangles
xrect <- c(1,2,5.5,9,10)-0.5
# plot
setEPS()
postscript(paste0(figure.path, "/Figure_9", ".eps"))
plot(1, 1, 
     type = "n",
     xaxt = "n",
     yaxt = "n", 
     ylab = "", 
     xlab = "",
     bty = "n",
     xlim = c(0,15),
     ylim = c(0,100))
axis(side=2,
     labels=c("0",
              "10",
              "20",
              "30",
              "40",
              "50",
              "60",
              "70",
              "80",
              "90",
              "100"),
     at=c("0",
          "10",
          "20",
          "30",
          "40",
          "50",
          "60",
          "70",
          "80",
          "90",
          "100"),
     las=1)
mtext(side=2, 
      at=50,
      cex=1,
      text="Proportion of patients (%)",
      line=2.5)
# colours
intcol <- c("#3f6f21","#519839","#61bd4f","#99d18f","#d6ecd2")
ctlcol <- hcl.colors(5,"Teal")

# bars
# pre-rand diagnosis - intervention group
rect(xrect[1] - 0.5, 0, xrect[1] + 0.45, prerand_cad_int, col = intcol[1], border = NA)
rect(xrect[1] - 0.5, prerand_cad_int, xrect[1] + 0.45, prerand_cad_int+prerand_mva_int, col = intcol[2], border = NA)
rect(xrect[1] - 0.5, prerand_cad_int+prerand_mva_int, xrect[1] + 0.45, prerand_cad_int+prerand_mva_int+prerand_vsa_int, col = intcol[3], border = NA)
rect(xrect[1] - 0.5, prerand_cad_int+prerand_mva_int+prerand_vsa_int, xrect[1] + 0.45, prerand_cad_int+prerand_mva_int+prerand_vsa_int+prerand_ncc_int, col = intcol[4], border = NA)
rect(xrect[1] - 0.5, prerand_cad_int+prerand_mva_int+prerand_vsa_int+prerand_ncc_int, xrect[1] + 0.45, prerand_cad_int+prerand_mva_int+prerand_vsa_int+prerand_ncc_int+prerand_oth_int, col = intcol[5], border = NA)
# pre-rand diagnosis - control group
rect(xrect[2] - 0.5, 0, xrect[2] + 0.45, prerand_cad_ctl, col = ctlcol[1], border = NA)
rect(xrect[2] - 0.5, prerand_cad_ctl, xrect[2] + 0.45, prerand_cad_ctl+prerand_mva_ctl, col = ctlcol[2], border = NA)
rect(xrect[2] - 0.5, prerand_cad_ctl+prerand_mva_ctl, xrect[2] + 0.45, prerand_cad_ctl+prerand_mva_ctl+prerand_vsa_ctl, col = ctlcol[3], border = NA)
rect(xrect[2] - 0.5, prerand_cad_ctl+prerand_mva_ctl+prerand_vsa_ctl, xrect[2] + 0.45, prerand_cad_ctl+prerand_mva_ctl+prerand_vsa_ctl+prerand_ncc_ctl, col = ctlcol[4], border = NA)
rect(xrect[2] - 0.5, prerand_cad_ctl+prerand_mva_ctl+prerand_vsa_ctl+prerand_ncc_ctl, xrect[2] + 0.45, prerand_cad_ctl+prerand_mva_ctl+prerand_vsa_ctl+prerand_ncc_ctl+prerand_oth_ctl, col = ctlcol[5], border = NA)

# post-rand diagnosis - intervention group
rect(xrect[3] - 0.5, 0, xrect[3] + 0.45, postrand_cad_int, col = intcol[1], border = NA)
rect(xrect[3] - 0.5, postrand_cad_int, xrect[3] + 0.45, postrand_cad_int+postrand_mva_int, col = intcol[2], border = NA)
rect(xrect[3] - 0.5, postrand_cad_int+postrand_mva_int, xrect[3] + 0.45, postrand_cad_int+postrand_mva_int+postrand_vsa_int, col = intcol[3], border = NA)
rect(xrect[3] - 0.5, postrand_cad_int+postrand_mva_int+postrand_vsa_int, xrect[3] + 0.45, postrand_cad_int+postrand_mva_int+postrand_vsa_int+postrand_ncc_int, col = intcol[4], border = NA)
rect(xrect[3] - 0.5, postrand_cad_int+postrand_mva_int+postrand_vsa_int+postrand_ncc_int, xrect[3] + 0.45, postrand_cad_int+postrand_mva_int+postrand_vsa_int+postrand_ncc_int+postrand_oth_int, col = intcol[5], border = NA)

# true endotype - intervention group
rect(xrect[4] - 0.5, 0, xrect[4] + 0.45, truediag_cad_int, col = intcol[1], border = NA)
rect(xrect[4] - 0.5, truediag_cad_int, xrect[4] + 0.45, truediag_cad_int+truediag_mva_int, col = intcol[2], border = NA)
rect(xrect[4] - 0.5, truediag_cad_int+truediag_mva_int, xrect[4] + 0.45, truediag_cad_int+truediag_mva_int+truediag_vsa_int, col = intcol[3], border = NA)
rect(xrect[4] - 0.5, truediag_cad_int+truediag_mva_int+truediag_vsa_int, xrect[4] + 0.45, truediag_cad_int+truediag_mva_int+truediag_vsa_int+truediag_ncc_int, col = intcol[4], border = NA)
rect(xrect[4] - 0.5, truediag_cad_int+truediag_mva_int+truediag_vsa_int+truediag_ncc_int, xrect[4] + 0.45, truediag_cad_int+truediag_mva_int+truediag_vsa_int+truediag_ncc_int+truediag_oth_int, col = intcol[5], border = NA)

# true endotype - control group
rect(xrect[5] - 0.5, 0, xrect[5] + 0.45, truediag_cad_ctl, col = ctlcol[1], border = NA)
rect(xrect[5] - 0.5, truediag_cad_ctl, xrect[5] + 0.45, truediag_cad_ctl+truediag_mva_ctl, col = ctlcol[2], border = NA)
rect(xrect[5] - 0.5, truediag_cad_ctl+truediag_mva_ctl, xrect[5] + 0.45, truediag_cad_ctl+truediag_mva_ctl+truediag_vsa_ctl, col = ctlcol[3], border = NA)
rect(xrect[5] - 0.5, truediag_cad_ctl+truediag_mva_ctl+truediag_vsa_ctl, xrect[5] + 0.45, truediag_cad_ctl+truediag_mva_ctl+truediag_vsa_ctl+truediag_ncc_ctl, col = ctlcol[4], border = NA)
rect(xrect[5] - 0.5, truediag_cad_ctl+truediag_mva_ctl+truediag_vsa_ctl+truediag_ncc_ctl, xrect[5] + 0.45, truediag_cad_ctl+truediag_mva_ctl+truediag_vsa_ctl+truediag_ncc_ctl+truediag_oth_ctl, col = ctlcol[5], border = NA)
# legend text
text(11.75, 95, "Diagnosis", cex=1)
legend(10.25,92.5, 
       legend=c("",
                "",
                "",
                "",
                ""),
       fill=c(intcol[5],
              intcol[4],
              intcol[3],
              intcol[2],
              intcol[1]),
       border=c(intcol[5],
                intcol[4],
                intcol[3],
                intcol[2],
                intcol[1]),
       bty="n",
       cex=1)
legend(10.75,92.5, 
       legend=c("Other",
                "NCC",
                "VSA",
                "MVA",
                "OCAD"),
       fill=c(ctlcol[5],
              ctlcol[4],
              ctlcol[3],
              ctlcol[2],
              ctlcol[1]),
       border=c(ctlcol[5],
                ctlcol[4],
                ctlcol[3],
                ctlcol[2],
                ctlcol[1]),
       bty="n",
       cex=1)
# x-axis labels
text(x=c(0.5, 1.5, 8.5, 9.5),
     y=(-3.5),
     labels=c("Int","Con"),
     xpd=T)
text(x=c(5),
     y=(-3.5),
     labels=c("Int"),
     xpd=T)
mtext(text=c("Post-angiogram,\npre-CMR,\npre-randomisation",
             "Post-CMR,\npost-randomisation",
             "True\nendotype"),
      side = 1, 
      line = 2,
      adj=0.5,
      at = c(mean(xrect[1:2]),
             xrect[3],
             mean(xrect[4:5])),
      cex=0.95)

# mtext(text=c("Post-CMR,\npost-randomisation"),
#       side = 1, 
#       line = 3,
#       adj=0.5,
#       at = c(xrect[3]),
#       cex=0.75)

axis(3,xrect[2:3],labels=F,tcl=0.5)
axis(3,mean(xrect[2:3]),labels="Diagnosis reached at end of CMR imaging visit",tick=F)

dev.off()

figtab9 <- list(head=rbindTable(list(Text="<b>Figure 9: Diagnoses across study timepoints.</b>")), 
                body=rbindTable(list(Text="<img src='C:/CORCMR/Unblinded/reports/v1_9/HardLock/Tables/Figures/Figure_9.wmf' alt='Figure 9'>"), 
                                end.row())
)
ExportTable.HTML(figtab9$head, figtab9$body, filename=figure.file, horiz.fmt, first=F, last=F)

# export figures as editable powerpoint files
# create powerpoint
fig_ppt <- read_pptx()
# insert images already produced into presentation - just those from manuscript and supplement 
# scatterplots
fig_ppt <- add_slide(fig_ppt)
fig_ppt <- ph_with(fig_ppt, value = external_img(src = "C:/CORCMR/Unblinded/reports/v1_10/HardLock/Tables/Figures/Figure_1_1.wmf"), location = ph_location_fullsize(newlabel=""), use_loc_size = TRUE )
fig_ppt <- add_slide(fig_ppt)
fig_ppt <- ph_with(fig_ppt, value = external_img(src = "C:/CORCMR/Unblinded/reports/v1_10/HardLock/Tables/Figures/Figure_2_1.wmf"), location = ph_location_fullsize(newlabel=""), use_loc_size = TRUE )
fig_ppt <- add_slide(fig_ppt)
fig_ppt <- ph_with(fig_ppt, value = external_img(src = "C:/CORCMR/Unblinded/reports/v1_10/HardLock/Tables/Figures/Figure_2_2.wmf"), location = ph_location_fullsize(newlabel=""), use_loc_size = TRUE )
fig_ppt <- add_slide(fig_ppt)
fig_ppt <- ph_with(fig_ppt, value = external_img(src = "C:/CORCMR/Unblinded/reports/v1_10/HardLock/Tables/Figures/Figure_3_1.wmf"), location = ph_location_fullsize(newlabel=""), use_loc_size = TRUE )
fig_ppt <- add_slide(fig_ppt)
fig_ppt <- ph_with(fig_ppt, value = external_img(src = "C:/CORCMR/Unblinded/reports/v1_10/HardLock/Tables/Figures/Figure_4_1.wmf"), location = ph_location_fullsize(newlabel=""), use_loc_size = TRUE )
fig_ppt <- add_slide(fig_ppt)
fig_ppt <- ph_with(fig_ppt, value = external_img(src = "C:/CORCMR/Unblinded/reports/v1_10/HardLock/Tables/Figures/Figure_4_2.wmf"), location = ph_location_fullsize(newlabel=""), use_loc_size = TRUE )
# standardised effect estimates
fig_ppt <- add_slide(fig_ppt)
fig_ppt <- ph_with(fig_ppt, value = external_img(src = "C:/CORCMR/Unblinded/reports/v1_10/HardLock/Tables/Figures/Figure_7.wmf"), location = ph_location_fullsize(newlabel=""), use_loc_size = TRUE )
fig_ppt <- add_slide(fig_ppt)
fig_ppt <- ph_with(fig_ppt, value = external_img(src = "C:/CORCMR/Unblinded/reports/v1_10/HardLock/Tables/Figures/Figure_8.wmf"), location = ph_location_fullsize(newlabel=""), use_loc_size = TRUE )
#export powerpoint
print(fig_ppt, target=paste0(table.path, "/CORCMR_ManuscriptFigures", Sys.Date(), ".pptx"))
# CI for change in diagnosis
prop.test(x=131, n=249, conf.level=0.95)
# copy all output files over from C drive to filestore
# 
# out.path.filestore<-paste0("//rcb-storage/filestore/Studies/CORCMR/Secure/Unblinded/reports/", Version, "/", vdraft)
# dir.create(out.path.filestore, recursive=T)
# 
# # OUTPUT SUBDIRECTORIES
# # CREATE SUBDIRECTORY FOR TABLES
# table.path.filestore<-paste(out.path.filestore,"Tables",sep="/")
# dir.create(table.path.filestore)
# # CREATE SUBDIRECTORY FOR FIGURES
# figure.path.filestore<-paste(out.path.filestore,"Tables","Figures",sep="/")
# dir.create(figure.path.filestore)
# # CREATE SUBDIRECTORY FOR FIGURES (diagnostics)
# diags.path.filestore<-paste(out.path.filestore,"Tables","Figures","Diagnostics",sep="/")
# dir.create(diags.path.filestore)
# 
# file.copy(from=out.path, to=out.path.filestore, overwrite=T, recursive=T)
# # remove C drive version
# unlink(out.path)
# 
# # END OF PROGRAM #
